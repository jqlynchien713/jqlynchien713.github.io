<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Deploy Rails with Docker Swarm (4) - Gitlab Runner è‡ªå‹•åŒ–éƒ¨ç½² | Jacquelynâ€™s Blog</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Deploy Rails with Docker Swarm (4) - Gitlab Runner è‡ªå‹•åŒ–éƒ¨ç½²" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="è‡ªå‹•åŒ–éƒ¨ç½² with Gitlab Runner Registration é€²å…¥ä¸Šä¸€ç¯‡é–‹å¥½çš„ Manager EC2ï¼Œä¸¦ä¸”æ­¤æ™‚çš„ EC2 æ‡‰è©²å·²ç¶“å®‰è£å¥½ Gitlab Runnerï¼Œé€™æ™‚å€™å¯ä»¥ç›´æ¥è¨»å†Šæˆ‘å€‘çš„ Runnerï¼šsudo gitlab-runner registerï¼Œä¸‹å¥½æŒ‡ä»¤å¾Œä¸€å…±æœƒå•ä¸ƒå€‹å•é¡Œï¼š Gitlab instance URL Registration Code å‰å…©å€‹å•é¡Œå¯ä»¥é€²å…¥åˆ° Gitlab project &gt; Settings &gt; CI/CD &gt; Runner å»æŸ¥çœ‹è¨­å®šç´°ç¯€ï¼Œå¦‚é™„åœ–çš„å·¦å´ Description for runner: docker é™„åœ–å³å´ç™½åº•é»‘å­—çš„éƒ¨åˆ† Tags for runner(comma seperated): prod é™„åœ–è—åº•éƒ¨åˆ†ï¼Œä¸”é€™å€‹ tag æ˜¯åœ¨å¾ŒçºŒæŒ‡å®š job è¦å“ªå€‹ runner åŸ·è¡Œçš„ä¾æ“š Optional maintenance note for runner: (optional) Enter the executor: docker Default Docker image: tiangolo/docker-with-compose å¾ŒçºŒçš„ job éœ€è¦ compose å¹«æˆ‘å€‘ build imageï¼Œå› æ­¤éœ€è¦æŒ‡å®šé€™å€‹ image .gitlab-ci.yml é€™é‚Šä¸»è¦ä¹Ÿæ˜¯åƒè€ƒ dockerswarm.rocks çš„ç¯„ä¾‹ï¼Œä»¥ä¸‹ç°¡å–®ä»‹ç´¹ä¸€ä¸‹ä»–çš„è¨­å®šå…§å®¹ï¼š Stage: åˆ†ç‚º build èˆ‡ deploy Build: docker-compose build --build-arg RAILS_MASTER_KEY=$RAILS_MASTER_KEY å–®ç´”åªæœ‰ build imageï¼Œä½†å› ç‚ºæˆ‘çš„ Dockerfile åŒ…å«äº† Asset Precompileï¼Œå› æ­¤éœ€è¦å¸¶å…¥ RAILS_MASTER_KEY åšç‚ºåƒæ•¸ Deploy: docker stack deploy -c docker-compose.yml [stack name] Only: æŒ‡å®šç™¼ç”Ÿæ–¼ main branch Tags: ç”¨æ–¼æŒ‡å®šåŸ·è¡Œçš„ runner EC2 Prerequisites å› ç‚º Traefik èˆ‡ Rails App ç‚ºç¨ç«‹çš„å…©å€‹ Stackï¼Œç‚ºäº†ç°¡åŒ–é–‹ç™¼æµç¨‹ï¼Œé€™é‚Šé¸æ“‡æ‰‹å‹•é€²å…¥ EC2 éƒ¨ç½² Traefik åŸæœ¬æ˜¯å¦å¤–é–‹ä¸€å€‹ traefik åˆ†æ”¯åš Traefik éƒ¨ç½²ï¼ˆä¸¦ä¸”æŒ‡å®š Traefik éƒ¨ç½²çš„ job åªç™¼ç”Ÿåœ¨è©²åˆ†æ”¯ã€åªæœƒç™¼ç”Ÿä¸€æ¬¡ï¼‰ï¼Œä½†åœ¨æ¼”è¬›æ™‚æœ‰äººåæ˜ ä¸ç¢ºå®š traefik åˆ†æ”¯éƒ¨ç½²å¾Œè¦ä¸è¦åˆåˆ° main åˆ†æ”¯ä¸Šã€git graph æœ‰é»ä¸æ˜ç¢ºï¼Œå› æ­¤æ”¹ç‚ºä»¥å…¬å¸å¯¦éš›éƒ¨ç½²çš„æµç¨‹åšä»‹ç´¹ éƒ¨ç½²çš„æ­¥é©Ÿå°±åƒåœ¨å¯¦éš›éƒ¨ç½²æµç¨‹æåˆ°çš„åœ–è¡¨ä¸€æ¨£ï¼š é–‹å•Ÿä¸€å€‹ swarmï¼šdocker swarm init --default-addr-pool 10.20.0.0/16 å› ç‚º Docker é è¨­çš„ subnet range èˆ‡ EC2 ç›¸åŒï¼Œéƒ½æ˜¯ 10.0.0.1ï¼Œå› æ­¤é€™é‚Šè¦ç‰¹åˆ¥æŒ‡å®šä¸ä¸€æ¨£çš„ç¯„åœï¼Œ Swarm æ‰é€£çš„åˆ°å¤–ç¶² é–‹å•Ÿ traefik networkï¼šdocker network create --driver=overlay traefik-public å–å¾—ç¾åœ¨çš„ swarm manager node idï¼šexport NODE_ID=$(docker info -f &#39;&#39;) æŒ‡å®š traefik æ¯æ¬¡éƒ½ deploy åœ¨åŒä¸€å€‹ node &amp; volume ä¸Šï¼šdocker node update --label-add traefik-public.traefik-public-certificates=true $NODE_ID éƒ¨ç½² traefikï¼šdocker stack deploy -c traefik.yml traefik æœ€å¾Œå°±æ˜¯æŠŠ App æ¨ä¸Š GitLab é€²è¡Œéƒ¨ç½²ã„Œï¼ï¼ï¼ Worker Node åŠ å…¥ Docker Swarm åˆ°é€™é‚Šè¨­å®šå®Œ Manager ç¯€é»å¾Œï¼Œæˆ‘å€‘å¯ä»¥å›å»é–‹ Worker Templateï¼ŒæŠŠåŠ å…¥ Swarm çš„æŒ‡ä»¤åŠ å›å»ï¼š å…ˆåœ¨ Manager æ‰¾å›åŠ å…¥ Swarm çš„æŒ‡ä»¤ï¼šdocker swarm join-token worker åœ¨ Worker Template çš„ User Data ä¸­åŠ å…¥å‰›å‰›æ‰¾å›çš„æŒ‡ä»¤ï¼Œæ–¼æ˜¯æœ€çµ‚çš„ User Data æœƒé•·ä¸‹é¢é€™æ¨£ï¼š #!/bin/bash # Start docker daemon sudo service docker start sudo chown ec2-user:docker /var/run/docker.sock # Join swarm docker swarm join --token [JOIN-TOKEN] [IP-ADDRESS]:2377 åˆ°é€™é‚Šä¸»è¦çš„æŠ€è¡“è¨­å®šéƒ½çµæŸäº†â€¦..çœŸçš„æ˜¯è¶…å¤šå…§å®¹è¦ä»‹ç´¹ï¼šï¼‰ ä¸‹ä¸€ç¯‡æœƒè£œå……ä¸€äº›ç›¸é—œçš„è­°é¡Œè¨è«–ï¼Œé‚„æœ‰é€™æ¬¡ COSCUP æ¼”è¬›çš„å¿ƒå¾—ï¼Œå¸Œæœ›æˆ‘ä¸è¦éš”å¤ªä¹…æ‰æŠŠæ–‡ç« ç”Ÿå‡ºä¾†ï¼šï¼‰" />
<meta property="og:description" content="è‡ªå‹•åŒ–éƒ¨ç½² with Gitlab Runner Registration é€²å…¥ä¸Šä¸€ç¯‡é–‹å¥½çš„ Manager EC2ï¼Œä¸¦ä¸”æ­¤æ™‚çš„ EC2 æ‡‰è©²å·²ç¶“å®‰è£å¥½ Gitlab Runnerï¼Œé€™æ™‚å€™å¯ä»¥ç›´æ¥è¨»å†Šæˆ‘å€‘çš„ Runnerï¼šsudo gitlab-runner registerï¼Œä¸‹å¥½æŒ‡ä»¤å¾Œä¸€å…±æœƒå•ä¸ƒå€‹å•é¡Œï¼š Gitlab instance URL Registration Code å‰å…©å€‹å•é¡Œå¯ä»¥é€²å…¥åˆ° Gitlab project &gt; Settings &gt; CI/CD &gt; Runner å»æŸ¥çœ‹è¨­å®šç´°ç¯€ï¼Œå¦‚é™„åœ–çš„å·¦å´ Description for runner: docker é™„åœ–å³å´ç™½åº•é»‘å­—çš„éƒ¨åˆ† Tags for runner(comma seperated): prod é™„åœ–è—åº•éƒ¨åˆ†ï¼Œä¸”é€™å€‹ tag æ˜¯åœ¨å¾ŒçºŒæŒ‡å®š job è¦å“ªå€‹ runner åŸ·è¡Œçš„ä¾æ“š Optional maintenance note for runner: (optional) Enter the executor: docker Default Docker image: tiangolo/docker-with-compose å¾ŒçºŒçš„ job éœ€è¦ compose å¹«æˆ‘å€‘ build imageï¼Œå› æ­¤éœ€è¦æŒ‡å®šé€™å€‹ image .gitlab-ci.yml é€™é‚Šä¸»è¦ä¹Ÿæ˜¯åƒè€ƒ dockerswarm.rocks çš„ç¯„ä¾‹ï¼Œä»¥ä¸‹ç°¡å–®ä»‹ç´¹ä¸€ä¸‹ä»–çš„è¨­å®šå…§å®¹ï¼š Stage: åˆ†ç‚º build èˆ‡ deploy Build: docker-compose build --build-arg RAILS_MASTER_KEY=$RAILS_MASTER_KEY å–®ç´”åªæœ‰ build imageï¼Œä½†å› ç‚ºæˆ‘çš„ Dockerfile åŒ…å«äº† Asset Precompileï¼Œå› æ­¤éœ€è¦å¸¶å…¥ RAILS_MASTER_KEY åšç‚ºåƒæ•¸ Deploy: docker stack deploy -c docker-compose.yml [stack name] Only: æŒ‡å®šç™¼ç”Ÿæ–¼ main branch Tags: ç”¨æ–¼æŒ‡å®šåŸ·è¡Œçš„ runner EC2 Prerequisites å› ç‚º Traefik èˆ‡ Rails App ç‚ºç¨ç«‹çš„å…©å€‹ Stackï¼Œç‚ºäº†ç°¡åŒ–é–‹ç™¼æµç¨‹ï¼Œé€™é‚Šé¸æ“‡æ‰‹å‹•é€²å…¥ EC2 éƒ¨ç½² Traefik åŸæœ¬æ˜¯å¦å¤–é–‹ä¸€å€‹ traefik åˆ†æ”¯åš Traefik éƒ¨ç½²ï¼ˆä¸¦ä¸”æŒ‡å®š Traefik éƒ¨ç½²çš„ job åªç™¼ç”Ÿåœ¨è©²åˆ†æ”¯ã€åªæœƒç™¼ç”Ÿä¸€æ¬¡ï¼‰ï¼Œä½†åœ¨æ¼”è¬›æ™‚æœ‰äººåæ˜ ä¸ç¢ºå®š traefik åˆ†æ”¯éƒ¨ç½²å¾Œè¦ä¸è¦åˆåˆ° main åˆ†æ”¯ä¸Šã€git graph æœ‰é»ä¸æ˜ç¢ºï¼Œå› æ­¤æ”¹ç‚ºä»¥å…¬å¸å¯¦éš›éƒ¨ç½²çš„æµç¨‹åšä»‹ç´¹ éƒ¨ç½²çš„æ­¥é©Ÿå°±åƒåœ¨å¯¦éš›éƒ¨ç½²æµç¨‹æåˆ°çš„åœ–è¡¨ä¸€æ¨£ï¼š é–‹å•Ÿä¸€å€‹ swarmï¼šdocker swarm init --default-addr-pool 10.20.0.0/16 å› ç‚º Docker é è¨­çš„ subnet range èˆ‡ EC2 ç›¸åŒï¼Œéƒ½æ˜¯ 10.0.0.1ï¼Œå› æ­¤é€™é‚Šè¦ç‰¹åˆ¥æŒ‡å®šä¸ä¸€æ¨£çš„ç¯„åœï¼Œ Swarm æ‰é€£çš„åˆ°å¤–ç¶² é–‹å•Ÿ traefik networkï¼šdocker network create --driver=overlay traefik-public å–å¾—ç¾åœ¨çš„ swarm manager node idï¼šexport NODE_ID=$(docker info -f &#39;&#39;) æŒ‡å®š traefik æ¯æ¬¡éƒ½ deploy åœ¨åŒä¸€å€‹ node &amp; volume ä¸Šï¼šdocker node update --label-add traefik-public.traefik-public-certificates=true $NODE_ID éƒ¨ç½² traefikï¼šdocker stack deploy -c traefik.yml traefik æœ€å¾Œå°±æ˜¯æŠŠ App æ¨ä¸Š GitLab é€²è¡Œéƒ¨ç½²ã„Œï¼ï¼ï¼ Worker Node åŠ å…¥ Docker Swarm åˆ°é€™é‚Šè¨­å®šå®Œ Manager ç¯€é»å¾Œï¼Œæˆ‘å€‘å¯ä»¥å›å»é–‹ Worker Templateï¼ŒæŠŠåŠ å…¥ Swarm çš„æŒ‡ä»¤åŠ å›å»ï¼š å…ˆåœ¨ Manager æ‰¾å›åŠ å…¥ Swarm çš„æŒ‡ä»¤ï¼šdocker swarm join-token worker åœ¨ Worker Template çš„ User Data ä¸­åŠ å…¥å‰›å‰›æ‰¾å›çš„æŒ‡ä»¤ï¼Œæ–¼æ˜¯æœ€çµ‚çš„ User Data æœƒé•·ä¸‹é¢é€™æ¨£ï¼š #!/bin/bash # Start docker daemon sudo service docker start sudo chown ec2-user:docker /var/run/docker.sock # Join swarm docker swarm join --token [JOIN-TOKEN] [IP-ADDRESS]:2377 åˆ°é€™é‚Šä¸»è¦çš„æŠ€è¡“è¨­å®šéƒ½çµæŸäº†â€¦..çœŸçš„æ˜¯è¶…å¤šå…§å®¹è¦ä»‹ç´¹ï¼šï¼‰ ä¸‹ä¸€ç¯‡æœƒè£œå……ä¸€äº›ç›¸é—œçš„è­°é¡Œè¨è«–ï¼Œé‚„æœ‰é€™æ¬¡ COSCUP æ¼”è¬›çš„å¿ƒå¾—ï¼Œå¸Œæœ›æˆ‘ä¸è¦éš”å¤ªä¹…æ‰æŠŠæ–‡ç« ç”Ÿå‡ºä¾†ï¼šï¼‰" />
<link rel="canonical" href="https://jqlynchien713.github.io/2022/08/03/coscup4.html" />
<meta property="og:url" content="https://jqlynchien713.github.io/2022/08/03/coscup4.html" />
<meta property="og:site_name" content="Jacquelynâ€™s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-08-03T15:16:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Deploy Rails with Docker Swarm (4) - Gitlab Runner è‡ªå‹•åŒ–éƒ¨ç½²" />
<script type="application/ld+json">
{"description":"è‡ªå‹•åŒ–éƒ¨ç½² with Gitlab Runner Registration é€²å…¥ä¸Šä¸€ç¯‡é–‹å¥½çš„ Manager EC2ï¼Œä¸¦ä¸”æ­¤æ™‚çš„ EC2 æ‡‰è©²å·²ç¶“å®‰è£å¥½ Gitlab Runnerï¼Œé€™æ™‚å€™å¯ä»¥ç›´æ¥è¨»å†Šæˆ‘å€‘çš„ Runnerï¼šsudo gitlab-runner registerï¼Œä¸‹å¥½æŒ‡ä»¤å¾Œä¸€å…±æœƒå•ä¸ƒå€‹å•é¡Œï¼š Gitlab instance URL Registration Code å‰å…©å€‹å•é¡Œå¯ä»¥é€²å…¥åˆ° Gitlab project &gt; Settings &gt; CI/CD &gt; Runner å»æŸ¥çœ‹è¨­å®šç´°ç¯€ï¼Œå¦‚é™„åœ–çš„å·¦å´ Description for runner: docker é™„åœ–å³å´ç™½åº•é»‘å­—çš„éƒ¨åˆ† Tags for runner(comma seperated): prod é™„åœ–è—åº•éƒ¨åˆ†ï¼Œä¸”é€™å€‹ tag æ˜¯åœ¨å¾ŒçºŒæŒ‡å®š job è¦å“ªå€‹ runner åŸ·è¡Œçš„ä¾æ“š Optional maintenance note for runner: (optional) Enter the executor: docker Default Docker image: tiangolo/docker-with-compose å¾ŒçºŒçš„ job éœ€è¦ compose å¹«æˆ‘å€‘ build imageï¼Œå› æ­¤éœ€è¦æŒ‡å®šé€™å€‹ image .gitlab-ci.yml é€™é‚Šä¸»è¦ä¹Ÿæ˜¯åƒè€ƒ dockerswarm.rocks çš„ç¯„ä¾‹ï¼Œä»¥ä¸‹ç°¡å–®ä»‹ç´¹ä¸€ä¸‹ä»–çš„è¨­å®šå…§å®¹ï¼š Stage: åˆ†ç‚º build èˆ‡ deploy Build: docker-compose build --build-arg RAILS_MASTER_KEY=$RAILS_MASTER_KEY å–®ç´”åªæœ‰ build imageï¼Œä½†å› ç‚ºæˆ‘çš„ Dockerfile åŒ…å«äº† Asset Precompileï¼Œå› æ­¤éœ€è¦å¸¶å…¥ RAILS_MASTER_KEY åšç‚ºåƒæ•¸ Deploy: docker stack deploy -c docker-compose.yml [stack name] Only: æŒ‡å®šç™¼ç”Ÿæ–¼ main branch Tags: ç”¨æ–¼æŒ‡å®šåŸ·è¡Œçš„ runner EC2 Prerequisites å› ç‚º Traefik èˆ‡ Rails App ç‚ºç¨ç«‹çš„å…©å€‹ Stackï¼Œç‚ºäº†ç°¡åŒ–é–‹ç™¼æµç¨‹ï¼Œé€™é‚Šé¸æ“‡æ‰‹å‹•é€²å…¥ EC2 éƒ¨ç½² Traefik åŸæœ¬æ˜¯å¦å¤–é–‹ä¸€å€‹ traefik åˆ†æ”¯åš Traefik éƒ¨ç½²ï¼ˆä¸¦ä¸”æŒ‡å®š Traefik éƒ¨ç½²çš„ job åªç™¼ç”Ÿåœ¨è©²åˆ†æ”¯ã€åªæœƒç™¼ç”Ÿä¸€æ¬¡ï¼‰ï¼Œä½†åœ¨æ¼”è¬›æ™‚æœ‰äººåæ˜ ä¸ç¢ºå®š traefik åˆ†æ”¯éƒ¨ç½²å¾Œè¦ä¸è¦åˆåˆ° main åˆ†æ”¯ä¸Šã€git graph æœ‰é»ä¸æ˜ç¢ºï¼Œå› æ­¤æ”¹ç‚ºä»¥å…¬å¸å¯¦éš›éƒ¨ç½²çš„æµç¨‹åšä»‹ç´¹ éƒ¨ç½²çš„æ­¥é©Ÿå°±åƒåœ¨å¯¦éš›éƒ¨ç½²æµç¨‹æåˆ°çš„åœ–è¡¨ä¸€æ¨£ï¼š é–‹å•Ÿä¸€å€‹ swarmï¼šdocker swarm init --default-addr-pool 10.20.0.0/16 å› ç‚º Docker é è¨­çš„ subnet range èˆ‡ EC2 ç›¸åŒï¼Œéƒ½æ˜¯ 10.0.0.1ï¼Œå› æ­¤é€™é‚Šè¦ç‰¹åˆ¥æŒ‡å®šä¸ä¸€æ¨£çš„ç¯„åœï¼Œ Swarm æ‰é€£çš„åˆ°å¤–ç¶² é–‹å•Ÿ traefik networkï¼šdocker network create --driver=overlay traefik-public å–å¾—ç¾åœ¨çš„ swarm manager node idï¼šexport NODE_ID=$(docker info -f &#39;&#39;) æŒ‡å®š traefik æ¯æ¬¡éƒ½ deploy åœ¨åŒä¸€å€‹ node &amp; volume ä¸Šï¼šdocker node update --label-add traefik-public.traefik-public-certificates=true $NODE_ID éƒ¨ç½² traefikï¼šdocker stack deploy -c traefik.yml traefik æœ€å¾Œå°±æ˜¯æŠŠ App æ¨ä¸Š GitLab é€²è¡Œéƒ¨ç½²ã„Œï¼ï¼ï¼ Worker Node åŠ å…¥ Docker Swarm åˆ°é€™é‚Šè¨­å®šå®Œ Manager ç¯€é»å¾Œï¼Œæˆ‘å€‘å¯ä»¥å›å»é–‹ Worker Templateï¼ŒæŠŠåŠ å…¥ Swarm çš„æŒ‡ä»¤åŠ å›å»ï¼š å…ˆåœ¨ Manager æ‰¾å›åŠ å…¥ Swarm çš„æŒ‡ä»¤ï¼šdocker swarm join-token worker åœ¨ Worker Template çš„ User Data ä¸­åŠ å…¥å‰›å‰›æ‰¾å›çš„æŒ‡ä»¤ï¼Œæ–¼æ˜¯æœ€çµ‚çš„ User Data æœƒé•·ä¸‹é¢é€™æ¨£ï¼š #!/bin/bash # Start docker daemon sudo service docker start sudo chown ec2-user:docker /var/run/docker.sock # Join swarm docker swarm join --token [JOIN-TOKEN] [IP-ADDRESS]:2377 åˆ°é€™é‚Šä¸»è¦çš„æŠ€è¡“è¨­å®šéƒ½çµæŸäº†â€¦..çœŸçš„æ˜¯è¶…å¤šå…§å®¹è¦ä»‹ç´¹ï¼šï¼‰ ä¸‹ä¸€ç¯‡æœƒè£œå……ä¸€äº›ç›¸é—œçš„è­°é¡Œè¨è«–ï¼Œé‚„æœ‰é€™æ¬¡ COSCUP æ¼”è¬›çš„å¿ƒå¾—ï¼Œå¸Œæœ›æˆ‘ä¸è¦éš”å¤ªä¹…æ‰æŠŠæ–‡ç« ç”Ÿå‡ºä¾†ï¼šï¼‰","url":"https://jqlynchien713.github.io/2022/08/03/coscup4.html","headline":"Deploy Rails with Docker Swarm (4) - Gitlab Runner è‡ªå‹•åŒ–éƒ¨ç½²","@type":"BlogPosting","dateModified":"2022-08-03T15:16:00+00:00","datePublished":"2022-08-03T15:16:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://jqlynchien713.github.io/2022/08/03/coscup4.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css">
  <link rel="shortcut icon" type="image/png" href="/favicon.png"><link type="application/atom+xml" rel="alternate" href="https://jqlynchien713.github.io/feed.xml" title="Jacquelyn's Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Jacquelyn&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/tags/">Tags</a><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <!-- enable latex -->
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Deploy Rails with Docker Swarm (4) - Gitlab Runner è‡ªå‹•åŒ–éƒ¨ç½²</h1>
    <p class="post-meta">
    <time class="dt-published" datetime="2022-08-03T15:16:00+00:00" itemprop="datePublished">Aug 3, 2022
      | ğŸ‘€
      <span class="reading-time" title="Estimated read time">
        
        
                                 8 mins
                                 
      </span>
    </time>
    |
    
      <span class="tag">update</span>
    
      <span class="tag">COSCUP</span>
    
      <span class="tag">docker-swarm</span>
    
      <span class="tag">traefik</span>
    
      <span class="tag">deploy</span>
    </p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div class="sidebar"><ul><li><a href="#è‡ªå‹•åŒ–éƒ¨ç½²-with-gitlab-runner">è‡ªå‹•åŒ–éƒ¨ç½² with Gitlab Runner</a><ul><li><a href="#registration">Registration</a></li><li><a href="#gitlab-ciyml">.gitlab-ci.yml</a></li><li><a href="#ec2-prerequisites">EC2 Prerequisites</a></li></ul></li><li><a href="#æœ€å¾Œå°±æ˜¯æŠŠ-app-æ¨ä¸Š-gitlab-é€²è¡Œéƒ¨ç½²ã„Œ">æœ€å¾Œå°±æ˜¯æŠŠ App æ¨ä¸Š GitLab é€²è¡Œéƒ¨ç½²ã„Œï¼ï¼ï¼</a><ul><li><a href="#worker-node-åŠ å…¥-docker-swarm">Worker Node åŠ å…¥ Docker Swarm</a></li></ul></li></ul></div>
    <h2 id="è‡ªå‹•åŒ–éƒ¨ç½²-with-gitlab-runner">è‡ªå‹•åŒ–éƒ¨ç½² with Gitlab Runner</h2>

<h3 id="registration">Registration</h3>

<p>é€²å…¥ä¸Šä¸€ç¯‡é–‹å¥½çš„ Manager EC2ï¼Œä¸¦ä¸”æ­¤æ™‚çš„ EC2 æ‡‰è©²å·²ç¶“å®‰è£å¥½ Gitlab Runnerï¼Œé€™æ™‚å€™å¯ä»¥ç›´æ¥è¨»å†Šæˆ‘å€‘çš„ Runnerï¼š<code class="language-plaintext highlighter-rouge">sudo gitlab-runner register</code>ï¼Œä¸‹å¥½æŒ‡ä»¤å¾Œä¸€å…±æœƒå•ä¸ƒå€‹å•é¡Œï¼š</p>

<ul>
  <li>Gitlab instance URL</li>
  <li>Registration Code
    <ul>
      <li>å‰å…©å€‹å•é¡Œå¯ä»¥é€²å…¥åˆ° Gitlab project &gt; Settings &gt; CI/CD &gt; Runner å»æŸ¥çœ‹è¨­å®šç´°ç¯€ï¼Œå¦‚é™„åœ–çš„å·¦å´</li>
    </ul>
  </li>
  <li>Description for runner: docker
    <ul>
      <li>é™„åœ–å³å´ç™½åº•é»‘å­—çš„éƒ¨åˆ†</li>
    </ul>
  </li>
  <li>Tags for runner(comma seperated): prod
    <ul>
      <li>é™„åœ–è—åº•éƒ¨åˆ†ï¼Œä¸”é€™å€‹ tag æ˜¯åœ¨<strong>å¾ŒçºŒæŒ‡å®š job è¦å“ªå€‹ runner åŸ·è¡Œçš„ä¾æ“š</strong></li>
    </ul>
  </li>
  <li>Optional maintenance note for runner: (optional)</li>
  <li>Enter the executor: docker</li>
  <li>Default Docker image: <code class="language-plaintext highlighter-rouge">tiangolo/docker-with-compose</code>
    <ul>
      <li>å¾ŒçºŒçš„ job éœ€è¦ compose å¹«æˆ‘å€‘ build imageï¼Œå› æ­¤éœ€è¦æŒ‡å®šé€™å€‹ image</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/img/runner.jpg" alt="/assets/img/runner.jpg" /></p>

<h3 id="gitlab-ciyml">.gitlab-ci.yml</h3>

<p>é€™é‚Šä¸»è¦ä¹Ÿæ˜¯åƒè€ƒ <a href="https://dockerswarm.rocks/gitlab-ci/">dockerswarm.rocks</a> çš„ç¯„ä¾‹ï¼Œä»¥ä¸‹ç°¡å–®ä»‹ç´¹ä¸€ä¸‹ä»–çš„è¨­å®šå…§å®¹ï¼š</p>

<ul>
  <li>Stage: åˆ†ç‚º build èˆ‡ deploy
    <ul>
      <li>Build: <code class="language-plaintext highlighter-rouge">docker-compose build --build-arg RAILS_MASTER_KEY=$RAILS_MASTER_KEY</code>
  å–®ç´”åªæœ‰ build imageï¼Œä½†å› ç‚ºæˆ‘çš„ Dockerfile åŒ…å«äº† Asset Precompileï¼Œå› æ­¤éœ€è¦å¸¶å…¥ <code class="language-plaintext highlighter-rouge">RAILS_MASTER_KEY</code> åšç‚ºåƒæ•¸</li>
      <li>Deploy: <code class="language-plaintext highlighter-rouge">docker stack deploy -c docker-compose.yml [stack name]</code></li>
    </ul>
  </li>
  <li>Only: æŒ‡å®šç™¼ç”Ÿæ–¼ main branch</li>
  <li>Tags: ç”¨æ–¼æŒ‡å®šåŸ·è¡Œçš„ runner</li>
</ul>

<h3 id="ec2-prerequisites">EC2 Prerequisites</h3>

<p>å› ç‚º Traefik èˆ‡ Rails App ç‚ºç¨ç«‹çš„å…©å€‹ Stackï¼Œç‚ºäº†ç°¡åŒ–é–‹ç™¼æµç¨‹ï¼Œé€™é‚Šé¸æ“‡æ‰‹å‹•é€²å…¥ EC2 éƒ¨ç½² Traefik</p>

<blockquote>
  <p>åŸæœ¬æ˜¯å¦å¤–é–‹ä¸€å€‹ traefik åˆ†æ”¯åš Traefik éƒ¨ç½²ï¼ˆä¸¦ä¸”æŒ‡å®š Traefik éƒ¨ç½²çš„ job åªç™¼ç”Ÿåœ¨è©²åˆ†æ”¯ã€åªæœƒç™¼ç”Ÿä¸€æ¬¡ï¼‰ï¼Œä½†åœ¨æ¼”è¬›æ™‚æœ‰äººåæ˜ ä¸ç¢ºå®š traefik åˆ†æ”¯éƒ¨ç½²å¾Œè¦ä¸è¦åˆåˆ° main åˆ†æ”¯ä¸Šã€git graph æœ‰é»ä¸æ˜ç¢ºï¼Œå› æ­¤æ”¹ç‚ºä»¥å…¬å¸å¯¦éš›éƒ¨ç½²çš„æµç¨‹åšä»‹ç´¹</p>

</blockquote>

<p>éƒ¨ç½²çš„æ­¥é©Ÿå°±åƒåœ¨å¯¦éš›éƒ¨ç½²æµç¨‹æåˆ°çš„åœ–è¡¨ä¸€æ¨£ï¼š</p>

<ol>
  <li>é–‹å•Ÿä¸€å€‹ swarmï¼š<code class="language-plaintext highlighter-rouge">docker swarm init --default-addr-pool 10.20.0.0/16</code>
    <ul>
      <li>å› ç‚º Docker é è¨­çš„ subnet range èˆ‡ EC2 ç›¸åŒï¼Œéƒ½æ˜¯ <code class="language-plaintext highlighter-rouge">10.0.0.1</code>ï¼Œå› æ­¤é€™é‚Šè¦ç‰¹åˆ¥æŒ‡å®šä¸ä¸€æ¨£çš„ç¯„åœï¼Œ Swarm æ‰é€£çš„åˆ°å¤–ç¶²</li>
    </ul>
  </li>
  <li>é–‹å•Ÿ traefik networkï¼š<code class="language-plaintext highlighter-rouge">docker network create --driver=overlay traefik-public</code></li>
  <li>å–å¾—ç¾åœ¨çš„ swarm manager node idï¼š<code class="language-plaintext highlighter-rouge">export NODE_ID=$(docker info -f '')</code></li>
  <li>æŒ‡å®š traefik æ¯æ¬¡éƒ½ deploy åœ¨åŒä¸€å€‹ node &amp; volume ä¸Šï¼š<code class="language-plaintext highlighter-rouge">docker node update --label-add traefik-public.traefik-public-certificates=true $NODE_ID</code></li>
  <li>éƒ¨ç½² traefikï¼š<code class="language-plaintext highlighter-rouge">docker stack deploy -c traefik.yml traefik</code></li>
</ol>

<h2 id="æœ€å¾Œå°±æ˜¯æŠŠ-app-æ¨ä¸Š-gitlab-é€²è¡Œéƒ¨ç½²ã„Œ">æœ€å¾Œå°±æ˜¯æŠŠ App æ¨ä¸Š GitLab é€²è¡Œéƒ¨ç½²ã„Œï¼ï¼ï¼</h2>

<h3 id="worker-node-åŠ å…¥-docker-swarm">Worker Node åŠ å…¥ Docker Swarm</h3>

<p>åˆ°é€™é‚Šè¨­å®šå®Œ Manager ç¯€é»å¾Œï¼Œæˆ‘å€‘å¯ä»¥å›å»é–‹ Worker Templateï¼ŒæŠŠåŠ å…¥ Swarm çš„æŒ‡ä»¤åŠ å›å»ï¼š</p>

<ol>
  <li>å…ˆåœ¨ Manager æ‰¾å›åŠ å…¥ Swarm çš„æŒ‡ä»¤ï¼š<code class="language-plaintext highlighter-rouge">docker swarm join-token worker</code></li>
  <li>
    <p>åœ¨ Worker Template çš„ User Data ä¸­åŠ å…¥å‰›å‰›æ‰¾å›çš„æŒ‡ä»¤ï¼Œæ–¼æ˜¯æœ€çµ‚çš„ User Data æœƒé•·ä¸‹é¢é€™æ¨£ï¼š</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c">#!/bin/bash</span>
 <span class="c"># Start docker daemon</span>
 <span class="nb">sudo </span>service docker start
 <span class="nb">sudo chown </span>ec2-user:docker /var/run/docker.sock

 <span class="c"># Join swarm</span>
 docker swarm <span class="nb">join</span> <span class="nt">--token</span> <span class="o">[</span>JOIN-TOKEN] <span class="o">[</span>IP-ADDRESS]:2377
</code></pre></div>    </div>
  </li>
</ol>

<hr />

<p>åˆ°é€™é‚Šä¸»è¦çš„æŠ€è¡“è¨­å®šéƒ½çµæŸäº†â€¦..çœŸçš„æ˜¯è¶…å¤šå…§å®¹è¦ä»‹ç´¹ï¼šï¼‰</p>

<p>ä¸‹ä¸€ç¯‡æœƒè£œå……ä¸€äº›ç›¸é—œçš„è­°é¡Œè¨è«–ï¼Œé‚„æœ‰é€™æ¬¡ COSCUP æ¼”è¬›çš„å¿ƒå¾—ï¼Œå¸Œæœ›æˆ‘ä¸è¦éš”å¤ªä¹…æ‰æŠŠæ–‡ç« ç”Ÿå‡ºä¾†ï¼šï¼‰</p>

  </div>

  
  
    <script src="https://utteranc.es/client.js"
            repo=jqlynchien713/jqlynchien713.github.io
            issue-term=pathname
            label=Comments
            theme=github-light
            crossorigin= "anonymous"
            async>
    </script>
  

<a class="u-url" href="/2022/08/03/coscup4.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Jacquelyn&#39;s Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Jacquelyn&#39;s Blog</li><li><a class="u-email" href="mailto:jqlynchien713@gmail.com">jqlynchien713@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-3"><ul class="social-media-list"><li><a href="https://github.com/jqlynchien713"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jqlynchien713</span></a></li></ul>
</div>

      <div class="footer-col footer-col-2">
        <p>Ê• â€¢á´¥â€¢Ê”</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
