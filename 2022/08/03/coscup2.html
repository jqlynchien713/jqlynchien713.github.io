<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Deploy Rails with Docker Swarm (2) - æµç¨‹ä»‹ç´¹èˆ‡è¨­å®š Traefik &amp; Rails | Jacquelynâ€™s Blog</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Deploy Rails with Docker Swarm (2) - æµç¨‹ä»‹ç´¹èˆ‡è¨­å®š Traefik &amp; Rails" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="æ¥ä¸‹ä¾†è®“æˆ‘å€‘é€²åˆ°å¯¦éš›æ“ä½œçš„éƒ¨åˆ†ï¼é€™ç¯‡ä¸»è¦æœƒå…ˆä»‹ç´¹ä¸€ä¸‹å¾ŒçºŒçš„æ–‡ç« æ¶æ§‹ï¼Œä¸»è¦æ˜¯åˆ†æˆä»¥ä¸‹ä¸‰å€‹éƒ¨åˆ†ï¼š è¨­å®š Rails &amp; Traefik è¨­å®š AWS è¨­å®š Gitlab runner è‡ªå‹•åŒ–éƒ¨ç½² å› ç‚ºç¯‡å¹…çš„é—œä¿‚ï¼Œé€™ç¯‡æ–‡æœƒå…ˆä»‹ç´¹ç¬¬ä¸€éƒ¨åˆ†ï¼Œå¾Œé¢å…©éƒ¨åˆ†ä¹Ÿæœƒå†å¦å¤–ç™¼æ–°çš„æ–‡ç« ï¼ˆä¸çŸ¥ä¸è¦ºå°±è®Šæˆé€£è¼‰ç³»åˆ—äº†ğŸ« ï¼‰ éƒ¨ç½²æµç¨‹ å¯¦ä½œæµç¨‹ æœ¬åœ°ç«¯é€²è¡Œéƒ¨ç½² é–‹å•Ÿ rails production server ç¢ºèªæœ¬åœ°ç«¯ Docker compose build/up çš†å¯é †åˆ©åŸ·è¡Œ æ‰‹å‹• ssh é€²å…¥ EC2 éƒ¨ç½² å°‡ Traefik èˆ‡ Docker Swarm ç›´æ¥éƒ¨ç½²åœ¨ EC2 è£¡ï¼Œè©³ç´°çš„æµç¨‹æœƒåœ¨ä¸‹ä¸€éƒ¨åˆ†çš„åœ–è£¡èªªæ˜ åˆ©ç”¨ Gitlab runner è‡ªå‹•éƒ¨ç½² å°‡å‰ä¸€æ­¥çš„æ‰€æœ‰è¨­å®šã€éƒ¨ç½²æŒ‡ä»¤è‡ªå‹•åŒ– å¯¦éš›éƒ¨ç½²æµç¨‹ é€™é‚Šè¦è¬›çš„æ˜¯å®Œæ•´çš„éƒ¨ç½²æµç¨‹ä¸ŠåŸ·è¡Œäº†å“ªäº›è¨­å®šï¼Œå¾ŒçºŒçš„ä»‹ç´¹ä¹Ÿæœƒå°‡ä»¥ä¸‹å››é»çš„é †åºä½œç‚ºä¸»è¦æ¶æ§‹é€²è¡Œä»‹ç´¹ï¼š è¨­å®š Traefik Serviceï¼šä¾ç…§ä¸Šä¸€ç¯‡æåˆ°çš„ Traefik ç‰¹æ€§ï¼Œå…ˆè¨­å®š reverse proxyï¼ˆå†æŠŠ app æ›ä¸Šå»ï¼‰ è¨­å®š Rails App Serviceï¼šåŸºæœ¬ä¸Šç­‰æ–¼åœ¨æœ¬åœ°ç«¯éƒ¨ç½²çš„æ­¥é©Ÿï¼Œä¹Ÿå°±æ˜¯ç¢ºèª Docker compose build/up å¯ä»¥é †åˆ©é–‹å•Ÿæœå‹™ è¨­å®š EC2 èˆ‡ Route53ï¼šåœ¨ç¢ºèªè¨­å®šæª”å¤§è‡´å®Œæˆå¾Œï¼Œè¨­å®šä¸¦é–‹å•Ÿ EC2ï¼Œå°‡å‰›å‰›è¨­å®šçš„æœå‹™éƒ¨ç½²ä¸Šå» è‡ªå‹•åŒ–éƒ¨ç½² with Gitlab Runnerï¼šè¨»å†Šä¸¦æ’°å¯« runner çš„è…³æœ¬ï¼ˆ.gitlab-ci.ymlï¼‰ï¼Œè€Œè…³æœ¬çš„å…§å®¹å‰‡æ˜¯å¯¦éš›åœ¨éƒ¨ç½²æ™‚éœ€è¦å°æ©Ÿå™¨æœ¬èº«ä¸‹çš„è¨­å®šï¼Œå…§å®¹å¦‚ä¸‹ï¼š é–‹å•Ÿ Docker Swarm å‰µå»º traefik-public çš„å…¬é–‹ Networkï¼Œè®“ App service å¯ä»¥ä½¿ç”¨ traefik ä¾†åš reverse proxy æŒ‡å®šæ¯æ¬¡ Traefik æ›´æ–°æ™‚å›ºå®šä½¿ç”¨åŒå€‹ç¯€é» ä½¿ç”¨ docker stack éƒ¨ç½² Traefik éƒ¨ç½² Rails App å¯¦éš›éƒ¨ç½² Docker Swarm çš„æµç¨‹ Rails &amp; Traefik Service Traefik Service Settings Traefik èˆ‡ Rails App å…¶å¯¦æ˜¯å…©å€‹ç¨ç«‹çš„æœå‹™ï¼Œå› æ­¤é€™é‚Šæœƒå°‡ Traefik èˆ‡ Rails App çš„è¨­å®šæª”åˆ†é–‹ï¼Œä¹Ÿå°±æ˜¯ Traefik æœƒæœ‰ä¸€å€‹ traefik.yml ç”¨æ–¼éƒ¨ç½² traefik stackï¼Œè€Œ Rails App å‰‡æ˜¯ä½¿ç”¨åŸå§‹çš„ docker-compose.yml å»éƒ¨ç½² task stackï¼ˆé€™é‚Šçš„ Rails App å«åš Task-Managerï¼Œå› æ­¤ stack name å–ç‚º taskï¼‰ é¦–å…ˆåœ¨ traefik.yml ä¸­çš„è¨­å®šæœƒèˆ‡ä¸€èˆ¬çš„ docker compose file æ¶æ§‹ç›¸åŒï¼Œé€™é‚Šæˆ‘æ˜¯åƒè€ƒ dockerswarm.rocks è£¡æä¾›çš„ Traefik è¨­å®šç¯„ä¾‹é€²è¡Œè¨­å®šï¼Œä¸éæˆ‘å€‘æœƒéœ€è¦ç‰¹åˆ¥è¨­å®šä»¥ä¸‹å¹¾é»ï¼ˆé€™éƒ¨åˆ†ä¹Ÿå¯ä»¥ç›´æ¥åƒè€ƒæˆ‘å¯«å¥½çš„è¨­å®šæª” traefik.yml / Task-Manager-Ruby Â· GitLabï¼‰ï¼š Networkï¼šéœ€è¦æ–°å¢ä¸€å€‹å« traefik-public çš„ç¶²è·¯ï¼Œä¸¦ä¸”è¨­å®šç‚º externalï¼Œå¥½è®“ Rails App å¯ä»¥é€éé€™å€‹ç¶²è·¯èˆ‡ Traefik æºé€š Volumesï¼šæ–°å¢ä¸€å€‹ traefik-public-certificate çš„ volumeï¼Œç”¨æ–¼å­˜æ”¾å·²ç¶“ç”³è«‹éçš„æ†‘è­‰ Serviceï¼šåˆ†ç‚ºå…©éƒ¨åˆ†éœ€è¦æ³¨æ„ï¼ŒCommand èˆ‡ Deploy Label Commandï¼šTraefik çš„åŸºæœ¬è¨­å®šï¼Œéœ€è¦æŒ‡å®š Docker providerã€é–‹å•Ÿ Swarm modeï¼Œæ†‘è­‰çš„ç”³è«‹ã€å„²å­˜ä½ç½®ï¼Œä»¥åŠ DNS Challenge ç­‰ç­‰ Deploy Labelï¼šç‚ºäº†è¦é–‹å•Ÿ Traefik Dashboard è€Œè¨­å®šçš„ reverse proxy routingï¼Œä¸»è¦æœ‰ä¸‹åˆ—å¹¾é»è¦è¨­å®šï¼š é–‹å•Ÿ Traefik ä¸¦åŠ å…¥ traefik-public Network Dashboard ç™»å…¥å¸³å¯† Http/Https host Redirect middlewareï¼šç•¶ç”¨æˆ¶ä½¿ç”¨ Http ç™¼é€è«‹æ±‚ï¼Œè‡ªå‹•è½‰ç‚º Https Load balancer portï¼šç•¶æœ‰ç›®çš„åœ°æ˜¯ host çš„è«‹æ±‚ï¼ŒTraefik éœ€è¦å°‡å…¶å°å‘çš„ port è¨­å®š wildcard é©—è­‰éçš„ domain åˆ°é€™ä¸€æ­¥åŸºæœ¬ä¸Š Traefik æœ¬èº«å·²ç¶“è¨­å®šå®Œç•¢ï¼Œå¯ä»¥å…ˆé€² EC2 è£¡é–‹å¥½ Traefik stack ä¾†æª¢æŸ¥æ˜¯å¦èƒ½æ­£ç¢ºé–‹å•Ÿã€‚ Rails App(Application) Service æ¥ä¸‹ä¾†è¦èªªæ˜çš„æ˜¯ Rails App è¦æ€éº¼è¨­å®šï¼Œç•¶ç„¶é€™å€‹éƒ¨ç½²æ¶æ§‹ä¸åªé™å®šæ–¼ Rails Appï¼Œä¸éé€™å€‹æ­¥é©Ÿå¯èƒ½è¦ä¾ç…§ä½¿ç”¨çš„èªè¨€æˆ–æ¡†æ¶è€Œæ”¹å‹•ã€‚ é¦–å…ˆå¿…é ˆç”Ÿæˆä¸€çµ„ RAILS_MASTER_KEYï¼Œå› ç‚º Rails åœ¨ Production ç’°å¢ƒä¸­éœ€è¦æœ‰ RAILS_MASTER_KEY æ‰èƒ½å•Ÿå‹•ï¼Œç¢ºå®š production server å¯æ­£å¸¸é–‹å•Ÿå¾Œï¼Œå¯ä»¥ä¾†æº–å‚™æˆ‘å€‘çš„ Dockerfile èˆ‡ Docker-compose file ä¾†é€²è¡Œ task stack çš„è¨­å®š Dockerfile é€™éƒ¨åˆ†æˆ‘ä½¿ç”¨çš„æ˜¯ https://github.com/elct9620/boxing é€™å€‹ gem ä¾†å¹«æˆ‘è‡ªå‹•ç”Ÿæˆï¼Œä»–æœƒä¾æ“šå°ˆæ¡ˆä¸­çš„ Gemfile ä»¥åŠ boxing æœ¬èº«çš„è¨­å®šæª”ï¼ˆconfig/boxing.rbï¼‰ä¾†è‡ªå‹•ç”Ÿæˆ Dockerfileã€‚å¦å¤–é€™å€‹ Gem çš„ä½œè€…ï¼ˆä¹Ÿå°±æ˜¯è’¼æ™‚å¤§å¤§ï¼‰æœ‰ç‰¹åˆ¥ç ”ç©¶å¦‚ä½•ç”Ÿæˆæœ€å°åŒ–çš„ Docker imageï¼Œå› æ­¤è‡ªå‹•ç”Ÿæˆçš„æ˜ åƒæª”å¤§ç´„åªæœƒæœ‰ï¼ˆæ“šä»–æœ¬äººæ‰€èªªï¼‰ 100 MBï¼Œä¸‹é¢åˆ—å‡ºå¯ä»¥å¦å¤–è¨­å®šçš„é¸é …ï¼ˆç²—é«”ç‚ºæˆ‘é€™æ¬¡æœ‰æ¡ç”¨çš„è¨­å®šï¼‰ï¼š Source Code Root Ignore File Extra Packages: Node.js &amp; Python Revision Information Sentry Support Asset Precompile: True Health Check è£œå……ï¼šOpenBox - Auto generate entrypoint settingsï¼Œå¦‚æœå°‡ Boxing èˆ‡ OpenBox åŒæ™‚æ¡ç”¨çš„è©±ï¼ŒBoxing ç”Ÿæˆçš„ Dockerfile æœƒå°‡ Entrypoint è‡ªå‹•æŒ‡å®šç‚º OpenBox ç”Ÿæˆçš„ Entrypoint Docker-compose file èˆ‡åœ¨æœ¬åœ°ç«¯è¨­å®šçš„ docker-compose.yml åŸºæœ¬ä¸Šä¸€æ¨£ï¼Œæˆ‘åœ¨é€™é‚Šæ˜¯åªæœ‰è¨­å®šä¸‰å€‹ service(app/redis/postgres)ï¼ŒNetwork åªæœ‰ net è®“ä¸‰å€‹ service å…±äº«ï¼Œä¸¦åŠ ä¸Šä¸‹é¢å…©é …è¨­å®šï¼š RAILS_MASTER_KEYï¼šå‰›å‰›ç”Ÿæˆçš„ RAILS_MASTER_KEY å¯ä»¥å…ˆæ”¾åˆ° Gitlab ä¸­è¨­å®šç‚º CI variableï¼ˆå¦‚æœè¦è·‘æœ¬åœ°æ¸¬è©¦çš„è©±å¯ä»¥å°‡ RAILS_MASTER_KEY æ”¾åœ¨ .envã€æˆ–è€…è¨­å®šç‚º app service çš„ environment varï¼Œå¯ä»¥åƒè€ƒæœ¬åœ°ç«¯çš„ docker-compose Line 55ï¼‰ DATABSE_URLï¼šåœ¨ app service çš„ environment variable è¦ç‰¹åˆ¥æŒ‡å®šè³‡æ–™åº«çš„è·¯å¾‘ï¼Œæ‰èƒ½æ­£ç¢ºé€£ç·šåˆ° postgres serviceï¼Œä¸¦ä¸”è¦æ³¨æ„æ ¼å¼ç‚º postgresql://[user[:password]@][netloc][:port][/dbname][?param1=value1&amp;...] åšå®ŒåŸºæœ¬çš„è¨­å®šå¾Œï¼Œåœ¨æŠŠ Traefik ç›¸é—œçš„ routing rules åŠ åˆ° deploy label ä¸Šã€‚é€™éƒ¨åˆ†å’Œåœ¨è¨­å®š Traefik çš„ deploy labels ä¸€æ¨£ï¼Œè¨­å®šå®Œç•¢å¾Œæœƒåƒé€™å€‹æª”æ¡ˆé¡ä¼¼ã€‚ è£œå…… Load Balancer Port è¨­å®š å‡è¨­ä»Šå¤©æˆ‘å€‘çš„ domain æ˜¯ abc.dev æœ‰ç”¨æˆ¶è«‹æ±‚äº† traefik.abc.dev(aka æˆ‘å€‘çš„ host name)ï¼Œè€Œæˆ‘å€‘çš„ Traefik Dashboard é–‹åœ¨ 8080 portï¼Œå‰‡ Traefik æœƒå°‡é€™å€‹ request å°å‘ 8080 Wildcard ç›¸é—œçŸ¥è­˜ ç›¸é—œè¨­å®šçš„è£œå……çŸ¥è­˜ï¼Œé€™é‚Šéœ€è¦åƒè€ƒæˆ‘å·²ç¶“å¯«å¥½çš„è¨­å®šæª” Wildcardï¼šACME é©—è­‰æ–¹å¼ - Letâ€™s Encrypt - å…è²»çš„ SSL/TLS æ†‘è­‰ (letsencrypt.org) å¯ä»¥ç›´æ¥ç”³è«‹æŸå€‹ domain çš„æ†‘è­‰ï¼Œè®“æ•´å€‹ domain ä¸‹çš„æ‰€æœ‰ host éƒ½å¯ä»¥ä½¿ç”¨åŒä¸€å¼µæ†‘è­‰ï¼ˆdomain.sans éƒ¨åˆ†ï¼‰ï¼Œä¸éœ€ç‰¹åœ°ç‚ºæ‰€æœ‰ host å€‹åˆ¥ç”³è«‹æ†‘è­‰ å±¬æ–¼ Letâ€™s Encrypt ç™¼æ”¾çš„å…¶ä¸­ä¸€ç¨®æ†‘è­‰æ ¼å¼ çµ¦äºˆ route53 æ¬Šé™çš„åŸå›  å› ç‚ºè¨­å®š DNS challenge èˆ‡ DNS Challenge Provider ç‚º route53 DNS challengeï¼šéœ€è¦æœ‰ route53 çš„æ¬Šé™æ‰èƒ½å‹•æ…‹é©—è­‰ *.domain ä¸‹çš„æ‰€æœ‰ host Route53 æä¾›è‡ªå‹•æ›´æ–°æ†‘è­‰çš„ API ç¬¬ä¸€éƒ¨åˆ†å°±åˆ°é€™é‚ŠçµæŸï¼Œå…¶å¯¦åšåˆ°é€™å€‹æ­¥é©Ÿæ‡‰è©²å°±èƒ½åœ¨æœ¬åœ°ç«¯é€²è¡Œéƒ¨ç½²ï¼ˆåƒ…é™ Rails éƒ¨åˆ†ï¼‰ å¸Œæœ›å¤§å®¶èˆ‡ Docker å¯ä»¥å¥½å¥½ç›¸è™•ï¼Œä»–çœŸçš„æ˜¯å€‹å¥½ç”¨ã„‰é…·æ±è¥¿ï¼ˆ" />
<meta property="og:description" content="æ¥ä¸‹ä¾†è®“æˆ‘å€‘é€²åˆ°å¯¦éš›æ“ä½œçš„éƒ¨åˆ†ï¼é€™ç¯‡ä¸»è¦æœƒå…ˆä»‹ç´¹ä¸€ä¸‹å¾ŒçºŒçš„æ–‡ç« æ¶æ§‹ï¼Œä¸»è¦æ˜¯åˆ†æˆä»¥ä¸‹ä¸‰å€‹éƒ¨åˆ†ï¼š è¨­å®š Rails &amp; Traefik è¨­å®š AWS è¨­å®š Gitlab runner è‡ªå‹•åŒ–éƒ¨ç½² å› ç‚ºç¯‡å¹…çš„é—œä¿‚ï¼Œé€™ç¯‡æ–‡æœƒå…ˆä»‹ç´¹ç¬¬ä¸€éƒ¨åˆ†ï¼Œå¾Œé¢å…©éƒ¨åˆ†ä¹Ÿæœƒå†å¦å¤–ç™¼æ–°çš„æ–‡ç« ï¼ˆä¸çŸ¥ä¸è¦ºå°±è®Šæˆé€£è¼‰ç³»åˆ—äº†ğŸ« ï¼‰ éƒ¨ç½²æµç¨‹ å¯¦ä½œæµç¨‹ æœ¬åœ°ç«¯é€²è¡Œéƒ¨ç½² é–‹å•Ÿ rails production server ç¢ºèªæœ¬åœ°ç«¯ Docker compose build/up çš†å¯é †åˆ©åŸ·è¡Œ æ‰‹å‹• ssh é€²å…¥ EC2 éƒ¨ç½² å°‡ Traefik èˆ‡ Docker Swarm ç›´æ¥éƒ¨ç½²åœ¨ EC2 è£¡ï¼Œè©³ç´°çš„æµç¨‹æœƒåœ¨ä¸‹ä¸€éƒ¨åˆ†çš„åœ–è£¡èªªæ˜ åˆ©ç”¨ Gitlab runner è‡ªå‹•éƒ¨ç½² å°‡å‰ä¸€æ­¥çš„æ‰€æœ‰è¨­å®šã€éƒ¨ç½²æŒ‡ä»¤è‡ªå‹•åŒ– å¯¦éš›éƒ¨ç½²æµç¨‹ é€™é‚Šè¦è¬›çš„æ˜¯å®Œæ•´çš„éƒ¨ç½²æµç¨‹ä¸ŠåŸ·è¡Œäº†å“ªäº›è¨­å®šï¼Œå¾ŒçºŒçš„ä»‹ç´¹ä¹Ÿæœƒå°‡ä»¥ä¸‹å››é»çš„é †åºä½œç‚ºä¸»è¦æ¶æ§‹é€²è¡Œä»‹ç´¹ï¼š è¨­å®š Traefik Serviceï¼šä¾ç…§ä¸Šä¸€ç¯‡æåˆ°çš„ Traefik ç‰¹æ€§ï¼Œå…ˆè¨­å®š reverse proxyï¼ˆå†æŠŠ app æ›ä¸Šå»ï¼‰ è¨­å®š Rails App Serviceï¼šåŸºæœ¬ä¸Šç­‰æ–¼åœ¨æœ¬åœ°ç«¯éƒ¨ç½²çš„æ­¥é©Ÿï¼Œä¹Ÿå°±æ˜¯ç¢ºèª Docker compose build/up å¯ä»¥é †åˆ©é–‹å•Ÿæœå‹™ è¨­å®š EC2 èˆ‡ Route53ï¼šåœ¨ç¢ºèªè¨­å®šæª”å¤§è‡´å®Œæˆå¾Œï¼Œè¨­å®šä¸¦é–‹å•Ÿ EC2ï¼Œå°‡å‰›å‰›è¨­å®šçš„æœå‹™éƒ¨ç½²ä¸Šå» è‡ªå‹•åŒ–éƒ¨ç½² with Gitlab Runnerï¼šè¨»å†Šä¸¦æ’°å¯« runner çš„è…³æœ¬ï¼ˆ.gitlab-ci.ymlï¼‰ï¼Œè€Œè…³æœ¬çš„å…§å®¹å‰‡æ˜¯å¯¦éš›åœ¨éƒ¨ç½²æ™‚éœ€è¦å°æ©Ÿå™¨æœ¬èº«ä¸‹çš„è¨­å®šï¼Œå…§å®¹å¦‚ä¸‹ï¼š é–‹å•Ÿ Docker Swarm å‰µå»º traefik-public çš„å…¬é–‹ Networkï¼Œè®“ App service å¯ä»¥ä½¿ç”¨ traefik ä¾†åš reverse proxy æŒ‡å®šæ¯æ¬¡ Traefik æ›´æ–°æ™‚å›ºå®šä½¿ç”¨åŒå€‹ç¯€é» ä½¿ç”¨ docker stack éƒ¨ç½² Traefik éƒ¨ç½² Rails App å¯¦éš›éƒ¨ç½² Docker Swarm çš„æµç¨‹ Rails &amp; Traefik Service Traefik Service Settings Traefik èˆ‡ Rails App å…¶å¯¦æ˜¯å…©å€‹ç¨ç«‹çš„æœå‹™ï¼Œå› æ­¤é€™é‚Šæœƒå°‡ Traefik èˆ‡ Rails App çš„è¨­å®šæª”åˆ†é–‹ï¼Œä¹Ÿå°±æ˜¯ Traefik æœƒæœ‰ä¸€å€‹ traefik.yml ç”¨æ–¼éƒ¨ç½² traefik stackï¼Œè€Œ Rails App å‰‡æ˜¯ä½¿ç”¨åŸå§‹çš„ docker-compose.yml å»éƒ¨ç½² task stackï¼ˆé€™é‚Šçš„ Rails App å«åš Task-Managerï¼Œå› æ­¤ stack name å–ç‚º taskï¼‰ é¦–å…ˆåœ¨ traefik.yml ä¸­çš„è¨­å®šæœƒèˆ‡ä¸€èˆ¬çš„ docker compose file æ¶æ§‹ç›¸åŒï¼Œé€™é‚Šæˆ‘æ˜¯åƒè€ƒ dockerswarm.rocks è£¡æä¾›çš„ Traefik è¨­å®šç¯„ä¾‹é€²è¡Œè¨­å®šï¼Œä¸éæˆ‘å€‘æœƒéœ€è¦ç‰¹åˆ¥è¨­å®šä»¥ä¸‹å¹¾é»ï¼ˆé€™éƒ¨åˆ†ä¹Ÿå¯ä»¥ç›´æ¥åƒè€ƒæˆ‘å¯«å¥½çš„è¨­å®šæª” traefik.yml / Task-Manager-Ruby Â· GitLabï¼‰ï¼š Networkï¼šéœ€è¦æ–°å¢ä¸€å€‹å« traefik-public çš„ç¶²è·¯ï¼Œä¸¦ä¸”è¨­å®šç‚º externalï¼Œå¥½è®“ Rails App å¯ä»¥é€éé€™å€‹ç¶²è·¯èˆ‡ Traefik æºé€š Volumesï¼šæ–°å¢ä¸€å€‹ traefik-public-certificate çš„ volumeï¼Œç”¨æ–¼å­˜æ”¾å·²ç¶“ç”³è«‹éçš„æ†‘è­‰ Serviceï¼šåˆ†ç‚ºå…©éƒ¨åˆ†éœ€è¦æ³¨æ„ï¼ŒCommand èˆ‡ Deploy Label Commandï¼šTraefik çš„åŸºæœ¬è¨­å®šï¼Œéœ€è¦æŒ‡å®š Docker providerã€é–‹å•Ÿ Swarm modeï¼Œæ†‘è­‰çš„ç”³è«‹ã€å„²å­˜ä½ç½®ï¼Œä»¥åŠ DNS Challenge ç­‰ç­‰ Deploy Labelï¼šç‚ºäº†è¦é–‹å•Ÿ Traefik Dashboard è€Œè¨­å®šçš„ reverse proxy routingï¼Œä¸»è¦æœ‰ä¸‹åˆ—å¹¾é»è¦è¨­å®šï¼š é–‹å•Ÿ Traefik ä¸¦åŠ å…¥ traefik-public Network Dashboard ç™»å…¥å¸³å¯† Http/Https host Redirect middlewareï¼šç•¶ç”¨æˆ¶ä½¿ç”¨ Http ç™¼é€è«‹æ±‚ï¼Œè‡ªå‹•è½‰ç‚º Https Load balancer portï¼šç•¶æœ‰ç›®çš„åœ°æ˜¯ host çš„è«‹æ±‚ï¼ŒTraefik éœ€è¦å°‡å…¶å°å‘çš„ port è¨­å®š wildcard é©—è­‰éçš„ domain åˆ°é€™ä¸€æ­¥åŸºæœ¬ä¸Š Traefik æœ¬èº«å·²ç¶“è¨­å®šå®Œç•¢ï¼Œå¯ä»¥å…ˆé€² EC2 è£¡é–‹å¥½ Traefik stack ä¾†æª¢æŸ¥æ˜¯å¦èƒ½æ­£ç¢ºé–‹å•Ÿã€‚ Rails App(Application) Service æ¥ä¸‹ä¾†è¦èªªæ˜çš„æ˜¯ Rails App è¦æ€éº¼è¨­å®šï¼Œç•¶ç„¶é€™å€‹éƒ¨ç½²æ¶æ§‹ä¸åªé™å®šæ–¼ Rails Appï¼Œä¸éé€™å€‹æ­¥é©Ÿå¯èƒ½è¦ä¾ç…§ä½¿ç”¨çš„èªè¨€æˆ–æ¡†æ¶è€Œæ”¹å‹•ã€‚ é¦–å…ˆå¿…é ˆç”Ÿæˆä¸€çµ„ RAILS_MASTER_KEYï¼Œå› ç‚º Rails åœ¨ Production ç’°å¢ƒä¸­éœ€è¦æœ‰ RAILS_MASTER_KEY æ‰èƒ½å•Ÿå‹•ï¼Œç¢ºå®š production server å¯æ­£å¸¸é–‹å•Ÿå¾Œï¼Œå¯ä»¥ä¾†æº–å‚™æˆ‘å€‘çš„ Dockerfile èˆ‡ Docker-compose file ä¾†é€²è¡Œ task stack çš„è¨­å®š Dockerfile é€™éƒ¨åˆ†æˆ‘ä½¿ç”¨çš„æ˜¯ https://github.com/elct9620/boxing é€™å€‹ gem ä¾†å¹«æˆ‘è‡ªå‹•ç”Ÿæˆï¼Œä»–æœƒä¾æ“šå°ˆæ¡ˆä¸­çš„ Gemfile ä»¥åŠ boxing æœ¬èº«çš„è¨­å®šæª”ï¼ˆconfig/boxing.rbï¼‰ä¾†è‡ªå‹•ç”Ÿæˆ Dockerfileã€‚å¦å¤–é€™å€‹ Gem çš„ä½œè€…ï¼ˆä¹Ÿå°±æ˜¯è’¼æ™‚å¤§å¤§ï¼‰æœ‰ç‰¹åˆ¥ç ”ç©¶å¦‚ä½•ç”Ÿæˆæœ€å°åŒ–çš„ Docker imageï¼Œå› æ­¤è‡ªå‹•ç”Ÿæˆçš„æ˜ åƒæª”å¤§ç´„åªæœƒæœ‰ï¼ˆæ“šä»–æœ¬äººæ‰€èªªï¼‰ 100 MBï¼Œä¸‹é¢åˆ—å‡ºå¯ä»¥å¦å¤–è¨­å®šçš„é¸é …ï¼ˆç²—é«”ç‚ºæˆ‘é€™æ¬¡æœ‰æ¡ç”¨çš„è¨­å®šï¼‰ï¼š Source Code Root Ignore File Extra Packages: Node.js &amp; Python Revision Information Sentry Support Asset Precompile: True Health Check è£œå……ï¼šOpenBox - Auto generate entrypoint settingsï¼Œå¦‚æœå°‡ Boxing èˆ‡ OpenBox åŒæ™‚æ¡ç”¨çš„è©±ï¼ŒBoxing ç”Ÿæˆçš„ Dockerfile æœƒå°‡ Entrypoint è‡ªå‹•æŒ‡å®šç‚º OpenBox ç”Ÿæˆçš„ Entrypoint Docker-compose file èˆ‡åœ¨æœ¬åœ°ç«¯è¨­å®šçš„ docker-compose.yml åŸºæœ¬ä¸Šä¸€æ¨£ï¼Œæˆ‘åœ¨é€™é‚Šæ˜¯åªæœ‰è¨­å®šä¸‰å€‹ service(app/redis/postgres)ï¼ŒNetwork åªæœ‰ net è®“ä¸‰å€‹ service å…±äº«ï¼Œä¸¦åŠ ä¸Šä¸‹é¢å…©é …è¨­å®šï¼š RAILS_MASTER_KEYï¼šå‰›å‰›ç”Ÿæˆçš„ RAILS_MASTER_KEY å¯ä»¥å…ˆæ”¾åˆ° Gitlab ä¸­è¨­å®šç‚º CI variableï¼ˆå¦‚æœè¦è·‘æœ¬åœ°æ¸¬è©¦çš„è©±å¯ä»¥å°‡ RAILS_MASTER_KEY æ”¾åœ¨ .envã€æˆ–è€…è¨­å®šç‚º app service çš„ environment varï¼Œå¯ä»¥åƒè€ƒæœ¬åœ°ç«¯çš„ docker-compose Line 55ï¼‰ DATABSE_URLï¼šåœ¨ app service çš„ environment variable è¦ç‰¹åˆ¥æŒ‡å®šè³‡æ–™åº«çš„è·¯å¾‘ï¼Œæ‰èƒ½æ­£ç¢ºé€£ç·šåˆ° postgres serviceï¼Œä¸¦ä¸”è¦æ³¨æ„æ ¼å¼ç‚º postgresql://[user[:password]@][netloc][:port][/dbname][?param1=value1&amp;...] åšå®ŒåŸºæœ¬çš„è¨­å®šå¾Œï¼Œåœ¨æŠŠ Traefik ç›¸é—œçš„ routing rules åŠ åˆ° deploy label ä¸Šã€‚é€™éƒ¨åˆ†å’Œåœ¨è¨­å®š Traefik çš„ deploy labels ä¸€æ¨£ï¼Œè¨­å®šå®Œç•¢å¾Œæœƒåƒé€™å€‹æª”æ¡ˆé¡ä¼¼ã€‚ è£œå…… Load Balancer Port è¨­å®š å‡è¨­ä»Šå¤©æˆ‘å€‘çš„ domain æ˜¯ abc.dev æœ‰ç”¨æˆ¶è«‹æ±‚äº† traefik.abc.dev(aka æˆ‘å€‘çš„ host name)ï¼Œè€Œæˆ‘å€‘çš„ Traefik Dashboard é–‹åœ¨ 8080 portï¼Œå‰‡ Traefik æœƒå°‡é€™å€‹ request å°å‘ 8080 Wildcard ç›¸é—œçŸ¥è­˜ ç›¸é—œè¨­å®šçš„è£œå……çŸ¥è­˜ï¼Œé€™é‚Šéœ€è¦åƒè€ƒæˆ‘å·²ç¶“å¯«å¥½çš„è¨­å®šæª” Wildcardï¼šACME é©—è­‰æ–¹å¼ - Letâ€™s Encrypt - å…è²»çš„ SSL/TLS æ†‘è­‰ (letsencrypt.org) å¯ä»¥ç›´æ¥ç”³è«‹æŸå€‹ domain çš„æ†‘è­‰ï¼Œè®“æ•´å€‹ domain ä¸‹çš„æ‰€æœ‰ host éƒ½å¯ä»¥ä½¿ç”¨åŒä¸€å¼µæ†‘è­‰ï¼ˆdomain.sans éƒ¨åˆ†ï¼‰ï¼Œä¸éœ€ç‰¹åœ°ç‚ºæ‰€æœ‰ host å€‹åˆ¥ç”³è«‹æ†‘è­‰ å±¬æ–¼ Letâ€™s Encrypt ç™¼æ”¾çš„å…¶ä¸­ä¸€ç¨®æ†‘è­‰æ ¼å¼ çµ¦äºˆ route53 æ¬Šé™çš„åŸå›  å› ç‚ºè¨­å®š DNS challenge èˆ‡ DNS Challenge Provider ç‚º route53 DNS challengeï¼šéœ€è¦æœ‰ route53 çš„æ¬Šé™æ‰èƒ½å‹•æ…‹é©—è­‰ *.domain ä¸‹çš„æ‰€æœ‰ host Route53 æä¾›è‡ªå‹•æ›´æ–°æ†‘è­‰çš„ API ç¬¬ä¸€éƒ¨åˆ†å°±åˆ°é€™é‚ŠçµæŸï¼Œå…¶å¯¦åšåˆ°é€™å€‹æ­¥é©Ÿæ‡‰è©²å°±èƒ½åœ¨æœ¬åœ°ç«¯é€²è¡Œéƒ¨ç½²ï¼ˆåƒ…é™ Rails éƒ¨åˆ†ï¼‰ å¸Œæœ›å¤§å®¶èˆ‡ Docker å¯ä»¥å¥½å¥½ç›¸è™•ï¼Œä»–çœŸçš„æ˜¯å€‹å¥½ç”¨ã„‰é…·æ±è¥¿ï¼ˆ" />
<link rel="canonical" href="https://jqlynchien713.github.io/2022/08/03/coscup2.html" />
<meta property="og:url" content="https://jqlynchien713.github.io/2022/08/03/coscup2.html" />
<meta property="og:site_name" content="Jacquelynâ€™s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-08-03T14:33:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Deploy Rails with Docker Swarm (2) - æµç¨‹ä»‹ç´¹èˆ‡è¨­å®š Traefik &amp; Rails" />
<script type="application/ld+json">
{"description":"æ¥ä¸‹ä¾†è®“æˆ‘å€‘é€²åˆ°å¯¦éš›æ“ä½œçš„éƒ¨åˆ†ï¼é€™ç¯‡ä¸»è¦æœƒå…ˆä»‹ç´¹ä¸€ä¸‹å¾ŒçºŒçš„æ–‡ç« æ¶æ§‹ï¼Œä¸»è¦æ˜¯åˆ†æˆä»¥ä¸‹ä¸‰å€‹éƒ¨åˆ†ï¼š è¨­å®š Rails &amp; Traefik è¨­å®š AWS è¨­å®š Gitlab runner è‡ªå‹•åŒ–éƒ¨ç½² å› ç‚ºç¯‡å¹…çš„é—œä¿‚ï¼Œé€™ç¯‡æ–‡æœƒå…ˆä»‹ç´¹ç¬¬ä¸€éƒ¨åˆ†ï¼Œå¾Œé¢å…©éƒ¨åˆ†ä¹Ÿæœƒå†å¦å¤–ç™¼æ–°çš„æ–‡ç« ï¼ˆä¸çŸ¥ä¸è¦ºå°±è®Šæˆé€£è¼‰ç³»åˆ—äº†ğŸ« ï¼‰ éƒ¨ç½²æµç¨‹ å¯¦ä½œæµç¨‹ æœ¬åœ°ç«¯é€²è¡Œéƒ¨ç½² é–‹å•Ÿ rails production server ç¢ºèªæœ¬åœ°ç«¯ Docker compose build/up çš†å¯é †åˆ©åŸ·è¡Œ æ‰‹å‹• ssh é€²å…¥ EC2 éƒ¨ç½² å°‡ Traefik èˆ‡ Docker Swarm ç›´æ¥éƒ¨ç½²åœ¨ EC2 è£¡ï¼Œè©³ç´°çš„æµç¨‹æœƒåœ¨ä¸‹ä¸€éƒ¨åˆ†çš„åœ–è£¡èªªæ˜ åˆ©ç”¨ Gitlab runner è‡ªå‹•éƒ¨ç½² å°‡å‰ä¸€æ­¥çš„æ‰€æœ‰è¨­å®šã€éƒ¨ç½²æŒ‡ä»¤è‡ªå‹•åŒ– å¯¦éš›éƒ¨ç½²æµç¨‹ é€™é‚Šè¦è¬›çš„æ˜¯å®Œæ•´çš„éƒ¨ç½²æµç¨‹ä¸ŠåŸ·è¡Œäº†å“ªäº›è¨­å®šï¼Œå¾ŒçºŒçš„ä»‹ç´¹ä¹Ÿæœƒå°‡ä»¥ä¸‹å››é»çš„é †åºä½œç‚ºä¸»è¦æ¶æ§‹é€²è¡Œä»‹ç´¹ï¼š è¨­å®š Traefik Serviceï¼šä¾ç…§ä¸Šä¸€ç¯‡æåˆ°çš„ Traefik ç‰¹æ€§ï¼Œå…ˆè¨­å®š reverse proxyï¼ˆå†æŠŠ app æ›ä¸Šå»ï¼‰ è¨­å®š Rails App Serviceï¼šåŸºæœ¬ä¸Šç­‰æ–¼åœ¨æœ¬åœ°ç«¯éƒ¨ç½²çš„æ­¥é©Ÿï¼Œä¹Ÿå°±æ˜¯ç¢ºèª Docker compose build/up å¯ä»¥é †åˆ©é–‹å•Ÿæœå‹™ è¨­å®š EC2 èˆ‡ Route53ï¼šåœ¨ç¢ºèªè¨­å®šæª”å¤§è‡´å®Œæˆå¾Œï¼Œè¨­å®šä¸¦é–‹å•Ÿ EC2ï¼Œå°‡å‰›å‰›è¨­å®šçš„æœå‹™éƒ¨ç½²ä¸Šå» è‡ªå‹•åŒ–éƒ¨ç½² with Gitlab Runnerï¼šè¨»å†Šä¸¦æ’°å¯« runner çš„è…³æœ¬ï¼ˆ.gitlab-ci.ymlï¼‰ï¼Œè€Œè…³æœ¬çš„å…§å®¹å‰‡æ˜¯å¯¦éš›åœ¨éƒ¨ç½²æ™‚éœ€è¦å°æ©Ÿå™¨æœ¬èº«ä¸‹çš„è¨­å®šï¼Œå…§å®¹å¦‚ä¸‹ï¼š é–‹å•Ÿ Docker Swarm å‰µå»º traefik-public çš„å…¬é–‹ Networkï¼Œè®“ App service å¯ä»¥ä½¿ç”¨ traefik ä¾†åš reverse proxy æŒ‡å®šæ¯æ¬¡ Traefik æ›´æ–°æ™‚å›ºå®šä½¿ç”¨åŒå€‹ç¯€é» ä½¿ç”¨ docker stack éƒ¨ç½² Traefik éƒ¨ç½² Rails App å¯¦éš›éƒ¨ç½² Docker Swarm çš„æµç¨‹ Rails &amp; Traefik Service Traefik Service Settings Traefik èˆ‡ Rails App å…¶å¯¦æ˜¯å…©å€‹ç¨ç«‹çš„æœå‹™ï¼Œå› æ­¤é€™é‚Šæœƒå°‡ Traefik èˆ‡ Rails App çš„è¨­å®šæª”åˆ†é–‹ï¼Œä¹Ÿå°±æ˜¯ Traefik æœƒæœ‰ä¸€å€‹ traefik.yml ç”¨æ–¼éƒ¨ç½² traefik stackï¼Œè€Œ Rails App å‰‡æ˜¯ä½¿ç”¨åŸå§‹çš„ docker-compose.yml å»éƒ¨ç½² task stackï¼ˆé€™é‚Šçš„ Rails App å«åš Task-Managerï¼Œå› æ­¤ stack name å–ç‚º taskï¼‰ é¦–å…ˆåœ¨ traefik.yml ä¸­çš„è¨­å®šæœƒèˆ‡ä¸€èˆ¬çš„ docker compose file æ¶æ§‹ç›¸åŒï¼Œé€™é‚Šæˆ‘æ˜¯åƒè€ƒ dockerswarm.rocks è£¡æä¾›çš„ Traefik è¨­å®šç¯„ä¾‹é€²è¡Œè¨­å®šï¼Œä¸éæˆ‘å€‘æœƒéœ€è¦ç‰¹åˆ¥è¨­å®šä»¥ä¸‹å¹¾é»ï¼ˆé€™éƒ¨åˆ†ä¹Ÿå¯ä»¥ç›´æ¥åƒè€ƒæˆ‘å¯«å¥½çš„è¨­å®šæª” traefik.yml / Task-Manager-Ruby Â· GitLabï¼‰ï¼š Networkï¼šéœ€è¦æ–°å¢ä¸€å€‹å« traefik-public çš„ç¶²è·¯ï¼Œä¸¦ä¸”è¨­å®šç‚º externalï¼Œå¥½è®“ Rails App å¯ä»¥é€éé€™å€‹ç¶²è·¯èˆ‡ Traefik æºé€š Volumesï¼šæ–°å¢ä¸€å€‹ traefik-public-certificate çš„ volumeï¼Œç”¨æ–¼å­˜æ”¾å·²ç¶“ç”³è«‹éçš„æ†‘è­‰ Serviceï¼šåˆ†ç‚ºå…©éƒ¨åˆ†éœ€è¦æ³¨æ„ï¼ŒCommand èˆ‡ Deploy Label Commandï¼šTraefik çš„åŸºæœ¬è¨­å®šï¼Œéœ€è¦æŒ‡å®š Docker providerã€é–‹å•Ÿ Swarm modeï¼Œæ†‘è­‰çš„ç”³è«‹ã€å„²å­˜ä½ç½®ï¼Œä»¥åŠ DNS Challenge ç­‰ç­‰ Deploy Labelï¼šç‚ºäº†è¦é–‹å•Ÿ Traefik Dashboard è€Œè¨­å®šçš„ reverse proxy routingï¼Œä¸»è¦æœ‰ä¸‹åˆ—å¹¾é»è¦è¨­å®šï¼š é–‹å•Ÿ Traefik ä¸¦åŠ å…¥ traefik-public Network Dashboard ç™»å…¥å¸³å¯† Http/Https host Redirect middlewareï¼šç•¶ç”¨æˆ¶ä½¿ç”¨ Http ç™¼é€è«‹æ±‚ï¼Œè‡ªå‹•è½‰ç‚º Https Load balancer portï¼šç•¶æœ‰ç›®çš„åœ°æ˜¯ host çš„è«‹æ±‚ï¼ŒTraefik éœ€è¦å°‡å…¶å°å‘çš„ port è¨­å®š wildcard é©—è­‰éçš„ domain åˆ°é€™ä¸€æ­¥åŸºæœ¬ä¸Š Traefik æœ¬èº«å·²ç¶“è¨­å®šå®Œç•¢ï¼Œå¯ä»¥å…ˆé€² EC2 è£¡é–‹å¥½ Traefik stack ä¾†æª¢æŸ¥æ˜¯å¦èƒ½æ­£ç¢ºé–‹å•Ÿã€‚ Rails App(Application) Service æ¥ä¸‹ä¾†è¦èªªæ˜çš„æ˜¯ Rails App è¦æ€éº¼è¨­å®šï¼Œç•¶ç„¶é€™å€‹éƒ¨ç½²æ¶æ§‹ä¸åªé™å®šæ–¼ Rails Appï¼Œä¸éé€™å€‹æ­¥é©Ÿå¯èƒ½è¦ä¾ç…§ä½¿ç”¨çš„èªè¨€æˆ–æ¡†æ¶è€Œæ”¹å‹•ã€‚ é¦–å…ˆå¿…é ˆç”Ÿæˆä¸€çµ„ RAILS_MASTER_KEYï¼Œå› ç‚º Rails åœ¨ Production ç’°å¢ƒä¸­éœ€è¦æœ‰ RAILS_MASTER_KEY æ‰èƒ½å•Ÿå‹•ï¼Œç¢ºå®š production server å¯æ­£å¸¸é–‹å•Ÿå¾Œï¼Œå¯ä»¥ä¾†æº–å‚™æˆ‘å€‘çš„ Dockerfile èˆ‡ Docker-compose file ä¾†é€²è¡Œ task stack çš„è¨­å®š Dockerfile é€™éƒ¨åˆ†æˆ‘ä½¿ç”¨çš„æ˜¯ https://github.com/elct9620/boxing é€™å€‹ gem ä¾†å¹«æˆ‘è‡ªå‹•ç”Ÿæˆï¼Œä»–æœƒä¾æ“šå°ˆæ¡ˆä¸­çš„ Gemfile ä»¥åŠ boxing æœ¬èº«çš„è¨­å®šæª”ï¼ˆconfig/boxing.rbï¼‰ä¾†è‡ªå‹•ç”Ÿæˆ Dockerfileã€‚å¦å¤–é€™å€‹ Gem çš„ä½œè€…ï¼ˆä¹Ÿå°±æ˜¯è’¼æ™‚å¤§å¤§ï¼‰æœ‰ç‰¹åˆ¥ç ”ç©¶å¦‚ä½•ç”Ÿæˆæœ€å°åŒ–çš„ Docker imageï¼Œå› æ­¤è‡ªå‹•ç”Ÿæˆçš„æ˜ åƒæª”å¤§ç´„åªæœƒæœ‰ï¼ˆæ“šä»–æœ¬äººæ‰€èªªï¼‰ 100 MBï¼Œä¸‹é¢åˆ—å‡ºå¯ä»¥å¦å¤–è¨­å®šçš„é¸é …ï¼ˆç²—é«”ç‚ºæˆ‘é€™æ¬¡æœ‰æ¡ç”¨çš„è¨­å®šï¼‰ï¼š Source Code Root Ignore File Extra Packages: Node.js &amp; Python Revision Information Sentry Support Asset Precompile: True Health Check è£œå……ï¼šOpenBox - Auto generate entrypoint settingsï¼Œå¦‚æœå°‡ Boxing èˆ‡ OpenBox åŒæ™‚æ¡ç”¨çš„è©±ï¼ŒBoxing ç”Ÿæˆçš„ Dockerfile æœƒå°‡ Entrypoint è‡ªå‹•æŒ‡å®šç‚º OpenBox ç”Ÿæˆçš„ Entrypoint Docker-compose file èˆ‡åœ¨æœ¬åœ°ç«¯è¨­å®šçš„ docker-compose.yml åŸºæœ¬ä¸Šä¸€æ¨£ï¼Œæˆ‘åœ¨é€™é‚Šæ˜¯åªæœ‰è¨­å®šä¸‰å€‹ service(app/redis/postgres)ï¼ŒNetwork åªæœ‰ net è®“ä¸‰å€‹ service å…±äº«ï¼Œä¸¦åŠ ä¸Šä¸‹é¢å…©é …è¨­å®šï¼š RAILS_MASTER_KEYï¼šå‰›å‰›ç”Ÿæˆçš„ RAILS_MASTER_KEY å¯ä»¥å…ˆæ”¾åˆ° Gitlab ä¸­è¨­å®šç‚º CI variableï¼ˆå¦‚æœè¦è·‘æœ¬åœ°æ¸¬è©¦çš„è©±å¯ä»¥å°‡ RAILS_MASTER_KEY æ”¾åœ¨ .envã€æˆ–è€…è¨­å®šç‚º app service çš„ environment varï¼Œå¯ä»¥åƒè€ƒæœ¬åœ°ç«¯çš„ docker-compose Line 55ï¼‰ DATABSE_URLï¼šåœ¨ app service çš„ environment variable è¦ç‰¹åˆ¥æŒ‡å®šè³‡æ–™åº«çš„è·¯å¾‘ï¼Œæ‰èƒ½æ­£ç¢ºé€£ç·šåˆ° postgres serviceï¼Œä¸¦ä¸”è¦æ³¨æ„æ ¼å¼ç‚º postgresql://[user[:password]@][netloc][:port][/dbname][?param1=value1&amp;...] åšå®ŒåŸºæœ¬çš„è¨­å®šå¾Œï¼Œåœ¨æŠŠ Traefik ç›¸é—œçš„ routing rules åŠ åˆ° deploy label ä¸Šã€‚é€™éƒ¨åˆ†å’Œåœ¨è¨­å®š Traefik çš„ deploy labels ä¸€æ¨£ï¼Œè¨­å®šå®Œç•¢å¾Œæœƒåƒé€™å€‹æª”æ¡ˆé¡ä¼¼ã€‚ è£œå…… Load Balancer Port è¨­å®š å‡è¨­ä»Šå¤©æˆ‘å€‘çš„ domain æ˜¯ abc.dev æœ‰ç”¨æˆ¶è«‹æ±‚äº† traefik.abc.dev(aka æˆ‘å€‘çš„ host name)ï¼Œè€Œæˆ‘å€‘çš„ Traefik Dashboard é–‹åœ¨ 8080 portï¼Œå‰‡ Traefik æœƒå°‡é€™å€‹ request å°å‘ 8080 Wildcard ç›¸é—œçŸ¥è­˜ ç›¸é—œè¨­å®šçš„è£œå……çŸ¥è­˜ï¼Œé€™é‚Šéœ€è¦åƒè€ƒæˆ‘å·²ç¶“å¯«å¥½çš„è¨­å®šæª” Wildcardï¼šACME é©—è­‰æ–¹å¼ - Letâ€™s Encrypt - å…è²»çš„ SSL/TLS æ†‘è­‰ (letsencrypt.org) å¯ä»¥ç›´æ¥ç”³è«‹æŸå€‹ domain çš„æ†‘è­‰ï¼Œè®“æ•´å€‹ domain ä¸‹çš„æ‰€æœ‰ host éƒ½å¯ä»¥ä½¿ç”¨åŒä¸€å¼µæ†‘è­‰ï¼ˆdomain.sans éƒ¨åˆ†ï¼‰ï¼Œä¸éœ€ç‰¹åœ°ç‚ºæ‰€æœ‰ host å€‹åˆ¥ç”³è«‹æ†‘è­‰ å±¬æ–¼ Letâ€™s Encrypt ç™¼æ”¾çš„å…¶ä¸­ä¸€ç¨®æ†‘è­‰æ ¼å¼ çµ¦äºˆ route53 æ¬Šé™çš„åŸå›  å› ç‚ºè¨­å®š DNS challenge èˆ‡ DNS Challenge Provider ç‚º route53 DNS challengeï¼šéœ€è¦æœ‰ route53 çš„æ¬Šé™æ‰èƒ½å‹•æ…‹é©—è­‰ *.domain ä¸‹çš„æ‰€æœ‰ host Route53 æä¾›è‡ªå‹•æ›´æ–°æ†‘è­‰çš„ API ç¬¬ä¸€éƒ¨åˆ†å°±åˆ°é€™é‚ŠçµæŸï¼Œå…¶å¯¦åšåˆ°é€™å€‹æ­¥é©Ÿæ‡‰è©²å°±èƒ½åœ¨æœ¬åœ°ç«¯é€²è¡Œéƒ¨ç½²ï¼ˆåƒ…é™ Rails éƒ¨åˆ†ï¼‰ å¸Œæœ›å¤§å®¶èˆ‡ Docker å¯ä»¥å¥½å¥½ç›¸è™•ï¼Œä»–çœŸçš„æ˜¯å€‹å¥½ç”¨ã„‰é…·æ±è¥¿ï¼ˆ","url":"https://jqlynchien713.github.io/2022/08/03/coscup2.html","headline":"Deploy Rails with Docker Swarm (2) - æµç¨‹ä»‹ç´¹èˆ‡è¨­å®š Traefik &amp; Rails","@type":"BlogPosting","dateModified":"2022-08-03T14:33:00+00:00","datePublished":"2022-08-03T14:33:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://jqlynchien713.github.io/2022/08/03/coscup2.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css">
  <link rel="shortcut icon" type="image/png" href="/favicon.png"><link type="application/atom+xml" rel="alternate" href="https://jqlynchien713.github.io/feed.xml" title="Jacquelyn's Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Jacquelyn&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/tags/">Tags</a><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <!-- enable latex -->
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Deploy Rails with Docker Swarm (2) - æµç¨‹ä»‹ç´¹èˆ‡è¨­å®š Traefik &amp; Rails</h1>
    <p class="post-meta">
    <time class="dt-published" datetime="2022-08-03T14:33:00+00:00" itemprop="datePublished">Aug 3, 2022
      | ğŸ‘€
      <span class="reading-time" title="Estimated read time">
        
        
                                 18 mins
                                 
      </span>
    </time>
    |
    
      <span class="tag">update</span>
    
      <span class="tag">COSCUP</span>
    
      <span class="tag">docker-swarm</span>
    
      <span class="tag">traefik</span>
    
      <span class="tag">deploy</span>
    </p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div class="sidebar"><ul><li><a href="#éƒ¨ç½²æµç¨‹">éƒ¨ç½²æµç¨‹</a><ul><li><a href="#å¯¦ä½œæµç¨‹">å¯¦ä½œæµç¨‹</a></li><li><a href="#å¯¦éš›éƒ¨ç½²æµç¨‹">å¯¦éš›éƒ¨ç½²æµç¨‹</a></li></ul></li><li><a href="#rails--traefik-service">Rails &amp; Traefik Service</a><ul><li><a href="#traefik-service-settings">Traefik Service Settings</a></li><li><a href="#rails-appapplication-service">Rails App(Application) Service</a><ul><li><a href="#dockerfile">Dockerfile</a></li><li><a href="#docker-compose-file">Docker-compose file</a></li></ul></li><li><a href="#è£œå……">è£œå……</a><ul><li><a href="#LB">Load Balancer Port è¨­å®š</a></li><li><a href="#wildcard">Wildcard ç›¸é—œçŸ¥è­˜</a></li></ul></li></ul></li></ul></div>
    <p>æ¥ä¸‹ä¾†è®“æˆ‘å€‘é€²åˆ°å¯¦éš›æ“ä½œçš„éƒ¨åˆ†ï¼é€™ç¯‡ä¸»è¦æœƒå…ˆä»‹ç´¹ä¸€ä¸‹å¾ŒçºŒçš„æ–‡ç« æ¶æ§‹ï¼Œä¸»è¦æ˜¯åˆ†æˆä»¥ä¸‹ä¸‰å€‹éƒ¨åˆ†ï¼š</p>

<ol>
  <li>è¨­å®š Rails &amp; Traefik</li>
  <li>è¨­å®š AWS</li>
  <li>è¨­å®š Gitlab runner è‡ªå‹•åŒ–éƒ¨ç½²</li>
</ol>

<p>å› ç‚ºç¯‡å¹…çš„é—œä¿‚ï¼Œé€™ç¯‡æ–‡æœƒå…ˆä»‹ç´¹ç¬¬ä¸€éƒ¨åˆ†ï¼Œå¾Œé¢å…©éƒ¨åˆ†ä¹Ÿæœƒå†å¦å¤–ç™¼æ–°çš„æ–‡ç« <br />ï¼ˆä¸çŸ¥ä¸è¦ºå°±è®Šæˆé€£è¼‰ç³»åˆ—äº†ğŸ« ï¼‰</p>

<h2 id="éƒ¨ç½²æµç¨‹">éƒ¨ç½²æµç¨‹</h2>

<h3 id="å¯¦ä½œæµç¨‹">å¯¦ä½œæµç¨‹</h3>

<ul>
  <li>æœ¬åœ°ç«¯é€²è¡Œéƒ¨ç½²
    <ul>
      <li>é–‹å•Ÿ rails production server</li>
      <li>ç¢ºèªæœ¬åœ°ç«¯ Docker compose build/up çš†å¯é †åˆ©åŸ·è¡Œ</li>
    </ul>
  </li>
  <li>æ‰‹å‹• ssh é€²å…¥ EC2 éƒ¨ç½²
    <ul>
      <li>å°‡ Traefik èˆ‡ Docker Swarm ç›´æ¥éƒ¨ç½²åœ¨ EC2 è£¡ï¼Œè©³ç´°çš„æµç¨‹æœƒåœ¨ä¸‹ä¸€éƒ¨åˆ†çš„åœ–è£¡èªªæ˜</li>
    </ul>
  </li>
  <li>åˆ©ç”¨ Gitlab runner è‡ªå‹•éƒ¨ç½²
    <ul>
      <li>å°‡å‰ä¸€æ­¥çš„æ‰€æœ‰è¨­å®šã€éƒ¨ç½²æŒ‡ä»¤è‡ªå‹•åŒ–</li>
    </ul>
  </li>
</ul>

<h3 id="å¯¦éš›éƒ¨ç½²æµç¨‹">å¯¦éš›éƒ¨ç½²æµç¨‹</h3>

<p>é€™é‚Šè¦è¬›çš„æ˜¯å®Œæ•´çš„éƒ¨ç½²æµç¨‹ä¸ŠåŸ·è¡Œäº†å“ªäº›è¨­å®šï¼Œå¾ŒçºŒçš„ä»‹ç´¹ä¹Ÿæœƒå°‡ä»¥ä¸‹å››é»çš„é †åºä½œç‚ºä¸»è¦æ¶æ§‹é€²è¡Œä»‹ç´¹ï¼š</p>

<ol>
  <li>è¨­å®š Traefik Serviceï¼šä¾ç…§ä¸Šä¸€ç¯‡æåˆ°çš„ Traefik ç‰¹æ€§ï¼Œå…ˆè¨­å®š reverse proxyï¼ˆå†æŠŠ app æ›ä¸Šå»ï¼‰</li>
  <li>è¨­å®š Rails App Serviceï¼šåŸºæœ¬ä¸Šç­‰æ–¼åœ¨æœ¬åœ°ç«¯éƒ¨ç½²çš„æ­¥é©Ÿï¼Œä¹Ÿå°±æ˜¯ç¢ºèª Docker compose build/up å¯ä»¥é †åˆ©é–‹å•Ÿæœå‹™</li>
  <li>è¨­å®š EC2 èˆ‡ Route53ï¼šåœ¨ç¢ºèªè¨­å®šæª”å¤§è‡´å®Œæˆå¾Œï¼Œè¨­å®šä¸¦é–‹å•Ÿ EC2ï¼Œå°‡å‰›å‰›è¨­å®šçš„æœå‹™éƒ¨ç½²ä¸Šå»</li>
  <li>è‡ªå‹•åŒ–éƒ¨ç½² with Gitlab Runnerï¼šè¨»å†Šä¸¦æ’°å¯« runner çš„è…³æœ¬ï¼ˆ<code class="language-plaintext highlighter-rouge">.gitlab-ci.yml</code>ï¼‰ï¼Œè€Œè…³æœ¬çš„å…§å®¹å‰‡æ˜¯<strong>å¯¦éš›åœ¨éƒ¨ç½²æ™‚éœ€è¦å°æ©Ÿå™¨æœ¬èº«ä¸‹çš„è¨­å®š</strong>ï¼Œå…§å®¹å¦‚ä¸‹ï¼š
    <ol>
      <li>é–‹å•Ÿ Docker Swarm</li>
      <li>å‰µå»º <code class="language-plaintext highlighter-rouge">traefik-public</code> çš„å…¬é–‹ Networkï¼Œè®“ App service å¯ä»¥ä½¿ç”¨ traefik ä¾†åš reverse proxy</li>
      <li>æŒ‡å®šæ¯æ¬¡ Traefik æ›´æ–°æ™‚å›ºå®šä½¿ç”¨åŒå€‹ç¯€é»</li>
      <li>ä½¿ç”¨ docker stack éƒ¨ç½² Traefik</li>
      <li>éƒ¨ç½² Rails App</li>
    </ol>

    <p id="order1"><img src="/assets/img/order1.jpg" alt="order1" /></p>

    <p>å¯¦éš›éƒ¨ç½² Docker Swarm çš„æµç¨‹</p>
  </li>
</ol>

<h2 id="rails--traefik-service">Rails &amp; Traefik Service</h2>

<h3 id="traefik-service-settings">Traefik Service Settings</h3>

<p>Traefik èˆ‡ Rails App å…¶å¯¦æ˜¯å…©å€‹ç¨ç«‹çš„æœå‹™ï¼Œå› æ­¤é€™é‚Šæœƒå°‡ Traefik èˆ‡ Rails App çš„è¨­å®šæª”åˆ†é–‹ï¼Œä¹Ÿå°±æ˜¯ <strong>Traefik æœƒæœ‰ä¸€å€‹ <code class="language-plaintext highlighter-rouge">traefik.yml</code> ç”¨æ–¼éƒ¨ç½² traefik stack</strong>ï¼Œè€Œ <strong>Rails App å‰‡æ˜¯ä½¿ç”¨åŸå§‹çš„ <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> å»éƒ¨ç½² task stack</strong>ï¼ˆé€™é‚Šçš„ Rails App å«åš Task-Managerï¼Œå› æ­¤ stack name å–ç‚º <code class="language-plaintext highlighter-rouge">task</code>ï¼‰</p>

<p>é¦–å…ˆåœ¨ traefik.yml ä¸­çš„è¨­å®šæœƒèˆ‡ä¸€èˆ¬çš„ docker compose file æ¶æ§‹ç›¸åŒï¼Œé€™é‚Šæˆ‘æ˜¯åƒè€ƒ <a href="https://dockerswarm.rocks/traefik/">dockerswarm.rocks</a> è£¡æä¾›çš„ Traefik è¨­å®šç¯„ä¾‹é€²è¡Œè¨­å®šï¼Œä¸éæˆ‘å€‘æœƒéœ€è¦ç‰¹åˆ¥è¨­å®šä»¥ä¸‹å¹¾é»ï¼ˆé€™éƒ¨åˆ†ä¹Ÿå¯ä»¥ç›´æ¥åƒè€ƒæˆ‘å¯«å¥½çš„è¨­å®šæª”  <a href="https://gitlab.com/jqlynchien713/task-manager-ruby/-/blob/main/traefik.yml">traefik.yml / Task-Manager-Ruby Â· GitLab</a>ï¼‰ï¼š</p>

<ul>
  <li>Networkï¼šéœ€è¦æ–°å¢ä¸€å€‹å« <code class="language-plaintext highlighter-rouge">traefik-public</code> çš„ç¶²è·¯ï¼Œä¸¦ä¸”è¨­å®šç‚º externalï¼Œå¥½è®“ Rails App å¯ä»¥é€éé€™å€‹ç¶²è·¯èˆ‡ Traefik æºé€š</li>
  <li>Volumesï¼šæ–°å¢ä¸€å€‹ <code class="language-plaintext highlighter-rouge">traefik-public-certificate</code> çš„ volumeï¼Œç”¨æ–¼å­˜æ”¾å·²ç¶“ç”³è«‹éçš„æ†‘è­‰</li>
  <li>Serviceï¼šåˆ†ç‚ºå…©éƒ¨åˆ†éœ€è¦æ³¨æ„ï¼ŒCommand èˆ‡ Deploy Label
    <ul>
      <li>Commandï¼šTraefik çš„<strong>åŸºæœ¬è¨­å®š</strong>ï¼Œéœ€è¦æŒ‡å®š Docker providerã€é–‹å•Ÿ Swarm modeï¼Œæ†‘è­‰çš„ç”³è«‹ã€å„²å­˜ä½ç½®ï¼Œä»¥åŠ DNS Challenge ç­‰ç­‰</li>
      <li>Deploy Labelï¼šç‚ºäº†è¦é–‹å•Ÿ Traefik Dashboard è€Œè¨­å®šçš„ <strong>reverse proxy routing</strong>ï¼Œä¸»è¦æœ‰ä¸‹åˆ—å¹¾é»è¦è¨­å®šï¼š
        <ul>
          <li>é–‹å•Ÿ Traefik ä¸¦åŠ å…¥ <code class="language-plaintext highlighter-rouge">traefik-public</code> Network</li>
          <li>Dashboard ç™»å…¥å¸³å¯†</li>
          <li>Http/Https host</li>
          <li>Redirect middlewareï¼šç•¶ç”¨æˆ¶ä½¿ç”¨ Http ç™¼é€è«‹æ±‚ï¼Œè‡ªå‹•è½‰ç‚º Https</li>
          <li><a href="#LB">Load balancer</a> portï¼šç•¶æœ‰ç›®çš„åœ°æ˜¯ host çš„è«‹æ±‚ï¼ŒTraefik éœ€è¦å°‡å…¶å°å‘çš„ port</li>
          <li>è¨­å®š <a href="#wildcard">wildcard</a> é©—è­‰éçš„ domain</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>åˆ°é€™ä¸€æ­¥åŸºæœ¬ä¸Š Traefik æœ¬èº«å·²ç¶“è¨­å®šå®Œç•¢ï¼Œå¯ä»¥å…ˆé€² EC2 è£¡é–‹å¥½ Traefik stack ä¾†æª¢æŸ¥æ˜¯å¦èƒ½æ­£ç¢ºé–‹å•Ÿã€‚</p>

<h3 id="rails-appapplication-service">Rails App(Application) Service</h3>

<p>æ¥ä¸‹ä¾†è¦èªªæ˜çš„æ˜¯ Rails App è¦æ€éº¼è¨­å®šï¼Œç•¶ç„¶é€™å€‹éƒ¨ç½²æ¶æ§‹ä¸åªé™å®šæ–¼ Rails Appï¼Œä¸éé€™å€‹æ­¥é©Ÿå¯èƒ½è¦ä¾ç…§ä½¿ç”¨çš„èªè¨€æˆ–æ¡†æ¶è€Œæ”¹å‹•ã€‚</p>

<p>é¦–å…ˆå¿…é ˆç”Ÿæˆä¸€çµ„ <code class="language-plaintext highlighter-rouge">RAILS_MASTER_KEY</code>ï¼Œå› ç‚º Rails åœ¨ Production ç’°å¢ƒä¸­éœ€è¦æœ‰ <code class="language-plaintext highlighter-rouge">RAILS_MASTER_KEY</code> æ‰èƒ½å•Ÿå‹•ï¼Œç¢ºå®š production server å¯æ­£å¸¸é–‹å•Ÿå¾Œï¼Œå¯ä»¥ä¾†æº–å‚™æˆ‘å€‘çš„ Dockerfile èˆ‡ Docker-compose file ä¾†é€²è¡Œ task stack çš„è¨­å®š</p>

<h4 id="dockerfile">Dockerfile</h4>

<p>é€™éƒ¨åˆ†æˆ‘ä½¿ç”¨çš„æ˜¯ https://github.com/elct9620/boxing é€™å€‹ gem ä¾†å¹«æˆ‘è‡ªå‹•ç”Ÿæˆï¼Œä»–æœƒä¾æ“šå°ˆæ¡ˆä¸­çš„ Gemfile ä»¥åŠ boxing æœ¬èº«çš„è¨­å®šæª”ï¼ˆ<code class="language-plaintext highlighter-rouge">config/boxing.rb</code>ï¼‰ä¾†è‡ªå‹•ç”Ÿæˆ Dockerfileã€‚å¦å¤–é€™å€‹ Gem çš„ä½œè€…ï¼ˆä¹Ÿå°±æ˜¯è’¼æ™‚å¤§å¤§ï¼‰æœ‰ç‰¹åˆ¥ç ”ç©¶å¦‚ä½•ç”Ÿæˆæœ€å°åŒ–çš„ Docker imageï¼Œå› æ­¤è‡ªå‹•ç”Ÿæˆçš„æ˜ åƒæª”å¤§ç´„åªæœƒæœ‰ï¼ˆæ“šä»–æœ¬äººæ‰€èªªï¼‰ 100 MBï¼Œä¸‹é¢åˆ—å‡ºå¯ä»¥å¦å¤–è¨­å®šçš„é¸é …ï¼ˆç²—é«”ç‚ºæˆ‘é€™æ¬¡æœ‰æ¡ç”¨çš„è¨­å®šï¼‰ï¼š</p>

<ul>
  <li>Source Code Root</li>
  <li>Ignore File</li>
  <li><strong>Extra Packages: Node.js &amp; Python</strong></li>
  <li>Revision Information</li>
  <li>Sentry Support</li>
  <li><strong>Asset Precompile: True</strong></li>
  <li>Health Check</li>
</ul>

<blockquote>
  <p>è£œå……ï¼š<strong><a href="https://github.com/elct9620/openbox">OpenBox</a></strong> - Auto generate entrypoint settingsï¼Œå¦‚æœå°‡ Boxing èˆ‡ OpenBox åŒæ™‚æ¡ç”¨çš„è©±ï¼ŒBoxing ç”Ÿæˆçš„ Dockerfile æœƒå°‡ Entrypoint è‡ªå‹•æŒ‡å®šç‚º OpenBox ç”Ÿæˆçš„ Entrypoint</p>

</blockquote>

<h4 id="docker-compose-file">Docker-compose file</h4>

<p>èˆ‡åœ¨æœ¬åœ°ç«¯è¨­å®šçš„ <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> åŸºæœ¬ä¸Šä¸€æ¨£ï¼Œæˆ‘åœ¨é€™é‚Šæ˜¯åªæœ‰è¨­å®šä¸‰å€‹ service(app/redis/postgres)ï¼ŒNetwork åªæœ‰ net è®“ä¸‰å€‹ service å…±äº«ï¼Œä¸¦åŠ ä¸Šä¸‹é¢å…©é …è¨­å®šï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">RAILS_MASTER_KEY</code>ï¼šå‰›å‰›ç”Ÿæˆçš„ <code class="language-plaintext highlighter-rouge">RAILS_MASTER_KEY</code> å¯ä»¥å…ˆæ”¾åˆ° Gitlab ä¸­è¨­å®šç‚º CI variableï¼ˆå¦‚æœè¦è·‘æœ¬åœ°æ¸¬è©¦çš„è©±å¯ä»¥å°‡ <code class="language-plaintext highlighter-rouge">RAILS_MASTER_KEY</code> æ”¾åœ¨ .envã€æˆ–è€…è¨­å®šç‚º app service çš„ environment varï¼Œå¯ä»¥åƒè€ƒ<a href="https://gitlab.com/jqlynchien713/task-manager-ruby/-/blob/main/docker-compose-local.yml">æœ¬åœ°ç«¯çš„ docker-compose</a> Line 55ï¼‰</li>
  <li><code class="language-plaintext highlighter-rouge">DATABSE_URL</code>ï¼šåœ¨ app service çš„ environment variable è¦ç‰¹åˆ¥æŒ‡å®šè³‡æ–™åº«çš„è·¯å¾‘ï¼Œæ‰èƒ½æ­£ç¢ºé€£ç·šåˆ° postgres serviceï¼Œä¸¦ä¸”è¦æ³¨æ„æ ¼å¼ç‚º <code class="language-plaintext highlighter-rouge">postgresql://[user[:password]@][netloc][:port][/dbname][?param1=value1&amp;...]</code></li>
</ul>

<p>åšå®ŒåŸºæœ¬çš„è¨­å®šå¾Œï¼Œåœ¨æŠŠ Traefik ç›¸é—œçš„ routing rules åŠ åˆ° deploy label ä¸Šã€‚é€™éƒ¨åˆ†å’Œåœ¨è¨­å®š Traefik çš„ deploy labels ä¸€æ¨£ï¼Œè¨­å®šå®Œç•¢å¾Œæœƒåƒ<a href="https://gitlab.com/jqlynchien713/task-manager-ruby/-/blob/main/docker-compose.yml">é€™å€‹æª”æ¡ˆ</a>é¡ä¼¼ã€‚</p>

<hr />
<h3 id="è£œå……">è£œå……</h3>
<h4 id="LB">Load Balancer Port è¨­å®š</h4>
<p>å‡è¨­ä»Šå¤©æˆ‘å€‘çš„ domain æ˜¯ <code class="language-plaintext highlighter-rouge">abc.dev</code> æœ‰ç”¨æˆ¶è«‹æ±‚äº† <code class="language-plaintext highlighter-rouge">traefik.abc.dev(aka æˆ‘å€‘çš„ host name)</code>ï¼Œè€Œæˆ‘å€‘çš„ Traefik Dashboard é–‹åœ¨ 8080 portï¼Œå‰‡ Traefik æœƒå°‡é€™å€‹ request å°å‘ 8080</p>

<h4 id="wildcard">Wildcard ç›¸é—œçŸ¥è­˜</h4>
<p>ç›¸é—œè¨­å®šçš„è£œå……çŸ¥è­˜ï¼Œé€™é‚Šéœ€è¦åƒè€ƒæˆ‘å·²ç¶“å¯«å¥½çš„<a href="https://gitlab.com/jqlynchien713/task-manager-ruby/-/blob/main/traefik.yml">è¨­å®šæª”</a></p>

<ul>
  <li>Wildcardï¼š<a href="https://letsencrypt.org/zh-tw/docs/challenge-types/#dns-01-%E8%80%83%E9%A9%97">ACME é©—è­‰æ–¹å¼ - Letâ€™s Encrypt - å…è²»çš„ SSL/TLS æ†‘è­‰ (letsencrypt.org)</a>
    <ul>
      <li>å¯ä»¥ç›´æ¥ç”³è«‹æŸå€‹ domain çš„æ†‘è­‰ï¼Œè®“æ•´å€‹ domain ä¸‹çš„æ‰€æœ‰ host éƒ½å¯ä»¥ä½¿ç”¨åŒä¸€å¼µæ†‘è­‰ï¼ˆdomain.sans éƒ¨åˆ†ï¼‰ï¼Œä¸éœ€ç‰¹åœ°ç‚ºæ‰€æœ‰ host å€‹åˆ¥ç”³è«‹æ†‘è­‰</li>
      <li>å±¬æ–¼ Letâ€™s Encrypt ç™¼æ”¾çš„å…¶ä¸­ä¸€ç¨®æ†‘è­‰æ ¼å¼</li>
    </ul>
  </li>
  <li>çµ¦äºˆ route53 æ¬Šé™çš„åŸå› 
    <ul>
      <li>å› ç‚ºè¨­å®š DNS challenge èˆ‡ DNS Challenge Provider ç‚º route53</li>
      <li>DNS challengeï¼šéœ€è¦æœ‰ route53 çš„æ¬Šé™æ‰èƒ½å‹•æ…‹é©—è­‰ *.domain ä¸‹çš„æ‰€æœ‰ host</li>
      <li>Route53 æä¾›è‡ªå‹•æ›´æ–°æ†‘è­‰çš„ API</li>
    </ul>
  </li>
</ul>

<hr />
<p>ç¬¬ä¸€éƒ¨åˆ†å°±åˆ°é€™é‚ŠçµæŸï¼Œå…¶å¯¦åšåˆ°é€™å€‹æ­¥é©Ÿæ‡‰è©²å°±èƒ½åœ¨æœ¬åœ°ç«¯é€²è¡Œéƒ¨ç½²ï¼ˆåƒ…é™ Rails éƒ¨åˆ†ï¼‰</p>

<p>å¸Œæœ›å¤§å®¶èˆ‡ Docker å¯ä»¥å¥½å¥½ç›¸è™•ï¼Œä»–çœŸçš„æ˜¯å€‹å¥½ç”¨ã„‰é…·æ±è¥¿ï¼ˆ</p>

  </div>

  
  
    <script src="https://utteranc.es/client.js"
            repo=jqlynchien713/jqlynchien713.github.io
            issue-term=pathname
            label=Comments
            theme=github-light
            crossorigin= "anonymous"
            async>
    </script>
  

<a class="u-url" href="/2022/08/03/coscup2.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Jacquelyn&#39;s Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Jacquelyn&#39;s Blog</li><li><a class="u-email" href="mailto:jqlynchien713@gmail.com">jqlynchien713@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-3"><ul class="social-media-list"><li><a href="https://github.com/jqlynchien713"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jqlynchien713</span></a></li></ul>
</div>

      <div class="footer-col footer-col-2">
        <p>Ê• â€¢á´¥â€¢Ê”</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
