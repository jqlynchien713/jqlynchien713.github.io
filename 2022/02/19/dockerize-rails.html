<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Dockerize Rails App | Jacquelynâ€™s Blog</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Dockerize Rails App" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="çµ‚æ–¼è£œåˆ°é€™ç¯‡äº†ï¼éœ€è¦ Dockerize çš„åŸå› å¾ˆç°¡å–®ï¼Œå› ç‚ºæœ¬åœ°ç’°å¢ƒè¢«æˆ‘è‡ªå·±æçˆ†äº†ğŸ˜€ ç°¡å–®ä¾†èªªå°±æ˜¯æˆ‘ä¸ƒå…«æœˆæ™‚é–‹ç™¼çš„å°ˆæ¡ˆï¼Œéš”äº†å››å€‹æœˆä¹‹å¾Œå†å›ä¾†ç¹¼çºŒæ”¯æ´æ™‚ï¼Œç™¼ç¾æ•´å€‹ç’°å¢ƒå‡ºä¸€å †å•é¡Œï¼ˆåŸºæœ¬ä¸Šéƒ½æ˜¯ M1 chips ç›¸é—œçš„ï¼‰ï¼Œä¸ç®¡æ€éº¼æ”¹ç’°å¢ƒè¨­å®šï¼Œä¸‹å®ŒæŒ‡ä»¤ä¹‹å¾Œæ°¸é éƒ½æœƒ crashï¼Œä¿®åˆ°æœ€å¾Œæˆ‘ä¹Ÿæ‡¶å¾—ç¹¼çºŒæ‰¾åŸå› äº†ï¼Œæƒ³èªªå‰›å­¸é Dockerï¼Œå…¶ä»–è³‡æ·±çš„åŒäº‹å€‘ä¹Ÿæœ‰é€™æ¨£æéï¼Œå°±æƒ³èªªä¸ç„¶æˆ‘ä¹Ÿä¾†è©¦è©¦çœ‹å§ï¼šï¼‰ é€™å€‹å°ˆæ¡ˆç”¨çš„ Ruby ç‰ˆæœ¬æ˜¯ 2.6.9ï¼ˆæ‰€ä»¥æ‰æœƒåœ¨ M1 çš„é›»è…¦ä¸Šå……æ»¿å•é¡Œï¼Œæœ€ä¸€é–‹å§‹åœ¨å®‰è£ 2.6.9 ç‰ˆçš„ Ruby æ™‚å°±å·²ç¶“å‹•éä¸€äº›æ‰‹è…³äº†ï¼šåœ¨ make binary å‡ºå•é¡Œçš„è©±å¯ä»¥å…ˆä¸‹ CFLAGS=&quot;-Wno-error=implicit-function-declaration&quot; rvm install x.x.x å†å®‰è£ by è€é—†ï¼‰é‚„æœƒéœ€è¦ç”¨åˆ° Redis, PostgresQL(DB), Webpackerï¼Œå°±éƒ½æ˜¯ä¸€äº›é–‹ç™¼ Rails æ™‚æ‰€éœ€æœ€åŸºæœ¬çš„é…ç½®ï¼Œä¸¦åœ¨å®¹å™¨åŒ–å¾Œä½¿ç”¨ docker-compose ä¾†å”èª¿é€™äº›é…ç½®ã€‚ Docker-compose ç°¡ä»‹ æ ¹æ“šå®˜ç¶²çš„ä»‹ç´¹ï¼Œdocker-compose æ˜¯ä¸€å€‹ç”¨æ–¼ç®¡ç†ã€åŸ·è¡Œå¤šå®¹å™¨ Docker Application çš„å·¥å…·ã€‚ä½¿ç”¨ docker-compose æ™‚éœ€è¦ç”¨ YAML æª”ä¾†å®šç¾© application çš„å„å€‹ servicesï¼Œæ¥ä¸‹ä¾†å³å¯é€éä¸€å€‹æŒ‡ä»¤ã€å¾é…ç½®ä¸­å‰µå»ºä¸¦å•Ÿå‹•æ‰€æœ‰æœå‹™ã€‚é€™æ¨£åšçš„å¥½è™•æ˜¯å¯ä»¥åŒæ™‚å®šç¾©ã€å”èª¿æ‰€æœ‰æœå‹™ï¼Œå¯ä»¥é¿å…åœ¨å€‹åˆ¥é–‹å•Ÿå®¹å™¨æ™‚é‚„è¦åšé¡å¤–çš„è¨­å®šï¼Œæé«˜é–‹ç™¼çš„æ•ˆç‡ã€‚ åŸºæœ¬ä¸Šåœ¨è¨­å®š docker-compose æ™‚ï¼Œéœ€è¦å…ˆæœ‰å„å€‹ service container è¦ç”¨çš„ imageï¼Œä¸è«–æ˜¯è‡ªå·±å¯«çš„ Dockerfileï¼Œæˆ–è€…æ˜¯å¾ docker hub ä¸Š pull ä¸‹ä¾†çš„ image éƒ½å¯ä»¥ã€‚æ¥ä¸‹ä¾†å°±æ˜¯ docker-compose.yml çš„æ’°å¯«ï¼Œéœ€è¦å…ˆå°æ•´å€‹æ‡‰ç”¨ç¨‹å¼åšå…¨åŸŸçš„è¨­å®šï¼ˆå¦‚ä½¿ç”¨çš„ docker-compose ç‰ˆæœ¬ã€è¦æœ‰å“ªäº› networks ç­‰ï¼‰ï¼Œæ¥è‘—å†å°å€‹åˆ¥çš„ services åšç´°ç¯€è¨­å®šï¼ˆé¸ç”¨å“ªè£¡çš„ imageã€port mappingã€å°ˆæ¡ˆçš„ç’°å¢ƒè®Šæ•¸â€¦ç­‰ï¼‰ Docker-compose Configurations åœ¨ docker-compose.yml çš„é–‹é ­éœ€è¦å…ˆå°æ•´å€‹ application åšæœ€åŸºæœ¬çš„è¨­å®šï¼Œä½†å› ç‚ºé€™é‚Šåªæ˜¯é–‹ç™¼ç’°å¢ƒè€Œå·²ï¼Œå› æ­¤å°±åªæœ‰ç°¡å–®åš Networks &amp; Volumes çš„è¨­å®šè€Œå·²ï¼Œä¸»è¦å°±æ˜¯é–‹å…©å€‹ Networks(development &amp; test) èˆ‡å››å€‹ Volumes(db_data, gem_cache, shared_data &amp; packs)ã€‚ Basic Setups Version: æŒ‡å®šè¦ä½¿ç”¨çš„ docker-compose ç‰ˆæœ¬ï¼Œç›®å‰çœ‹åˆ°å¤§å¤šæ•¸çš„æ•™å­¸éƒ½æ˜¯ç”¨ç¬¬ä¸‰ç‰ˆ Networks: åœ¨å»ºèµ· application ä¹‹å¾Œï¼Œdocker-compose æœƒæŠŠæ‰€æœ‰å®¹å™¨éƒ½ä¸Ÿåˆ°ä¸€å€‹ default network ä¸­ï¼Œè€Œåœ¨åŒå€‹ network è£¡çš„å®¹å™¨éƒ½äº’ç›¸ reachableã€‚å¦‚æœä¸æƒ³ä½¿ç”¨é è¨­çš„ default network çš„è©±ä¹Ÿèƒ½è‡ªå·±å¦å¤–å®£å‘Šï¼Œä¸¦å‰µé€ æ›´è¤‡é›œçš„ network topologyã€‚åŸºæœ¬ä¸Šå¯ä»¥é€éé€™æ¨£çš„è¨­å®šé”åˆ°å€éš”ç’°å¢ƒçš„æ•ˆæœï¼Œé€™ä¹Ÿæ˜¯ç‚ºä»€éº¼é€™å€‹å°ˆæ¡ˆçš„ networks è¨­ç½®è¦åˆ†æˆ development èˆ‡ test çš„åŸå›  Volumes: çµ±ä¸€å®£å‘Šæ‰€æœ‰ images æœƒç”¨åˆ°çš„ volumesï¼Œå› ç‚ºæœ‰äº› services å¯èƒ½æœƒéœ€è¦å…±ç”¨ volumes(åƒæ˜¯é€™å€‹å°ˆæ¡ˆè£¡çš„ shared_data volume å°±æ˜¯æ‹¿ä¾†è®“æ‰€æœ‰ containers å…±ç”¨çš„ volume)ã€‚ä¸»è¦çš„åŠŸç”¨æ˜¯åœ¨é–‹ç™¼çš„æ™‚å€™å¯ä»¥åŒæ­¥å°‡æœ¬åœ°ç«¯ä¿®æ”¹çš„å…§å®¹ï¼Œmapping åˆ°å®¹å™¨è£¡çš„å°ˆæ¡ˆï¼Œåœ¨é–‹ç™¼ä¸Šæ¯”è¼ƒç¯€çœæ™‚é–“ã€‚ Mapping çš„æ ¼å¼ï¼š å¤–ç•Œ:å®¹å™¨ Services Configurations è·Ÿä¸Šé¢æåˆ°çš„é…ç½®ä¸€æ¨£ï¼Œå†åŠ ä¸Šéœ€è¦æ¸¬è©¦ç”¨çš„ç’°å¢ƒä¹‹å¾Œï¼Œæˆ‘å€‘åœ¨ docker-compose è£¡ç¸½å…±æœƒéœ€è¦ä»¥ä¸‹äº”å€‹æœå‹™: redis, db(postgres), app, test, webpacker Redis Docker-compose service è¨­å®š image: å¯ä»¥ç›´æ¥é¸ç”¨ docker hub ä¸Šçš„ redis image command: ç•¶é€™å€‹æœå‹™é–‹å§‹é‹è¡Œæ™‚è¦åŸ·è¡Œçš„æŒ‡ä»¤ï¼Œaka åŸ·è¡Œ redis server çš„æŒ‡ä»¤ redis-server networks: é€™é‚Šå› ç‚ºé–‹ç™¼èˆ‡æ¸¬è©¦ç’°å¢ƒéƒ½æœƒç”¨åˆ° redisï¼Œæ‰€ä»¥å…©å€‹ network éƒ½è¦æ”¾é€²ä¾† volumes: é€™é‚Šåªéœ€è¦ shared_data AppName_redis: image: redis:6.0-alpine command: redis-server networks: - development - test volumes: - shared_data:/var/shared/redis Rails App è¨­å®š éœ€è¦å°‡ app å…§è¨­å®šçš„ redis url æ”¹æˆ docker-compose è£¡æŒ‡å®šçš„ service name æ ¼å¼ï¼š&quot;redis://AppName_redis:6379/1&quot; (development &amp; test å…©å€‹ç’°å¢ƒä¸‹éƒ½éœ€è¦æ”¹) Reference DB(PostgresQL) Docker-compose service è¨­å®š image: é€™é‚Šä¹Ÿæ˜¯ç›´æ¥é¸ç”¨ docker hub ä¸Šçš„ postgres container volumes: é™¤äº†æ‰€æœ‰ service å…±ç”¨çš„ shared_data å¤–ï¼Œé‚„éœ€è¦æŒ‡å®šä¸€å€‹ç”¨ä¾†å„²å­˜è³‡æ–™åº«è³‡è¨Šçš„ volume(db_data) networks: é€™é‚Šä¹Ÿæ˜¯å…©å€‹ç’°å¢ƒéƒ½æœƒéœ€è¦ dbï¼Œå› æ­¤å…©å€‹ network éƒ½éœ€è¦æ”¾ environment: ç”¨ä¾†è¨­å®šé€™å€‹ container çš„ç’°å¢ƒè®Šæ•¸ï¼Œé€™é‚Šéœ€è¦è¨­å®šçš„æ˜¯è³‡æ–™åº«çš„å¸³è™Ÿå¯†ç¢¼ï¼Œè€Œå®˜æ–¹ image é è¨­çš„å¸³è™Ÿç‚º postgres å¯†ç¢¼ç‚º passwordï¼›å› ç‚ºé€™é‚Šåªæ˜¯æ¸¬è©¦ç’°å¢ƒï¼Œæ‰€ä»¥ç”¨é è¨­çš„æ²’é—œä¿‚ï¼Œä½†å¦‚æœä¸Š staging æˆ– production é€™ç¨®æ­£å¼çš„ç’°å¢ƒæ™‚ï¼Œå°±éœ€è¦å¦å¤–ç”¨ CI å·¥å…·åšè¨­å®šã€‚ ports: åš port mapping ç”¨ï¼Œè®“è³‡æ–™åº«å¯ä»¥è¢«å¤–ç•Œè®€å– AppName_db: image: postgres:14-alpine container_name: AppName_db volumes: - db_data:/var/lib/postgresql/data - shared_data:/var/shared networks: - development - test environment: POSTGRES_USER: postgres POSTGRES_PASSWORD: password ports: - 5432:5432 Rails App è¨­å®šï¼šconfig/database.yml éœ€è¦å°‡æ•´å€‹ app è¦é€£çµçš„ db æ”¹æˆ docker-compose ä¸Šçš„ serviceï¼Œä¸¦ä¸”è¨­å®šå¸³è™Ÿå¯†ç¢¼ host: AppName_db username: postgres -&gt; image default setting password: password -&gt; image default setting é–‹å•Ÿæ•´å€‹æœå‹™å¾Œè¦è¨˜å¾—å…ˆä¸‹ bundle exec rake db:create ä¾†å‰µå»ºæœƒç”¨åˆ°çš„ dbï¼Œå¦å‰‡è³‡æ–™åº«çš„å…§å®¹æœƒé•·åœ¨ä¸€å€‹å¾ˆå¥‡æ€ªçš„ä½ç½®ï¼Œå¾ŒçºŒå¦‚æœè¦ç”¨ rake çš„æŒ‡ä»¤æ“ä½œè³‡æ–™åº«æœƒæ²’è¾¦æ³•è®€å–åˆ°æ­£ç¢ºçš„è³‡æ–™ App Dockerfile for Rails App 2 base images node:14-alpine, ruby:2.6.9-alpine: é€™é‚Šæœƒç”¨åˆ°å…©å±¤ base image æ˜¯å› ç‚ºå°ˆæ¡ˆè£¡çš„ node ç‰ˆæœ¬æ˜¯ 14ï¼Œä¸éå¦‚æœåªç”¨ apk add å»ä¸‹è¼‰ node çš„è©±éƒ½æœƒè¼‰åˆ°æœ€æ–°çš„ 16 ç‰ˆï¼Œå› æ­¤æœ€å¾Œæ±ºå®šè¼‰å…©å±¤ base imageï¼Œä¸¦ä¸”æŠŠå¸¶ 14 ç‰ˆçš„è¨­å®šè¤‡è£½åˆ° ruby image è£¡ï¼Œnode çš„éƒ¨åˆ†å°±èƒ½æ­£å¸¸é‹ä½œäº† Env variables Copy entrypoint scripts and grant execution permission Copy everything from node image Install all dependencies(not including node) é€™é‚Šè¦é¿é–‹ä¸‹è¼‰ nodeï¼Œä»¥å…æŠŠ 14 ç‰ˆçš„è¨­å®šè¦†è“‹æ‰ FROM node:14-alpine as node RUN apk add --update --no-cache python2 &amp;&amp; ln -sf python2 /usr/bin/python FROM ruby:2.6.9-alpine ENV APP_PATH /var/app ENV BUNDLE_VERSION 2.2.33 ENV BUNDLE_PATH /usr/local/bundle/gems ENV TMP_PATH /tmp/ ENV RAILS_LOG_TO_STDOUT true ENV RAILS_PORT 3000 # copy entrypoint scripts and grant execution permissions COPY ./dev-docker-entrypoint.sh /usr/local/bin/dev-entrypoint.sh COPY ./test-docker-entrypoint.sh /usr/local/bin/test-entrypoint.sh COPY --from=node . . RUN chmod +x /usr/local/bin/dev-entrypoint.sh &amp;&amp; chmod +x /usr/local/bin/test-entrypoint.sh # install dependencies for application RUN apk -U add --no-cache \ build-base \ git \ postgresql-dev \ postgresql-client \ libxml2-dev \ libidn-dev \ libxslt-dev \ yarn \ imagemagick6 \ imagemagick6-c++ \ imagemagick6-dev \ imagemagick6-libs \ tzdata \ less \ curl \ bash \ &amp;&amp; rm -rf /var/cache/apk/* \ &amp;&amp; mkdir -p $APP_PATH RUN gem install bundler --version &quot;$BUNDLE_VERSION&quot; \ &amp;&amp; rm -rf $GEM_HOME/cache/* RUN yarn install --check-file # navigate to app directory WORKDIR $APP_PATH EXPOSE $RAILS_PORT ENTRYPOINT [ &quot;bundle&quot;, &quot;exec&quot; ] Docker-compose service è¨­å®š image: ä½¿ç”¨ä¸Šè¿°çš„ Dockerfile å»ºå‡ºçš„ imageï¼Œè·Ÿä¸Šé¢å¹¾å€‹æœå‹™ä¸ä¸€æ¨£ï¼Œè¦ä½¿ç”¨ build ä¾†æŒ‡å®šå»ºç«‹ image çš„è³‡æ–™å¤¾é‚„æœ‰ Dockerfile çš„ä½ç½® volumes: é™¤äº†å…±ç”¨çš„ shared_data å¤–ï¼Œé‚„æœ‰æ•´å€‹å°ˆæ¡ˆçš„ mappingï¼Œéœ€è¦å°æ‡‰åˆ°å‰›å‰› Dockerfile è£¡å®šç¾©çš„ $APP_PATH ä¸Šï¼Œè—‰ç”± Docker bind mounts é”åˆ° hot reloading çš„æ•ˆæœï¼›å¦å¤–é‚„æœ‰ gem_cache çš„ volumeï¼Œè®“ dependencies å¯ä»¥è¢«æ¸…ç†å’Œé‡å»ºè€Œä¸æœƒå¹²æ“¾ app çš„å…¶ä»–éƒ¨åˆ† stdin_open: è®“å®¹å™¨çš„æ¨™æº–è¼¸å…¥ä¿æŒæ‰“é–‹ tty: å°‡ Docker åˆ†é…ä¸€å€‹è™›æ“¬çµ‚ç«¯ï¼ˆpseudo-ttyï¼‰ä¸¦ç¶å®šåˆ°å®¹å™¨çš„æ¨™æº–è¼¸å…¥ä¸Šï¼Œè®“æˆ‘å€‘å¯ä»¥ä½¿ç”¨ byebug ä¾†é€²è¡Œ debug entrypoint: è¨­å®šç•¶å° docker-compose è£¡çš„ container ä¸‹æŒ‡ä»¤æ™‚çš„é€²å…¥é» command: ç•¶å•Ÿå‹•å®¹å™¨å¾Œè¦åŸ·è¡Œçš„æŒ‡ä»¤ env_file: ç’°å¢ƒè¨­å®šæª” environment: ç’°å¢ƒè®Šæ•¸ï¼Œå¯ä»¥è¢«å¯«åœ¨ç’°å¢ƒè¨­å®šæª”è£¡ï¼Œé€™é‚Šæœƒåˆ†é–‹å¯«æ˜¯å› ç‚ºå…¬å¸çš„å°ˆæ¡ˆè£¡å·²ç¶“æœ‰é è¨­çš„ç’°å¢ƒè¨­å®šæª”äº†ï¼Œç‚ºäº†ä¸æ´—æ‰åŸæœ¬çš„è¨­å®šæ‰å¦å¤–å¯«åœ¨é€™å€‹é …ç›®ä¸‹ã€‚ depends_on: é–‹å•Ÿé€™å€‹æœå‹™å‰éœ€è¦å…¶ä»–å“ªäº›æœå‹™çš„æ”¯æ´ AppName_app: build: context: . dockerfile: Dockerfile.dev container_name: AppName_app volumes: - .:/var/app - shared_data:/var/shared - gem_cache:/usr/local/bundle/gems networks: - development ports: - 3000:3000 stdin_open: true tty: true entrypoint: dev-entrypoint.sh command: - rails server -p 3000 -b 0.0.0.0 env_file: .env.example environment: RAILS_ENV: development WEBPACKER_DEV_SERVER_HOST: webpacker depends_on: - AppName_db - webpacker ActionMailer ç›¸é—œè¨­å®š å¦‚æœæœƒç”¨åˆ° ActionMailer çš„è©±éœ€è¦æŠŠ default_url_options æ”¹æˆ docker-compose ä¸ŠæŒ‡å®šçš„ ip addressï¼Œconfig/environments/development.rb: config.action_mailer.default_url_options = { host: &#39;0.0.0.0:3000&#39; } Test Docker-compose service è¨­å®š image: åŒæ¨£ä½¿ç”¨ app çš„ image volumes: èˆ‡ app çš„è¨­å®šç›¸åŒ AppName_test: image: AppName_AppName_app container_name: AppName_test volumes: - .:/var/app - shared_data:/var/shared - gem_cache:/usr/local/bundle/gems networks: - test ports: - 3001:3000 stdin_open: true tty: true entrypoint: test-entrypoint.sh command: [&quot;rails&quot;, &quot;-v&quot;] environment: RAILS_ENV: test WEBPACKER_DEV_SERVER_HOST: webpacker depends_on: - AppName_db - webpacker æ³¨æ„äº‹é … test service åœ¨å»ºç«‹å®Œä¹‹å¾Œæœ¬ä¾†å°±æœƒæ­»æ‰ åŸ·è¡Œæ¸¬è©¦ï¼šdocker-compose run --rm AppName_test rspec Webpacker æœ€å¾Œå°±æ˜¯è¢«æå¾—åŠæ­»ã„‰ webpacker äº†ï¼çµ‚æ–¼è¦çµæŸäº†ï¼ï¼ï¼ğŸ˜€ğŸ”ª Rails Appâ€™s Webpack settings: config/webpacker.yml åŸºæœ¬ä¸Šå°±æ˜¯éœ€è¦æŠŠ webpacker è¨­å®šæˆ docker-compose è£¡é…ç½®çš„ webpacker è·¯å¾‘ dev_server: host: webpacker (â†’ webpacker container name) public: 0.0.0.0:3035 (â†’ 0.0.0.0 ç‚º rails host) Webpack container settings: ä½¿ç”¨èˆ‡ rails app container ç›¸åŒçš„ Dockerfileã€ç›¸åŒçš„ volume Node.js è¨­å®š v14ï¼š Dockerfile.dev: ç”¨å…©å±¤ base image FROM node:14-alpine as node ä¸‹è¼‰ python2 RUN apk add --update --no-cache python2 &amp;&amp; ln -sf python2 /usr/bin/python FROM ruby:2.6.9-alpine æŠŠ node é‚£é‚Šçš„è¨­å®šè¤‡è£½éä¾†ï¼šCOPY --from=node . . è¦å…ˆåŸ·è¡Œ yarn install ç­‰æŒ‡ä»¤ï¼Œç”Ÿæˆ lock file Heap out of memory error: ref Set environment variable: - NODE_OPTIONS=--max_old_space_size=4096 webpacker: build: context: . dockerfile: Dockerfile.dev command: ruby bin/webpack-dev-server volumes: - shared_data:/var/shared - gem_cache:/usr/local/bundle/gems - .:/var/app environment: - NODE_OPTIONS=--max_old_space_size=4096 - NODE_ENV=development - RAILS_ENV=development - WEBPACKER_DEV_SERVER_HOST=0.0.0.0 ports: - &quot;3035:3035&quot; networks: - development æ‰€æœ‰æ”¹å‹•éçš„æª”æ¡ˆåˆ—è¡¨ config/cable.yml: url: &quot;redis://AppName_redis:6379/1&quot; config/database.yml: host: AppName_db(db service name) username: postgres password: postgres database: postgres config/environments/development.rb: config.action_mailer.default_url_options = { host: &#39;0.0.0.0:3000&#39; } config/settings.yml: host: localhost:3000 config/webpacker.yml: host: webpacker public: 0.0.0.0:3035 å¥½ã„Œâ€¦.å¤§æ¦‚å°±æ˜¯é€™æ¨£ï¼Œå¯«é€™ç¯‡çœŸçš„è±ªç´¯ï¼Œä½†æ˜¯å¯« k8s é‚£å…©ç¯‡å¥½åƒæœƒæ›´ç´¯ğŸ¥²ï¼Ÿï¼ˆå“­ã„Œ Reference Dockerfile base: Rails 6 development with Docker and Docker Compose Webpacker container: railsé–‹ç™¼ç’°å¢ƒå®¹å™¨åŒ–å¯¦æˆ°æŒ‡å—" />
<meta property="og:description" content="çµ‚æ–¼è£œåˆ°é€™ç¯‡äº†ï¼éœ€è¦ Dockerize çš„åŸå› å¾ˆç°¡å–®ï¼Œå› ç‚ºæœ¬åœ°ç’°å¢ƒè¢«æˆ‘è‡ªå·±æçˆ†äº†ğŸ˜€ ç°¡å–®ä¾†èªªå°±æ˜¯æˆ‘ä¸ƒå…«æœˆæ™‚é–‹ç™¼çš„å°ˆæ¡ˆï¼Œéš”äº†å››å€‹æœˆä¹‹å¾Œå†å›ä¾†ç¹¼çºŒæ”¯æ´æ™‚ï¼Œç™¼ç¾æ•´å€‹ç’°å¢ƒå‡ºä¸€å †å•é¡Œï¼ˆåŸºæœ¬ä¸Šéƒ½æ˜¯ M1 chips ç›¸é—œçš„ï¼‰ï¼Œä¸ç®¡æ€éº¼æ”¹ç’°å¢ƒè¨­å®šï¼Œä¸‹å®ŒæŒ‡ä»¤ä¹‹å¾Œæ°¸é éƒ½æœƒ crashï¼Œä¿®åˆ°æœ€å¾Œæˆ‘ä¹Ÿæ‡¶å¾—ç¹¼çºŒæ‰¾åŸå› äº†ï¼Œæƒ³èªªå‰›å­¸é Dockerï¼Œå…¶ä»–è³‡æ·±çš„åŒäº‹å€‘ä¹Ÿæœ‰é€™æ¨£æéï¼Œå°±æƒ³èªªä¸ç„¶æˆ‘ä¹Ÿä¾†è©¦è©¦çœ‹å§ï¼šï¼‰ é€™å€‹å°ˆæ¡ˆç”¨çš„ Ruby ç‰ˆæœ¬æ˜¯ 2.6.9ï¼ˆæ‰€ä»¥æ‰æœƒåœ¨ M1 çš„é›»è…¦ä¸Šå……æ»¿å•é¡Œï¼Œæœ€ä¸€é–‹å§‹åœ¨å®‰è£ 2.6.9 ç‰ˆçš„ Ruby æ™‚å°±å·²ç¶“å‹•éä¸€äº›æ‰‹è…³äº†ï¼šåœ¨ make binary å‡ºå•é¡Œçš„è©±å¯ä»¥å…ˆä¸‹ CFLAGS=&quot;-Wno-error=implicit-function-declaration&quot; rvm install x.x.x å†å®‰è£ by è€é—†ï¼‰é‚„æœƒéœ€è¦ç”¨åˆ° Redis, PostgresQL(DB), Webpackerï¼Œå°±éƒ½æ˜¯ä¸€äº›é–‹ç™¼ Rails æ™‚æ‰€éœ€æœ€åŸºæœ¬çš„é…ç½®ï¼Œä¸¦åœ¨å®¹å™¨åŒ–å¾Œä½¿ç”¨ docker-compose ä¾†å”èª¿é€™äº›é…ç½®ã€‚ Docker-compose ç°¡ä»‹ æ ¹æ“šå®˜ç¶²çš„ä»‹ç´¹ï¼Œdocker-compose æ˜¯ä¸€å€‹ç”¨æ–¼ç®¡ç†ã€åŸ·è¡Œå¤šå®¹å™¨ Docker Application çš„å·¥å…·ã€‚ä½¿ç”¨ docker-compose æ™‚éœ€è¦ç”¨ YAML æª”ä¾†å®šç¾© application çš„å„å€‹ servicesï¼Œæ¥ä¸‹ä¾†å³å¯é€éä¸€å€‹æŒ‡ä»¤ã€å¾é…ç½®ä¸­å‰µå»ºä¸¦å•Ÿå‹•æ‰€æœ‰æœå‹™ã€‚é€™æ¨£åšçš„å¥½è™•æ˜¯å¯ä»¥åŒæ™‚å®šç¾©ã€å”èª¿æ‰€æœ‰æœå‹™ï¼Œå¯ä»¥é¿å…åœ¨å€‹åˆ¥é–‹å•Ÿå®¹å™¨æ™‚é‚„è¦åšé¡å¤–çš„è¨­å®šï¼Œæé«˜é–‹ç™¼çš„æ•ˆç‡ã€‚ åŸºæœ¬ä¸Šåœ¨è¨­å®š docker-compose æ™‚ï¼Œéœ€è¦å…ˆæœ‰å„å€‹ service container è¦ç”¨çš„ imageï¼Œä¸è«–æ˜¯è‡ªå·±å¯«çš„ Dockerfileï¼Œæˆ–è€…æ˜¯å¾ docker hub ä¸Š pull ä¸‹ä¾†çš„ image éƒ½å¯ä»¥ã€‚æ¥ä¸‹ä¾†å°±æ˜¯ docker-compose.yml çš„æ’°å¯«ï¼Œéœ€è¦å…ˆå°æ•´å€‹æ‡‰ç”¨ç¨‹å¼åšå…¨åŸŸçš„è¨­å®šï¼ˆå¦‚ä½¿ç”¨çš„ docker-compose ç‰ˆæœ¬ã€è¦æœ‰å“ªäº› networks ç­‰ï¼‰ï¼Œæ¥è‘—å†å°å€‹åˆ¥çš„ services åšç´°ç¯€è¨­å®šï¼ˆé¸ç”¨å“ªè£¡çš„ imageã€port mappingã€å°ˆæ¡ˆçš„ç’°å¢ƒè®Šæ•¸â€¦ç­‰ï¼‰ Docker-compose Configurations åœ¨ docker-compose.yml çš„é–‹é ­éœ€è¦å…ˆå°æ•´å€‹ application åšæœ€åŸºæœ¬çš„è¨­å®šï¼Œä½†å› ç‚ºé€™é‚Šåªæ˜¯é–‹ç™¼ç’°å¢ƒè€Œå·²ï¼Œå› æ­¤å°±åªæœ‰ç°¡å–®åš Networks &amp; Volumes çš„è¨­å®šè€Œå·²ï¼Œä¸»è¦å°±æ˜¯é–‹å…©å€‹ Networks(development &amp; test) èˆ‡å››å€‹ Volumes(db_data, gem_cache, shared_data &amp; packs)ã€‚ Basic Setups Version: æŒ‡å®šè¦ä½¿ç”¨çš„ docker-compose ç‰ˆæœ¬ï¼Œç›®å‰çœ‹åˆ°å¤§å¤šæ•¸çš„æ•™å­¸éƒ½æ˜¯ç”¨ç¬¬ä¸‰ç‰ˆ Networks: åœ¨å»ºèµ· application ä¹‹å¾Œï¼Œdocker-compose æœƒæŠŠæ‰€æœ‰å®¹å™¨éƒ½ä¸Ÿåˆ°ä¸€å€‹ default network ä¸­ï¼Œè€Œåœ¨åŒå€‹ network è£¡çš„å®¹å™¨éƒ½äº’ç›¸ reachableã€‚å¦‚æœä¸æƒ³ä½¿ç”¨é è¨­çš„ default network çš„è©±ä¹Ÿèƒ½è‡ªå·±å¦å¤–å®£å‘Šï¼Œä¸¦å‰µé€ æ›´è¤‡é›œçš„ network topologyã€‚åŸºæœ¬ä¸Šå¯ä»¥é€éé€™æ¨£çš„è¨­å®šé”åˆ°å€éš”ç’°å¢ƒçš„æ•ˆæœï¼Œé€™ä¹Ÿæ˜¯ç‚ºä»€éº¼é€™å€‹å°ˆæ¡ˆçš„ networks è¨­ç½®è¦åˆ†æˆ development èˆ‡ test çš„åŸå›  Volumes: çµ±ä¸€å®£å‘Šæ‰€æœ‰ images æœƒç”¨åˆ°çš„ volumesï¼Œå› ç‚ºæœ‰äº› services å¯èƒ½æœƒéœ€è¦å…±ç”¨ volumes(åƒæ˜¯é€™å€‹å°ˆæ¡ˆè£¡çš„ shared_data volume å°±æ˜¯æ‹¿ä¾†è®“æ‰€æœ‰ containers å…±ç”¨çš„ volume)ã€‚ä¸»è¦çš„åŠŸç”¨æ˜¯åœ¨é–‹ç™¼çš„æ™‚å€™å¯ä»¥åŒæ­¥å°‡æœ¬åœ°ç«¯ä¿®æ”¹çš„å…§å®¹ï¼Œmapping åˆ°å®¹å™¨è£¡çš„å°ˆæ¡ˆï¼Œåœ¨é–‹ç™¼ä¸Šæ¯”è¼ƒç¯€çœæ™‚é–“ã€‚ Mapping çš„æ ¼å¼ï¼š å¤–ç•Œ:å®¹å™¨ Services Configurations è·Ÿä¸Šé¢æåˆ°çš„é…ç½®ä¸€æ¨£ï¼Œå†åŠ ä¸Šéœ€è¦æ¸¬è©¦ç”¨çš„ç’°å¢ƒä¹‹å¾Œï¼Œæˆ‘å€‘åœ¨ docker-compose è£¡ç¸½å…±æœƒéœ€è¦ä»¥ä¸‹äº”å€‹æœå‹™: redis, db(postgres), app, test, webpacker Redis Docker-compose service è¨­å®š image: å¯ä»¥ç›´æ¥é¸ç”¨ docker hub ä¸Šçš„ redis image command: ç•¶é€™å€‹æœå‹™é–‹å§‹é‹è¡Œæ™‚è¦åŸ·è¡Œçš„æŒ‡ä»¤ï¼Œaka åŸ·è¡Œ redis server çš„æŒ‡ä»¤ redis-server networks: é€™é‚Šå› ç‚ºé–‹ç™¼èˆ‡æ¸¬è©¦ç’°å¢ƒéƒ½æœƒç”¨åˆ° redisï¼Œæ‰€ä»¥å…©å€‹ network éƒ½è¦æ”¾é€²ä¾† volumes: é€™é‚Šåªéœ€è¦ shared_data AppName_redis: image: redis:6.0-alpine command: redis-server networks: - development - test volumes: - shared_data:/var/shared/redis Rails App è¨­å®š éœ€è¦å°‡ app å…§è¨­å®šçš„ redis url æ”¹æˆ docker-compose è£¡æŒ‡å®šçš„ service name æ ¼å¼ï¼š&quot;redis://AppName_redis:6379/1&quot; (development &amp; test å…©å€‹ç’°å¢ƒä¸‹éƒ½éœ€è¦æ”¹) Reference DB(PostgresQL) Docker-compose service è¨­å®š image: é€™é‚Šä¹Ÿæ˜¯ç›´æ¥é¸ç”¨ docker hub ä¸Šçš„ postgres container volumes: é™¤äº†æ‰€æœ‰ service å…±ç”¨çš„ shared_data å¤–ï¼Œé‚„éœ€è¦æŒ‡å®šä¸€å€‹ç”¨ä¾†å„²å­˜è³‡æ–™åº«è³‡è¨Šçš„ volume(db_data) networks: é€™é‚Šä¹Ÿæ˜¯å…©å€‹ç’°å¢ƒéƒ½æœƒéœ€è¦ dbï¼Œå› æ­¤å…©å€‹ network éƒ½éœ€è¦æ”¾ environment: ç”¨ä¾†è¨­å®šé€™å€‹ container çš„ç’°å¢ƒè®Šæ•¸ï¼Œé€™é‚Šéœ€è¦è¨­å®šçš„æ˜¯è³‡æ–™åº«çš„å¸³è™Ÿå¯†ç¢¼ï¼Œè€Œå®˜æ–¹ image é è¨­çš„å¸³è™Ÿç‚º postgres å¯†ç¢¼ç‚º passwordï¼›å› ç‚ºé€™é‚Šåªæ˜¯æ¸¬è©¦ç’°å¢ƒï¼Œæ‰€ä»¥ç”¨é è¨­çš„æ²’é—œä¿‚ï¼Œä½†å¦‚æœä¸Š staging æˆ– production é€™ç¨®æ­£å¼çš„ç’°å¢ƒæ™‚ï¼Œå°±éœ€è¦å¦å¤–ç”¨ CI å·¥å…·åšè¨­å®šã€‚ ports: åš port mapping ç”¨ï¼Œè®“è³‡æ–™åº«å¯ä»¥è¢«å¤–ç•Œè®€å– AppName_db: image: postgres:14-alpine container_name: AppName_db volumes: - db_data:/var/lib/postgresql/data - shared_data:/var/shared networks: - development - test environment: POSTGRES_USER: postgres POSTGRES_PASSWORD: password ports: - 5432:5432 Rails App è¨­å®šï¼šconfig/database.yml éœ€è¦å°‡æ•´å€‹ app è¦é€£çµçš„ db æ”¹æˆ docker-compose ä¸Šçš„ serviceï¼Œä¸¦ä¸”è¨­å®šå¸³è™Ÿå¯†ç¢¼ host: AppName_db username: postgres -&gt; image default setting password: password -&gt; image default setting é–‹å•Ÿæ•´å€‹æœå‹™å¾Œè¦è¨˜å¾—å…ˆä¸‹ bundle exec rake db:create ä¾†å‰µå»ºæœƒç”¨åˆ°çš„ dbï¼Œå¦å‰‡è³‡æ–™åº«çš„å…§å®¹æœƒé•·åœ¨ä¸€å€‹å¾ˆå¥‡æ€ªçš„ä½ç½®ï¼Œå¾ŒçºŒå¦‚æœè¦ç”¨ rake çš„æŒ‡ä»¤æ“ä½œè³‡æ–™åº«æœƒæ²’è¾¦æ³•è®€å–åˆ°æ­£ç¢ºçš„è³‡æ–™ App Dockerfile for Rails App 2 base images node:14-alpine, ruby:2.6.9-alpine: é€™é‚Šæœƒç”¨åˆ°å…©å±¤ base image æ˜¯å› ç‚ºå°ˆæ¡ˆè£¡çš„ node ç‰ˆæœ¬æ˜¯ 14ï¼Œä¸éå¦‚æœåªç”¨ apk add å»ä¸‹è¼‰ node çš„è©±éƒ½æœƒè¼‰åˆ°æœ€æ–°çš„ 16 ç‰ˆï¼Œå› æ­¤æœ€å¾Œæ±ºå®šè¼‰å…©å±¤ base imageï¼Œä¸¦ä¸”æŠŠå¸¶ 14 ç‰ˆçš„è¨­å®šè¤‡è£½åˆ° ruby image è£¡ï¼Œnode çš„éƒ¨åˆ†å°±èƒ½æ­£å¸¸é‹ä½œäº† Env variables Copy entrypoint scripts and grant execution permission Copy everything from node image Install all dependencies(not including node) é€™é‚Šè¦é¿é–‹ä¸‹è¼‰ nodeï¼Œä»¥å…æŠŠ 14 ç‰ˆçš„è¨­å®šè¦†è“‹æ‰ FROM node:14-alpine as node RUN apk add --update --no-cache python2 &amp;&amp; ln -sf python2 /usr/bin/python FROM ruby:2.6.9-alpine ENV APP_PATH /var/app ENV BUNDLE_VERSION 2.2.33 ENV BUNDLE_PATH /usr/local/bundle/gems ENV TMP_PATH /tmp/ ENV RAILS_LOG_TO_STDOUT true ENV RAILS_PORT 3000 # copy entrypoint scripts and grant execution permissions COPY ./dev-docker-entrypoint.sh /usr/local/bin/dev-entrypoint.sh COPY ./test-docker-entrypoint.sh /usr/local/bin/test-entrypoint.sh COPY --from=node . . RUN chmod +x /usr/local/bin/dev-entrypoint.sh &amp;&amp; chmod +x /usr/local/bin/test-entrypoint.sh # install dependencies for application RUN apk -U add --no-cache \ build-base \ git \ postgresql-dev \ postgresql-client \ libxml2-dev \ libidn-dev \ libxslt-dev \ yarn \ imagemagick6 \ imagemagick6-c++ \ imagemagick6-dev \ imagemagick6-libs \ tzdata \ less \ curl \ bash \ &amp;&amp; rm -rf /var/cache/apk/* \ &amp;&amp; mkdir -p $APP_PATH RUN gem install bundler --version &quot;$BUNDLE_VERSION&quot; \ &amp;&amp; rm -rf $GEM_HOME/cache/* RUN yarn install --check-file # navigate to app directory WORKDIR $APP_PATH EXPOSE $RAILS_PORT ENTRYPOINT [ &quot;bundle&quot;, &quot;exec&quot; ] Docker-compose service è¨­å®š image: ä½¿ç”¨ä¸Šè¿°çš„ Dockerfile å»ºå‡ºçš„ imageï¼Œè·Ÿä¸Šé¢å¹¾å€‹æœå‹™ä¸ä¸€æ¨£ï¼Œè¦ä½¿ç”¨ build ä¾†æŒ‡å®šå»ºç«‹ image çš„è³‡æ–™å¤¾é‚„æœ‰ Dockerfile çš„ä½ç½® volumes: é™¤äº†å…±ç”¨çš„ shared_data å¤–ï¼Œé‚„æœ‰æ•´å€‹å°ˆæ¡ˆçš„ mappingï¼Œéœ€è¦å°æ‡‰åˆ°å‰›å‰› Dockerfile è£¡å®šç¾©çš„ $APP_PATH ä¸Šï¼Œè—‰ç”± Docker bind mounts é”åˆ° hot reloading çš„æ•ˆæœï¼›å¦å¤–é‚„æœ‰ gem_cache çš„ volumeï¼Œè®“ dependencies å¯ä»¥è¢«æ¸…ç†å’Œé‡å»ºè€Œä¸æœƒå¹²æ“¾ app çš„å…¶ä»–éƒ¨åˆ† stdin_open: è®“å®¹å™¨çš„æ¨™æº–è¼¸å…¥ä¿æŒæ‰“é–‹ tty: å°‡ Docker åˆ†é…ä¸€å€‹è™›æ“¬çµ‚ç«¯ï¼ˆpseudo-ttyï¼‰ä¸¦ç¶å®šåˆ°å®¹å™¨çš„æ¨™æº–è¼¸å…¥ä¸Šï¼Œè®“æˆ‘å€‘å¯ä»¥ä½¿ç”¨ byebug ä¾†é€²è¡Œ debug entrypoint: è¨­å®šç•¶å° docker-compose è£¡çš„ container ä¸‹æŒ‡ä»¤æ™‚çš„é€²å…¥é» command: ç•¶å•Ÿå‹•å®¹å™¨å¾Œè¦åŸ·è¡Œçš„æŒ‡ä»¤ env_file: ç’°å¢ƒè¨­å®šæª” environment: ç’°å¢ƒè®Šæ•¸ï¼Œå¯ä»¥è¢«å¯«åœ¨ç’°å¢ƒè¨­å®šæª”è£¡ï¼Œé€™é‚Šæœƒåˆ†é–‹å¯«æ˜¯å› ç‚ºå…¬å¸çš„å°ˆæ¡ˆè£¡å·²ç¶“æœ‰é è¨­çš„ç’°å¢ƒè¨­å®šæª”äº†ï¼Œç‚ºäº†ä¸æ´—æ‰åŸæœ¬çš„è¨­å®šæ‰å¦å¤–å¯«åœ¨é€™å€‹é …ç›®ä¸‹ã€‚ depends_on: é–‹å•Ÿé€™å€‹æœå‹™å‰éœ€è¦å…¶ä»–å“ªäº›æœå‹™çš„æ”¯æ´ AppName_app: build: context: . dockerfile: Dockerfile.dev container_name: AppName_app volumes: - .:/var/app - shared_data:/var/shared - gem_cache:/usr/local/bundle/gems networks: - development ports: - 3000:3000 stdin_open: true tty: true entrypoint: dev-entrypoint.sh command: - rails server -p 3000 -b 0.0.0.0 env_file: .env.example environment: RAILS_ENV: development WEBPACKER_DEV_SERVER_HOST: webpacker depends_on: - AppName_db - webpacker ActionMailer ç›¸é—œè¨­å®š å¦‚æœæœƒç”¨åˆ° ActionMailer çš„è©±éœ€è¦æŠŠ default_url_options æ”¹æˆ docker-compose ä¸ŠæŒ‡å®šçš„ ip addressï¼Œconfig/environments/development.rb: config.action_mailer.default_url_options = { host: &#39;0.0.0.0:3000&#39; } Test Docker-compose service è¨­å®š image: åŒæ¨£ä½¿ç”¨ app çš„ image volumes: èˆ‡ app çš„è¨­å®šç›¸åŒ AppName_test: image: AppName_AppName_app container_name: AppName_test volumes: - .:/var/app - shared_data:/var/shared - gem_cache:/usr/local/bundle/gems networks: - test ports: - 3001:3000 stdin_open: true tty: true entrypoint: test-entrypoint.sh command: [&quot;rails&quot;, &quot;-v&quot;] environment: RAILS_ENV: test WEBPACKER_DEV_SERVER_HOST: webpacker depends_on: - AppName_db - webpacker æ³¨æ„äº‹é … test service åœ¨å»ºç«‹å®Œä¹‹å¾Œæœ¬ä¾†å°±æœƒæ­»æ‰ åŸ·è¡Œæ¸¬è©¦ï¼šdocker-compose run --rm AppName_test rspec Webpacker æœ€å¾Œå°±æ˜¯è¢«æå¾—åŠæ­»ã„‰ webpacker äº†ï¼çµ‚æ–¼è¦çµæŸäº†ï¼ï¼ï¼ğŸ˜€ğŸ”ª Rails Appâ€™s Webpack settings: config/webpacker.yml åŸºæœ¬ä¸Šå°±æ˜¯éœ€è¦æŠŠ webpacker è¨­å®šæˆ docker-compose è£¡é…ç½®çš„ webpacker è·¯å¾‘ dev_server: host: webpacker (â†’ webpacker container name) public: 0.0.0.0:3035 (â†’ 0.0.0.0 ç‚º rails host) Webpack container settings: ä½¿ç”¨èˆ‡ rails app container ç›¸åŒçš„ Dockerfileã€ç›¸åŒçš„ volume Node.js è¨­å®š v14ï¼š Dockerfile.dev: ç”¨å…©å±¤ base image FROM node:14-alpine as node ä¸‹è¼‰ python2 RUN apk add --update --no-cache python2 &amp;&amp; ln -sf python2 /usr/bin/python FROM ruby:2.6.9-alpine æŠŠ node é‚£é‚Šçš„è¨­å®šè¤‡è£½éä¾†ï¼šCOPY --from=node . . è¦å…ˆåŸ·è¡Œ yarn install ç­‰æŒ‡ä»¤ï¼Œç”Ÿæˆ lock file Heap out of memory error: ref Set environment variable: - NODE_OPTIONS=--max_old_space_size=4096 webpacker: build: context: . dockerfile: Dockerfile.dev command: ruby bin/webpack-dev-server volumes: - shared_data:/var/shared - gem_cache:/usr/local/bundle/gems - .:/var/app environment: - NODE_OPTIONS=--max_old_space_size=4096 - NODE_ENV=development - RAILS_ENV=development - WEBPACKER_DEV_SERVER_HOST=0.0.0.0 ports: - &quot;3035:3035&quot; networks: - development æ‰€æœ‰æ”¹å‹•éçš„æª”æ¡ˆåˆ—è¡¨ config/cable.yml: url: &quot;redis://AppName_redis:6379/1&quot; config/database.yml: host: AppName_db(db service name) username: postgres password: postgres database: postgres config/environments/development.rb: config.action_mailer.default_url_options = { host: &#39;0.0.0.0:3000&#39; } config/settings.yml: host: localhost:3000 config/webpacker.yml: host: webpacker public: 0.0.0.0:3035 å¥½ã„Œâ€¦.å¤§æ¦‚å°±æ˜¯é€™æ¨£ï¼Œå¯«é€™ç¯‡çœŸçš„è±ªç´¯ï¼Œä½†æ˜¯å¯« k8s é‚£å…©ç¯‡å¥½åƒæœƒæ›´ç´¯ğŸ¥²ï¼Ÿï¼ˆå“­ã„Œ Reference Dockerfile base: Rails 6 development with Docker and Docker Compose Webpacker container: railsé–‹ç™¼ç’°å¢ƒå®¹å™¨åŒ–å¯¦æˆ°æŒ‡å—" />
<link rel="canonical" href="https://jqlynchien713.github.io/2022/02/19/dockerize-rails.html" />
<meta property="og:url" content="https://jqlynchien713.github.io/2022/02/19/dockerize-rails.html" />
<meta property="og:site_name" content="Jacquelynâ€™s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-02-19T14:51:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Dockerize Rails App" />
<script type="application/ld+json">
{"description":"çµ‚æ–¼è£œåˆ°é€™ç¯‡äº†ï¼éœ€è¦ Dockerize çš„åŸå› å¾ˆç°¡å–®ï¼Œå› ç‚ºæœ¬åœ°ç’°å¢ƒè¢«æˆ‘è‡ªå·±æçˆ†äº†ğŸ˜€ ç°¡å–®ä¾†èªªå°±æ˜¯æˆ‘ä¸ƒå…«æœˆæ™‚é–‹ç™¼çš„å°ˆæ¡ˆï¼Œéš”äº†å››å€‹æœˆä¹‹å¾Œå†å›ä¾†ç¹¼çºŒæ”¯æ´æ™‚ï¼Œç™¼ç¾æ•´å€‹ç’°å¢ƒå‡ºä¸€å †å•é¡Œï¼ˆåŸºæœ¬ä¸Šéƒ½æ˜¯ M1 chips ç›¸é—œçš„ï¼‰ï¼Œä¸ç®¡æ€éº¼æ”¹ç’°å¢ƒè¨­å®šï¼Œä¸‹å®ŒæŒ‡ä»¤ä¹‹å¾Œæ°¸é éƒ½æœƒ crashï¼Œä¿®åˆ°æœ€å¾Œæˆ‘ä¹Ÿæ‡¶å¾—ç¹¼çºŒæ‰¾åŸå› äº†ï¼Œæƒ³èªªå‰›å­¸é Dockerï¼Œå…¶ä»–è³‡æ·±çš„åŒäº‹å€‘ä¹Ÿæœ‰é€™æ¨£æéï¼Œå°±æƒ³èªªä¸ç„¶æˆ‘ä¹Ÿä¾†è©¦è©¦çœ‹å§ï¼šï¼‰ é€™å€‹å°ˆæ¡ˆç”¨çš„ Ruby ç‰ˆæœ¬æ˜¯ 2.6.9ï¼ˆæ‰€ä»¥æ‰æœƒåœ¨ M1 çš„é›»è…¦ä¸Šå……æ»¿å•é¡Œï¼Œæœ€ä¸€é–‹å§‹åœ¨å®‰è£ 2.6.9 ç‰ˆçš„ Ruby æ™‚å°±å·²ç¶“å‹•éä¸€äº›æ‰‹è…³äº†ï¼šåœ¨ make binary å‡ºå•é¡Œçš„è©±å¯ä»¥å…ˆä¸‹ CFLAGS=&quot;-Wno-error=implicit-function-declaration&quot; rvm install x.x.x å†å®‰è£ by è€é—†ï¼‰é‚„æœƒéœ€è¦ç”¨åˆ° Redis, PostgresQL(DB), Webpackerï¼Œå°±éƒ½æ˜¯ä¸€äº›é–‹ç™¼ Rails æ™‚æ‰€éœ€æœ€åŸºæœ¬çš„é…ç½®ï¼Œä¸¦åœ¨å®¹å™¨åŒ–å¾Œä½¿ç”¨ docker-compose ä¾†å”èª¿é€™äº›é…ç½®ã€‚ Docker-compose ç°¡ä»‹ æ ¹æ“šå®˜ç¶²çš„ä»‹ç´¹ï¼Œdocker-compose æ˜¯ä¸€å€‹ç”¨æ–¼ç®¡ç†ã€åŸ·è¡Œå¤šå®¹å™¨ Docker Application çš„å·¥å…·ã€‚ä½¿ç”¨ docker-compose æ™‚éœ€è¦ç”¨ YAML æª”ä¾†å®šç¾© application çš„å„å€‹ servicesï¼Œæ¥ä¸‹ä¾†å³å¯é€éä¸€å€‹æŒ‡ä»¤ã€å¾é…ç½®ä¸­å‰µå»ºä¸¦å•Ÿå‹•æ‰€æœ‰æœå‹™ã€‚é€™æ¨£åšçš„å¥½è™•æ˜¯å¯ä»¥åŒæ™‚å®šç¾©ã€å”èª¿æ‰€æœ‰æœå‹™ï¼Œå¯ä»¥é¿å…åœ¨å€‹åˆ¥é–‹å•Ÿå®¹å™¨æ™‚é‚„è¦åšé¡å¤–çš„è¨­å®šï¼Œæé«˜é–‹ç™¼çš„æ•ˆç‡ã€‚ åŸºæœ¬ä¸Šåœ¨è¨­å®š docker-compose æ™‚ï¼Œéœ€è¦å…ˆæœ‰å„å€‹ service container è¦ç”¨çš„ imageï¼Œä¸è«–æ˜¯è‡ªå·±å¯«çš„ Dockerfileï¼Œæˆ–è€…æ˜¯å¾ docker hub ä¸Š pull ä¸‹ä¾†çš„ image éƒ½å¯ä»¥ã€‚æ¥ä¸‹ä¾†å°±æ˜¯ docker-compose.yml çš„æ’°å¯«ï¼Œéœ€è¦å…ˆå°æ•´å€‹æ‡‰ç”¨ç¨‹å¼åšå…¨åŸŸçš„è¨­å®šï¼ˆå¦‚ä½¿ç”¨çš„ docker-compose ç‰ˆæœ¬ã€è¦æœ‰å“ªäº› networks ç­‰ï¼‰ï¼Œæ¥è‘—å†å°å€‹åˆ¥çš„ services åšç´°ç¯€è¨­å®šï¼ˆé¸ç”¨å“ªè£¡çš„ imageã€port mappingã€å°ˆæ¡ˆçš„ç’°å¢ƒè®Šæ•¸â€¦ç­‰ï¼‰ Docker-compose Configurations åœ¨ docker-compose.yml çš„é–‹é ­éœ€è¦å…ˆå°æ•´å€‹ application åšæœ€åŸºæœ¬çš„è¨­å®šï¼Œä½†å› ç‚ºé€™é‚Šåªæ˜¯é–‹ç™¼ç’°å¢ƒè€Œå·²ï¼Œå› æ­¤å°±åªæœ‰ç°¡å–®åš Networks &amp; Volumes çš„è¨­å®šè€Œå·²ï¼Œä¸»è¦å°±æ˜¯é–‹å…©å€‹ Networks(development &amp; test) èˆ‡å››å€‹ Volumes(db_data, gem_cache, shared_data &amp; packs)ã€‚ Basic Setups Version: æŒ‡å®šè¦ä½¿ç”¨çš„ docker-compose ç‰ˆæœ¬ï¼Œç›®å‰çœ‹åˆ°å¤§å¤šæ•¸çš„æ•™å­¸éƒ½æ˜¯ç”¨ç¬¬ä¸‰ç‰ˆ Networks: åœ¨å»ºèµ· application ä¹‹å¾Œï¼Œdocker-compose æœƒæŠŠæ‰€æœ‰å®¹å™¨éƒ½ä¸Ÿåˆ°ä¸€å€‹ default network ä¸­ï¼Œè€Œåœ¨åŒå€‹ network è£¡çš„å®¹å™¨éƒ½äº’ç›¸ reachableã€‚å¦‚æœä¸æƒ³ä½¿ç”¨é è¨­çš„ default network çš„è©±ä¹Ÿèƒ½è‡ªå·±å¦å¤–å®£å‘Šï¼Œä¸¦å‰µé€ æ›´è¤‡é›œçš„ network topologyã€‚åŸºæœ¬ä¸Šå¯ä»¥é€éé€™æ¨£çš„è¨­å®šé”åˆ°å€éš”ç’°å¢ƒçš„æ•ˆæœï¼Œé€™ä¹Ÿæ˜¯ç‚ºä»€éº¼é€™å€‹å°ˆæ¡ˆçš„ networks è¨­ç½®è¦åˆ†æˆ development èˆ‡ test çš„åŸå›  Volumes: çµ±ä¸€å®£å‘Šæ‰€æœ‰ images æœƒç”¨åˆ°çš„ volumesï¼Œå› ç‚ºæœ‰äº› services å¯èƒ½æœƒéœ€è¦å…±ç”¨ volumes(åƒæ˜¯é€™å€‹å°ˆæ¡ˆè£¡çš„ shared_data volume å°±æ˜¯æ‹¿ä¾†è®“æ‰€æœ‰ containers å…±ç”¨çš„ volume)ã€‚ä¸»è¦çš„åŠŸç”¨æ˜¯åœ¨é–‹ç™¼çš„æ™‚å€™å¯ä»¥åŒæ­¥å°‡æœ¬åœ°ç«¯ä¿®æ”¹çš„å…§å®¹ï¼Œmapping åˆ°å®¹å™¨è£¡çš„å°ˆæ¡ˆï¼Œåœ¨é–‹ç™¼ä¸Šæ¯”è¼ƒç¯€çœæ™‚é–“ã€‚ Mapping çš„æ ¼å¼ï¼š å¤–ç•Œ:å®¹å™¨ Services Configurations è·Ÿä¸Šé¢æåˆ°çš„é…ç½®ä¸€æ¨£ï¼Œå†åŠ ä¸Šéœ€è¦æ¸¬è©¦ç”¨çš„ç’°å¢ƒä¹‹å¾Œï¼Œæˆ‘å€‘åœ¨ docker-compose è£¡ç¸½å…±æœƒéœ€è¦ä»¥ä¸‹äº”å€‹æœå‹™: redis, db(postgres), app, test, webpacker Redis Docker-compose service è¨­å®š image: å¯ä»¥ç›´æ¥é¸ç”¨ docker hub ä¸Šçš„ redis image command: ç•¶é€™å€‹æœå‹™é–‹å§‹é‹è¡Œæ™‚è¦åŸ·è¡Œçš„æŒ‡ä»¤ï¼Œaka åŸ·è¡Œ redis server çš„æŒ‡ä»¤ redis-server networks: é€™é‚Šå› ç‚ºé–‹ç™¼èˆ‡æ¸¬è©¦ç’°å¢ƒéƒ½æœƒç”¨åˆ° redisï¼Œæ‰€ä»¥å…©å€‹ network éƒ½è¦æ”¾é€²ä¾† volumes: é€™é‚Šåªéœ€è¦ shared_data AppName_redis: image: redis:6.0-alpine command: redis-server networks: - development - test volumes: - shared_data:/var/shared/redis Rails App è¨­å®š éœ€è¦å°‡ app å…§è¨­å®šçš„ redis url æ”¹æˆ docker-compose è£¡æŒ‡å®šçš„ service name æ ¼å¼ï¼š&quot;redis://AppName_redis:6379/1&quot; (development &amp; test å…©å€‹ç’°å¢ƒä¸‹éƒ½éœ€è¦æ”¹) Reference DB(PostgresQL) Docker-compose service è¨­å®š image: é€™é‚Šä¹Ÿæ˜¯ç›´æ¥é¸ç”¨ docker hub ä¸Šçš„ postgres container volumes: é™¤äº†æ‰€æœ‰ service å…±ç”¨çš„ shared_data å¤–ï¼Œé‚„éœ€è¦æŒ‡å®šä¸€å€‹ç”¨ä¾†å„²å­˜è³‡æ–™åº«è³‡è¨Šçš„ volume(db_data) networks: é€™é‚Šä¹Ÿæ˜¯å…©å€‹ç’°å¢ƒéƒ½æœƒéœ€è¦ dbï¼Œå› æ­¤å…©å€‹ network éƒ½éœ€è¦æ”¾ environment: ç”¨ä¾†è¨­å®šé€™å€‹ container çš„ç’°å¢ƒè®Šæ•¸ï¼Œé€™é‚Šéœ€è¦è¨­å®šçš„æ˜¯è³‡æ–™åº«çš„å¸³è™Ÿå¯†ç¢¼ï¼Œè€Œå®˜æ–¹ image é è¨­çš„å¸³è™Ÿç‚º postgres å¯†ç¢¼ç‚º passwordï¼›å› ç‚ºé€™é‚Šåªæ˜¯æ¸¬è©¦ç’°å¢ƒï¼Œæ‰€ä»¥ç”¨é è¨­çš„æ²’é—œä¿‚ï¼Œä½†å¦‚æœä¸Š staging æˆ– production é€™ç¨®æ­£å¼çš„ç’°å¢ƒæ™‚ï¼Œå°±éœ€è¦å¦å¤–ç”¨ CI å·¥å…·åšè¨­å®šã€‚ ports: åš port mapping ç”¨ï¼Œè®“è³‡æ–™åº«å¯ä»¥è¢«å¤–ç•Œè®€å– AppName_db: image: postgres:14-alpine container_name: AppName_db volumes: - db_data:/var/lib/postgresql/data - shared_data:/var/shared networks: - development - test environment: POSTGRES_USER: postgres POSTGRES_PASSWORD: password ports: - 5432:5432 Rails App è¨­å®šï¼šconfig/database.yml éœ€è¦å°‡æ•´å€‹ app è¦é€£çµçš„ db æ”¹æˆ docker-compose ä¸Šçš„ serviceï¼Œä¸¦ä¸”è¨­å®šå¸³è™Ÿå¯†ç¢¼ host: AppName_db username: postgres -&gt; image default setting password: password -&gt; image default setting é–‹å•Ÿæ•´å€‹æœå‹™å¾Œè¦è¨˜å¾—å…ˆä¸‹ bundle exec rake db:create ä¾†å‰µå»ºæœƒç”¨åˆ°çš„ dbï¼Œå¦å‰‡è³‡æ–™åº«çš„å…§å®¹æœƒé•·åœ¨ä¸€å€‹å¾ˆå¥‡æ€ªçš„ä½ç½®ï¼Œå¾ŒçºŒå¦‚æœè¦ç”¨ rake çš„æŒ‡ä»¤æ“ä½œè³‡æ–™åº«æœƒæ²’è¾¦æ³•è®€å–åˆ°æ­£ç¢ºçš„è³‡æ–™ App Dockerfile for Rails App 2 base images node:14-alpine, ruby:2.6.9-alpine: é€™é‚Šæœƒç”¨åˆ°å…©å±¤ base image æ˜¯å› ç‚ºå°ˆæ¡ˆè£¡çš„ node ç‰ˆæœ¬æ˜¯ 14ï¼Œä¸éå¦‚æœåªç”¨ apk add å»ä¸‹è¼‰ node çš„è©±éƒ½æœƒè¼‰åˆ°æœ€æ–°çš„ 16 ç‰ˆï¼Œå› æ­¤æœ€å¾Œæ±ºå®šè¼‰å…©å±¤ base imageï¼Œä¸¦ä¸”æŠŠå¸¶ 14 ç‰ˆçš„è¨­å®šè¤‡è£½åˆ° ruby image è£¡ï¼Œnode çš„éƒ¨åˆ†å°±èƒ½æ­£å¸¸é‹ä½œäº† Env variables Copy entrypoint scripts and grant execution permission Copy everything from node image Install all dependencies(not including node) é€™é‚Šè¦é¿é–‹ä¸‹è¼‰ nodeï¼Œä»¥å…æŠŠ 14 ç‰ˆçš„è¨­å®šè¦†è“‹æ‰ FROM node:14-alpine as node RUN apk add --update --no-cache python2 &amp;&amp; ln -sf python2 /usr/bin/python FROM ruby:2.6.9-alpine ENV APP_PATH /var/app ENV BUNDLE_VERSION 2.2.33 ENV BUNDLE_PATH /usr/local/bundle/gems ENV TMP_PATH /tmp/ ENV RAILS_LOG_TO_STDOUT true ENV RAILS_PORT 3000 # copy entrypoint scripts and grant execution permissions COPY ./dev-docker-entrypoint.sh /usr/local/bin/dev-entrypoint.sh COPY ./test-docker-entrypoint.sh /usr/local/bin/test-entrypoint.sh COPY --from=node . . RUN chmod +x /usr/local/bin/dev-entrypoint.sh &amp;&amp; chmod +x /usr/local/bin/test-entrypoint.sh # install dependencies for application RUN apk -U add --no-cache \\ build-base \\ git \\ postgresql-dev \\ postgresql-client \\ libxml2-dev \\ libidn-dev \\ libxslt-dev \\ yarn \\ imagemagick6 \\ imagemagick6-c++ \\ imagemagick6-dev \\ imagemagick6-libs \\ tzdata \\ less \\ curl \\ bash \\ &amp;&amp; rm -rf /var/cache/apk/* \\ &amp;&amp; mkdir -p $APP_PATH RUN gem install bundler --version &quot;$BUNDLE_VERSION&quot; \\ &amp;&amp; rm -rf $GEM_HOME/cache/* RUN yarn install --check-file # navigate to app directory WORKDIR $APP_PATH EXPOSE $RAILS_PORT ENTRYPOINT [ &quot;bundle&quot;, &quot;exec&quot; ] Docker-compose service è¨­å®š image: ä½¿ç”¨ä¸Šè¿°çš„ Dockerfile å»ºå‡ºçš„ imageï¼Œè·Ÿä¸Šé¢å¹¾å€‹æœå‹™ä¸ä¸€æ¨£ï¼Œè¦ä½¿ç”¨ build ä¾†æŒ‡å®šå»ºç«‹ image çš„è³‡æ–™å¤¾é‚„æœ‰ Dockerfile çš„ä½ç½® volumes: é™¤äº†å…±ç”¨çš„ shared_data å¤–ï¼Œé‚„æœ‰æ•´å€‹å°ˆæ¡ˆçš„ mappingï¼Œéœ€è¦å°æ‡‰åˆ°å‰›å‰› Dockerfile è£¡å®šç¾©çš„ $APP_PATH ä¸Šï¼Œè—‰ç”± Docker bind mounts é”åˆ° hot reloading çš„æ•ˆæœï¼›å¦å¤–é‚„æœ‰ gem_cache çš„ volumeï¼Œè®“ dependencies å¯ä»¥è¢«æ¸…ç†å’Œé‡å»ºè€Œä¸æœƒå¹²æ“¾ app çš„å…¶ä»–éƒ¨åˆ† stdin_open: è®“å®¹å™¨çš„æ¨™æº–è¼¸å…¥ä¿æŒæ‰“é–‹ tty: å°‡ Docker åˆ†é…ä¸€å€‹è™›æ“¬çµ‚ç«¯ï¼ˆpseudo-ttyï¼‰ä¸¦ç¶å®šåˆ°å®¹å™¨çš„æ¨™æº–è¼¸å…¥ä¸Šï¼Œè®“æˆ‘å€‘å¯ä»¥ä½¿ç”¨ byebug ä¾†é€²è¡Œ debug entrypoint: è¨­å®šç•¶å° docker-compose è£¡çš„ container ä¸‹æŒ‡ä»¤æ™‚çš„é€²å…¥é» command: ç•¶å•Ÿå‹•å®¹å™¨å¾Œè¦åŸ·è¡Œçš„æŒ‡ä»¤ env_file: ç’°å¢ƒè¨­å®šæª” environment: ç’°å¢ƒè®Šæ•¸ï¼Œå¯ä»¥è¢«å¯«åœ¨ç’°å¢ƒè¨­å®šæª”è£¡ï¼Œé€™é‚Šæœƒåˆ†é–‹å¯«æ˜¯å› ç‚ºå…¬å¸çš„å°ˆæ¡ˆè£¡å·²ç¶“æœ‰é è¨­çš„ç’°å¢ƒè¨­å®šæª”äº†ï¼Œç‚ºäº†ä¸æ´—æ‰åŸæœ¬çš„è¨­å®šæ‰å¦å¤–å¯«åœ¨é€™å€‹é …ç›®ä¸‹ã€‚ depends_on: é–‹å•Ÿé€™å€‹æœå‹™å‰éœ€è¦å…¶ä»–å“ªäº›æœå‹™çš„æ”¯æ´ AppName_app: build: context: . dockerfile: Dockerfile.dev container_name: AppName_app volumes: - .:/var/app - shared_data:/var/shared - gem_cache:/usr/local/bundle/gems networks: - development ports: - 3000:3000 stdin_open: true tty: true entrypoint: dev-entrypoint.sh command: - rails server -p 3000 -b 0.0.0.0 env_file: .env.example environment: RAILS_ENV: development WEBPACKER_DEV_SERVER_HOST: webpacker depends_on: - AppName_db - webpacker ActionMailer ç›¸é—œè¨­å®š å¦‚æœæœƒç”¨åˆ° ActionMailer çš„è©±éœ€è¦æŠŠ default_url_options æ”¹æˆ docker-compose ä¸ŠæŒ‡å®šçš„ ip addressï¼Œconfig/environments/development.rb: config.action_mailer.default_url_options = { host: &#39;0.0.0.0:3000&#39; } Test Docker-compose service è¨­å®š image: åŒæ¨£ä½¿ç”¨ app çš„ image volumes: èˆ‡ app çš„è¨­å®šç›¸åŒ AppName_test: image: AppName_AppName_app container_name: AppName_test volumes: - .:/var/app - shared_data:/var/shared - gem_cache:/usr/local/bundle/gems networks: - test ports: - 3001:3000 stdin_open: true tty: true entrypoint: test-entrypoint.sh command: [&quot;rails&quot;, &quot;-v&quot;] environment: RAILS_ENV: test WEBPACKER_DEV_SERVER_HOST: webpacker depends_on: - AppName_db - webpacker æ³¨æ„äº‹é … test service åœ¨å»ºç«‹å®Œä¹‹å¾Œæœ¬ä¾†å°±æœƒæ­»æ‰ åŸ·è¡Œæ¸¬è©¦ï¼šdocker-compose run --rm AppName_test rspec Webpacker æœ€å¾Œå°±æ˜¯è¢«æå¾—åŠæ­»ã„‰ webpacker äº†ï¼çµ‚æ–¼è¦çµæŸäº†ï¼ï¼ï¼ğŸ˜€ğŸ”ª Rails Appâ€™s Webpack settings: config/webpacker.yml åŸºæœ¬ä¸Šå°±æ˜¯éœ€è¦æŠŠ webpacker è¨­å®šæˆ docker-compose è£¡é…ç½®çš„ webpacker è·¯å¾‘ dev_server: host: webpacker (â†’ webpacker container name) public: 0.0.0.0:3035 (â†’ 0.0.0.0 ç‚º rails host) Webpack container settings: ä½¿ç”¨èˆ‡ rails app container ç›¸åŒçš„ Dockerfileã€ç›¸åŒçš„ volume Node.js è¨­å®š v14ï¼š Dockerfile.dev: ç”¨å…©å±¤ base image FROM node:14-alpine as node ä¸‹è¼‰ python2 RUN apk add --update --no-cache python2 &amp;&amp; ln -sf python2 /usr/bin/python FROM ruby:2.6.9-alpine æŠŠ node é‚£é‚Šçš„è¨­å®šè¤‡è£½éä¾†ï¼šCOPY --from=node . . è¦å…ˆåŸ·è¡Œ yarn install ç­‰æŒ‡ä»¤ï¼Œç”Ÿæˆ lock file Heap out of memory error: ref Set environment variable: - NODE_OPTIONS=--max_old_space_size=4096 webpacker: build: context: . dockerfile: Dockerfile.dev command: ruby bin/webpack-dev-server volumes: - shared_data:/var/shared - gem_cache:/usr/local/bundle/gems - .:/var/app environment: - NODE_OPTIONS=--max_old_space_size=4096 - NODE_ENV=development - RAILS_ENV=development - WEBPACKER_DEV_SERVER_HOST=0.0.0.0 ports: - &quot;3035:3035&quot; networks: - development æ‰€æœ‰æ”¹å‹•éçš„æª”æ¡ˆåˆ—è¡¨ config/cable.yml: url: &quot;redis://AppName_redis:6379/1&quot; config/database.yml: host: AppName_db(db service name) username: postgres password: postgres database: postgres config/environments/development.rb: config.action_mailer.default_url_options = { host: &#39;0.0.0.0:3000&#39; } config/settings.yml: host: localhost:3000 config/webpacker.yml: host: webpacker public: 0.0.0.0:3035 å¥½ã„Œâ€¦.å¤§æ¦‚å°±æ˜¯é€™æ¨£ï¼Œå¯«é€™ç¯‡çœŸçš„è±ªç´¯ï¼Œä½†æ˜¯å¯« k8s é‚£å…©ç¯‡å¥½åƒæœƒæ›´ç´¯ğŸ¥²ï¼Ÿï¼ˆå“­ã„Œ Reference Dockerfile base: Rails 6 development with Docker and Docker Compose Webpacker container: railsé–‹ç™¼ç’°å¢ƒå®¹å™¨åŒ–å¯¦æˆ°æŒ‡å—","url":"https://jqlynchien713.github.io/2022/02/19/dockerize-rails.html","headline":"Dockerize Rails App","@type":"BlogPosting","dateModified":"2022-02-19T14:51:00+00:00","datePublished":"2022-02-19T14:51:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://jqlynchien713.github.io/2022/02/19/dockerize-rails.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css">
  <link rel="shortcut icon" type="image/png" href="/favicon.png"><link type="application/atom+xml" rel="alternate" href="https://jqlynchien713.github.io/feed.xml" title="Jacquelyn's Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Jacquelyn&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/tags/">Tags</a><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <!-- enable latex -->
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Dockerize Rails App</h1>
    <p class="post-meta">
    <time class="dt-published" datetime="2022-02-19T14:51:00+00:00" itemprop="datePublished">Feb 19, 2022
      | ğŸ‘€
      <span class="reading-time" title="Estimated read time">
        
        
                                 29 mins
                                 
      </span>
    </time>
    |
    
      <span class="tag">update</span>
    
      <span class="tag">deploy</span>
    
      <span class="tag">docker-compose</span>
    
      <span class="tag">rails</span>
    </p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div class="sidebar"><ul><li><a href="#docker-compose-ç°¡ä»‹">Docker-compose ç°¡ä»‹</a></li><li><a href="#docker-compose-configurations">Docker-compose Configurations</a><ul><li><a href="#basic-setups">Basic Setups</a></li></ul></li><li><a href="#services-configurations">Services Configurations</a><ul><li><a href="#redis">Redis</a></li><li><a href="#dbpostgresql">DB(PostgresQL)</a></li><li><a href="#app">App</a></li><li><a href="#test">Test</a></li><li><a href="#webpacker">Webpacker</a></li></ul></li><li><a href="#æ‰€æœ‰æ”¹å‹•éçš„æª”æ¡ˆåˆ—è¡¨">æ‰€æœ‰æ”¹å‹•éçš„æª”æ¡ˆåˆ—è¡¨</a></li></ul></div>
    <p>çµ‚æ–¼è£œåˆ°é€™ç¯‡äº†ï¼éœ€è¦ Dockerize çš„åŸå› å¾ˆç°¡å–®ï¼Œå› ç‚ºæœ¬åœ°ç’°å¢ƒè¢«æˆ‘è‡ªå·±æçˆ†äº†ğŸ˜€ ç°¡å–®ä¾†èªªå°±æ˜¯æˆ‘ä¸ƒå…«æœˆæ™‚é–‹ç™¼çš„å°ˆæ¡ˆï¼Œéš”äº†å››å€‹æœˆä¹‹å¾Œå†å›ä¾†ç¹¼çºŒæ”¯æ´æ™‚ï¼Œç™¼ç¾æ•´å€‹ç’°å¢ƒå‡ºä¸€å †å•é¡Œï¼ˆåŸºæœ¬ä¸Šéƒ½æ˜¯ M1 chips ç›¸é—œçš„ï¼‰ï¼Œä¸ç®¡æ€éº¼æ”¹ç’°å¢ƒè¨­å®šï¼Œä¸‹å®ŒæŒ‡ä»¤ä¹‹å¾Œæ°¸é éƒ½æœƒ crashï¼Œä¿®åˆ°æœ€å¾Œæˆ‘ä¹Ÿæ‡¶å¾—ç¹¼çºŒæ‰¾åŸå› äº†ï¼Œæƒ³èªªå‰›å­¸é Dockerï¼Œå…¶ä»–è³‡æ·±çš„åŒäº‹å€‘ä¹Ÿæœ‰é€™æ¨£æéï¼Œå°±æƒ³èªªä¸ç„¶æˆ‘ä¹Ÿä¾†è©¦è©¦çœ‹å§ï¼šï¼‰</p>

<p>é€™å€‹å°ˆæ¡ˆç”¨çš„ Ruby ç‰ˆæœ¬æ˜¯ 2.6.9ï¼ˆæ‰€ä»¥æ‰æœƒåœ¨ M1 çš„é›»è…¦ä¸Šå……æ»¿å•é¡Œï¼Œæœ€ä¸€é–‹å§‹åœ¨å®‰è£ 2.6.9 ç‰ˆçš„ Ruby æ™‚å°±å·²ç¶“å‹•éä¸€äº›æ‰‹è…³äº†ï¼šåœ¨ make binary å‡ºå•é¡Œçš„è©±å¯ä»¥å…ˆä¸‹ <code class="language-plaintext highlighter-rouge">CFLAGS="-Wno-error=implicit-function-declaration" rvm install x.x.x</code> å†å®‰è£ by è€é—†ï¼‰é‚„æœƒéœ€è¦ç”¨åˆ° Redis, PostgresQL(DB), Webpackerï¼Œå°±éƒ½æ˜¯ä¸€äº›é–‹ç™¼ Rails æ™‚æ‰€éœ€æœ€åŸºæœ¬çš„é…ç½®ï¼Œä¸¦åœ¨å®¹å™¨åŒ–å¾Œä½¿ç”¨ docker-compose ä¾†å”èª¿é€™äº›é…ç½®ã€‚</p>

<h2 id="docker-compose-ç°¡ä»‹">Docker-compose ç°¡ä»‹</h2>
<p>æ ¹æ“šå®˜ç¶²çš„ä»‹ç´¹ï¼Œdocker-compose æ˜¯ä¸€å€‹ç”¨æ–¼ç®¡ç†ã€åŸ·è¡Œå¤šå®¹å™¨ Docker Application çš„å·¥å…·ã€‚ä½¿ç”¨ docker-compose æ™‚éœ€è¦ç”¨ YAML æª”ä¾†å®šç¾© application çš„å„å€‹ servicesï¼Œæ¥ä¸‹ä¾†å³å¯é€éä¸€å€‹æŒ‡ä»¤ã€å¾é…ç½®ä¸­å‰µå»ºä¸¦å•Ÿå‹•æ‰€æœ‰æœå‹™ã€‚é€™æ¨£åšçš„å¥½è™•æ˜¯å¯ä»¥åŒæ™‚å®šç¾©ã€å”èª¿æ‰€æœ‰æœå‹™ï¼Œå¯ä»¥é¿å…åœ¨å€‹åˆ¥é–‹å•Ÿå®¹å™¨æ™‚é‚„è¦åšé¡å¤–çš„è¨­å®šï¼Œæé«˜é–‹ç™¼çš„æ•ˆç‡ã€‚</p>

<p>åŸºæœ¬ä¸Šåœ¨è¨­å®š docker-compose æ™‚ï¼Œéœ€è¦å…ˆæœ‰å„å€‹ service container è¦ç”¨çš„ imageï¼Œä¸è«–æ˜¯è‡ªå·±å¯«çš„ Dockerfileï¼Œæˆ–è€…æ˜¯å¾ docker hub ä¸Š pull ä¸‹ä¾†çš„ image éƒ½å¯ä»¥ã€‚æ¥ä¸‹ä¾†å°±æ˜¯ <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> çš„æ’°å¯«ï¼Œéœ€è¦å…ˆå°æ•´å€‹æ‡‰ç”¨ç¨‹å¼åšå…¨åŸŸçš„è¨­å®šï¼ˆå¦‚ä½¿ç”¨çš„ docker-compose ç‰ˆæœ¬ã€è¦æœ‰å“ªäº› networks ç­‰ï¼‰ï¼Œæ¥è‘—å†å°å€‹åˆ¥çš„ services åšç´°ç¯€è¨­å®šï¼ˆé¸ç”¨å“ªè£¡çš„ imageã€port mappingã€å°ˆæ¡ˆçš„ç’°å¢ƒè®Šæ•¸â€¦ç­‰ï¼‰</p>

<h2 id="docker-compose-configurations">Docker-compose Configurations</h2>
<p>åœ¨ <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> çš„é–‹é ­éœ€è¦å…ˆå°æ•´å€‹ application åšæœ€åŸºæœ¬çš„è¨­å®šï¼Œä½†å› ç‚ºé€™é‚Šåªæ˜¯é–‹ç™¼ç’°å¢ƒè€Œå·²ï¼Œå› æ­¤å°±åªæœ‰ç°¡å–®åš Networks &amp; Volumes çš„è¨­å®šè€Œå·²ï¼Œä¸»è¦å°±æ˜¯é–‹å…©å€‹ Networks(<code class="language-plaintext highlighter-rouge">development</code> &amp; <code class="language-plaintext highlighter-rouge">test</code>) èˆ‡å››å€‹ Volumes(<code class="language-plaintext highlighter-rouge">db_data</code>, <code class="language-plaintext highlighter-rouge">gem_cache</code>, <code class="language-plaintext highlighter-rouge">shared_data</code> &amp; <code class="language-plaintext highlighter-rouge">packs</code>)ã€‚</p>

<h3 id="basic-setups">Basic Setups</h3>
<ul>
  <li><ins>Version</ins>: æŒ‡å®šè¦ä½¿ç”¨çš„ docker-compose ç‰ˆæœ¬ï¼Œç›®å‰çœ‹åˆ°å¤§å¤šæ•¸çš„æ•™å­¸éƒ½æ˜¯ç”¨ç¬¬ä¸‰ç‰ˆ</li>
  <li><ins>Networks</ins>: åœ¨å»ºèµ· application ä¹‹å¾Œï¼Œdocker-compose æœƒæŠŠæ‰€æœ‰å®¹å™¨éƒ½ä¸Ÿåˆ°ä¸€å€‹ default network ä¸­ï¼Œè€Œåœ¨åŒå€‹ network è£¡çš„å®¹å™¨éƒ½äº’ç›¸ reachableã€‚å¦‚æœä¸æƒ³ä½¿ç”¨é è¨­çš„ default network çš„è©±ä¹Ÿèƒ½è‡ªå·±å¦å¤–å®£å‘Šï¼Œä¸¦å‰µé€ æ›´è¤‡é›œçš„ network topologyã€‚åŸºæœ¬ä¸Šå¯ä»¥é€éé€™æ¨£çš„è¨­å®šé”åˆ°å€éš”ç’°å¢ƒçš„æ•ˆæœï¼Œé€™ä¹Ÿæ˜¯ç‚ºä»€éº¼é€™å€‹å°ˆæ¡ˆçš„ networks è¨­ç½®è¦åˆ†æˆ development èˆ‡ test çš„åŸå› </li>
  <li><ins>Volumes</ins>: çµ±ä¸€å®£å‘Šæ‰€æœ‰ images æœƒç”¨åˆ°çš„ volumesï¼Œå› ç‚ºæœ‰äº› services å¯èƒ½æœƒéœ€è¦å…±ç”¨ volumes(åƒæ˜¯é€™å€‹å°ˆæ¡ˆè£¡çš„ <code class="language-plaintext highlighter-rouge">shared_data</code> volume å°±æ˜¯æ‹¿ä¾†è®“æ‰€æœ‰ containers å…±ç”¨çš„ volume)ã€‚ä¸»è¦çš„åŠŸç”¨æ˜¯åœ¨é–‹ç™¼çš„æ™‚å€™å¯ä»¥åŒæ­¥å°‡æœ¬åœ°ç«¯ä¿®æ”¹çš„å…§å®¹ï¼Œmapping åˆ°å®¹å™¨è£¡çš„å°ˆæ¡ˆï¼Œåœ¨é–‹ç™¼ä¸Šæ¯”è¼ƒç¯€çœæ™‚é–“ã€‚
    <blockquote>
      <p>Mapping çš„æ ¼å¼ï¼š <code class="language-plaintext highlighter-rouge">å¤–ç•Œ:å®¹å™¨</code></p>
    </blockquote>
  </li>
</ul>

<h2 id="services-configurations">Services Configurations</h2>
<p>è·Ÿä¸Šé¢æåˆ°çš„é…ç½®ä¸€æ¨£ï¼Œå†åŠ ä¸Šéœ€è¦æ¸¬è©¦ç”¨çš„ç’°å¢ƒä¹‹å¾Œï¼Œæˆ‘å€‘åœ¨ docker-compose è£¡ç¸½å…±æœƒéœ€è¦ä»¥ä¸‹äº”å€‹æœå‹™: <code class="language-plaintext highlighter-rouge">redis</code>, <code class="language-plaintext highlighter-rouge">db</code>(postgres), <code class="language-plaintext highlighter-rouge">app</code>, <code class="language-plaintext highlighter-rouge">test</code>, <code class="language-plaintext highlighter-rouge">webpacker</code></p>

<h3 id="redis">Redis</h3>
<ul>
  <li>Docker-compose service è¨­å®š
    <ul>
      <li><ins>image</ins>: å¯ä»¥ç›´æ¥é¸ç”¨ docker hub ä¸Šçš„ redis image</li>
      <li><ins>command</ins>: ç•¶é€™å€‹æœå‹™é–‹å§‹é‹è¡Œæ™‚è¦åŸ·è¡Œçš„æŒ‡ä»¤ï¼Œaka åŸ·è¡Œ redis server çš„æŒ‡ä»¤ <code class="language-plaintext highlighter-rouge">redis-server</code></li>
      <li><ins>networks</ins>: é€™é‚Šå› ç‚ºé–‹ç™¼èˆ‡æ¸¬è©¦ç’°å¢ƒéƒ½æœƒç”¨åˆ° redisï¼Œæ‰€ä»¥å…©å€‹ network éƒ½è¦æ”¾é€²ä¾†</li>
      <li><ins>volumes</ins>: é€™é‚Šåªéœ€è¦ <code class="language-plaintext highlighter-rouge">shared_data</code></li>
    </ul>

    <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">AppName_redis</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">redis:6.0-alpine</span>
  <span class="na">command</span><span class="pi">:</span> <span class="s">redis-server</span>
  <span class="na">networks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">development</span>
    <span class="pi">-</span> <span class="s">test</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">shared_data:/var/shared/redis</span>
</code></pre></div>    </div>
  </li>
  <li>Rails App è¨­å®š
    <ul>
      <li>éœ€è¦å°‡ app å…§è¨­å®šçš„ redis url æ”¹æˆ docker-compose è£¡æŒ‡å®šçš„ service name æ ¼å¼ï¼š<code class="language-plaintext highlighter-rouge">"redis://AppName_redis:6379/1"</code> (development &amp; test å…©å€‹ç’°å¢ƒä¸‹éƒ½éœ€è¦æ”¹) <a href="https://stackoverflow.com/questions/34729752/sidekiq-error-connecting-to-redis-on-127-0-0-16379-errnoeconnrefused-on-doc">Reference</a></li>
    </ul>
  </li>
</ul>

<h3 id="dbpostgresql">DB(PostgresQL)</h3>
<ul>
  <li>Docker-compose service è¨­å®š
    <ul>
      <li><ins>image</ins>: é€™é‚Šä¹Ÿæ˜¯ç›´æ¥é¸ç”¨ docker hub ä¸Šçš„ postgres container</li>
      <li><ins>volumes</ins>: é™¤äº†æ‰€æœ‰ service å…±ç”¨çš„ <code class="language-plaintext highlighter-rouge">shared_data</code> å¤–ï¼Œé‚„éœ€è¦æŒ‡å®šä¸€å€‹ç”¨ä¾†å„²å­˜è³‡æ–™åº«è³‡è¨Šçš„ volume(<code class="language-plaintext highlighter-rouge">db_data</code>)</li>
      <li><ins>networks</ins>: é€™é‚Šä¹Ÿæ˜¯å…©å€‹ç’°å¢ƒéƒ½æœƒéœ€è¦ dbï¼Œå› æ­¤å…©å€‹ network éƒ½éœ€è¦æ”¾</li>
      <li><ins>environment</ins>: ç”¨ä¾†è¨­å®šé€™å€‹ container çš„ç’°å¢ƒè®Šæ•¸ï¼Œé€™é‚Šéœ€è¦è¨­å®šçš„æ˜¯è³‡æ–™åº«çš„å¸³è™Ÿå¯†ç¢¼ï¼Œè€Œå®˜æ–¹ image é è¨­çš„å¸³è™Ÿç‚º <code class="language-plaintext highlighter-rouge">postgres</code> å¯†ç¢¼ç‚º <code class="language-plaintext highlighter-rouge">password</code>ï¼›å› ç‚ºé€™é‚Šåªæ˜¯æ¸¬è©¦ç’°å¢ƒï¼Œæ‰€ä»¥ç”¨é è¨­çš„æ²’é—œä¿‚ï¼Œä½†å¦‚æœä¸Š staging æˆ– production é€™ç¨®æ­£å¼çš„ç’°å¢ƒæ™‚ï¼Œå°±éœ€è¦å¦å¤–ç”¨ CI å·¥å…·åšè¨­å®šã€‚</li>
      <li><ins>ports</ins>: åš port mapping ç”¨ï¼Œè®“è³‡æ–™åº«å¯ä»¥è¢«å¤–ç•Œè®€å–</li>
    </ul>

    <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">AppName_db</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">postgres:14-alpine</span>
  <span class="na">container_name</span><span class="pi">:</span> <span class="s">AppName_db</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">db_data:/var/lib/postgresql/data</span>
    <span class="pi">-</span> <span class="s">shared_data:/var/shared</span>
  <span class="na">networks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">development</span>
    <span class="pi">-</span> <span class="s">test</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="na">POSTGRES_USER</span><span class="pi">:</span> <span class="s">postgres</span>
    <span class="na">POSTGRES_PASSWORD</span><span class="pi">:</span> <span class="s">password</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">5432:5432</span>
</code></pre></div>    </div>
  </li>
  <li>Rails App è¨­å®šï¼š<code class="language-plaintext highlighter-rouge">config/database.yml</code>
    <ul>
      <li>éœ€è¦å°‡æ•´å€‹ app è¦é€£çµçš„ db æ”¹æˆ docker-compose ä¸Šçš„ serviceï¼Œä¸¦ä¸”è¨­å®šå¸³è™Ÿå¯†ç¢¼</li>
      <li>host: <code class="language-plaintext highlighter-rouge">AppName_db</code></li>
      <li>username: <code class="language-plaintext highlighter-rouge">postgres</code> -&gt; image default setting</li>
      <li>password: <code class="language-plaintext highlighter-rouge">password</code> -&gt; image default setting</li>
    </ul>
  </li>
  <li>é–‹å•Ÿæ•´å€‹æœå‹™å¾Œè¦è¨˜å¾—å…ˆä¸‹ <code class="language-plaintext highlighter-rouge">bundle exec rake db:create</code> ä¾†å‰µå»ºæœƒç”¨åˆ°çš„ dbï¼Œå¦å‰‡è³‡æ–™åº«çš„å…§å®¹æœƒé•·åœ¨ä¸€å€‹å¾ˆå¥‡æ€ªçš„ä½ç½®ï¼Œå¾ŒçºŒå¦‚æœè¦ç”¨ rake çš„æŒ‡ä»¤æ“ä½œè³‡æ–™åº«æœƒæ²’è¾¦æ³•è®€å–åˆ°æ­£ç¢ºçš„è³‡æ–™</li>
</ul>

<h3 id="app">App</h3>
<ul>
  <li>Dockerfile for Rails App
    <ul>
      <li>2 base images <code class="language-plaintext highlighter-rouge">node:14-alpine</code>, <code class="language-plaintext highlighter-rouge">ruby:2.6.9-alpine</code>: é€™é‚Šæœƒç”¨åˆ°å…©å±¤ base image æ˜¯å› ç‚ºå°ˆæ¡ˆè£¡çš„ node ç‰ˆæœ¬æ˜¯ 14ï¼Œä¸éå¦‚æœåªç”¨ <code class="language-plaintext highlighter-rouge">apk add</code> å»ä¸‹è¼‰ node çš„è©±éƒ½æœƒè¼‰åˆ°æœ€æ–°çš„ 16 ç‰ˆï¼Œå› æ­¤æœ€å¾Œæ±ºå®šè¼‰å…©å±¤ base imageï¼Œä¸¦ä¸”æŠŠå¸¶ 14 ç‰ˆçš„è¨­å®šè¤‡è£½åˆ° ruby image è£¡ï¼Œnode çš„éƒ¨åˆ†å°±èƒ½æ­£å¸¸é‹ä½œäº†</li>
      <li>Env variables</li>
      <li>Copy entrypoint scripts and grant execution permission</li>
      <li>Copy everything from node image</li>
      <li>Install all dependencies(not including node)
        <ul>
          <li>é€™é‚Šè¦é¿é–‹ä¸‹è¼‰ nodeï¼Œä»¥å…æŠŠ 14 ç‰ˆçš„è¨­å®šè¦†è“‹æ‰</li>
        </ul>
      </li>
    </ul>

    <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> node:14-alpine as node</span>
<span class="k">RUN </span>apk add <span class="nt">--update</span> <span class="nt">--no-cache</span> python2 <span class="o">&amp;&amp;</span> <span class="nb">ln</span> <span class="nt">-sf</span> python2 /usr/bin/python
<span class="k">FROM</span><span class="s"> ruby:2.6.9-alpine</span>

<span class="k">ENV</span><span class="s"> APP_PATH /var/app</span>
<span class="k">ENV</span><span class="s"> BUNDLE_VERSION 2.2.33</span>
<span class="k">ENV</span><span class="s"> BUNDLE_PATH /usr/local/bundle/gems</span>
<span class="k">ENV</span><span class="s"> TMP_PATH /tmp/</span>
<span class="k">ENV</span><span class="s"> RAILS_LOG_TO_STDOUT true</span>
<span class="k">ENV</span><span class="s"> RAILS_PORT 3000</span>

<span class="c"># copy entrypoint scripts and grant execution permissions</span>
<span class="k">COPY</span><span class="s"> ./dev-docker-entrypoint.sh /usr/local/bin/dev-entrypoint.sh</span>
<span class="k">COPY</span><span class="s"> ./test-docker-entrypoint.sh /usr/local/bin/test-entrypoint.sh</span>
<span class="k">COPY</span><span class="s"> --from=node . .</span>
<span class="k">RUN </span><span class="nb">chmod</span> +x /usr/local/bin/dev-entrypoint.sh <span class="o">&amp;&amp;</span> <span class="nb">chmod</span> +x /usr/local/bin/test-entrypoint.sh

<span class="c"># install dependencies for application</span>
<span class="k">RUN </span>apk <span class="nt">-U</span> add <span class="nt">--no-cache</span> <span class="se">\
</span>build-base <span class="se">\
</span>git <span class="se">\
</span>postgresql-dev <span class="se">\
</span>postgresql-client <span class="se">\
</span>libxml2-dev <span class="se">\
</span>libidn-dev <span class="se">\
</span>libxslt-dev <span class="se">\
</span>yarn <span class="se">\
</span>imagemagick6 <span class="se">\
</span>imagemagick6-c++ <span class="se">\
</span>imagemagick6-dev <span class="se">\
</span>imagemagick6-libs <span class="se">\
</span>tzdata <span class="se">\
</span>less <span class="se">\
</span>curl <span class="se">\
</span>bash <span class="se">\
</span><span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> /var/cache/apk/<span class="k">*</span> <span class="se">\
</span><span class="o">&amp;&amp;</span> <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$APP_PATH</span>

<span class="k">RUN </span>gem <span class="nb">install </span>bundler <span class="nt">--version</span> <span class="s2">"</span><span class="nv">$BUNDLE_VERSION</span><span class="s2">"</span> <span class="se">\
</span><span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> <span class="nv">$GEM_HOME</span>/cache/<span class="k">*</span>

<span class="k">RUN </span>yarn <span class="nb">install</span> <span class="nt">--check-file</span>

<span class="c"># navigate to app directory</span>
<span class="k">WORKDIR</span><span class="s"> $APP_PATH</span>

<span class="k">EXPOSE</span><span class="s"> $RAILS_PORT</span>

<span class="k">ENTRYPOINT</span><span class="s"> [ "bundle", "exec" ]</span>
</code></pre></div>    </div>
  </li>
  <li>Docker-compose service è¨­å®š
    <ul>
      <li><ins>image</ins>: ä½¿ç”¨ä¸Šè¿°çš„ Dockerfile å»ºå‡ºçš„ imageï¼Œè·Ÿä¸Šé¢å¹¾å€‹æœå‹™ä¸ä¸€æ¨£ï¼Œè¦ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">build</code> ä¾†æŒ‡å®šå»ºç«‹ image çš„è³‡æ–™å¤¾é‚„æœ‰ Dockerfile çš„ä½ç½®</li>
      <li><ins>volumes</ins>: é™¤äº†å…±ç”¨çš„ <code class="language-plaintext highlighter-rouge">shared_data</code> å¤–ï¼Œé‚„æœ‰æ•´å€‹å°ˆæ¡ˆçš„ mappingï¼Œéœ€è¦å°æ‡‰åˆ°å‰›å‰› Dockerfile è£¡å®šç¾©çš„ <code class="language-plaintext highlighter-rouge">$APP_PATH</code> ä¸Šï¼Œè—‰ç”± Docker bind mounts é”åˆ° hot reloading çš„æ•ˆæœï¼›å¦å¤–é‚„æœ‰ <code class="language-plaintext highlighter-rouge">gem_cache</code> çš„ volumeï¼Œè®“ dependencies å¯ä»¥è¢«æ¸…ç†å’Œé‡å»ºè€Œä¸æœƒå¹²æ“¾ app çš„å…¶ä»–éƒ¨åˆ†</li>
      <li><ins>stdin_open</ins>: è®“å®¹å™¨çš„æ¨™æº–è¼¸å…¥ä¿æŒæ‰“é–‹</li>
      <li><ins>tty</ins>: å°‡ Docker åˆ†é…ä¸€å€‹è™›æ“¬çµ‚ç«¯ï¼ˆpseudo-ttyï¼‰ä¸¦ç¶å®šåˆ°å®¹å™¨çš„æ¨™æº–è¼¸å…¥ä¸Šï¼Œè®“æˆ‘å€‘å¯ä»¥ä½¿ç”¨ byebug ä¾†é€²è¡Œ debug</li>
      <li><ins>entrypoint</ins>: è¨­å®šç•¶å° docker-compose è£¡çš„ container ä¸‹æŒ‡ä»¤æ™‚çš„é€²å…¥é»</li>
      <li><ins>command</ins>: ç•¶å•Ÿå‹•å®¹å™¨å¾Œè¦åŸ·è¡Œçš„æŒ‡ä»¤</li>
      <li><ins>env_file</ins>: ç’°å¢ƒè¨­å®šæª”</li>
      <li><ins>environment</ins>: ç’°å¢ƒè®Šæ•¸ï¼Œå¯ä»¥è¢«å¯«åœ¨ç’°å¢ƒè¨­å®šæª”è£¡ï¼Œé€™é‚Šæœƒåˆ†é–‹å¯«æ˜¯å› ç‚ºå…¬å¸çš„å°ˆæ¡ˆè£¡å·²ç¶“æœ‰é è¨­çš„ç’°å¢ƒè¨­å®šæª”äº†ï¼Œç‚ºäº†ä¸æ´—æ‰åŸæœ¬çš„è¨­å®šæ‰å¦å¤–å¯«åœ¨é€™å€‹é …ç›®ä¸‹ã€‚</li>
      <li><ins>depends_on</ins>: é–‹å•Ÿé€™å€‹æœå‹™å‰éœ€è¦å…¶ä»–å“ªäº›æœå‹™çš„æ”¯æ´</li>
    </ul>

    <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">AppName_app</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="na">context</span><span class="pi">:</span> <span class="s">.</span>
    <span class="na">dockerfile</span><span class="pi">:</span> <span class="s">Dockerfile.dev</span>
  <span class="na">container_name</span><span class="pi">:</span> <span class="s">AppName_app</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">.:/var/app</span>
    <span class="pi">-</span> <span class="s">shared_data:/var/shared</span>
    <span class="pi">-</span> <span class="s">gem_cache:/usr/local/bundle/gems</span>
  <span class="na">networks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">development</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">3000:3000</span>
  <span class="na">stdin_open</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">tty</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">entrypoint</span><span class="pi">:</span> <span class="s">dev-entrypoint.sh</span>
  <span class="na">command</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">rails server -p 3000 -b 0.0.0.0</span>
  <span class="na">env_file</span><span class="pi">:</span> <span class="s">.env.example</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="na">RAILS_ENV</span><span class="pi">:</span> <span class="s">development</span>
    <span class="na">WEBPACKER_DEV_SERVER_HOST</span><span class="pi">:</span> <span class="s">webpacker</span>
  <span class="na">depends_on</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">AppName_db</span>
    <span class="pi">-</span> <span class="s">webpacker</span>
</code></pre></div>    </div>
  </li>
  <li>ActionMailer ç›¸é—œè¨­å®š
    <ul>
      <li>å¦‚æœæœƒç”¨åˆ° ActionMailer çš„è©±éœ€è¦æŠŠ default_url_options æ”¹æˆ docker-compose ä¸ŠæŒ‡å®šçš„ ip addressï¼Œ<code class="language-plaintext highlighter-rouge">config/environments/development.rb</code>: <code class="language-plaintext highlighter-rouge">config.action_mailer.default_url_options = { host: '0.0.0.0:3000' }</code></li>
    </ul>
  </li>
</ul>

<h3 id="test">Test</h3>
<ul>
  <li>Docker-compose service è¨­å®š
    <ul>
      <li>image: åŒæ¨£ä½¿ç”¨ app çš„ image</li>
      <li>volumes: èˆ‡ app çš„è¨­å®šç›¸åŒ</li>
    </ul>
  </li>
</ul>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">AppName_test</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">AppName_AppName_app</span>
  <span class="na">container_name</span><span class="pi">:</span> <span class="s">AppName_test</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">.:/var/app</span>
    <span class="pi">-</span> <span class="s">shared_data:/var/shared</span>
    <span class="pi">-</span> <span class="s">gem_cache:/usr/local/bundle/gems</span>
  <span class="na">networks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">test</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">3001:3000</span>
  <span class="na">stdin_open</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">tty</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">entrypoint</span><span class="pi">:</span> <span class="s">test-entrypoint.sh</span>
  <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">rails"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">-v"</span><span class="pi">]</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="na">RAILS_ENV</span><span class="pi">:</span> <span class="s">test</span>
    <span class="na">WEBPACKER_DEV_SERVER_HOST</span><span class="pi">:</span> <span class="s">webpacker</span>
  <span class="na">depends_on</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">AppName_db</span>
    <span class="pi">-</span> <span class="s">webpacker</span>
</code></pre></div></div>
<ul>
  <li>æ³¨æ„äº‹é …
    <ul>
      <li><code class="language-plaintext highlighter-rouge">test</code> service åœ¨å»ºç«‹å®Œä¹‹å¾Œæœ¬ä¾†å°±æœƒæ­»æ‰</li>
      <li>åŸ·è¡Œæ¸¬è©¦ï¼š<code class="language-plaintext highlighter-rouge">docker-compose run --rm AppName_test rspec</code></li>
    </ul>
  </li>
</ul>

<h3 id="webpacker">Webpacker</h3>
<p>æœ€å¾Œå°±æ˜¯è¢«æå¾—åŠæ­»ã„‰ webpacker äº†ï¼çµ‚æ–¼è¦çµæŸäº†ï¼ï¼ï¼ğŸ˜€ğŸ”ª</p>
<ul>
  <li>Rails Appâ€™s Webpack settings: <code class="language-plaintext highlighter-rouge">config/webpacker.yml</code>
    <ul>
      <li>åŸºæœ¬ä¸Šå°±æ˜¯éœ€è¦æŠŠ webpacker è¨­å®šæˆ docker-compose è£¡é…ç½®çš„ webpacker è·¯å¾‘</li>
      <li>dev_server:
        <ul>
          <li>host: <code class="language-plaintext highlighter-rouge">webpacker</code> (â†’ webpacker container name)</li>
          <li>public: <code class="language-plaintext highlighter-rouge">0.0.0.0:3035</code> (â†’ <code class="language-plaintext highlighter-rouge">0.0.0.0</code> ç‚º rails host)</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Webpack container settings:
    <ul>
      <li>ä½¿ç”¨èˆ‡ rails app container ç›¸åŒçš„ Dockerfileã€ç›¸åŒçš„ volume</li>
      <li><code class="language-plaintext highlighter-rouge">Node.js</code> è¨­å®š v14ï¼š
        <ul>
          <li><code class="language-plaintext highlighter-rouge">Dockerfile.dev</code>: ç”¨å…©å±¤  base image
            <ul>
              <li><code class="language-plaintext highlighter-rouge">FROM node:14-alpine as node</code>
                <ul>
                  <li>ä¸‹è¼‰ python2</li>
                  <li><code class="language-plaintext highlighter-rouge">RUN apk add --update --no-cache python2 &amp;&amp; ln -sf python2 /usr/bin/python</code></li>
                </ul>
              </li>
              <li><code class="language-plaintext highlighter-rouge">FROM ruby:2.6.9-alpine</code>
                <ul>
                  <li>æŠŠ node é‚£é‚Šçš„è¨­å®šè¤‡è£½éä¾†ï¼š<code class="language-plaintext highlighter-rouge">COPY --from=node . .</code></li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>è¦å…ˆåŸ·è¡Œ <code class="language-plaintext highlighter-rouge">yarn install</code> ç­‰æŒ‡ä»¤ï¼Œç”Ÿæˆ lock file</li>
      <li>Heap out of memory error: <a href="https://blog.m4x.io/2021/webpack-how-to-fix-out-of-memory/">ref</a>
        <ul>
          <li>Set environment variable:</li>
          <li><code class="language-plaintext highlighter-rouge">- NODE_OPTIONS=--max_old_space_size=4096</code></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">webpacker</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="na">context</span><span class="pi">:</span> <span class="s">.</span>
    <span class="na">dockerfile</span><span class="pi">:</span> <span class="s">Dockerfile.dev</span>
  <span class="na">command</span><span class="pi">:</span> <span class="s">ruby bin/webpack-dev-server</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">shared_data:/var/shared</span>
    <span class="pi">-</span> <span class="s">gem_cache:/usr/local/bundle/gems</span>
    <span class="pi">-</span> <span class="s">.:/var/app</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">NODE_OPTIONS=--max_old_space_size=4096</span>
    <span class="pi">-</span> <span class="s">NODE_ENV=development</span>
    <span class="pi">-</span> <span class="s">RAILS_ENV=development</span>
    <span class="pi">-</span> <span class="s">WEBPACKER_DEV_SERVER_HOST=0.0.0.0</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">3035:3035"</span>
  <span class="na">networks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">development</span>
</code></pre></div></div>

<hr />
<h2 id="æ‰€æœ‰æ”¹å‹•éçš„æª”æ¡ˆåˆ—è¡¨">æ‰€æœ‰æ”¹å‹•éçš„æª”æ¡ˆåˆ—è¡¨</h2>
<ul>
  <li><code class="language-plaintext highlighter-rouge">config/cable.yml</code>: <code class="language-plaintext highlighter-rouge">url: "redis://AppName_redis:6379/1"</code></li>
  <li><code class="language-plaintext highlighter-rouge">config/database.yml</code>:
    <ul>
      <li>host: AppName_db(db service name)</li>
      <li>username: postgres</li>
      <li>password: postgres</li>
      <li>database: postgres</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">config/environments/development.rb</code>: <code class="language-plaintext highlighter-rouge">config.action_mailer.default_url_options = { host: '0.0.0.0:3000' }</code></li>
  <li><code class="language-plaintext highlighter-rouge">config/settings.yml</code>: <code class="language-plaintext highlighter-rouge">host: localhost:3000</code></li>
  <li><code class="language-plaintext highlighter-rouge">config/webpacker.yml</code>:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">host: webpacker</code></li>
      <li><code class="language-plaintext highlighter-rouge">public: 0.0.0.0:3035</code></li>
    </ul>
  </li>
</ul>

<hr />
<p>å¥½ã„Œâ€¦.å¤§æ¦‚å°±æ˜¯é€™æ¨£ï¼Œå¯«é€™ç¯‡çœŸçš„è±ªç´¯ï¼Œä½†æ˜¯å¯« k8s é‚£å…©ç¯‡å¥½åƒæœƒæ›´ç´¯ğŸ¥²ï¼Ÿï¼ˆå“­ã„Œ</p>

<font color="grey" style="font-size: 24px">Reference</font>
<ul>
  <li>Dockerfile base: <a href="https://betterprogramming.pub/rails-6-development-with-docker-55437314a1ad">Rails 6 development with Docker and Docker Compose</a></li>
  <li>Webpacker container: <a href="https://medium.com/@joehwang.com/rails%E9%96%8B%E7%99%BC%E7%92%B0%E5%A2%83%E5%AE%B9%E5%99%A8%E5%8C%96-505dba2c9678">railsé–‹ç™¼ç’°å¢ƒå®¹å™¨åŒ–å¯¦æˆ°æŒ‡å—</a></li>
</ul>

  </div>

  
  
    <script src="https://utteranc.es/client.js"
            repo=jqlynchien713/jqlynchien713.github.io
            issue-term=pathname
            label=Comments
            theme=github-light
            crossorigin= "anonymous"
            async>
    </script>
  

<a class="u-url" href="/2022/02/19/dockerize-rails.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Jacquelyn&#39;s Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Jacquelyn&#39;s Blog</li><li><a class="u-email" href="mailto:jqlynchien713@gmail.com">jqlynchien713@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-3"><ul class="social-media-list"><li><a href="https://github.com/jqlynchien713"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jqlynchien713</span></a></li></ul>
</div>

      <div class="footer-col footer-col-2">
        <p>Ê• â€¢á´¥â€¢Ê”</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
