---
layout: post
title: VPC/Route 53 config & Nginx + EC2 æœ€ç°¡å–®çš„ EC2 å¯¦ä½œğŸ« 
date: 2022-05-16 21:52 +0800
tags: update
---
æœ€è¿‘å› ç‚ºå…¬å¸é–‹äº†å¹¾å ‚ AWS çš„æ•™è‚²è¨“ç·´ï¼Œèª²ç¨‹çµæŸå¾Œè€é—†å€‘æœ‰æŒ‡æ´¾å›å®¶ä½œæ¥­éœ€è¦å®Œæˆï¼Œå› æ­¤æŠŠå¯¦ä½œçš„æ­·ç¨‹ç´€éŒ„åœ¨é€™é‚Šï¼ˆä¸çŸ¥é“æˆ‘ k8s é‚£å…©ç¯‡å•¥æ™‚æ‰èƒ½ç™¼ä½ˆğŸ« ï¼‰

## Homework
åŸºæœ¬è¦æ±‚
- VPC å»ºå‡ºä¾†è¦æœ‰ Subnet / Route Table
- Route 53 è¦è¨­å®šå‡º sub-domain è¦æœ‰å¹¾ç­† CNAME / A

å…¶å¯¦é€™æ¬¡çš„ä½œæ¥­è »ç°¡å–®çš„ï¼Œå› ç‚º VPC é è¨­å°±æœƒå¹«æˆ‘å€‘é–‹å¥½ Subnet èˆ‡ route tableï¼Œéº»ç…©çš„é»æ˜¯åœ¨è¦ç†è§£ Route 53 çš„æœå‹™åˆ°åº•å¯ä»¥å¹«æˆ‘å€‘å®Œæˆä»€éº¼äº‹ã€‚

### HW - record

1. Create VPC
    - Route table æ–°å¢è·¯ç”±é€£åˆ°å¤–ç¶²ï¼š
        - Main route table â†’ Routes â†’ Edit Routes
        - Destination: 0.0.0.0/0 , Target: igw-XXXX
2. Create EC2
    1. [Day4ï¼šAmazon Elastic Cloud Compute(EC2)](https://ithelp.ithome.com.tw/articles/10233669)
    2. [ã€AWS 101ã€‘é‚å…¥AWSçš„ç¬¬ä¸€æ­¥-è¨­å®šVPC & public subnet](https://www.kx.com.tw/aws-usecase-VPC/)
3. Setup Route53
    1. [Day11ï¼šAmazon Route 53](https://ithelp.ithome.com.tw/articles/10234138)
4. Amplify: ä»¥è¦–è¦ºæ–¹å¼å»ºç½® Web å‰ç«¯ UI
    1. [Deploy your Jekyll Site using AWS Amplify â€” with only a few clicks](https://medium.com/@jameshamann/deploy-your-jekyll-site-using-aws-amplify-with-only-a-few-clicks-8f3dd8f26112)
    2. Amplify console - Domain management: å¯ä»¥ç›´æ¥åœ¨åŸæœ‰çš„ domain åŠ ä¸Šä¸€å€‹ subdomain

### å•é¡Œ

1. CNAME æ‡‰ç”¨å ´æ™¯ï¼šå…§éƒ¨é–‹ç™¼æ–¹ä¾¿ï¼ˆè¨­åœ¨ private zoneï¼‰ã€å®‰å…¨æ€§ï¼ˆè¨­å®šæª”éƒ½è¨­ CNAME çš„ dnsï¼‰
2. Name server ç”¨è™•ï¼šè®“å…¶ä»–äººå¾—ä»¥ query åˆ°æˆ‘å€‘è‡ªå·±è¨­å®šçš„ dns record

## Nginx in EC2

> Prerequisite: EC2 w/ SG allowing http & https
>

### Nginx Config
åœ¨è¨­å®šå®Œä¸Šè¿° Route 53 çš„ A / CNAME record ä¹‹å¾Œï¼Œè¦ºå¾—å¦‚æœæ²’æœ‰çœŸçš„é–‹ä¸€å€‹ server é¡¯ç¤ºä¸€é»æ±è¥¿çœŸçš„å¤ªå°ä¸èµ·è‡ªå·±ã„Œå§ï¼ˆè›¤ï¼‰ï¼Œæ–¼æ˜¯å°±æ”¾äº†ä¸€å€‹ç°¡å–®çš„é é¢é€²å»å‰›å‰›é–‹å¥½çš„ EC2 è£¡

1. ä¸‹è¼‰ nginx & epel

    ```bash
    sudo yum install -y epel-release
    sudo yum install nginx -y
    ```

2. Nginx ç›¸é—œæŒ‡ä»¤

    ```bash
    sudo systemctl start nginx
    sudo systemctl enable nginx
    sudo systemctl status nginx
    ```

3. å»ºç«‹è³‡æ–™å¤¾æ”¾ç½®è¦ serve çš„éœæ…‹æª”æ¡ˆï¼ŒæŠŠ index.html åŠ åˆ°è£¡é¢

    ```bash
    sudo mkdir /var/www/jc713.staff.5xruby.dev/public_html
    ```

4. æ”¹è®Šè©²è³‡æ–™å¤¾çš„æ‰€æœ‰æ¬Šï¼Œè®“ Nginx å¯ä»¥å­˜å–åŸ·è¡Œ

    ```bash
    sudo chown -R nginx: /var/www/jc713.staff.5xruby.dev/
    ```

5. Enable SELinux: `sudo vim /etc/selinux/config` å°‡ disable æ”¹æˆ enable

    & check `sudo sestatus`

6. é–‹æ”¾ SELinux å­˜å– Nginx website files

    ```bash
    sudo setsebool -P httpd_can_network_connect on
    sudo chcon -Rt httpd_sys_content_t /var/www/
    ```

7. Nginx è¨­å®šæª” `sudo vi /etc/nginx/sites-available/jc713.staff.5xruby.dev.conf`

    ```bash
    server {
        listen 80;
        listen [::]:80;

        root /var/www/example-one.com/public_html;

        index index.html;

        server_name example-one.com www.example-one.com;

        access_log /var/log/nginx/example-one.com.access.log;
        error_log /var/log/nginx/example-one.com.error.log;

        location / {
            try_files $uri $uri/ =404;
        }
    }
    ```

8. é©—è­‰ Nginx è¨­å®š

    ```bash
    $ sudo nginx -t
    nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
    nginx: configuration file /etc/nginx/nginx.conf test is successful
    ```

9. Restart Nginx with `sudo systemctl restart nginx`

### Nginx SSL settings

1. å®‰è£ Certbot

    ```bash
    sudo apt install certbot -y
    sudo apt-get install -y python-certbot-nginx
    ```

2. ç”Ÿæˆ SSL æ†‘è­‰ & Nginx è¨­å®š

    ```bash
    $ sudo certbot --nginx
    -------
    1. You site admin email address
    2. Terms of Service agreement.
    3. List of domains you need HTTPS for. Certbot will automatically detect this information from the Nginx conf files.
    4. HTTP to HTTPS redirection confirmation (it is better to redirect)
    ```

3. Certbot æœƒè‡ªå‹•åœ¨å‰›å‰›è¨­å®šçš„ Nginx è¨­å®šæª”è£¡ç”¢ç”Ÿä»¥ä¸‹è³‡è¨Š

    ```bash
    listen [::]:443 ssl ipv6only=on; # managed by Certbot
        listen 443 ssl; # managed by Certbot
        ssl_certificate /etc/letsencrypt/live/kartsavings.com/fullchain.pem; # managed by Certbot
        ssl_certificate_key /etc/letsencrypt/live/kartsavings.com/privkey.pem; # managed by Certbot
        include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
    }
    ```

4. Done!

<font color="grey" style="font-size: 24px">Reference</font>
- [Ref 1](https://comtechies.com/how-to-install-and-configure-nginx-on-amazon-ec2-rhel-and-ubuntu-instances.html)
- [Ref 2](https://comtechies.com/nginx-letsencrypt-setup-guide-certbot.html)

