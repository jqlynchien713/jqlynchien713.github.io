---
layout: post
title: Kubernetes å¯¦ä½œç´€éŒ„(Draft)
date: 2022-02-05 17:12 +0800
tags: update deploy
---

ä»Šå¤©æ±ºå®šä¾†å¯«ä¸Šå­¸æœŸå¿…ä¿®èª²çš„æœŸæœ«å ±å‘Šï¼é›–ç„¶èªªé€™å ‚èª²éå¾—éå¸¸è«åå…¶å¦™ï¼ŒæœŸæœ«å°ˆæ¡ˆä¹Ÿåªæœ‰ä¸€ï¼ˆï¼Ÿï¼‰å€‹æ¢ä»¶ï¼Œä¸éåœ¨å»ºå®Œæ•´å€‹å°ˆæ¡ˆä¹‹å¾Œé‚„æ˜¯å­¸åˆ°è »å¤šæ±è¥¿çš„ã€‚è‡³æ–¼è€å¸«æå‡ºçš„å”¯ä¸€ä¸€å€‹æ¢ä»¶å‰‡æ˜¯è¦æˆ‘å€‘ç†è§£å¾®æœå‹™åˆ°åº•åœ¨å¹¹å˜›ï¼Œä¸¦ä¸”ä¸€å®šè¦ç”¨åˆ° Kubernetesï¼›åœ¨èˆ‡çµ„å“¡è¨è«–éå¾Œï¼Œæˆ‘å€‘æ±ºå®šåšå€‹æœ€ç°¡å–®çš„è«–å£‡ç¶²ç«™ï¼ˆå¯ä»¥è¨»å†Šã€ç™»å…¥ã€ç™¼æ–‡ã€ç•™è¨€ï¼‰ï¼Œå‰ç«¯ä½¿ç”¨ React.jsï¼Œå¾Œç«¯ä½¿ç”¨ Django ä½œç‚º API serverï¼Œç”¨ Docker æŠŠé€™å…©å€‹æœå‹™æ‰“åŒ…å¾Œï¼Œå†ä¾†ç…©æƒ±è¦æ€éº¼ç”¨ K8s æˆ– Docker-compose å°é€™äº›æœå‹™åšç®¡ç†ã€‚

## K8s åŸºæœ¬æ¦‚å¿µ
### éœ€è¦å®‰è£çš„ä¸€äº›å°å·¥å…·
* minikube:å”åŠ©é–‹ç™¼è€…åœ¨è¨­ç½®æœ¬æ©Ÿç‰ˆçš„ Kubernetes cluster
* kubectl:ç®¡ç†ã€è¨­å®š Kubernetes çš„ CLI
* octant:æŸ¥çœ‹ Kubernetes å„ç¨®ç‹€æ…‹çš„ web interface

### åŸºæœ¬ä¸‰å…ƒä»¶ - Pod, Service, Deployment
> é€™éƒ¨åˆ†æ˜¯[é€™ç¯‡æ–‡ç« ](https://cwhu.medium.com/kubernetes-basic-concept-tutorial-e033e3504ec0)çš„ç­†è¨˜æ•´ç†

* Pod: K8s é‹ä½œçš„æœ€å°å–®ä½ï¼Œä¸€å€‹ pod å°æ‡‰åˆ°ä¸€å€‹æ‡‰ç”¨æœå‹™ï¼Œå¯ä»¥å«æœ‰ä¸€å€‹æˆ–å¤šå€‹ container
  * Worker Node(Node): K8s é‹ä½œçš„æœ€å°**ç¡¬é«”**å–®ä½ï¼Œæ¯å€‹ Node éƒ½å«æœ‰ä¸‰å€‹çµ„ä»¶: kubeletã€kube-proxyã€Container Runtime
    * <ins>kubelet</ins>:è² è²¬ç®¡ç†æ‰€æœ‰ Pods çš„ç‹€æ…‹ä»¥åŠèˆ‡ Master çš„æºé€š
    * <ins>kube-proxy</ins>:è² è²¬æ›´æ–° Node çš„ iptableï¼Œè®“å…¶ä»–çµé»/ç‰©ä»¶å¯ä»¥å¾—çŸ¥è©²ç¯€é»ä¸Šæ‰€æœ‰ Pods çš„ç‹€æ…‹
    * <ins>Container Runtime</ins>:è² è²¬åŸ·è¡Œå®¹å™¨çš„ç¨‹å¼ï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯ Docker container å‰‡ç‚º Docker Engine
  * Master Node:ç®¡ç†æ‰€æœ‰ Worker Node çš„çµé»ï¼Œå«æœ‰å››å€‹çµ„ä»¶ï¼škube-apiserverã€etcdã€kube-schedulerã€kube-controller-manager
    * <ins>kube-apiserver</ins>:ç®¡ç†æ•´å€‹ K8s çš„ API Endpointï¼Œè½‰ä»‹ Node ä¹‹é–“çš„æºé€šï¼Œä¸¦è² è²¬èº«ä»½èªè­‰èˆ‡æˆæ¬Š
    * <ins>etcd</ins>:è² è²¬ Cluster çš„è³‡æ–™å‚™ä»½
    * <ins>kube-scheduler</ins>:æ ¹æ“š Node çš„ç¡¬é«”é™åˆ¶èˆ‡ç¾æœ‰è³‡æºèª¿åº¦æ‰€æœ‰ Pods
    * <ins>kube-controller-manager</ins>:ç®¡ç† controllerï¼ˆç›£è¦–ç‹€æ…‹çš„ processï¼‰çš„çµ„ä»¶
  * Cluster:K8s ä¸­å¤šå€‹ Node å’Œ Master çš„é›†åˆ
* Service:å®šç¾©ä¸€ç¾¤ Pods è¦å¦‚ä½•è¢«å­˜å–åŠé€£ç·š
* Deployment:å° Pod åšæ©«å‘æ“´å±•ï¼Œè¤‡è£½å¤šå€‹ç›¸åŒçš„ Pod åœ¨ Cluster ä¸­åŒæ™‚æä¾›æœå‹™

## å‰ç«¯è¨­å®š
æœ¬å°ˆæ¡ˆçš„å‰ç«¯ç”± React.js (v17) å»ºç½®ï¼Œéƒ¨åˆ†å…ƒä»¶å› ç‚ºèˆ‡ä¹‹å‰å¯«çš„å°ˆæ¡ˆé€šç”¨ï¼Œæ‰€ä»¥ç”¨çš„æ˜¯åŸå§‹çš„ class basedï¼Œå¦ä¸€éƒ¨åˆ†~~å› ç‚ºè¢«ç•¢æ¥­å°ˆé¡Œçµ„å“¡æ¨å‘~~ï¼Œä½¿ç”¨çš„æ˜¯ functional component çš„å¯«æ³•ã€‚

### Basic Settings - Routing
åœ¨æ•´å€‹å‰ç«¯é–‹ç™¼çš„éç¨‹ä¸­ï¼Œæˆ‘é‡åˆ°æ¯”è¼ƒéº»ç…©çš„åœ°æ–¹æœ‰ Routing çš„è¨­ç½®ã€‚å› ç‚ºé€™æ¬¡å°ˆæ¡ˆä¸¦æ²’æœ‰å¾ˆå¤§ï¼Œæ‰€ä»¥æˆ‘æŠŠ routing çš„è¦å‰‡ç›´æ¥å¯«åœ¨ App.js è£¡ï¼Œä½¿ç”¨çš„æ˜¯ `react-router-dom` çš„å¥—ä»¶ã€‚åŸºæœ¬ä¸Šæœƒç”¨åˆ° BrowserRouterã€Routesã€Route ä¸‰å€‹ç‰©ä»¶ï¼Œ`BrowserRouter` ç”¨æ–¼è™•ç†å‹•æ…‹å…§å®¹çš„è·¯å¾‘å®£å‘Šï¼ˆéœæ…‹å‰‡ä½¿ç”¨ `HashRouter`ï¼‰ï¼Œ`Routes` å‰‡ç‚º v5 çš„ `Switch` åœ¨ v6 çš„å°æ‡‰ï¼Œä¹Ÿå°±æ˜¯æ§åˆ¶ url èˆ‡ path çš„ mappingï¼Œæœ€å¾Œ `Route` çš„éƒ¨åˆ†å°±æ˜¯å–®ç´”çš„è·¯å¾‘å®£å‘Šï¼Œèˆ‡è©²è·¯å¾‘å°æ‡‰åˆ°çš„å…ƒä»¶ã€‚

```jsx
import { BrowserRouter, Route, Routes } from "react-router-dom";

function App() {
  return (
    <>
      <Nav/>
      <div className='container py-5'>
        <BrowserRouter>
          <Routes>
              <Route index element={<PostContainer/>}/>
              <Route path="post/:postId" element={<Post />}/>
              <Route path="profile" element={<Profile />}/>
              <Route path="login" element={<Login />}/>
              <Route path="signup" element={<Signup />}/>
          </Routes>
        </BrowserRouter>
      </div>
    </>
  );
}
```

### Dockerfile
è‡³æ–¼å®¹å™¨åŒ–çš„éƒ¨åˆ†å°±çœŸçš„å¾ˆç°¡å–®ï¼Œåªéœ€è¦ä½¿ç”¨æ­£ç¢ºç‰ˆæœ¬çš„ node base imageï¼ˆæˆ‘å€‘ç”¨çš„æ˜¯ node:14-alpineï¼‰ï¼Œæ¥ä¸‹ä¾†åªè¦ç¢ºèªæ‰€æœ‰æ±è¥¿éƒ½æœ‰è¤‡è£½åˆ°å®¹å™¨è£¡ï¼Œç„¶å¾Œå®‰è£æ‰€æœ‰å¥—ä»¶ï¼Œå°±å¯ä»¥æŠŠå‰ç«¯çš„ server é–‹èµ·ä¾†äº†ã€‚
```Dockerfile
FROM node:14-alpine
WORKDIR /forum
COPY package.json .
RUN yarn install
COPY . .
RUN npm run build
EXPOSE 3000
CMD ["yarn", "start"]
```
> é€™é‚Šæ²’ä½¿ç”¨ Volume æ˜¯å› ç‚ºé‚„æ²’å­¸åˆ°...ğŸ˜€ğŸ”ª<br>
> å¾Œç«¯å› ç‚ºæ˜¯å…¨éƒ¨äº¤çµ¦å¦ä¸€å€‹çµ„å“¡è™•ç†ï¼Œæ‰€ä»¥æˆ‘èƒ½ç´€éŒ„çš„æ±è¥¿ä¹Ÿä¸å¤š QQ

## Deployment
å› ç‚ºæˆ‘æ˜¯å…ˆçœ‹åˆ° docker-compose çš„æ•™å­¸ï¼ŒåŸæœ¬æƒ³ç”¨ Kompose ä¾†å°‡ docker-compose è½‰æ›ç‚º K8s çš„è¨­å®šæª”ï¼Œä¸éå› ç‚ºä¸ç®¡æ€éº¼è½‰éƒ½è½‰ä¸å‹•ï¼Œæ–¼æ˜¯æˆ‘å€‘æœ€å¾Œæ±ºå®šè‡ªå·±é‡æ–°è¨­å®š K8sã€‚

### Docker-compose
åœ¨æˆ‘å€‘å»ºç½®å®Œå‰å¾Œç«¯çš„å®¹å™¨å¾Œï¼Œç›´æ¥åœ¨å…©å€‹å°ˆæ¡ˆçš„å¤–é¢å†æ–°å¢ä¸€å€‹ docker-compose çš„ yaml æª”ï¼Œä¸éå› ç‚º

æª”æ¡ˆçµæ§‹å¦‚ä¸‹ï¼š

```
â–¾ forum/
  â–¸ public/
  â–¸ src/
    Dockerfile
    package.json
    yarn-error.log
    yarn.lock
â–¾ forumserver/
  â–¸ forum/
    Dockerfile
    requirements.txt
    start_server.sh
    uwsgi.ini
â–¾ nginx/
    nginx-setup.conf
  docker-compose.yml
```

è€Œ docker-compose çš„å…§å®¹å¦‚ä¸‹ï¼š

```yml
version: '3'

services:
  backend:
    build:
      context: ./forumserver
    command: /bin/sh /opt/uwsgi/start_server.sh
    ports:
      - "8000:8000"
  frontend:
    build:
      context: ./forum
    volumes:
      - react_build:/forum/build
    command: yarn start
  nginx:
    image: nginx:latest
    ports:
      - 80:8080
    volumes:
      - ./nginx/nginx-setup.conf:/etc/nginx/conf.d/default.conf:ro
      - react_build:/var/www/forum
    depends_on:
      - backend
      - frontend
volumes:
  react_build:

```

### Kubernetes


<font color="grey" style="font-size: 24px">Reference</font>
* [Kubernetes åŸºç¤æ•™å­¸ï¼ˆä¸€ï¼‰åŸç†ä»‹ç´¹](https://cwhu.medium.com/kubernetes-basic-concept-tutorial-e033e3504ec0)
* [Kubernetes åŸºç¤æ•™å­¸ï¼ˆäºŒï¼‰å¯¦ä½œç¯„ä¾‹ï¼šPodã€Serviceã€Deploymentã€Ingress](https://cwhu.medium.com/kubernetes-implement-ingress-deployment-tutorial-7431c5f96c3e)
* Youtube Link
