---
layout: post
title: Kubernetes å¯¦ä½œç´€éŒ„ï¼ˆä¸Šï¼‰- Web Application Settings
date: 2022-02-05 17:12 +0800
tags: update deploy
---

ä»Šå¤©æ±ºå®šä¾†å¯«ä¸Šå­¸æœŸå¿…ä¿®èª²çš„æœŸæœ«å ±å‘Šï¼é›–ç„¶èªªé€™å ‚èª²éå¾—éå¸¸è«åå…¶å¦™ï¼ŒæœŸæœ«å°ˆæ¡ˆä¹Ÿåªæœ‰ä¸€ï¼ˆï¼Ÿï¼‰å€‹æ¢ä»¶ï¼Œä¸éåœ¨å»ºå®Œæ•´å€‹å°ˆæ¡ˆä¹‹å¾Œé‚„æ˜¯å­¸åˆ°è »å¤šæ±è¥¿çš„ã€‚è‡³æ–¼è€å¸«æå‡ºçš„å”¯ä¸€ä¸€å€‹æ¢ä»¶å‰‡æ˜¯è¦æˆ‘å€‘ç†è§£å¾®æœå‹™åˆ°åº•åœ¨å¹¹å˜›ï¼Œä¸¦ä¸”ä¸€å®šè¦ç”¨åˆ° Kubernetesï¼›åœ¨èˆ‡çµ„å“¡è¨è«–éå¾Œï¼Œæˆ‘å€‘æ±ºå®šåšå€‹æœ€ç°¡å–®çš„è«–å£‡ç¶²ç«™ï¼ˆå¯ä»¥è¨»å†Šã€ç™»å…¥ã€ç™¼æ–‡ã€ç•™è¨€ï¼‰ï¼Œå‰ç«¯ä½¿ç”¨ React.jsï¼Œå¾Œç«¯ä½¿ç”¨ Django ä½œç‚º API serverï¼Œç”¨ Docker æŠŠé€™å…©å€‹æœå‹™æ‰“åŒ…å¾Œï¼Œå†ä¾†ç…©æƒ±è¦æ€éº¼ç”¨ K8s æˆ– Docker-compose å°é€™äº›æœå‹™åšç®¡ç†ã€‚

æœ¬å°ˆæ¡ˆçš„å‰ç«¯ç”± React.js (v17) å»ºç½®ï¼Œéƒ¨åˆ†å…ƒä»¶å› ç‚ºèˆ‡ä¹‹å‰å¯«çš„å°ˆæ¡ˆé€šç”¨ï¼Œæ‰€ä»¥ç”¨çš„æ˜¯åŸå§‹çš„ class basedï¼Œå¦ä¸€éƒ¨åˆ†~~å› ç‚ºè¢«ç•¢æ¥­å°ˆé¡Œçµ„å“¡æ¨å‘~~ï¼Œä½¿ç”¨çš„æ˜¯ functional component çš„å¯«æ³•ã€‚

## Basic Settings - Routing
åœ¨æ•´å€‹å‰ç«¯é–‹ç™¼çš„éç¨‹ä¸­ï¼Œæˆ‘é‡åˆ°æ¯”è¼ƒéº»ç…©çš„åœ°æ–¹æœ‰ Routing çš„è¨­ç½®ã€‚å› ç‚ºé€™æ¬¡å°ˆæ¡ˆä¸¦æ²’æœ‰å¾ˆå¤§ï¼Œæ‰€ä»¥æˆ‘æŠŠ routing çš„è¦å‰‡ç›´æ¥å¯«åœ¨ App.js è£¡ï¼Œä½¿ç”¨çš„æ˜¯ `react-router-dom` çš„å¥—ä»¶ã€‚åŸºæœ¬ä¸Šæœƒç”¨åˆ° BrowserRouterã€Routesã€Route ä¸‰å€‹ç‰©ä»¶ï¼Œ`BrowserRouter` ç”¨æ–¼è™•ç†å‹•æ…‹å…§å®¹çš„è·¯å¾‘å®£å‘Šï¼ˆéœæ…‹å‰‡ä½¿ç”¨ `HashRouter`ï¼‰ï¼Œ`Routes` å‰‡ç‚º v5 çš„ `Switch` åœ¨ v6 çš„å°æ‡‰ï¼Œä¹Ÿå°±æ˜¯æ§åˆ¶ url èˆ‡ path çš„ mappingï¼Œæœ€å¾Œ `Route` çš„éƒ¨åˆ†å°±æ˜¯å–®ç´”çš„è·¯å¾‘å®£å‘Šï¼Œèˆ‡è©²è·¯å¾‘å°æ‡‰åˆ°çš„å…ƒä»¶ã€‚

```jsx
import { BrowserRouter, Route, Routes } from "react-router-dom";

function App() {
  return (
    <>
      <Nav/>
      <div className='container py-5'>
        <BrowserRouter>
          <Routes>
              <Route index element={<PostContainer/>}/>
              <Route path="post/:postId" element={<Post />}/>
              <Route path="profile" element={<Profile />}/>
              <Route path="login" element={<Login />}/>
              <Route path="signup" element={<Signup />}/>
          </Routes>
        </BrowserRouter>
      </div>
    </>
  );
}
```

## Dockerfile
è‡³æ–¼å®¹å™¨åŒ–çš„éƒ¨åˆ†å°±çœŸçš„å¾ˆç°¡å–®ï¼Œåªéœ€è¦ä½¿ç”¨æ­£ç¢ºç‰ˆæœ¬çš„ node base imageï¼ˆæˆ‘å€‘ç”¨çš„æ˜¯ node:14-alpineï¼‰ï¼Œæ¥ä¸‹ä¾†åªè¦ç¢ºèªæ‰€æœ‰æ±è¥¿éƒ½æœ‰è¤‡è£½åˆ°å®¹å™¨è£¡ï¼Œç„¶å¾Œå®‰è£æ‰€æœ‰å¥—ä»¶ï¼Œå°±å¯ä»¥æŠŠå‰ç«¯çš„ server é–‹èµ·ä¾†äº†ã€‚
```Dockerfile
FROM node:14-alpine
WORKDIR /forum
COPY package.json .
RUN yarn install
COPY . .
RUN npm run build
EXPOSE 3000
CMD ["yarn", "start"]
```
> é€™é‚Šæ²’ä½¿ç”¨ Volume æ˜¯å› ç‚ºé‚„æ²’å­¸åˆ°...ğŸ˜€ğŸ”ª<br>
> å¾Œç«¯å› ç‚ºæ˜¯å…¨éƒ¨äº¤çµ¦å¦ä¸€å€‹çµ„å“¡è™•ç†ï¼Œæ‰€ä»¥æˆ‘èƒ½ç´€éŒ„çš„æ±è¥¿ä¹Ÿä¸å¤š QQ

## Docker-compose
### æª”æ¡ˆçµæ§‹
åœ¨æˆ‘å€‘å»ºç½®å®Œå‰å¾Œç«¯çš„å®¹å™¨å¾Œï¼Œç›´æ¥åœ¨å…©å€‹å°ˆæ¡ˆçš„å¤–é¢å†æ–°å¢ä¸€å€‹ docker-compose çš„ yaml æª”ã€‚ä¸éå› ç‚ºéœ€è¦ nginx ä¾†åå‘ä»£ç† React çš„ Node.js web serverï¼Œæ‰€ä»¥éœ€è¦æ–°å¢ä¸€æ”¯ `nginx-setup.conf` çš„è¨­å®šæª”ï¼›è€Œå¾Œç«¯æ¡ç”¨ uWSGI ä½œç‚º WSGI ä¼ºæœå™¨ï¼Œå› æ­¤æ‰æœƒæœ‰ `uwsgi.ini` é€™å€‹æª”æ¡ˆã€‚

```
â–¾ forum/  # front-end
  â–¸ public/
  â–¸ src/
    Dockerfile
    package.json
    yarn-error.log
    yarn.lock
â–¾ forumserver/  # back-end
  â–¸ forum/
    Dockerfile
    requirements.txt
    start_server.sh
    uwsgi.ini
â–¾ nginx/
    nginx-setup.conf
  docker-compose.yml
```

### WSGI & Nginx
åœ¨ç¬¬ä¸€æ¬¡æ¥è§¸åˆ° Python web app æ™‚ï¼Œå°±æœ‰è½èªªé WSGI é€™å€‹æ±è¥¿ï¼Œè‡³æ–¼ Nginx å‰‡æ˜¯é€£å¯¦ç¿’ä¹Ÿéƒ½æœƒç”¨åˆ°çš„å·¥å…·ï¼Œåœ¨é€™é‚Šå…ˆç°¡å–®ä»‹ç´¹ä¸€ä¸‹é€™å…©å€‹å·¥å…·çš„ç”¨é€”ï¼š
* WSGI: Python Web Server GateWay Interfaceï¼ŒPython å°æ–¼ Web Server èˆ‡ Web Application ä¹‹é–“æºé€šçš„è¦ç¯„ã€‚
* Nginx: å¯ä»¥æé«˜ Web server æ•ˆèƒ½ï¼Œå°æ–¼éœæ…‹æª”æ¡ˆæœ‰ Cache çš„æ©Ÿåˆ¶ï¼Œé™ä½ response çš„ç­‰å¾…æ™‚é–“ï¼ŒåŒæ™‚æœ‰å‡è¡¡é™„è¼‰çš„ç‰¹æ€§ï¼Œä¹Ÿå¯ä»¥ä½œç‚ºåå‘ä»£ç†ä¼ºæœå™¨

åœ¨æ¡ç”¨äº†ä¸Šè¿°å…©å€‹å·¥å…·å¾Œï¼Œå°ˆæ¡ˆçš„ request å‚³éæ¶æ§‹æœƒè·Ÿä¸‹åœ–ä¸€æ¨£ï¼š

![](/assets/img/docker-compose.jpg)

å› ç‚º Nginx server ç„¡æ³•å¯¦ç¾ WSGI è¦ç¯„ï¼Œå› æ­¤æˆ‘å€‘æ¡ç”¨äº† uWSGIï¼Œæ˜¯ä¸€ç¨®å¯¦ç¾äº† WSGI ç­‰è¦ç¯„çš„ serverï¼ˆå¦å¤–ä¸€ç¨®ä¹Ÿå¾ˆå¸¸è¦‹çš„ WSGI server ç‚º Gunicornï¼‰ï¼Œç”¨æ–¼æ¥æ”¶å‰ç«¯ï¼ˆä»£ç†ï¼‰ä¼ºæœå™¨è½‰ç™¼çš„å‹•æ…‹è«‹æ±‚ï¼Œè½‰ç™¼çµ¦ Web application(Django)ï¼Œä¸¦æ¥æ”¶å›å‚³çš„çµæœã€è½‰ç™¼çµ¦ä»£ç†ä¼ºæœå™¨(Nginx)ã€‚

ç‚ºäº†èƒ½é †åˆ©ä½¿ç”¨ Nginx èˆ‡ uWSGI server åšæºé€šï¼Œæˆ‘å€‘éœ€è¦åŠ ä¸Š Nginx çš„è¨­å®šæª”ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯è¨­å®šè¦è½å“ªå€‹ port ä¾†çš„ requestï¼Œé‚„æœ‰ API server çš„ä½ç½®ï¼Œä¸¦ä¸”è¨­å®šéœæ…‹æª”æ¡ˆçš„è·¯å¾‘ã€‚å…¶ä¸­ `try_files` é‚£è¡Œçš„æ„ç¾©æ˜¯ï¼Œç•¶é‡åˆ°ç„¡æ³•è§£æçš„è·¯å¾‘æ™‚ï¼Œå…¨éƒ¨éƒ½å°å‘ `index.html`ï¼Œé€™éº¼åšå°±æœƒé”åˆ°è®€å– React app çš„æ•ˆæœã€‚

```nginx
upstream api {
    server backend:8000;
}

server {
  listen 8080;

  location / {
    root /var/www/forum;
    try_files $uri $uri/ /index.html =404;
  }

  location /api/ {
    proxy_pass http://api;
    proxy_set_header Host $http_host;
  }
}
```

### docker-compose.yml
æœ€å¾Œå› ç‚ºæˆ‘å€‘åŠ ä¸Šäº† Nginxï¼Œå› æ­¤æœƒéœ€è¦åœ¨ `docker-compose.yml` è£¡æ–°å¢ä¸€é … Nginx çš„æœå‹™ï¼›æ‰€ä»¥æœ€å¾Œç¸½å…±æœƒæœ‰å‰å¾Œç«¯èˆ‡ Nginx ä¸‰å€‹æœå‹™ï¼Œè¨­ç½®å¦‚ä¸‹ï¼š

```yml
version: '3'

services:
  backend:
    build:
      context: ./forumserver
    command: /bin/sh /opt/uwsgi/start_server.sh
    ports:
      - "8000:8000"
  frontend:
    build:
      context: ./forum
    volumes:
      - react_build:/forum/build
    command: yarn start
  nginx:
    image: nginx:latest
    ports:
      - 80:8080
    volumes:
      - ./nginx/nginx-setup.conf:/etc/nginx/conf.d/default.conf:ro
      - react_build:/var/www/forum
    depends_on:
      - backend
      - frontend
volumes:
  react_build:

```




<font color="grey" style="font-size: 24px">Reference</font>
* [Flask ç‚ºç”šéº¼éœ€è¦ WSGI èˆ‡ Nginx](https://www.maxlist.xyz/2020/05/06/flask-wsgi-nginx/)
* [Docker \| Towards serving React (Nginx) with Django API (gunicorn)](https://www.youtube.com/watch?v=e63EBEFJkH0)
* [[Docker æ•™å­¸] å¦‚ä½•å°‡å‰ç«¯ç¶²ç«™æ‰“åŒ…æˆ Docker Image](https://youtu.be/QdTmWAaB38A?t=376)
