---
layout: post
title: SSH to EC2 with Auto Assigned Certificates
date: 2022-06-05 16:24 +0800
tags: update aws ec2 ssh
---
åœ¨é–‹å§‹ä½¿ç”¨ EC2 å¾Œï¼Œæ¯æ¬¡éƒ½è¦æ‰¾åˆ° EC2 çš„ certificate å¸¶å…¥ ssh çš„æŒ‡ä»¤è£¡çœŸã„‰å¾ˆéº»ç…©ï¼Œå‰›å¥½åœ¨ä¸Šæ¬¡ä¸Šèª²çš„æ™‚å€™è€å¸«æ•™äº† ssh çš„è¨­å®šï¼Œè®“æˆ‘å€‘åœ¨ä¹‹å¾Œé€£å…¥ EC2 éƒ½å¯ä»¥ä½¿ç”¨åŸæœ¬é›»è…¦è£¡çš„ ssh keyã€ä¸¦é€é `ssh i-[EC2 id]` å°±èƒ½é€£åˆ° EC2 è£¡ã„Œï¼Œæ¯”åŸæœ¬çš„æ–¹æ³•æ–¹ä¾¿è¨±å¤šï¼
## Create qualified EC2
åœ¨ EC2 çš„éƒ¨åˆ†ï¼Œä¸»è¦æ˜¯éœ€è¦å°‡ Session Manager çš„ *role* æŒ‡å®šçµ¦æˆ‘å€‘æƒ³è¦é€£ç·šçš„ EC2
- Create new EC2 instances(optional)
- Assigning IAM role with Session Manager access
  - Policy name: `AmazonEC2RoleforSSM`

## æ–°å¢ä½¿ç”¨è€…
åŒæ™‚æˆ‘å€‘å¿…é ˆè¦æŒ‡å®šï¼Œä»Šå¤©é€£é€² EC2 çš„æ˜¯å“ªä¸€å€‹ *user*
- åœ¨ AWS IAM æ–°å¢ä¸€å€‹ userï¼Œè©² user è¦æœ‰ `AdministratorAccess`
- `aws configure --profile default` æ–°å¢ä¸€å€‹ default çš„ aws user

    ![æˆªåœ– 2022-06-05 15.57.54.png](/assets/img/key-sec.png)

    - USER_KEY = `[Access key ID]`
    - USER_SECRET = `[Secret access key]`

## è¨­å®šæœ¬åœ°ç«¯ SSH
æœ€å¾Œå°±æ˜¯æ¯”è¼ƒéº»ç…©çš„ ssh è¨­å®šï¼Œåƒè€ƒä¸‹é¢çš„é€™å€‹ script
- Ref:  https://github.com/qoomon/aws-ssm-ec2-proxy-command
- è¤‡è£½ [aws-ssm-ec2-proxy-command.sh](https://github.com/qoomon/aws-ssm-ec2-proxy-command/blob/master/aws-ssm-ec2-proxy-command.sh) åˆ° `.ssh` ä¸‹
- `chmod +x ~/.ssh/aws-ssm-ec2-proxy-command.sh`
- å¯¦éš›ä½¿ç”¨ï¼šä»¥ default IAM user é€£é€² EC2

  ```bash
  AWS_PROFILE=default ssh ec2-user@i-0c45c33713e830c9d \
    -i "~/.ssh/id_ed25519" \
    -o ProxyCommand="~/.ssh/aws-ssm-ec2-proxy-command.sh %h %r %p ~/.ssh/id_ed25519.pub"
  ```

- åŠ å…¥ `.ssh/config`

  ```bash
  host i-* mi-*
    User ec2-user
    IdentityFile ~/.ssh/id_ed25519
    ProxyCommand ~/.ssh/aws-ssm-ec2-proxy-command.sh %h %r %p ~/.ssh/id_ed25519.pub
    StrictHostKeyChecking no
  ```

- è¨­å®šå®Œå¾Œèˆ‡ EC2 é€£ç·šï¼š`ssh i-072f2dd63ae1189e9`

å®Œæˆå•¦ï¼ï¼ï¼ğŸ¥³ğŸ¥³ğŸ¥³ğŸ¥³
