---
layout: post
title: Deploy Rails with Docker Swarm (2) - æµç¨‹ä»‹ç´¹èˆ‡è¨­å®š Traefik & Rails
date: 2022-08-03 22:33 +0800
tags: update COSCUP docker-swarm traefik deploy
---
æ¥ä¸‹ä¾†è®“æˆ‘å€‘é€²åˆ°å¯¦éš›æ“ä½œçš„éƒ¨åˆ†ï¼é€™ç¯‡ä¸»è¦æœƒå…ˆä»‹ç´¹ä¸€ä¸‹å¾ŒçºŒçš„æ–‡ç« æ¶æ§‹ï¼Œä¸»è¦æ˜¯åˆ†æˆä»¥ä¸‹ä¸‰å€‹éƒ¨åˆ†ï¼š

1. è¨­å®š Rails & Traefik
2. è¨­å®š AWS
3. è¨­å®š Gitlab runner è‡ªå‹•åŒ–éƒ¨ç½²

å› ç‚ºç¯‡å¹…çš„é—œä¿‚ï¼Œé€™ç¯‡æ–‡æœƒå…ˆä»‹ç´¹ç¬¬ä¸€éƒ¨åˆ†ï¼Œå¾Œé¢å…©éƒ¨åˆ†ä¹Ÿæœƒå†å¦å¤–ç™¼æ–°çš„æ–‡ç« <br>ï¼ˆä¸çŸ¥ä¸è¦ºå°±è®Šæˆé€£è¼‰ç³»åˆ—äº†ğŸ« ï¼‰


## éƒ¨ç½²æµç¨‹

### å¯¦ä½œæµç¨‹

- æœ¬åœ°ç«¯é€²è¡Œéƒ¨ç½²
    - é–‹å•Ÿ rails production server
    - ç¢ºèªæœ¬åœ°ç«¯ Docker compose build/up çš†å¯é †åˆ©åŸ·è¡Œ
- æ‰‹å‹• ssh é€²å…¥ EC2 éƒ¨ç½²
    - å°‡ Traefik èˆ‡ Docker Swarm ç›´æ¥éƒ¨ç½²åœ¨ EC2 è£¡ï¼Œè©³ç´°çš„æµç¨‹æœƒåœ¨ä¸‹ä¸€éƒ¨åˆ†çš„åœ–è£¡èªªæ˜
- åˆ©ç”¨ Gitlab runner è‡ªå‹•éƒ¨ç½²
    - å°‡å‰ä¸€æ­¥çš„æ‰€æœ‰è¨­å®šã€éƒ¨ç½²æŒ‡ä»¤è‡ªå‹•åŒ–

### å¯¦éš›éƒ¨ç½²æµç¨‹

é€™é‚Šè¦è¬›çš„æ˜¯å®Œæ•´çš„éƒ¨ç½²æµç¨‹ä¸ŠåŸ·è¡Œäº†å“ªäº›è¨­å®šï¼Œå¾ŒçºŒçš„ä»‹ç´¹ä¹Ÿæœƒå°‡ä»¥ä¸‹å››é»çš„é †åºä½œç‚ºä¸»è¦æ¶æ§‹é€²è¡Œä»‹ç´¹ï¼š

1. è¨­å®š Traefik Serviceï¼šä¾ç…§ä¸Šä¸€ç¯‡æåˆ°çš„ Traefik ç‰¹æ€§ï¼Œå…ˆè¨­å®š reverse proxyï¼ˆå†æŠŠ app æ›ä¸Šå»ï¼‰
2. è¨­å®š Rails App Serviceï¼šåŸºæœ¬ä¸Šç­‰æ–¼åœ¨æœ¬åœ°ç«¯éƒ¨ç½²çš„æ­¥é©Ÿï¼Œä¹Ÿå°±æ˜¯ç¢ºèª Docker compose build/up å¯ä»¥é †åˆ©é–‹å•Ÿæœå‹™
3. è¨­å®š EC2 èˆ‡ Route53ï¼šåœ¨ç¢ºèªè¨­å®šæª”å¤§è‡´å®Œæˆå¾Œï¼Œè¨­å®šä¸¦é–‹å•Ÿ EC2ï¼Œå°‡å‰›å‰›è¨­å®šçš„æœå‹™éƒ¨ç½²ä¸Šå»
4. è‡ªå‹•åŒ–éƒ¨ç½² with Gitlab Runnerï¼šè¨»å†Šä¸¦æ’°å¯« runner çš„è…³æœ¬ï¼ˆ`.gitlab-ci.yml`ï¼‰ï¼Œè€Œè…³æœ¬çš„å…§å®¹å‰‡æ˜¯**å¯¦éš›åœ¨éƒ¨ç½²æ™‚éœ€è¦å°æ©Ÿå™¨æœ¬èº«ä¸‹çš„è¨­å®š**ï¼Œå…§å®¹å¦‚ä¸‹ï¼š
    1. é–‹å•Ÿ Docker Swarm
    2. å‰µå»º `traefik-public` çš„å…¬é–‹ Networkï¼Œè®“ App service å¯ä»¥ä½¿ç”¨ traefik ä¾†åš reverse proxy
    3. æŒ‡å®šæ¯æ¬¡ Traefik æ›´æ–°æ™‚å›ºå®šä½¿ç”¨åŒå€‹ç¯€é»
    4. ä½¿ç”¨ docker stack éƒ¨ç½² Traefik
    5. éƒ¨ç½² Rails App

    ![order1](/assets/img/order1.jpg)
    {: #order1}

    å¯¦éš›éƒ¨ç½² Docker Swarm çš„æµç¨‹


## Rails & Traefik Service

### Traefik Service Settings

Traefik èˆ‡ Rails App å…¶å¯¦æ˜¯å…©å€‹ç¨ç«‹çš„æœå‹™ï¼Œå› æ­¤é€™é‚Šæœƒå°‡ Traefik èˆ‡ Rails App çš„è¨­å®šæª”åˆ†é–‹ï¼Œä¹Ÿå°±æ˜¯ **Traefik æœƒæœ‰ä¸€å€‹ `traefik.yml` ç”¨æ–¼éƒ¨ç½² traefik stack**ï¼Œè€Œ **Rails App å‰‡æ˜¯ä½¿ç”¨åŸå§‹çš„ `docker-compose.yml` å»éƒ¨ç½² task stack**ï¼ˆé€™é‚Šçš„ Rails App å«åš Task-Managerï¼Œå› æ­¤ stack name å–ç‚º `task`ï¼‰

é¦–å…ˆåœ¨ traefik.yml ä¸­çš„è¨­å®šæœƒèˆ‡ä¸€èˆ¬çš„ docker compose file æ¶æ§‹ç›¸åŒï¼Œé€™é‚Šæˆ‘æ˜¯åƒè€ƒ [dockerswarm.rocks](https://dockerswarm.rocks/traefik/) è£¡æä¾›çš„ Traefik è¨­å®šç¯„ä¾‹é€²è¡Œè¨­å®šï¼Œä¸éæˆ‘å€‘æœƒéœ€è¦ç‰¹åˆ¥è¨­å®šä»¥ä¸‹å¹¾é»ï¼ˆé€™éƒ¨åˆ†ä¹Ÿå¯ä»¥ç›´æ¥åƒè€ƒæˆ‘å¯«å¥½çš„è¨­å®šæª”  [traefik.yml / Task-Manager-Ruby Â· GitLab](https://gitlab.com/joannachou713/task-manager-ruby/-/blob/main/traefik.yml)ï¼‰ï¼š

- Networkï¼šéœ€è¦æ–°å¢ä¸€å€‹å« `traefik-public` çš„ç¶²è·¯ï¼Œä¸¦ä¸”è¨­å®šç‚º externalï¼Œå¥½è®“ Rails App å¯ä»¥é€éé€™å€‹ç¶²è·¯èˆ‡ Traefik æºé€š
- Volumesï¼šæ–°å¢ä¸€å€‹ `traefik-public-certificate` çš„ volumeï¼Œç”¨æ–¼å­˜æ”¾å·²ç¶“ç”³è«‹éçš„æ†‘è­‰
- Serviceï¼šåˆ†ç‚ºå…©éƒ¨åˆ†éœ€è¦æ³¨æ„ï¼ŒCommand èˆ‡ Deploy Label
    - Commandï¼šTraefik çš„**åŸºæœ¬è¨­å®š**ï¼Œéœ€è¦æŒ‡å®š Docker providerã€é–‹å•Ÿ Swarm modeï¼Œæ†‘è­‰çš„ç”³è«‹ã€å„²å­˜ä½ç½®ï¼Œä»¥åŠ DNS Challenge ç­‰ç­‰
    - Deploy Labelï¼šç‚ºäº†è¦é–‹å•Ÿ Traefik Dashboard è€Œè¨­å®šçš„ **reverse proxy routing**ï¼Œä¸»è¦æœ‰ä¸‹åˆ—å¹¾é»è¦è¨­å®šï¼š
        - é–‹å•Ÿ Traefik ä¸¦åŠ å…¥ `traefik-public` Network
        - Dashboard ç™»å…¥å¸³å¯†
        - Http/Https host
        - Redirect middlewareï¼šç•¶ç”¨æˆ¶ä½¿ç”¨ Http ç™¼é€è«‹æ±‚ï¼Œè‡ªå‹•è½‰ç‚º Https
        - [Load balancer](#LB) portï¼šç•¶æœ‰ç›®çš„åœ°æ˜¯ host çš„è«‹æ±‚ï¼ŒTraefik éœ€è¦å°‡å…¶å°å‘çš„ port
        - è¨­å®š [wildcard](#wildcard) é©—è­‰éçš„ domain

åˆ°é€™ä¸€æ­¥åŸºæœ¬ä¸Š Traefik æœ¬èº«å·²ç¶“è¨­å®šå®Œç•¢ï¼Œå¯ä»¥å…ˆé€² EC2 è£¡é–‹å¥½ Traefik stack ä¾†æª¢æŸ¥æ˜¯å¦èƒ½æ­£ç¢ºé–‹å•Ÿã€‚

### Rails App(Application) Service

æ¥ä¸‹ä¾†è¦èªªæ˜çš„æ˜¯ Rails App è¦æ€éº¼è¨­å®šï¼Œç•¶ç„¶é€™å€‹éƒ¨ç½²æ¶æ§‹ä¸åªé™å®šæ–¼ Rails Appï¼Œä¸éé€™å€‹æ­¥é©Ÿå¯èƒ½è¦ä¾ç…§ä½¿ç”¨çš„èªè¨€æˆ–æ¡†æ¶è€Œæ”¹å‹•ã€‚

é¦–å…ˆå¿…é ˆç”Ÿæˆä¸€çµ„ `RAILS_MASTER_KEY`ï¼Œå› ç‚º Rails åœ¨ Production ç’°å¢ƒä¸­éœ€è¦æœ‰ `RAILS_MASTER_KEY` æ‰èƒ½å•Ÿå‹•ï¼Œç¢ºå®š production server å¯æ­£å¸¸é–‹å•Ÿå¾Œï¼Œå¯ä»¥ä¾†æº–å‚™æˆ‘å€‘çš„ Dockerfile èˆ‡ Docker-compose file ä¾†é€²è¡Œ task stack çš„è¨­å®š

#### Dockerfile

é€™éƒ¨åˆ†æˆ‘ä½¿ç”¨çš„æ˜¯ https://github.com/elct9620/boxing é€™å€‹ gem ä¾†å¹«æˆ‘è‡ªå‹•ç”Ÿæˆï¼Œä»–æœƒä¾æ“šå°ˆæ¡ˆä¸­çš„ Gemfile ä»¥åŠ boxing æœ¬èº«çš„è¨­å®šæª”ï¼ˆ`config/boxing.rb`ï¼‰ä¾†è‡ªå‹•ç”Ÿæˆ Dockerfileã€‚å¦å¤–é€™å€‹ Gem çš„ä½œè€…ï¼ˆä¹Ÿå°±æ˜¯è’¼æ™‚å¤§å¤§ï¼‰æœ‰ç‰¹åˆ¥ç ”ç©¶å¦‚ä½•ç”Ÿæˆæœ€å°åŒ–çš„ Docker imageï¼Œå› æ­¤è‡ªå‹•ç”Ÿæˆçš„æ˜ åƒæª”å¤§ç´„åªæœƒæœ‰ï¼ˆæ“šä»–æœ¬äººæ‰€èªªï¼‰ 100 MBï¼Œä¸‹é¢åˆ—å‡ºå¯ä»¥å¦å¤–è¨­å®šçš„é¸é …ï¼ˆç²—é«”ç‚ºæˆ‘é€™æ¬¡æœ‰æ¡ç”¨çš„è¨­å®šï¼‰ï¼š

- Source Code Root
- Ignore File
- **Extra Packages: Node.js & Python**
- Revision Information
- Sentry Support
- **Asset Precompile: True**
- Health Check

> è£œå……ï¼š**[OpenBox](https://github.com/elct9620/openbox)** - Auto generate entrypoint settingsï¼Œå¦‚æœå°‡ Boxing èˆ‡ OpenBox åŒæ™‚æ¡ç”¨çš„è©±ï¼ŒBoxing ç”Ÿæˆçš„ Dockerfile æœƒå°‡ Entrypoint è‡ªå‹•æŒ‡å®šç‚º OpenBox ç”Ÿæˆçš„ Entrypoint
>

#### Docker-compose file

èˆ‡åœ¨æœ¬åœ°ç«¯è¨­å®šçš„ `docker-compose.yml` åŸºæœ¬ä¸Šä¸€æ¨£ï¼Œæˆ‘åœ¨é€™é‚Šæ˜¯åªæœ‰è¨­å®šä¸‰å€‹ service(app/redis/postgres)ï¼ŒNetwork åªæœ‰ net è®“ä¸‰å€‹ service å…±äº«ï¼Œä¸¦åŠ ä¸Šä¸‹é¢å…©é …è¨­å®šï¼š

- `RAILS_MASTER_KEY`ï¼šå‰›å‰›ç”Ÿæˆçš„ `RAILS_MASTER_KEY` å¯ä»¥å…ˆæ”¾åˆ° Gitlab ä¸­è¨­å®šç‚º CI variableï¼ˆå¦‚æœè¦è·‘æœ¬åœ°æ¸¬è©¦çš„è©±å¯ä»¥å°‡ `RAILS_MASTER_KEY` æ”¾åœ¨ .envã€æˆ–è€…è¨­å®šç‚º app service çš„ environment varï¼Œå¯ä»¥åƒè€ƒ[æœ¬åœ°ç«¯çš„ docker-compose](https://gitlab.com/joannachou713/task-manager-ruby/-/blob/main/docker-compose-local.yml) Line 55ï¼‰
- `DATABSE_URL`ï¼šåœ¨ app service çš„ environment variable è¦ç‰¹åˆ¥æŒ‡å®šè³‡æ–™åº«çš„è·¯å¾‘ï¼Œæ‰èƒ½æ­£ç¢ºé€£ç·šåˆ° postgres serviceï¼Œä¸¦ä¸”è¦æ³¨æ„æ ¼å¼ç‚º `postgresql://[user[:password]@][netloc][:port][/dbname][?param1=value1&...]`

åšå®ŒåŸºæœ¬çš„è¨­å®šå¾Œï¼Œåœ¨æŠŠ Traefik ç›¸é—œçš„ routing rules åŠ åˆ° deploy label ä¸Šã€‚é€™éƒ¨åˆ†å’Œåœ¨è¨­å®š Traefik çš„ deploy labels ä¸€æ¨£ï¼Œè¨­å®šå®Œç•¢å¾Œæœƒåƒ[é€™å€‹æª”æ¡ˆ](https://gitlab.com/joannachou713/task-manager-ruby/-/blob/main/docker-compose.yml)é¡ä¼¼ã€‚

---
### è£œå……
#### Load Balancer Port è¨­å®š
{: #LB }
å‡è¨­ä»Šå¤©æˆ‘å€‘çš„ domain æ˜¯ `abc.dev` æœ‰ç”¨æˆ¶è«‹æ±‚äº† `traefik.abc.dev(aka æˆ‘å€‘çš„ host name)`ï¼Œè€Œæˆ‘å€‘çš„ Traefik Dashboard é–‹åœ¨ 8080 portï¼Œå‰‡ Traefik æœƒå°‡é€™å€‹ request å°å‘ 8080

#### Wildcard ç›¸é—œçŸ¥è­˜
{: #wildcard }
ç›¸é—œè¨­å®šçš„è£œå……çŸ¥è­˜ï¼Œé€™é‚Šéœ€è¦åƒè€ƒæˆ‘å·²ç¶“å¯«å¥½çš„[è¨­å®šæª”](https://gitlab.com/joannachou713/task-manager-ruby/-/blob/main/traefik.yml)

- Wildcardï¼š[ACME é©—è­‰æ–¹å¼ - Let's Encrypt - å…è²»çš„ SSL/TLS æ†‘è­‰ (letsencrypt.org)](https://letsencrypt.org/zh-tw/docs/challenge-types/#dns-01-%E8%80%83%E9%A9%97)
    - å¯ä»¥ç›´æ¥ç”³è«‹æŸå€‹ domain çš„æ†‘è­‰ï¼Œè®“æ•´å€‹ domain ä¸‹çš„æ‰€æœ‰ host éƒ½å¯ä»¥ä½¿ç”¨åŒä¸€å¼µæ†‘è­‰ï¼ˆdomain.sans éƒ¨åˆ†ï¼‰ï¼Œä¸éœ€ç‰¹åœ°ç‚ºæ‰€æœ‰ host å€‹åˆ¥ç”³è«‹æ†‘è­‰
    - å±¬æ–¼ Letâ€™s Encrypt ç™¼æ”¾çš„å…¶ä¸­ä¸€ç¨®æ†‘è­‰æ ¼å¼
- çµ¦äºˆ route53 æ¬Šé™çš„åŸå› 
    - å› ç‚ºè¨­å®š DNS challenge èˆ‡ DNS Challenge Provider ç‚º route53
    - DNS challengeï¼šéœ€è¦æœ‰ route53 çš„æ¬Šé™æ‰èƒ½å‹•æ…‹é©—è­‰ *.domain ä¸‹çš„æ‰€æœ‰ host
    - Route53 æä¾›è‡ªå‹•æ›´æ–°æ†‘è­‰çš„ API

---
ç¬¬ä¸€éƒ¨åˆ†å°±åˆ°é€™é‚ŠçµæŸï¼Œå…¶å¯¦åšåˆ°é€™å€‹æ­¥é©Ÿæ‡‰è©²å°±èƒ½åœ¨æœ¬åœ°ç«¯é€²è¡Œéƒ¨ç½²ï¼ˆåƒ…é™ Rails éƒ¨åˆ†ï¼‰

å¸Œæœ›å¤§å®¶èˆ‡ Docker å¯ä»¥å¥½å¥½ç›¸è™•ï¼Œä»–çœŸçš„æ˜¯å€‹å¥½ç”¨ã„‰é…·æ±è¥¿ï¼ˆ
