<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.2.1">Jekyll</generator><link href="https://jqlynchien713.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://jqlynchien713.github.io/" rel="alternate" type="text/html" /><updated>2023-03-17T09:15:07+00:00</updated><id>https://jqlynchien713.github.io/feed.xml</id><title type="html">Jacquelynâ€™s Blog</title><subtitle>Ê• â€¢á´¥â€¢Ê”</subtitle><entry><title type="html">Deploy Rails with Docker Swarm (4) - Gitlab Runner è‡ªå‹•åŒ–éƒ¨ç½²</title><link href="https://jqlynchien713.github.io/2022/08/03/coscup4.html" rel="alternate" type="text/html" title="Deploy Rails with Docker Swarm (4) - Gitlab Runner è‡ªå‹•åŒ–éƒ¨ç½²" /><published>2022-08-03T15:16:00+00:00</published><updated>2022-08-03T15:16:00+00:00</updated><id>https://jqlynchien713.github.io/2022/08/03/coscup4</id><content type="html" xml:base="https://jqlynchien713.github.io/2022/08/03/coscup4.html"><![CDATA[<h2 id="è‡ªå‹•åŒ–éƒ¨ç½²-with-gitlab-runner">è‡ªå‹•åŒ–éƒ¨ç½² with Gitlab Runner</h2>

<h3 id="registration">Registration</h3>

<p>é€²å…¥ä¸Šä¸€ç¯‡é–‹å¥½çš„ Manager EC2ï¼Œä¸¦ä¸”æ­¤æ™‚çš„ EC2 æ‡‰è©²å·²ç¶“å®‰è£å¥½ Gitlab Runnerï¼Œé€™æ™‚å€™å¯ä»¥ç›´æ¥è¨»å†Šæˆ‘å€‘çš„ Runnerï¼š<code class="language-plaintext highlighter-rouge">sudo gitlab-runner register</code>ï¼Œä¸‹å¥½æŒ‡ä»¤å¾Œä¸€å…±æœƒå•ä¸ƒå€‹å•é¡Œï¼š</p>

<ul>
  <li>Gitlab instance URL</li>
  <li>Registration Code
    <ul>
      <li>å‰å…©å€‹å•é¡Œå¯ä»¥é€²å…¥åˆ° Gitlab project &gt; Settings &gt; CI/CD &gt; Runner å»æŸ¥çœ‹è¨­å®šç´°ç¯€ï¼Œå¦‚é™„åœ–çš„å·¦å´</li>
    </ul>
  </li>
  <li>Description for runner: docker
    <ul>
      <li>é™„åœ–å³å´ç™½åº•é»‘å­—çš„éƒ¨åˆ†</li>
    </ul>
  </li>
  <li>Tags for runner(comma seperated): prod
    <ul>
      <li>é™„åœ–è—åº•éƒ¨åˆ†ï¼Œä¸”é€™å€‹ tag æ˜¯åœ¨<strong>å¾ŒçºŒæŒ‡å®š job è¦å“ªå€‹ runner åŸ·è¡Œçš„ä¾æ“š</strong></li>
    </ul>
  </li>
  <li>Optional maintenance note for runner: (optional)</li>
  <li>Enter the executor: docker</li>
  <li>Default Docker image: <code class="language-plaintext highlighter-rouge">tiangolo/docker-with-compose</code>
    <ul>
      <li>å¾ŒçºŒçš„ job éœ€è¦ compose å¹«æˆ‘å€‘ build imageï¼Œå› æ­¤éœ€è¦æŒ‡å®šé€™å€‹ image</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/img/runner.jpg" alt="/assets/img/runner.jpg" /></p>

<h3 id="gitlab-ciyml">.gitlab-ci.yml</h3>

<p>é€™é‚Šä¸»è¦ä¹Ÿæ˜¯åƒè€ƒ <a href="https://dockerswarm.rocks/gitlab-ci/">dockerswarm.rocks</a> çš„ç¯„ä¾‹ï¼Œä»¥ä¸‹ç°¡å–®ä»‹ç´¹ä¸€ä¸‹ä»–çš„è¨­å®šå…§å®¹ï¼š</p>

<ul>
  <li>Stage: åˆ†ç‚º build èˆ‡ deploy
    <ul>
      <li>Build: <code class="language-plaintext highlighter-rouge">docker-compose build --build-arg RAILS_MASTER_KEY=$RAILS_MASTER_KEY</code>
  å–®ç´”åªæœ‰ build imageï¼Œä½†å› ç‚ºæˆ‘çš„ Dockerfile åŒ…å«äº† Asset Precompileï¼Œå› æ­¤éœ€è¦å¸¶å…¥ <code class="language-plaintext highlighter-rouge">RAILS_MASTER_KEY</code> åšç‚ºåƒæ•¸</li>
      <li>Deploy: <code class="language-plaintext highlighter-rouge">docker stack deploy -c docker-compose.yml [stack name]</code></li>
    </ul>
  </li>
  <li>Only: æŒ‡å®šç™¼ç”Ÿæ–¼ main branch</li>
  <li>Tags: ç”¨æ–¼æŒ‡å®šåŸ·è¡Œçš„ runner</li>
</ul>

<h3 id="ec2-prerequisites">EC2 Prerequisites</h3>

<p>å› ç‚º Traefik èˆ‡ Rails App ç‚ºç¨ç«‹çš„å…©å€‹ Stackï¼Œç‚ºäº†ç°¡åŒ–é–‹ç™¼æµç¨‹ï¼Œé€™é‚Šé¸æ“‡æ‰‹å‹•é€²å…¥ EC2 éƒ¨ç½² Traefik</p>

<blockquote>
  <p>åŸæœ¬æ˜¯å¦å¤–é–‹ä¸€å€‹ traefik åˆ†æ”¯åš Traefik éƒ¨ç½²ï¼ˆä¸¦ä¸”æŒ‡å®š Traefik éƒ¨ç½²çš„ job åªç™¼ç”Ÿåœ¨è©²åˆ†æ”¯ã€åªæœƒç™¼ç”Ÿä¸€æ¬¡ï¼‰ï¼Œä½†åœ¨æ¼”è¬›æ™‚æœ‰äººåæ˜ ä¸ç¢ºå®š traefik åˆ†æ”¯éƒ¨ç½²å¾Œè¦ä¸è¦åˆåˆ° main åˆ†æ”¯ä¸Šã€git graph æœ‰é»ä¸æ˜ç¢ºï¼Œå› æ­¤æ”¹ç‚ºä»¥å…¬å¸å¯¦éš›éƒ¨ç½²çš„æµç¨‹åšä»‹ç´¹</p>

</blockquote>

<p>éƒ¨ç½²çš„æ­¥é©Ÿå°±åƒåœ¨å¯¦éš›éƒ¨ç½²æµç¨‹æåˆ°çš„åœ–è¡¨ä¸€æ¨£ï¼š</p>

<ol>
  <li>é–‹å•Ÿä¸€å€‹ swarmï¼š<code class="language-plaintext highlighter-rouge">docker swarm init --default-addr-pool 10.20.0.0/16</code>
    <ul>
      <li>å› ç‚º Docker é è¨­çš„ subnet range èˆ‡ EC2 ç›¸åŒï¼Œéƒ½æ˜¯ <code class="language-plaintext highlighter-rouge">10.0.0.1</code>ï¼Œå› æ­¤é€™é‚Šè¦ç‰¹åˆ¥æŒ‡å®šä¸ä¸€æ¨£çš„ç¯„åœï¼Œ Swarm æ‰é€£çš„åˆ°å¤–ç¶²</li>
    </ul>
  </li>
  <li>é–‹å•Ÿ traefik networkï¼š<code class="language-plaintext highlighter-rouge">docker network create --driver=overlay traefik-public</code></li>
  <li>å–å¾—ç¾åœ¨çš„ swarm manager node idï¼š<code class="language-plaintext highlighter-rouge">export NODE_ID=$(docker info -f '')</code></li>
  <li>æŒ‡å®š traefik æ¯æ¬¡éƒ½ deploy åœ¨åŒä¸€å€‹ node &amp; volume ä¸Šï¼š<code class="language-plaintext highlighter-rouge">docker node update --label-add traefik-public.traefik-public-certificates=true $NODE_ID</code></li>
  <li>éƒ¨ç½² traefikï¼š<code class="language-plaintext highlighter-rouge">docker stack deploy -c traefik.yml traefik</code></li>
</ol>

<h2 id="æœ€å¾Œå°±æ˜¯æŠŠ-app-æ¨ä¸Š-gitlab-é€²è¡Œéƒ¨ç½²ã„Œ">æœ€å¾Œå°±æ˜¯æŠŠ App æ¨ä¸Š GitLab é€²è¡Œéƒ¨ç½²ã„Œï¼ï¼ï¼</h2>

<h3 id="worker-node-åŠ å…¥-docker-swarm">Worker Node åŠ å…¥ Docker Swarm</h3>

<p>åˆ°é€™é‚Šè¨­å®šå®Œ Manager ç¯€é»å¾Œï¼Œæˆ‘å€‘å¯ä»¥å›å»é–‹ Worker Templateï¼ŒæŠŠåŠ å…¥ Swarm çš„æŒ‡ä»¤åŠ å›å»ï¼š</p>

<ol>
  <li>å…ˆåœ¨ Manager æ‰¾å›åŠ å…¥ Swarm çš„æŒ‡ä»¤ï¼š<code class="language-plaintext highlighter-rouge">docker swarm join-token worker</code></li>
  <li>
    <p>åœ¨ Worker Template çš„ User Data ä¸­åŠ å…¥å‰›å‰›æ‰¾å›çš„æŒ‡ä»¤ï¼Œæ–¼æ˜¯æœ€çµ‚çš„ User Data æœƒé•·ä¸‹é¢é€™æ¨£ï¼š</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c">#!/bin/bash</span>
 <span class="c"># Start docker daemon</span>
 <span class="nb">sudo </span>service docker start
 <span class="nb">sudo chown </span>ec2-user:docker /var/run/docker.sock

 <span class="c"># Join swarm</span>
 docker swarm <span class="nb">join</span> <span class="nt">--token</span> <span class="o">[</span>JOIN-TOKEN] <span class="o">[</span>IP-ADDRESS]:2377
</code></pre></div>    </div>
  </li>
</ol>

<hr />

<p>åˆ°é€™é‚Šä¸»è¦çš„æŠ€è¡“è¨­å®šéƒ½çµæŸäº†â€¦..çœŸçš„æ˜¯è¶…å¤šå…§å®¹è¦ä»‹ç´¹ï¼šï¼‰</p>

<p>ä¸‹ä¸€ç¯‡æœƒè£œå……ä¸€äº›ç›¸é—œçš„è­°é¡Œè¨è«–ï¼Œé‚„æœ‰é€™æ¬¡ COSCUP æ¼”è¬›çš„å¿ƒå¾—ï¼Œå¸Œæœ›æˆ‘ä¸è¦éš”å¤ªä¹…æ‰æŠŠæ–‡ç« ç”Ÿå‡ºä¾†ï¼šï¼‰</p>]]></content><author><name></name></author><category term="update" /><category term="COSCUP" /><category term="docker-swarm" /><category term="traefik" /><category term="deploy" /><summary type="html"><![CDATA[è‡ªå‹•åŒ–éƒ¨ç½² with Gitlab Runner Registration é€²å…¥ä¸Šä¸€ç¯‡é–‹å¥½çš„ Manager EC2ï¼Œä¸¦ä¸”æ­¤æ™‚çš„ EC2 æ‡‰è©²å·²ç¶“å®‰è£å¥½ Gitlab Runnerï¼Œé€™æ™‚å€™å¯ä»¥ç›´æ¥è¨»å†Šæˆ‘å€‘çš„ Runnerï¼šsudo gitlab-runner registerï¼Œä¸‹å¥½æŒ‡ä»¤å¾Œä¸€å…±æœƒå•ä¸ƒå€‹å•é¡Œï¼š Gitlab instance URL Registration Code å‰å…©å€‹å•é¡Œå¯ä»¥é€²å…¥åˆ° Gitlab project &gt; Settings &gt; CI/CD &gt; Runner å»æŸ¥çœ‹è¨­å®šç´°ç¯€ï¼Œå¦‚é™„åœ–çš„å·¦å´ Description for runner: docker é™„åœ–å³å´ç™½åº•é»‘å­—çš„éƒ¨åˆ† Tags for runner(comma seperated): prod é™„åœ–è—åº•éƒ¨åˆ†ï¼Œä¸”é€™å€‹ tag æ˜¯åœ¨å¾ŒçºŒæŒ‡å®š job è¦å“ªå€‹ runner åŸ·è¡Œçš„ä¾æ“š Optional maintenance note for runner: (optional) Enter the executor: docker Default Docker image: tiangolo/docker-with-compose å¾ŒçºŒçš„ job éœ€è¦ compose å¹«æˆ‘å€‘ build imageï¼Œå› æ­¤éœ€è¦æŒ‡å®šé€™å€‹ image .gitlab-ci.yml é€™é‚Šä¸»è¦ä¹Ÿæ˜¯åƒè€ƒ dockerswarm.rocks çš„ç¯„ä¾‹ï¼Œä»¥ä¸‹ç°¡å–®ä»‹ç´¹ä¸€ä¸‹ä»–çš„è¨­å®šå…§å®¹ï¼š Stage: åˆ†ç‚º build èˆ‡ deploy Build: docker-compose build --build-arg RAILS_MASTER_KEY=$RAILS_MASTER_KEY å–®ç´”åªæœ‰ build imageï¼Œä½†å› ç‚ºæˆ‘çš„ Dockerfile åŒ…å«äº† Asset Precompileï¼Œå› æ­¤éœ€è¦å¸¶å…¥ RAILS_MASTER_KEY åšç‚ºåƒæ•¸ Deploy: docker stack deploy -c docker-compose.yml [stack name] Only: æŒ‡å®šç™¼ç”Ÿæ–¼ main branch Tags: ç”¨æ–¼æŒ‡å®šåŸ·è¡Œçš„ runner EC2 Prerequisites å› ç‚º Traefik èˆ‡ Rails App ç‚ºç¨ç«‹çš„å…©å€‹ Stackï¼Œç‚ºäº†ç°¡åŒ–é–‹ç™¼æµç¨‹ï¼Œé€™é‚Šé¸æ“‡æ‰‹å‹•é€²å…¥ EC2 éƒ¨ç½² Traefik åŸæœ¬æ˜¯å¦å¤–é–‹ä¸€å€‹ traefik åˆ†æ”¯åš Traefik éƒ¨ç½²ï¼ˆä¸¦ä¸”æŒ‡å®š Traefik éƒ¨ç½²çš„ job åªç™¼ç”Ÿåœ¨è©²åˆ†æ”¯ã€åªæœƒç™¼ç”Ÿä¸€æ¬¡ï¼‰ï¼Œä½†åœ¨æ¼”è¬›æ™‚æœ‰äººåæ˜ ä¸ç¢ºå®š traefik åˆ†æ”¯éƒ¨ç½²å¾Œè¦ä¸è¦åˆåˆ° main åˆ†æ”¯ä¸Šã€git graph æœ‰é»ä¸æ˜ç¢ºï¼Œå› æ­¤æ”¹ç‚ºä»¥å…¬å¸å¯¦éš›éƒ¨ç½²çš„æµç¨‹åšä»‹ç´¹ éƒ¨ç½²çš„æ­¥é©Ÿå°±åƒåœ¨å¯¦éš›éƒ¨ç½²æµç¨‹æåˆ°çš„åœ–è¡¨ä¸€æ¨£ï¼š é–‹å•Ÿä¸€å€‹ swarmï¼šdocker swarm init --default-addr-pool 10.20.0.0/16 å› ç‚º Docker é è¨­çš„ subnet range èˆ‡ EC2 ç›¸åŒï¼Œéƒ½æ˜¯ 10.0.0.1ï¼Œå› æ­¤é€™é‚Šè¦ç‰¹åˆ¥æŒ‡å®šä¸ä¸€æ¨£çš„ç¯„åœï¼Œ Swarm æ‰é€£çš„åˆ°å¤–ç¶² é–‹å•Ÿ traefik networkï¼šdocker network create --driver=overlay traefik-public å–å¾—ç¾åœ¨çš„ swarm manager node idï¼šexport NODE_ID=$(docker info -f '') æŒ‡å®š traefik æ¯æ¬¡éƒ½ deploy åœ¨åŒä¸€å€‹ node &amp; volume ä¸Šï¼šdocker node update --label-add traefik-public.traefik-public-certificates=true $NODE_ID éƒ¨ç½² traefikï¼šdocker stack deploy -c traefik.yml traefik æœ€å¾Œå°±æ˜¯æŠŠ App æ¨ä¸Š GitLab é€²è¡Œéƒ¨ç½²ã„Œï¼ï¼ï¼ Worker Node åŠ å…¥ Docker Swarm åˆ°é€™é‚Šè¨­å®šå®Œ Manager ç¯€é»å¾Œï¼Œæˆ‘å€‘å¯ä»¥å›å»é–‹ Worker Templateï¼ŒæŠŠåŠ å…¥ Swarm çš„æŒ‡ä»¤åŠ å›å»ï¼š å…ˆåœ¨ Manager æ‰¾å›åŠ å…¥ Swarm çš„æŒ‡ä»¤ï¼šdocker swarm join-token worker åœ¨ Worker Template çš„ User Data ä¸­åŠ å…¥å‰›å‰›æ‰¾å›çš„æŒ‡ä»¤ï¼Œæ–¼æ˜¯æœ€çµ‚çš„ User Data æœƒé•·ä¸‹é¢é€™æ¨£ï¼š #!/bin/bash # Start docker daemon sudo service docker start sudo chown ec2-user:docker /var/run/docker.sock # Join swarm docker swarm join --token [JOIN-TOKEN] [IP-ADDRESS]:2377 åˆ°é€™é‚Šä¸»è¦çš„æŠ€è¡“è¨­å®šéƒ½çµæŸäº†â€¦..çœŸçš„æ˜¯è¶…å¤šå…§å®¹è¦ä»‹ç´¹ï¼šï¼‰ ä¸‹ä¸€ç¯‡æœƒè£œå……ä¸€äº›ç›¸é—œçš„è­°é¡Œè¨è«–ï¼Œé‚„æœ‰é€™æ¬¡ COSCUP æ¼”è¬›çš„å¿ƒå¾—ï¼Œå¸Œæœ›æˆ‘ä¸è¦éš”å¤ªä¹…æ‰æŠŠæ–‡ç« ç”Ÿå‡ºä¾†ï¼šï¼‰]]></summary></entry><entry><title type="html">Deploy Rails with Docker Swarm (3) - å¯¦éš›éƒ¨ç½²æµç¨‹ï¼šAWS</title><link href="https://jqlynchien713.github.io/2022/08/03/coscup3.html" rel="alternate" type="text/html" title="Deploy Rails with Docker Swarm (3) - å¯¦éš›éƒ¨ç½²æµç¨‹ï¼šAWS" /><published>2022-08-03T15:13:00+00:00</published><updated>2022-08-03T15:13:00+00:00</updated><id>https://jqlynchien713.github.io/2022/08/03/coscup3</id><content type="html" xml:base="https://jqlynchien713.github.io/2022/08/03/coscup3.html"><![CDATA[<h2 id="aws-config">AWS Config</h2>

<p>é€™å€‹éƒ¨åˆ†åœ¨ COSCUP çš„æ¼”è¬›æåˆ°çš„å…§å®¹å¾ˆå°‘ï¼Œä¸»è¦æ˜¯å› ç‚ºæ™‚é–“çš„é—œä¿‚ï¼Œä¸éæˆ‘è¦ºå¾—é€™éƒ¨åˆ†çš„è¨­å®šä¹Ÿè »é‡è¦çš„ï¼Œæ‰€ä»¥æœƒåœ¨é€™é‚Šå…¨éƒ¨åˆ—å‡ºä¾†ï¼</p>

<h3 id="ami--template-æ¯”è¼ƒ">AMI &amp; Template æ¯”è¼ƒ</h3>

<p>ç‚ºäº†ç°¡åŒ–é–‹ EC2 çš„ç¨‹åºï¼Œæˆ‘é€™é‚Šæœƒç”¨åˆ° AMI èˆ‡ Template é€™å…©å€‹æœå‹™ï¼Œå…ˆç¨å¾®æ¯”è¼ƒä¸€ä¸‹ä»–å€‘çš„å®šç¾©ï¼š</p>

<ul>
  <li>AMI (software only)ï¼šæ˜ åƒæª”æœå‹™ï¼Œä¿ç•™ EC2 ä¸Šçš„æ‰€æœ‰å®‰è£å¥—ä»¶</li>
  <li>Template (hardware only)ï¼šEC2 æ¨¡æ¿ï¼Œä¿ç•™ä¸€æ¨£çš„ EC2 å•Ÿå‹•ç²¾éˆï¼ˆåŒ…å«ç¡¬é«”è¨­å®šèˆ‡ User dataï¼‰</li>
</ul>

<h3 id="æ¶æ§‹ç°¡ä»‹">æ¶æ§‹ç°¡ä»‹</h3>

<p>æ ¹æ“šä¸Šä¸€ç¯‡ä»‹ç´¹çš„ Swarm æ¶æ§‹ï¼Œæˆ‘å€‘æœƒæœ‰å…©ç¨®ç¯€é»ï¼Œåˆ†åˆ¥éœ€è¦çš„å¥—ä»¶èˆ‡è¨­å®šå°æ‡‰å¦‚ä¸‹ï¼š</p>

<table>
  <thead>
    <tr>
      <th>Node Type</th>
      <th>Manager</th>
      <th>Worker</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1. AMI</td>
      <td>Docker, Gitlab Runner</td>
      <td>Docker</td>
    </tr>
    <tr>
      <td>2. Template</td>
      <td>Start Docker Engine<br />Specify Security Group<br />SSM &amp; Route53 IAM role</td>
      <td>Start Docker Engine<br />Specify Security Group</td>
    </tr>
  </tbody>
</table>

<ul>
  <li>Manager nodeï¼šéœ€è¦å®‰è£ Gitlab Runner è®“æˆ‘å€‘è‡ªå‹•åŒ–æ“æ§é€™äº›ç¯€é»ï¼Œä¸¦ä¸”éœ€è¦å¤šçµ¦äºˆ SSM &amp; Route53 æ¬Šé™ï¼Œåˆ†åˆ¥è®“æˆ‘å€‘å¯ä»¥é€²å…¥ EC2 ä¸‹æŒ‡ä»¤ã€èˆ‡æ“ä½œ DNS ç›¸é—œçš„è¨­å®š</li>
  <li>Security Groupï¼šæŒ‡å®š worker &amp; manager ä½¿ç”¨åŒå€‹ SGï¼Œä¸¦ä¸”åœ¨é€™å€‹ SG è£¡é–‹å•Ÿã€Œæ‰€æœ‰ port å…è¨±ä»»ä½•ä¾†è‡ªæ­¤ SG çš„ inboudã€ï¼Œä¸éé€™é‚Šé–‹å•Ÿæ‰€æœ‰ port çš„æ¬Šé™åªæ˜¯ç‚ºäº†æ–¹ä¾¿æ‰€è¨­å®šï¼Œå¯¦éš›ä¸Šé‚„æ˜¯åªèƒ½æŒ‡å®š Docker Swarm è£¡æºé€šç”¨çš„é‚£å¹¾å€‹ portï¼Œå¯ä»¥åƒè€ƒ<a href="https://docs.docker.com/engine/swarm/swarm-tutorial/#open-protocols-and-ports-between-the-hosts:~:text=%3A%20192.168.99.100.-,Open%20protocols%20and%20ports%20between%20the%20hosts,-%F0%9F%94%97">å®˜æ–¹æ–‡ä»¶</a>ä¸Šçš„èªªæ˜ã€‚é™¤äº†é€™å€‹è¦å‰‡ä»¥å¤–ï¼Œè¨˜å¾—è¦é–‹æ”¾ http &amp; https çš„ portï¼</li>
</ul>

<h3 id="ec2-settings">EC2 Settings</h3>

<p>äº†è§£ç¯€é»éœ€æ±‚å·®ç•°å¾Œï¼Œæˆ‘åœ¨å¯¦ä½œä¸Šçš„æ“ä½œæ­¥é©Ÿå¦‚ä¸‹ï¼š</p>

<ol>
  <li>é–‹å•Ÿä¸€å€‹ EC2ï¼Œå®‰è£ docker</li>
  <li>è£½ä½œ worker AMI</li>
  <li>å›åˆ°åŸæœ‰çš„ EC2ï¼Œå®‰è£ Gitlab Runner</li>
  <li>è£½ä½œ manager AMI</li>
  <li>é–‹å•Ÿ AWS EC2 Templateï¼Œæ–°å¢ä¸€å€‹ä»¥ worker AMI ç‚ºåŸºç¤çš„ template
    <ol>
      <li>
        <p>è¨­å®š Security Groupï¼Œå¦‚åœ–ä¸­çš„ç¬¬ä¸€åˆ—ï¼Œä¾†æºç‚ºè©² SG çš„ IDï¼š</p>

        <p><img src="/assets/img/sg.png" alt="/assets/img/sg.png" /></p>
      </li>
      <li>
        <p>åœ¨ User Data åŠ ä¸Šè¦è‡ªå‹•åŸ·è¡Œçš„æŒ‡ä»¤ï¼š</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c">#!/bin/bash</span>
 <span class="c"># Start docker daemon</span>
 <span class="nb">sudo </span>service docker start
 <span class="nb">sudo chown </span>ec2-user:docker /var/run/docker.sock
</code></pre></div>        </div>
      </li>
    </ol>
  </li>
  <li>é–‹å•Ÿ AWS EC2 Templateï¼Œæ–°å¢ä¸€å€‹ä»¥ worker AMI ç‚ºåŸºç¤çš„ template
    <ol>
      <li>çµ¦äºˆå…·æœ‰ SSM &amp; Route53 æ¬Šé™çš„ IAM role</li>
      <li>è¨­å®š Security Groupï¼ˆåŒ worker templateï¼‰</li>
      <li>åœ¨ User Data åŠ ä¸Šè‡ªå‹•é–‹å•Ÿ docker daemonï¼ˆåŒ worker templateï¼‰</li>
    </ol>
  </li>
</ol>

<h3 id="route53-settings">Route53 Settings</h3>

<p>é€™æ™‚å€™å¯ä»¥å¾ Manager Template é–‹å•Ÿä¸€å€‹ EC2ï¼Œå»åˆ° Route53 ä¸­çš„æ‰˜ç®¡å€åŸŸï¼ˆHosted Zoneï¼‰ï¼ŒæŠŠé€™å€‹ EC2 çš„ public IP addr è¨­å®š A record</p>

<p><img src="/assets/img/route53.png" alt="/assets/img/route53.png" /></p>]]></content><author><name></name></author><category term="update" /><category term="COSCUP" /><category term="docker-swarm" /><category term="traefik" /><category term="deploy" /><summary type="html"><![CDATA[AWS Config é€™å€‹éƒ¨åˆ†åœ¨ COSCUP çš„æ¼”è¬›æåˆ°çš„å…§å®¹å¾ˆå°‘ï¼Œä¸»è¦æ˜¯å› ç‚ºæ™‚é–“çš„é—œä¿‚ï¼Œä¸éæˆ‘è¦ºå¾—é€™éƒ¨åˆ†çš„è¨­å®šä¹Ÿè »é‡è¦çš„ï¼Œæ‰€ä»¥æœƒåœ¨é€™é‚Šå…¨éƒ¨åˆ—å‡ºä¾†ï¼ AMI &amp; Template æ¯”è¼ƒ ç‚ºäº†ç°¡åŒ–é–‹ EC2 çš„ç¨‹åºï¼Œæˆ‘é€™é‚Šæœƒç”¨åˆ° AMI èˆ‡ Template é€™å…©å€‹æœå‹™ï¼Œå…ˆç¨å¾®æ¯”è¼ƒä¸€ä¸‹ä»–å€‘çš„å®šç¾©ï¼š AMI (software only)ï¼šæ˜ åƒæª”æœå‹™ï¼Œä¿ç•™ EC2 ä¸Šçš„æ‰€æœ‰å®‰è£å¥—ä»¶ Template (hardware only)ï¼šEC2 æ¨¡æ¿ï¼Œä¿ç•™ä¸€æ¨£çš„ EC2 å•Ÿå‹•ç²¾éˆï¼ˆåŒ…å«ç¡¬é«”è¨­å®šèˆ‡ User dataï¼‰ æ¶æ§‹ç°¡ä»‹ æ ¹æ“šä¸Šä¸€ç¯‡ä»‹ç´¹çš„ Swarm æ¶æ§‹ï¼Œæˆ‘å€‘æœƒæœ‰å…©ç¨®ç¯€é»ï¼Œåˆ†åˆ¥éœ€è¦çš„å¥—ä»¶èˆ‡è¨­å®šå°æ‡‰å¦‚ä¸‹ï¼š Node Type Manager Worker 1. AMI Docker, Gitlab Runner Docker 2. Template Start Docker EngineSpecify Security GroupSSM &amp; Route53 IAM role Start Docker EngineSpecify Security Group Manager nodeï¼šéœ€è¦å®‰è£ Gitlab Runner è®“æˆ‘å€‘è‡ªå‹•åŒ–æ“æ§é€™äº›ç¯€é»ï¼Œä¸¦ä¸”éœ€è¦å¤šçµ¦äºˆ SSM &amp; Route53 æ¬Šé™ï¼Œåˆ†åˆ¥è®“æˆ‘å€‘å¯ä»¥é€²å…¥ EC2 ä¸‹æŒ‡ä»¤ã€èˆ‡æ“ä½œ DNS ç›¸é—œçš„è¨­å®š Security Groupï¼šæŒ‡å®š worker &amp; manager ä½¿ç”¨åŒå€‹ SGï¼Œä¸¦ä¸”åœ¨é€™å€‹ SG è£¡é–‹å•Ÿã€Œæ‰€æœ‰ port å…è¨±ä»»ä½•ä¾†è‡ªæ­¤ SG çš„ inboudã€ï¼Œä¸éé€™é‚Šé–‹å•Ÿæ‰€æœ‰ port çš„æ¬Šé™åªæ˜¯ç‚ºäº†æ–¹ä¾¿æ‰€è¨­å®šï¼Œå¯¦éš›ä¸Šé‚„æ˜¯åªèƒ½æŒ‡å®š Docker Swarm è£¡æºé€šç”¨çš„é‚£å¹¾å€‹ portï¼Œå¯ä»¥åƒè€ƒå®˜æ–¹æ–‡ä»¶ä¸Šçš„èªªæ˜ã€‚é™¤äº†é€™å€‹è¦å‰‡ä»¥å¤–ï¼Œè¨˜å¾—è¦é–‹æ”¾ http &amp; https çš„ portï¼ EC2 Settings äº†è§£ç¯€é»éœ€æ±‚å·®ç•°å¾Œï¼Œæˆ‘åœ¨å¯¦ä½œä¸Šçš„æ“ä½œæ­¥é©Ÿå¦‚ä¸‹ï¼š é–‹å•Ÿä¸€å€‹ EC2ï¼Œå®‰è£ docker è£½ä½œ worker AMI å›åˆ°åŸæœ‰çš„ EC2ï¼Œå®‰è£ Gitlab Runner è£½ä½œ manager AMI é–‹å•Ÿ AWS EC2 Templateï¼Œæ–°å¢ä¸€å€‹ä»¥ worker AMI ç‚ºåŸºç¤çš„ template è¨­å®š Security Groupï¼Œå¦‚åœ–ä¸­çš„ç¬¬ä¸€åˆ—ï¼Œä¾†æºç‚ºè©² SG çš„ IDï¼š åœ¨ User Data åŠ ä¸Šè¦è‡ªå‹•åŸ·è¡Œçš„æŒ‡ä»¤ï¼š #!/bin/bash # Start docker daemon sudo service docker start sudo chown ec2-user:docker /var/run/docker.sock é–‹å•Ÿ AWS EC2 Templateï¼Œæ–°å¢ä¸€å€‹ä»¥ worker AMI ç‚ºåŸºç¤çš„ template çµ¦äºˆå…·æœ‰ SSM &amp; Route53 æ¬Šé™çš„ IAM role è¨­å®š Security Groupï¼ˆåŒ worker templateï¼‰ åœ¨ User Data åŠ ä¸Šè‡ªå‹•é–‹å•Ÿ docker daemonï¼ˆåŒ worker templateï¼‰ Route53 Settings é€™æ™‚å€™å¯ä»¥å¾ Manager Template é–‹å•Ÿä¸€å€‹ EC2ï¼Œå»åˆ° Route53 ä¸­çš„æ‰˜ç®¡å€åŸŸï¼ˆHosted Zoneï¼‰ï¼ŒæŠŠé€™å€‹ EC2 çš„ public IP addr è¨­å®š A record]]></summary></entry><entry><title type="html">Deploy Rails with Docker Swarm (2) - æµç¨‹ä»‹ç´¹èˆ‡è¨­å®š Traefik &amp;amp; Rails</title><link href="https://jqlynchien713.github.io/2022/08/03/coscup2.html" rel="alternate" type="text/html" title="Deploy Rails with Docker Swarm (2) - æµç¨‹ä»‹ç´¹èˆ‡è¨­å®š Traefik &amp;amp; Rails" /><published>2022-08-03T14:33:00+00:00</published><updated>2022-08-03T14:33:00+00:00</updated><id>https://jqlynchien713.github.io/2022/08/03/coscup2</id><content type="html" xml:base="https://jqlynchien713.github.io/2022/08/03/coscup2.html"><![CDATA[<p>æ¥ä¸‹ä¾†è®“æˆ‘å€‘é€²åˆ°å¯¦éš›æ“ä½œçš„éƒ¨åˆ†ï¼é€™ç¯‡ä¸»è¦æœƒå…ˆä»‹ç´¹ä¸€ä¸‹å¾ŒçºŒçš„æ–‡ç« æ¶æ§‹ï¼Œä¸»è¦æ˜¯åˆ†æˆä»¥ä¸‹ä¸‰å€‹éƒ¨åˆ†ï¼š</p>

<ol>
  <li>è¨­å®š Rails &amp; Traefik</li>
  <li>è¨­å®š AWS</li>
  <li>è¨­å®š Gitlab runner è‡ªå‹•åŒ–éƒ¨ç½²</li>
</ol>

<p>å› ç‚ºç¯‡å¹…çš„é—œä¿‚ï¼Œé€™ç¯‡æ–‡æœƒå…ˆä»‹ç´¹ç¬¬ä¸€éƒ¨åˆ†ï¼Œå¾Œé¢å…©éƒ¨åˆ†ä¹Ÿæœƒå†å¦å¤–ç™¼æ–°çš„æ–‡ç« <br />ï¼ˆä¸çŸ¥ä¸è¦ºå°±è®Šæˆé€£è¼‰ç³»åˆ—äº†ğŸ« ï¼‰</p>

<h2 id="éƒ¨ç½²æµç¨‹">éƒ¨ç½²æµç¨‹</h2>

<h3 id="å¯¦ä½œæµç¨‹">å¯¦ä½œæµç¨‹</h3>

<ul>
  <li>æœ¬åœ°ç«¯é€²è¡Œéƒ¨ç½²
    <ul>
      <li>é–‹å•Ÿ rails production server</li>
      <li>ç¢ºèªæœ¬åœ°ç«¯ Docker compose build/up çš†å¯é †åˆ©åŸ·è¡Œ</li>
    </ul>
  </li>
  <li>æ‰‹å‹• ssh é€²å…¥ EC2 éƒ¨ç½²
    <ul>
      <li>å°‡ Traefik èˆ‡ Docker Swarm ç›´æ¥éƒ¨ç½²åœ¨ EC2 è£¡ï¼Œè©³ç´°çš„æµç¨‹æœƒåœ¨ä¸‹ä¸€éƒ¨åˆ†çš„åœ–è£¡èªªæ˜</li>
    </ul>
  </li>
  <li>åˆ©ç”¨ Gitlab runner è‡ªå‹•éƒ¨ç½²
    <ul>
      <li>å°‡å‰ä¸€æ­¥çš„æ‰€æœ‰è¨­å®šã€éƒ¨ç½²æŒ‡ä»¤è‡ªå‹•åŒ–</li>
    </ul>
  </li>
</ul>

<h3 id="å¯¦éš›éƒ¨ç½²æµç¨‹">å¯¦éš›éƒ¨ç½²æµç¨‹</h3>

<p>é€™é‚Šè¦è¬›çš„æ˜¯å®Œæ•´çš„éƒ¨ç½²æµç¨‹ä¸ŠåŸ·è¡Œäº†å“ªäº›è¨­å®šï¼Œå¾ŒçºŒçš„ä»‹ç´¹ä¹Ÿæœƒå°‡ä»¥ä¸‹å››é»çš„é †åºä½œç‚ºä¸»è¦æ¶æ§‹é€²è¡Œä»‹ç´¹ï¼š</p>

<ol>
  <li>è¨­å®š Traefik Serviceï¼šä¾ç…§ä¸Šä¸€ç¯‡æåˆ°çš„ Traefik ç‰¹æ€§ï¼Œå…ˆè¨­å®š reverse proxyï¼ˆå†æŠŠ app æ›ä¸Šå»ï¼‰</li>
  <li>è¨­å®š Rails App Serviceï¼šåŸºæœ¬ä¸Šç­‰æ–¼åœ¨æœ¬åœ°ç«¯éƒ¨ç½²çš„æ­¥é©Ÿï¼Œä¹Ÿå°±æ˜¯ç¢ºèª Docker compose build/up å¯ä»¥é †åˆ©é–‹å•Ÿæœå‹™</li>
  <li>è¨­å®š EC2 èˆ‡ Route53ï¼šåœ¨ç¢ºèªè¨­å®šæª”å¤§è‡´å®Œæˆå¾Œï¼Œè¨­å®šä¸¦é–‹å•Ÿ EC2ï¼Œå°‡å‰›å‰›è¨­å®šçš„æœå‹™éƒ¨ç½²ä¸Šå»</li>
  <li>è‡ªå‹•åŒ–éƒ¨ç½² with Gitlab Runnerï¼šè¨»å†Šä¸¦æ’°å¯« runner çš„è…³æœ¬ï¼ˆ<code class="language-plaintext highlighter-rouge">.gitlab-ci.yml</code>ï¼‰ï¼Œè€Œè…³æœ¬çš„å…§å®¹å‰‡æ˜¯<strong>å¯¦éš›åœ¨éƒ¨ç½²æ™‚éœ€è¦å°æ©Ÿå™¨æœ¬èº«ä¸‹çš„è¨­å®š</strong>ï¼Œå…§å®¹å¦‚ä¸‹ï¼š
    <ol>
      <li>é–‹å•Ÿ Docker Swarm</li>
      <li>å‰µå»º <code class="language-plaintext highlighter-rouge">traefik-public</code> çš„å…¬é–‹ Networkï¼Œè®“ App service å¯ä»¥ä½¿ç”¨ traefik ä¾†åš reverse proxy</li>
      <li>æŒ‡å®šæ¯æ¬¡ Traefik æ›´æ–°æ™‚å›ºå®šä½¿ç”¨åŒå€‹ç¯€é»</li>
      <li>ä½¿ç”¨ docker stack éƒ¨ç½² Traefik</li>
      <li>éƒ¨ç½² Rails App</li>
    </ol>

    <p id="order1"><img src="/assets/img/order1.jpg" alt="order1" /></p>

    <p>å¯¦éš›éƒ¨ç½² Docker Swarm çš„æµç¨‹</p>
  </li>
</ol>

<h2 id="rails--traefik-service">Rails &amp; Traefik Service</h2>

<h3 id="traefik-service-settings">Traefik Service Settings</h3>

<p>Traefik èˆ‡ Rails App å…¶å¯¦æ˜¯å…©å€‹ç¨ç«‹çš„æœå‹™ï¼Œå› æ­¤é€™é‚Šæœƒå°‡ Traefik èˆ‡ Rails App çš„è¨­å®šæª”åˆ†é–‹ï¼Œä¹Ÿå°±æ˜¯ <strong>Traefik æœƒæœ‰ä¸€å€‹ <code class="language-plaintext highlighter-rouge">traefik.yml</code> ç”¨æ–¼éƒ¨ç½² traefik stack</strong>ï¼Œè€Œ <strong>Rails App å‰‡æ˜¯ä½¿ç”¨åŸå§‹çš„ <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> å»éƒ¨ç½² task stack</strong>ï¼ˆé€™é‚Šçš„ Rails App å«åš Task-Managerï¼Œå› æ­¤ stack name å–ç‚º <code class="language-plaintext highlighter-rouge">task</code>ï¼‰</p>

<p>é¦–å…ˆåœ¨ traefik.yml ä¸­çš„è¨­å®šæœƒèˆ‡ä¸€èˆ¬çš„ docker compose file æ¶æ§‹ç›¸åŒï¼Œé€™é‚Šæˆ‘æ˜¯åƒè€ƒ <a href="https://dockerswarm.rocks/traefik/">dockerswarm.rocks</a> è£¡æä¾›çš„ Traefik è¨­å®šç¯„ä¾‹é€²è¡Œè¨­å®šï¼Œä¸éæˆ‘å€‘æœƒéœ€è¦ç‰¹åˆ¥è¨­å®šä»¥ä¸‹å¹¾é»ï¼ˆé€™éƒ¨åˆ†ä¹Ÿå¯ä»¥ç›´æ¥åƒè€ƒæˆ‘å¯«å¥½çš„è¨­å®šæª”  <a href="https://gitlab.com/jqlynchien713/task-manager-ruby/-/blob/main/traefik.yml">traefik.yml / Task-Manager-Ruby Â· GitLab</a>ï¼‰ï¼š</p>

<ul>
  <li>Networkï¼šéœ€è¦æ–°å¢ä¸€å€‹å« <code class="language-plaintext highlighter-rouge">traefik-public</code> çš„ç¶²è·¯ï¼Œä¸¦ä¸”è¨­å®šç‚º externalï¼Œå¥½è®“ Rails App å¯ä»¥é€éé€™å€‹ç¶²è·¯èˆ‡ Traefik æºé€š</li>
  <li>Volumesï¼šæ–°å¢ä¸€å€‹ <code class="language-plaintext highlighter-rouge">traefik-public-certificate</code> çš„ volumeï¼Œç”¨æ–¼å­˜æ”¾å·²ç¶“ç”³è«‹éçš„æ†‘è­‰</li>
  <li>Serviceï¼šåˆ†ç‚ºå…©éƒ¨åˆ†éœ€è¦æ³¨æ„ï¼ŒCommand èˆ‡ Deploy Label
    <ul>
      <li>Commandï¼šTraefik çš„<strong>åŸºæœ¬è¨­å®š</strong>ï¼Œéœ€è¦æŒ‡å®š Docker providerã€é–‹å•Ÿ Swarm modeï¼Œæ†‘è­‰çš„ç”³è«‹ã€å„²å­˜ä½ç½®ï¼Œä»¥åŠ DNS Challenge ç­‰ç­‰</li>
      <li>Deploy Labelï¼šç‚ºäº†è¦é–‹å•Ÿ Traefik Dashboard è€Œè¨­å®šçš„ <strong>reverse proxy routing</strong>ï¼Œä¸»è¦æœ‰ä¸‹åˆ—å¹¾é»è¦è¨­å®šï¼š
        <ul>
          <li>é–‹å•Ÿ Traefik ä¸¦åŠ å…¥ <code class="language-plaintext highlighter-rouge">traefik-public</code> Network</li>
          <li>Dashboard ç™»å…¥å¸³å¯†</li>
          <li>Http/Https host</li>
          <li>Redirect middlewareï¼šç•¶ç”¨æˆ¶ä½¿ç”¨ Http ç™¼é€è«‹æ±‚ï¼Œè‡ªå‹•è½‰ç‚º Https</li>
          <li><a href="#LB">Load balancer</a> portï¼šç•¶æœ‰ç›®çš„åœ°æ˜¯ host çš„è«‹æ±‚ï¼ŒTraefik éœ€è¦å°‡å…¶å°å‘çš„ port</li>
          <li>è¨­å®š <a href="#wildcard">wildcard</a> é©—è­‰éçš„ domain</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>åˆ°é€™ä¸€æ­¥åŸºæœ¬ä¸Š Traefik æœ¬èº«å·²ç¶“è¨­å®šå®Œç•¢ï¼Œå¯ä»¥å…ˆé€² EC2 è£¡é–‹å¥½ Traefik stack ä¾†æª¢æŸ¥æ˜¯å¦èƒ½æ­£ç¢ºé–‹å•Ÿã€‚</p>

<h3 id="rails-appapplication-service">Rails App(Application) Service</h3>

<p>æ¥ä¸‹ä¾†è¦èªªæ˜çš„æ˜¯ Rails App è¦æ€éº¼è¨­å®šï¼Œç•¶ç„¶é€™å€‹éƒ¨ç½²æ¶æ§‹ä¸åªé™å®šæ–¼ Rails Appï¼Œä¸éé€™å€‹æ­¥é©Ÿå¯èƒ½è¦ä¾ç…§ä½¿ç”¨çš„èªè¨€æˆ–æ¡†æ¶è€Œæ”¹å‹•ã€‚</p>

<p>é¦–å…ˆå¿…é ˆç”Ÿæˆä¸€çµ„ <code class="language-plaintext highlighter-rouge">RAILS_MASTER_KEY</code>ï¼Œå› ç‚º Rails åœ¨ Production ç’°å¢ƒä¸­éœ€è¦æœ‰ <code class="language-plaintext highlighter-rouge">RAILS_MASTER_KEY</code> æ‰èƒ½å•Ÿå‹•ï¼Œç¢ºå®š production server å¯æ­£å¸¸é–‹å•Ÿå¾Œï¼Œå¯ä»¥ä¾†æº–å‚™æˆ‘å€‘çš„ Dockerfile èˆ‡ Docker-compose file ä¾†é€²è¡Œ task stack çš„è¨­å®š</p>

<h4 id="dockerfile">Dockerfile</h4>

<p>é€™éƒ¨åˆ†æˆ‘ä½¿ç”¨çš„æ˜¯ https://github.com/elct9620/boxing é€™å€‹ gem ä¾†å¹«æˆ‘è‡ªå‹•ç”Ÿæˆï¼Œä»–æœƒä¾æ“šå°ˆæ¡ˆä¸­çš„ Gemfile ä»¥åŠ boxing æœ¬èº«çš„è¨­å®šæª”ï¼ˆ<code class="language-plaintext highlighter-rouge">config/boxing.rb</code>ï¼‰ä¾†è‡ªå‹•ç”Ÿæˆ Dockerfileã€‚å¦å¤–é€™å€‹ Gem çš„ä½œè€…ï¼ˆä¹Ÿå°±æ˜¯è’¼æ™‚å¤§å¤§ï¼‰æœ‰ç‰¹åˆ¥ç ”ç©¶å¦‚ä½•ç”Ÿæˆæœ€å°åŒ–çš„ Docker imageï¼Œå› æ­¤è‡ªå‹•ç”Ÿæˆçš„æ˜ åƒæª”å¤§ç´„åªæœƒæœ‰ï¼ˆæ“šä»–æœ¬äººæ‰€èªªï¼‰ 100 MBï¼Œä¸‹é¢åˆ—å‡ºå¯ä»¥å¦å¤–è¨­å®šçš„é¸é …ï¼ˆç²—é«”ç‚ºæˆ‘é€™æ¬¡æœ‰æ¡ç”¨çš„è¨­å®šï¼‰ï¼š</p>

<ul>
  <li>Source Code Root</li>
  <li>Ignore File</li>
  <li><strong>Extra Packages: Node.js &amp; Python</strong></li>
  <li>Revision Information</li>
  <li>Sentry Support</li>
  <li><strong>Asset Precompile: True</strong></li>
  <li>Health Check</li>
</ul>

<blockquote>
  <p>è£œå……ï¼š<strong><a href="https://github.com/elct9620/openbox">OpenBox</a></strong> - Auto generate entrypoint settingsï¼Œå¦‚æœå°‡ Boxing èˆ‡ OpenBox åŒæ™‚æ¡ç”¨çš„è©±ï¼ŒBoxing ç”Ÿæˆçš„ Dockerfile æœƒå°‡ Entrypoint è‡ªå‹•æŒ‡å®šç‚º OpenBox ç”Ÿæˆçš„ Entrypoint</p>

</blockquote>

<h4 id="docker-compose-file">Docker-compose file</h4>

<p>èˆ‡åœ¨æœ¬åœ°ç«¯è¨­å®šçš„ <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> åŸºæœ¬ä¸Šä¸€æ¨£ï¼Œæˆ‘åœ¨é€™é‚Šæ˜¯åªæœ‰è¨­å®šä¸‰å€‹ service(app/redis/postgres)ï¼ŒNetwork åªæœ‰ net è®“ä¸‰å€‹ service å…±äº«ï¼Œä¸¦åŠ ä¸Šä¸‹é¢å…©é …è¨­å®šï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">RAILS_MASTER_KEY</code>ï¼šå‰›å‰›ç”Ÿæˆçš„ <code class="language-plaintext highlighter-rouge">RAILS_MASTER_KEY</code> å¯ä»¥å…ˆæ”¾åˆ° Gitlab ä¸­è¨­å®šç‚º CI variableï¼ˆå¦‚æœè¦è·‘æœ¬åœ°æ¸¬è©¦çš„è©±å¯ä»¥å°‡ <code class="language-plaintext highlighter-rouge">RAILS_MASTER_KEY</code> æ”¾åœ¨ .envã€æˆ–è€…è¨­å®šç‚º app service çš„ environment varï¼Œå¯ä»¥åƒè€ƒ<a href="https://gitlab.com/jqlynchien713/task-manager-ruby/-/blob/main/docker-compose-local.yml">æœ¬åœ°ç«¯çš„ docker-compose</a> Line 55ï¼‰</li>
  <li><code class="language-plaintext highlighter-rouge">DATABSE_URL</code>ï¼šåœ¨ app service çš„ environment variable è¦ç‰¹åˆ¥æŒ‡å®šè³‡æ–™åº«çš„è·¯å¾‘ï¼Œæ‰èƒ½æ­£ç¢ºé€£ç·šåˆ° postgres serviceï¼Œä¸¦ä¸”è¦æ³¨æ„æ ¼å¼ç‚º <code class="language-plaintext highlighter-rouge">postgresql://[user[:password]@][netloc][:port][/dbname][?param1=value1&amp;...]</code></li>
</ul>

<p>åšå®ŒåŸºæœ¬çš„è¨­å®šå¾Œï¼Œåœ¨æŠŠ Traefik ç›¸é—œçš„ routing rules åŠ åˆ° deploy label ä¸Šã€‚é€™éƒ¨åˆ†å’Œåœ¨è¨­å®š Traefik çš„ deploy labels ä¸€æ¨£ï¼Œè¨­å®šå®Œç•¢å¾Œæœƒåƒ<a href="https://gitlab.com/jqlynchien713/task-manager-ruby/-/blob/main/docker-compose.yml">é€™å€‹æª”æ¡ˆ</a>é¡ä¼¼ã€‚</p>

<hr />
<h3 id="è£œå……">è£œå……</h3>
<h4 id="LB">Load Balancer Port è¨­å®š</h4>
<p>å‡è¨­ä»Šå¤©æˆ‘å€‘çš„ domain æ˜¯ <code class="language-plaintext highlighter-rouge">abc.dev</code> æœ‰ç”¨æˆ¶è«‹æ±‚äº† <code class="language-plaintext highlighter-rouge">traefik.abc.dev(aka æˆ‘å€‘çš„ host name)</code>ï¼Œè€Œæˆ‘å€‘çš„ Traefik Dashboard é–‹åœ¨ 8080 portï¼Œå‰‡ Traefik æœƒå°‡é€™å€‹ request å°å‘ 8080</p>

<h4 id="wildcard">Wildcard ç›¸é—œçŸ¥è­˜</h4>
<p>ç›¸é—œè¨­å®šçš„è£œå……çŸ¥è­˜ï¼Œé€™é‚Šéœ€è¦åƒè€ƒæˆ‘å·²ç¶“å¯«å¥½çš„<a href="https://gitlab.com/jqlynchien713/task-manager-ruby/-/blob/main/traefik.yml">è¨­å®šæª”</a></p>

<ul>
  <li>Wildcardï¼š<a href="https://letsencrypt.org/zh-tw/docs/challenge-types/#dns-01-%E8%80%83%E9%A9%97">ACME é©—è­‰æ–¹å¼ - Letâ€™s Encrypt - å…è²»çš„ SSL/TLS æ†‘è­‰ (letsencrypt.org)</a>
    <ul>
      <li>å¯ä»¥ç›´æ¥ç”³è«‹æŸå€‹ domain çš„æ†‘è­‰ï¼Œè®“æ•´å€‹ domain ä¸‹çš„æ‰€æœ‰ host éƒ½å¯ä»¥ä½¿ç”¨åŒä¸€å¼µæ†‘è­‰ï¼ˆdomain.sans éƒ¨åˆ†ï¼‰ï¼Œä¸éœ€ç‰¹åœ°ç‚ºæ‰€æœ‰ host å€‹åˆ¥ç”³è«‹æ†‘è­‰</li>
      <li>å±¬æ–¼ Letâ€™s Encrypt ç™¼æ”¾çš„å…¶ä¸­ä¸€ç¨®æ†‘è­‰æ ¼å¼</li>
    </ul>
  </li>
  <li>çµ¦äºˆ route53 æ¬Šé™çš„åŸå› 
    <ul>
      <li>å› ç‚ºè¨­å®š DNS challenge èˆ‡ DNS Challenge Provider ç‚º route53</li>
      <li>DNS challengeï¼šéœ€è¦æœ‰ route53 çš„æ¬Šé™æ‰èƒ½å‹•æ…‹é©—è­‰ *.domain ä¸‹çš„æ‰€æœ‰ host</li>
      <li>Route53 æä¾›è‡ªå‹•æ›´æ–°æ†‘è­‰çš„ API</li>
    </ul>
  </li>
</ul>

<hr />
<p>ç¬¬ä¸€éƒ¨åˆ†å°±åˆ°é€™é‚ŠçµæŸï¼Œå…¶å¯¦åšåˆ°é€™å€‹æ­¥é©Ÿæ‡‰è©²å°±èƒ½åœ¨æœ¬åœ°ç«¯é€²è¡Œéƒ¨ç½²ï¼ˆåƒ…é™ Rails éƒ¨åˆ†ï¼‰</p>

<p>å¸Œæœ›å¤§å®¶èˆ‡ Docker å¯ä»¥å¥½å¥½ç›¸è™•ï¼Œä»–çœŸçš„æ˜¯å€‹å¥½ç”¨ã„‰é…·æ±è¥¿ï¼ˆ</p>]]></content><author><name></name></author><category term="update" /><category term="COSCUP" /><category term="docker-swarm" /><category term="traefik" /><category term="deploy" /><summary type="html"><![CDATA[æ¥ä¸‹ä¾†è®“æˆ‘å€‘é€²åˆ°å¯¦éš›æ“ä½œçš„éƒ¨åˆ†ï¼é€™ç¯‡ä¸»è¦æœƒå…ˆä»‹ç´¹ä¸€ä¸‹å¾ŒçºŒçš„æ–‡ç« æ¶æ§‹ï¼Œä¸»è¦æ˜¯åˆ†æˆä»¥ä¸‹ä¸‰å€‹éƒ¨åˆ†ï¼š è¨­å®š Rails &amp; Traefik è¨­å®š AWS è¨­å®š Gitlab runner è‡ªå‹•åŒ–éƒ¨ç½² å› ç‚ºç¯‡å¹…çš„é—œä¿‚ï¼Œé€™ç¯‡æ–‡æœƒå…ˆä»‹ç´¹ç¬¬ä¸€éƒ¨åˆ†ï¼Œå¾Œé¢å…©éƒ¨åˆ†ä¹Ÿæœƒå†å¦å¤–ç™¼æ–°çš„æ–‡ç« ï¼ˆä¸çŸ¥ä¸è¦ºå°±è®Šæˆé€£è¼‰ç³»åˆ—äº†ğŸ« ï¼‰ éƒ¨ç½²æµç¨‹ å¯¦ä½œæµç¨‹ æœ¬åœ°ç«¯é€²è¡Œéƒ¨ç½² é–‹å•Ÿ rails production server ç¢ºèªæœ¬åœ°ç«¯ Docker compose build/up çš†å¯é †åˆ©åŸ·è¡Œ æ‰‹å‹• ssh é€²å…¥ EC2 éƒ¨ç½² å°‡ Traefik èˆ‡ Docker Swarm ç›´æ¥éƒ¨ç½²åœ¨ EC2 è£¡ï¼Œè©³ç´°çš„æµç¨‹æœƒåœ¨ä¸‹ä¸€éƒ¨åˆ†çš„åœ–è£¡èªªæ˜ åˆ©ç”¨ Gitlab runner è‡ªå‹•éƒ¨ç½² å°‡å‰ä¸€æ­¥çš„æ‰€æœ‰è¨­å®šã€éƒ¨ç½²æŒ‡ä»¤è‡ªå‹•åŒ– å¯¦éš›éƒ¨ç½²æµç¨‹ é€™é‚Šè¦è¬›çš„æ˜¯å®Œæ•´çš„éƒ¨ç½²æµç¨‹ä¸ŠåŸ·è¡Œäº†å“ªäº›è¨­å®šï¼Œå¾ŒçºŒçš„ä»‹ç´¹ä¹Ÿæœƒå°‡ä»¥ä¸‹å››é»çš„é †åºä½œç‚ºä¸»è¦æ¶æ§‹é€²è¡Œä»‹ç´¹ï¼š è¨­å®š Traefik Serviceï¼šä¾ç…§ä¸Šä¸€ç¯‡æåˆ°çš„ Traefik ç‰¹æ€§ï¼Œå…ˆè¨­å®š reverse proxyï¼ˆå†æŠŠ app æ›ä¸Šå»ï¼‰ è¨­å®š Rails App Serviceï¼šåŸºæœ¬ä¸Šç­‰æ–¼åœ¨æœ¬åœ°ç«¯éƒ¨ç½²çš„æ­¥é©Ÿï¼Œä¹Ÿå°±æ˜¯ç¢ºèª Docker compose build/up å¯ä»¥é †åˆ©é–‹å•Ÿæœå‹™ è¨­å®š EC2 èˆ‡ Route53ï¼šåœ¨ç¢ºèªè¨­å®šæª”å¤§è‡´å®Œæˆå¾Œï¼Œè¨­å®šä¸¦é–‹å•Ÿ EC2ï¼Œå°‡å‰›å‰›è¨­å®šçš„æœå‹™éƒ¨ç½²ä¸Šå» è‡ªå‹•åŒ–éƒ¨ç½² with Gitlab Runnerï¼šè¨»å†Šä¸¦æ’°å¯« runner çš„è…³æœ¬ï¼ˆ.gitlab-ci.ymlï¼‰ï¼Œè€Œè…³æœ¬çš„å…§å®¹å‰‡æ˜¯å¯¦éš›åœ¨éƒ¨ç½²æ™‚éœ€è¦å°æ©Ÿå™¨æœ¬èº«ä¸‹çš„è¨­å®šï¼Œå…§å®¹å¦‚ä¸‹ï¼š é–‹å•Ÿ Docker Swarm å‰µå»º traefik-public çš„å…¬é–‹ Networkï¼Œè®“ App service å¯ä»¥ä½¿ç”¨ traefik ä¾†åš reverse proxy æŒ‡å®šæ¯æ¬¡ Traefik æ›´æ–°æ™‚å›ºå®šä½¿ç”¨åŒå€‹ç¯€é» ä½¿ç”¨ docker stack éƒ¨ç½² Traefik éƒ¨ç½² Rails App å¯¦éš›éƒ¨ç½² Docker Swarm çš„æµç¨‹ Rails &amp; Traefik Service Traefik Service Settings Traefik èˆ‡ Rails App å…¶å¯¦æ˜¯å…©å€‹ç¨ç«‹çš„æœå‹™ï¼Œå› æ­¤é€™é‚Šæœƒå°‡ Traefik èˆ‡ Rails App çš„è¨­å®šæª”åˆ†é–‹ï¼Œä¹Ÿå°±æ˜¯ Traefik æœƒæœ‰ä¸€å€‹ traefik.yml ç”¨æ–¼éƒ¨ç½² traefik stackï¼Œè€Œ Rails App å‰‡æ˜¯ä½¿ç”¨åŸå§‹çš„ docker-compose.yml å»éƒ¨ç½² task stackï¼ˆé€™é‚Šçš„ Rails App å«åš Task-Managerï¼Œå› æ­¤ stack name å–ç‚º taskï¼‰ é¦–å…ˆåœ¨ traefik.yml ä¸­çš„è¨­å®šæœƒèˆ‡ä¸€èˆ¬çš„ docker compose file æ¶æ§‹ç›¸åŒï¼Œé€™é‚Šæˆ‘æ˜¯åƒè€ƒ dockerswarm.rocks è£¡æä¾›çš„ Traefik è¨­å®šç¯„ä¾‹é€²è¡Œè¨­å®šï¼Œä¸éæˆ‘å€‘æœƒéœ€è¦ç‰¹åˆ¥è¨­å®šä»¥ä¸‹å¹¾é»ï¼ˆé€™éƒ¨åˆ†ä¹Ÿå¯ä»¥ç›´æ¥åƒè€ƒæˆ‘å¯«å¥½çš„è¨­å®šæª” traefik.yml / Task-Manager-Ruby Â· GitLabï¼‰ï¼š Networkï¼šéœ€è¦æ–°å¢ä¸€å€‹å« traefik-public çš„ç¶²è·¯ï¼Œä¸¦ä¸”è¨­å®šç‚º externalï¼Œå¥½è®“ Rails App å¯ä»¥é€éé€™å€‹ç¶²è·¯èˆ‡ Traefik æºé€š Volumesï¼šæ–°å¢ä¸€å€‹ traefik-public-certificate çš„ volumeï¼Œç”¨æ–¼å­˜æ”¾å·²ç¶“ç”³è«‹éçš„æ†‘è­‰ Serviceï¼šåˆ†ç‚ºå…©éƒ¨åˆ†éœ€è¦æ³¨æ„ï¼ŒCommand èˆ‡ Deploy Label Commandï¼šTraefik çš„åŸºæœ¬è¨­å®šï¼Œéœ€è¦æŒ‡å®š Docker providerã€é–‹å•Ÿ Swarm modeï¼Œæ†‘è­‰çš„ç”³è«‹ã€å„²å­˜ä½ç½®ï¼Œä»¥åŠ DNS Challenge ç­‰ç­‰ Deploy Labelï¼šç‚ºäº†è¦é–‹å•Ÿ Traefik Dashboard è€Œè¨­å®šçš„ reverse proxy routingï¼Œä¸»è¦æœ‰ä¸‹åˆ—å¹¾é»è¦è¨­å®šï¼š é–‹å•Ÿ Traefik ä¸¦åŠ å…¥ traefik-public Network Dashboard ç™»å…¥å¸³å¯† Http/Https host Redirect middlewareï¼šç•¶ç”¨æˆ¶ä½¿ç”¨ Http ç™¼é€è«‹æ±‚ï¼Œè‡ªå‹•è½‰ç‚º Https Load balancer portï¼šç•¶æœ‰ç›®çš„åœ°æ˜¯ host çš„è«‹æ±‚ï¼ŒTraefik éœ€è¦å°‡å…¶å°å‘çš„ port è¨­å®š wildcard é©—è­‰éçš„ domain åˆ°é€™ä¸€æ­¥åŸºæœ¬ä¸Š Traefik æœ¬èº«å·²ç¶“è¨­å®šå®Œç•¢ï¼Œå¯ä»¥å…ˆé€² EC2 è£¡é–‹å¥½ Traefik stack ä¾†æª¢æŸ¥æ˜¯å¦èƒ½æ­£ç¢ºé–‹å•Ÿã€‚ Rails App(Application) Service æ¥ä¸‹ä¾†è¦èªªæ˜çš„æ˜¯ Rails App è¦æ€éº¼è¨­å®šï¼Œç•¶ç„¶é€™å€‹éƒ¨ç½²æ¶æ§‹ä¸åªé™å®šæ–¼ Rails Appï¼Œä¸éé€™å€‹æ­¥é©Ÿå¯èƒ½è¦ä¾ç…§ä½¿ç”¨çš„èªè¨€æˆ–æ¡†æ¶è€Œæ”¹å‹•ã€‚ é¦–å…ˆå¿…é ˆç”Ÿæˆä¸€çµ„ RAILS_MASTER_KEYï¼Œå› ç‚º Rails åœ¨ Production ç’°å¢ƒä¸­éœ€è¦æœ‰ RAILS_MASTER_KEY æ‰èƒ½å•Ÿå‹•ï¼Œç¢ºå®š production server å¯æ­£å¸¸é–‹å•Ÿå¾Œï¼Œå¯ä»¥ä¾†æº–å‚™æˆ‘å€‘çš„ Dockerfile èˆ‡ Docker-compose file ä¾†é€²è¡Œ task stack çš„è¨­å®š Dockerfile é€™éƒ¨åˆ†æˆ‘ä½¿ç”¨çš„æ˜¯ https://github.com/elct9620/boxing é€™å€‹ gem ä¾†å¹«æˆ‘è‡ªå‹•ç”Ÿæˆï¼Œä»–æœƒä¾æ“šå°ˆæ¡ˆä¸­çš„ Gemfile ä»¥åŠ boxing æœ¬èº«çš„è¨­å®šæª”ï¼ˆconfig/boxing.rbï¼‰ä¾†è‡ªå‹•ç”Ÿæˆ Dockerfileã€‚å¦å¤–é€™å€‹ Gem çš„ä½œè€…ï¼ˆä¹Ÿå°±æ˜¯è’¼æ™‚å¤§å¤§ï¼‰æœ‰ç‰¹åˆ¥ç ”ç©¶å¦‚ä½•ç”Ÿæˆæœ€å°åŒ–çš„ Docker imageï¼Œå› æ­¤è‡ªå‹•ç”Ÿæˆçš„æ˜ åƒæª”å¤§ç´„åªæœƒæœ‰ï¼ˆæ“šä»–æœ¬äººæ‰€èªªï¼‰ 100 MBï¼Œä¸‹é¢åˆ—å‡ºå¯ä»¥å¦å¤–è¨­å®šçš„é¸é …ï¼ˆç²—é«”ç‚ºæˆ‘é€™æ¬¡æœ‰æ¡ç”¨çš„è¨­å®šï¼‰ï¼š Source Code Root Ignore File Extra Packages: Node.js &amp; Python Revision Information Sentry Support Asset Precompile: True Health Check è£œå……ï¼šOpenBox - Auto generate entrypoint settingsï¼Œå¦‚æœå°‡ Boxing èˆ‡ OpenBox åŒæ™‚æ¡ç”¨çš„è©±ï¼ŒBoxing ç”Ÿæˆçš„ Dockerfile æœƒå°‡ Entrypoint è‡ªå‹•æŒ‡å®šç‚º OpenBox ç”Ÿæˆçš„ Entrypoint Docker-compose file èˆ‡åœ¨æœ¬åœ°ç«¯è¨­å®šçš„ docker-compose.yml åŸºæœ¬ä¸Šä¸€æ¨£ï¼Œæˆ‘åœ¨é€™é‚Šæ˜¯åªæœ‰è¨­å®šä¸‰å€‹ service(app/redis/postgres)ï¼ŒNetwork åªæœ‰ net è®“ä¸‰å€‹ service å…±äº«ï¼Œä¸¦åŠ ä¸Šä¸‹é¢å…©é …è¨­å®šï¼š RAILS_MASTER_KEYï¼šå‰›å‰›ç”Ÿæˆçš„ RAILS_MASTER_KEY å¯ä»¥å…ˆæ”¾åˆ° Gitlab ä¸­è¨­å®šç‚º CI variableï¼ˆå¦‚æœè¦è·‘æœ¬åœ°æ¸¬è©¦çš„è©±å¯ä»¥å°‡ RAILS_MASTER_KEY æ”¾åœ¨ .envã€æˆ–è€…è¨­å®šç‚º app service çš„ environment varï¼Œå¯ä»¥åƒè€ƒæœ¬åœ°ç«¯çš„ docker-compose Line 55ï¼‰ DATABSE_URLï¼šåœ¨ app service çš„ environment variable è¦ç‰¹åˆ¥æŒ‡å®šè³‡æ–™åº«çš„è·¯å¾‘ï¼Œæ‰èƒ½æ­£ç¢ºé€£ç·šåˆ° postgres serviceï¼Œä¸¦ä¸”è¦æ³¨æ„æ ¼å¼ç‚º postgresql://[user[:password]@][netloc][:port][/dbname][?param1=value1&amp;...] åšå®ŒåŸºæœ¬çš„è¨­å®šå¾Œï¼Œåœ¨æŠŠ Traefik ç›¸é—œçš„ routing rules åŠ åˆ° deploy label ä¸Šã€‚é€™éƒ¨åˆ†å’Œåœ¨è¨­å®š Traefik çš„ deploy labels ä¸€æ¨£ï¼Œè¨­å®šå®Œç•¢å¾Œæœƒåƒé€™å€‹æª”æ¡ˆé¡ä¼¼ã€‚ è£œå…… Load Balancer Port è¨­å®š å‡è¨­ä»Šå¤©æˆ‘å€‘çš„ domain æ˜¯ abc.dev æœ‰ç”¨æˆ¶è«‹æ±‚äº† traefik.abc.dev(aka æˆ‘å€‘çš„ host name)ï¼Œè€Œæˆ‘å€‘çš„ Traefik Dashboard é–‹åœ¨ 8080 portï¼Œå‰‡ Traefik æœƒå°‡é€™å€‹ request å°å‘ 8080 Wildcard ç›¸é—œçŸ¥è­˜ ç›¸é—œè¨­å®šçš„è£œå……çŸ¥è­˜ï¼Œé€™é‚Šéœ€è¦åƒè€ƒæˆ‘å·²ç¶“å¯«å¥½çš„è¨­å®šæª” Wildcardï¼šACME é©—è­‰æ–¹å¼ - Letâ€™s Encrypt - å…è²»çš„ SSL/TLS æ†‘è­‰ (letsencrypt.org) å¯ä»¥ç›´æ¥ç”³è«‹æŸå€‹ domain çš„æ†‘è­‰ï¼Œè®“æ•´å€‹ domain ä¸‹çš„æ‰€æœ‰ host éƒ½å¯ä»¥ä½¿ç”¨åŒä¸€å¼µæ†‘è­‰ï¼ˆdomain.sans éƒ¨åˆ†ï¼‰ï¼Œä¸éœ€ç‰¹åœ°ç‚ºæ‰€æœ‰ host å€‹åˆ¥ç”³è«‹æ†‘è­‰ å±¬æ–¼ Letâ€™s Encrypt ç™¼æ”¾çš„å…¶ä¸­ä¸€ç¨®æ†‘è­‰æ ¼å¼ çµ¦äºˆ route53 æ¬Šé™çš„åŸå›  å› ç‚ºè¨­å®š DNS challenge èˆ‡ DNS Challenge Provider ç‚º route53 DNS challengeï¼šéœ€è¦æœ‰ route53 çš„æ¬Šé™æ‰èƒ½å‹•æ…‹é©—è­‰ *.domain ä¸‹çš„æ‰€æœ‰ host Route53 æä¾›è‡ªå‹•æ›´æ–°æ†‘è­‰çš„ API ç¬¬ä¸€éƒ¨åˆ†å°±åˆ°é€™é‚ŠçµæŸï¼Œå…¶å¯¦åšåˆ°é€™å€‹æ­¥é©Ÿæ‡‰è©²å°±èƒ½åœ¨æœ¬åœ°ç«¯é€²è¡Œéƒ¨ç½²ï¼ˆåƒ…é™ Rails éƒ¨åˆ†ï¼‰ å¸Œæœ›å¤§å®¶èˆ‡ Docker å¯ä»¥å¥½å¥½ç›¸è™•ï¼Œä»–çœŸçš„æ˜¯å€‹å¥½ç”¨ã„‰é…·æ±è¥¿ï¼ˆ]]></summary></entry><entry><title type="html">Deploy Rails with Docker Swarm (1) - å·¥å…·ä»‹ç´¹</title><link href="https://jqlynchien713.github.io/2022/07/30/coscup1.html" rel="alternate" type="text/html" title="Deploy Rails with Docker Swarm (1) - å·¥å…·ä»‹ç´¹" /><published>2022-07-30T10:19:00+00:00</published><updated>2022-07-30T10:19:00+00:00</updated><id>https://jqlynchien713.github.io/2022/07/30/coscup1</id><content type="html" xml:base="https://jqlynchien713.github.io/2022/07/30/coscup1.html"><![CDATA[<p>COSCUP å®‰å…¨ä¸‹èŠï¼ï¼ˆå¤§æ¦‚ï¼‰</p>

<p>å› ç‚ºçµ‚æ–¼çµæŸã„Œï¼Œæƒ³èªªä¾†æŠŠæˆ‘çš„ç°¡å ±å…§å®¹è½‰æ›æˆéƒ¨è½æ ¼çš„å¯¦é«”ç´€éŒ„ï¼Œç›®å‰é è¨ˆæœƒç™¼å€‹ä¸‰ç¯‡ï¼Œåˆ†åˆ¥æ˜¯<strong>å·¥å…·ä»‹ç´¹</strong>ã€<strong>å¯¦ä½œæµç¨‹</strong>ã€<strong>å…¶ä»–è­°é¡Œ</strong>ï¼ˆå°±æ˜¯å¯¦éš›ç°¡å ±çš„ mappingï¼‰ï¼Œé€™é‚Šä¹Ÿé™„ä¸Šå¯¦éš›å ±å‘Šçš„<a href="https://docs.google.com/presentation/d/1c1ip0DacaPZ8jKVLdtDPkB1ud3qiH44mp8TscCdTbD4/edit?usp=sharing">ç°¡å ±</a>ä»¥åŠæˆ‘å¯¦ä½œçš„ <a href="https://gitlab.com/jqlynchien713/task-manager-ruby">Repository</a>ï¼Œæ¥ä¸‹ä¾†å°±é€²å…¥æ­£é¡Œã„…ï¼</p>

<h2 id="docker-swarm">Docker Swarm</h2>

<h3 id="structure">Structure</h3>

<p>Docker Swarm çš„çµæ§‹å¯ä»¥è¦–ç‚ºä¸€å€‹ Clusterï¼ˆå¢é›†ï¼‰ï¼Œå¢é›†é‡Œæœƒæœ‰ä¸€åˆ°å¤šå€‹ Master/Manager Node ä¾†æ§åˆ¶æˆ‘å€‘çš„ç¯€é»ï¼Œå¦å¤–ä¹Ÿæœƒæœ‰ 0 åˆ°å¤šå€‹çš„ Worker nodeï¼Œè€Œé€™é‚Šç´«è‰²çš„æ¡†æ¡†éƒ½æ˜¯ä¸€å°æ©Ÿå™¨ï¼Œæ¯å°æ©Ÿå™¨ä¸Šéƒ½æœƒæœ‰åŸ·è¡Œä¸­çš„ docker daemonã€‚</p>

<p>ç•¶æˆ‘å€‘è¦é€²è¡Œ deploy çš„å‹•ä½œæ™‚ï¼Œæœƒå…ˆé€é Docker Clinent å‘ Manager node ç™¼èµ· deploy request çµ¦ Manager node çš„ scheduler/discovery serviceï¼Œé€éèˆ‡ worker node ä¸Šçš„ docker daemon è¯ç¹«ä¾†æ§åˆ¶é€™äº›å·¥ä½œç¯€é»ã€‚</p>

<p><img src="/assets/img/swarm.png" alt="Work.jpg" /></p>

<h3 id="scalability--availability-feature">Scalability &amp; Availability Feature</h3>

<p>é¦–å…ˆä¾†æ¯”è¼ƒä¸€ä¸‹é€™å…©é …ç‰¹æ€§å®šç¾©ä¸Šçš„å·®ç•°ï¼š</p>

<ul>
  <li>Scalability: ç•¶æµé‡è®Šå¤§/è®Šå°æ™‚ï¼Œç³»çµ±ä¸­çš„ server æ•¸å¯ä»¥æ©«å‘æ“´å±•æˆ–ç¸®æ¸›</li>
  <li>Availability: ç•¶éƒ¨åˆ†çš„æ©Ÿå™¨ç„¡æ³•é‹ä½œæ™‚ï¼Œèƒ½å¤ ç¢ºä¿æœå‹™ä¸è¢«ä¸­æ–·ï¼ˆè‡ªå‹•é–‹å•Ÿæ–°çš„ instanceï¼‰</li>
</ul>

<p>Docker Swarm é”åˆ°é€™å…©é …ç‰¹æ€§çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<ol>
  <li>Scalabilityï¼šè‡ªå‹•åœ¨ç©ºé–“è¶³å¤ çš„ worker ä¸Šé–‹å•Ÿæ–°çš„ container</li>
  <li>Availabilityï¼šä»¥æ›´æ–° appã€é™ä½ downtime ç‚ºä¾‹
    <ol>
      <li>ç•¶éœ€è¦æ›´æ–° app ç‰ˆæœ¬æ™‚ï¼Œå¯ä»¥è®“ load balancer è‡ªå‹• route åˆ°æ–°ç‰ˆ app ä¸Š</li>
      <li>æ¼¸é€²å¼å–ä»£æ‰€æœ‰èˆŠç‰ˆçš„ app container</li>
    </ol>
  </li>
</ol>

<h3 id="deploy-tools-stack-vs-compose">Deploy Tools: Stack vs Compose</h3>

<p>ç•¶æˆ‘å€‘éœ€è¦ä½¿ç”¨ docker swarm é€™å€‹æ¶æ§‹æ™‚ï¼Œå¿…é ˆé€é Docker stack é€™é …å·¥å…·é€²è¡Œéƒ¨ç½²çš„å‹•ä½œã€‚Stack å¯ä»¥èªªæ˜¯é€²åŒ–ç‰ˆçš„ Composeï¼Œå› ç‚ºåŸºæœ¬ä¸Š stack çš„è¨­å®šæª”æ ¼å¼å°±æ˜¯ docker-compose.ymlï¼Œä»¥ä¸‹æ˜¯é€™å…©å€‹å·¥å…·ä¹‹é–“çš„ç•°åŒï¼š</p>

<ol>
  <li>éƒ½ä½¿ç”¨ compose format é€²è¡Œ deployï¼Œä½†æ˜¯ stack åªæ”¯æ´ç‰ˆæœ¬ä¸‰ä»¥ä¸Š</li>
  <li>Stack ç„¡æ³• build imageï¼Œå› æ­¤åªèƒ½ä½¿ç”¨ç¾æœ‰çš„æ˜ åƒæª”ï¼Œæˆ–è€…ä½¿ç”¨ compose ä¾†å¹«æˆ‘å€‘åš build image çš„å‹•ä½œ</li>
  <li>Compose åªèƒ½åšåˆ°å–®ä¸€æ©Ÿå™¨ä¸Šçš„åŸ·è¡Œï¼Œä½† stack æ­é…äº† docker swarm çš„æ¶æ§‹ï¼Œå¯ä»¥é€é scheduler èˆ‡ worker çš„ docker daemon é€²è¡Œè¯ç¹«ï¼Œå› æ­¤å¯ä»¥åšåˆ°å¤šå°æ©Ÿå™¨ä¹‹é–“çš„æ“ä½œï¼Œé”åˆ° cluster çš„æ•ˆæœ</li>
  <li>Compose ç›¸è¼ƒä¹‹ä¸‹æ›´é©åˆç”¨æ–¼é–‹ç™¼ç’°å¢ƒ</li>
</ol>

<h3 id="åè©è§£é‡‹-service-vs-task">åè©è§£é‡‹: Service vs Task</h3>

<ul>
  <li>Taskï¼šå„å€‹<strong>å¯¦é«”æ©Ÿ</strong>ä¸Šé ˆè¦åŸ·è¡Œçš„äººç‰©ï¼›ç•¶ service æŒ‡å®šçš„ replica ç‚º 3 æ™‚ï¼Œä»£è¡¨æœƒæœ‰ 3 å€‹ tasks åˆ†åˆ¥åŸ·è¡Œåœ¨ 3 å€‹ container è£¡</li>
  <li>Serviceï¼šä¸€å€‹ image æ‰€æä¾›çš„æœå‹™ï¼Œlike: app/redis/postgres</li>
  <li>æ‰€æœ‰ service çš„ç¸½å’Œç¨±ç‚º stack</li>
</ul>

<p><img src="https://docs.docker.com/engine/swarm/images/services-diagram.png" alt="https://docs.docker.com/engine/swarm/images/services-diagram.png" /></p>

<h2 id="traefik">Traefik</h2>

<p>Traefik æœ€ç›´è§€çš„è§£é‡‹å°±æ˜¯ä¸€å€‹ reverse proxy çš„å·¥å…·ï¼Œä¹Ÿå¯ä»¥æ‹¿ä¾†åš load balancer ä½¿ç”¨ã€‚é‚£ä»–çš„å¥½è™•æœ‰ä»¥ä¸‹é€™å¹¾é»ï¼š</p>

<ol>
  <li>èˆ‡ Docker é«˜åº¦æ•´åˆï¼šå¯ä»¥ç›´æ¥åœ¨ docker compose å®šç¾© service æ™‚ï¼Œç›´æ¥æŠŠ routing rules å®šç¾©åœ¨ deploy label  ä¸‹é¢</li>
  <li>è‡ªå‹•å‘ Letâ€™s Encrypt ç”³è«‹ HTTPS æ†‘è­‰ï¼Œé™ä½ç”³è«‹æ†‘è­‰çš„ç¹è¤‡ç¨‹åº</li>
  <li>ç„¡éœ€é‡å•Ÿï¼šç•¶æˆ‘å€‘æœ‰æ–°çš„ app å¸Œæœ›å¯ä»¥ç”¨ Traefik åš reverse proxy æ™‚ï¼Œä¸éœ€è¦é‡æ–°å•Ÿå‹• Traefikï¼Œä»–å°±èƒ½è‡ªå‹•å¹«æˆ‘å€‘æŠŠæ–°çš„ host request å°å‘æ–°çš„ application ä¸Š</li>
  <li>æœ‰åˆ¥æ–¼ä»¥å¾€è¨­å®š reverse proxy æ™‚ï¼Œéƒ½éœ€è¦å…ˆè¨­å®šå¥½ app å†å»è¨­å®š reverse proxy çš„è·¯ç”±ï¼ŒTraefik æ˜¯å…ˆæŠŠä»–è‡ªå·±çš„æœå‹™é–‹å¥½å¾Œï¼Œå†æŠŠæˆ‘å€‘è¦é–‹æ”¾çš„ app æ›ä¸Šå»</li>
</ol>

<h2 id="aws">AWS</h2>

<h3 id="ec2">EC2</h3>

<p>å°±æ˜¯ä¸€å°è™›æ“¬æ©Ÿï¼Œå¿…é ˆå­˜åœ¨æ–¼æŸå€‹ VPC çš„å­ç¶²è·¯ä¸‹ï¼ˆå¯ç›´æ¥é¸æ“‡ AWS æä¾›çµ¦å…è²»å¸³æˆ¶çš„é è¨­ VPCï¼‰ã€‚åŒæ™‚ä¹Ÿç‚ºäº†è¦ç°¡åŒ–å¾ŒçºŒçš„å¯¦ä½œæµç¨‹ï¼Œé€™é‚Šä¹Ÿæœƒä½¿ç”¨åˆ° AMI èˆ‡ EC2 template ä¾†åŠ é€Ÿæˆ‘å€‘é–‹å•Ÿæ©Ÿå™¨çš„æ­¥é©Ÿï¼Œä»¥ä¸‹ç°¡å–®ä»‹ç´¹ä¸€ä¸‹é€™å…©é …å·¥å…·ï¼š</p>

<ul>
  <li>AMI (software only)ï¼šæ˜ åƒæª”æœå‹™ï¼Œå¯ä»¥å¾æˆ‘å€‘å·²ç¶“é–‹å¥½ä¸¦å®‰è£ä¸€äº›å¥—ä»¶ä¹‹å¾Œçš„ EC2 è£½æˆã€‚å› ç‚ºæ˜¯æ˜ åƒæª”çš„é—œä¿‚ï¼Œå»ºå¥½ AMI å¾Œæœƒå¹«æˆ‘å€‘ä¿ç•™è©² EC2 ä¸Šå·²ç¶“å®‰è£å¥½çš„å¥—ä»¶ã€‚</li>
  <li>Template (hardware only)ï¼šEC2 æ¨¡æ¿ï¼Œå”åŠ©é–‹å•ŸåŒæ¨£çš„ EC2 å•Ÿå‹•ç²¾éˆï¼Œå…§å®¹åŒ…å«äº†ç¡¬é«”çš„é¸æ“‡ã€VPC/Subnet è¨­å®šã€IAM è§’è‰²çš„çµ¦å®šï¼Œä»¥åŠ user data çš„å…§å®¹ï¼ˆå•Ÿå‹•å¾Œè¦åŸ·è¡Œçš„è…³æœ¬ï¼‰</li>
</ul>

<h3 id="route53è·¯ç”±æœå‹™">Route53ï¼šè·¯ç”±æœå‹™</h3>

<ul>
  <li>æœƒç‚ºæ“æœ‰çš„ Domain ç”¢ç”Ÿ Hosted Zone çš„ Name Serverï¼Œç®¡ç† DNS routingï¼ˆdomain è¦å°æ‡‰åˆ°å“ªå€‹ IP addressï¼‰</li>
  <li>å¯ä»¥å‰µå»ºè¨±å¤šå‹æ…‹çš„ recordï¼Œå®šç¾© sub-domain</li>
</ul>]]></content><author><name></name></author><category term="update" /><category term="COSCUP" /><category term="docker-swarm" /><category term="traefik" /><category term="deploy" /><summary type="html"><![CDATA[COSCUP å®‰å…¨ä¸‹èŠï¼ï¼ˆå¤§æ¦‚ï¼‰ å› ç‚ºçµ‚æ–¼çµæŸã„Œï¼Œæƒ³èªªä¾†æŠŠæˆ‘çš„ç°¡å ±å…§å®¹è½‰æ›æˆéƒ¨è½æ ¼çš„å¯¦é«”ç´€éŒ„ï¼Œç›®å‰é è¨ˆæœƒç™¼å€‹ä¸‰ç¯‡ï¼Œåˆ†åˆ¥æ˜¯å·¥å…·ä»‹ç´¹ã€å¯¦ä½œæµç¨‹ã€å…¶ä»–è­°é¡Œï¼ˆå°±æ˜¯å¯¦éš›ç°¡å ±çš„ mappingï¼‰ï¼Œé€™é‚Šä¹Ÿé™„ä¸Šå¯¦éš›å ±å‘Šçš„ç°¡å ±ä»¥åŠæˆ‘å¯¦ä½œçš„ Repositoryï¼Œæ¥ä¸‹ä¾†å°±é€²å…¥æ­£é¡Œã„…ï¼ Docker Swarm Structure Docker Swarm çš„çµæ§‹å¯ä»¥è¦–ç‚ºä¸€å€‹ Clusterï¼ˆå¢é›†ï¼‰ï¼Œå¢é›†é‡Œæœƒæœ‰ä¸€åˆ°å¤šå€‹ Master/Manager Node ä¾†æ§åˆ¶æˆ‘å€‘çš„ç¯€é»ï¼Œå¦å¤–ä¹Ÿæœƒæœ‰ 0 åˆ°å¤šå€‹çš„ Worker nodeï¼Œè€Œé€™é‚Šç´«è‰²çš„æ¡†æ¡†éƒ½æ˜¯ä¸€å°æ©Ÿå™¨ï¼Œæ¯å°æ©Ÿå™¨ä¸Šéƒ½æœƒæœ‰åŸ·è¡Œä¸­çš„ docker daemonã€‚ ç•¶æˆ‘å€‘è¦é€²è¡Œ deploy çš„å‹•ä½œæ™‚ï¼Œæœƒå…ˆé€é Docker Clinent å‘ Manager node ç™¼èµ· deploy request çµ¦ Manager node çš„ scheduler/discovery serviceï¼Œé€éèˆ‡ worker node ä¸Šçš„ docker daemon è¯ç¹«ä¾†æ§åˆ¶é€™äº›å·¥ä½œç¯€é»ã€‚ Scalability &amp; Availability Feature é¦–å…ˆä¾†æ¯”è¼ƒä¸€ä¸‹é€™å…©é …ç‰¹æ€§å®šç¾©ä¸Šçš„å·®ç•°ï¼š Scalability: ç•¶æµé‡è®Šå¤§/è®Šå°æ™‚ï¼Œç³»çµ±ä¸­çš„ server æ•¸å¯ä»¥æ©«å‘æ“´å±•æˆ–ç¸®æ¸› Availability: ç•¶éƒ¨åˆ†çš„æ©Ÿå™¨ç„¡æ³•é‹ä½œæ™‚ï¼Œèƒ½å¤ ç¢ºä¿æœå‹™ä¸è¢«ä¸­æ–·ï¼ˆè‡ªå‹•é–‹å•Ÿæ–°çš„ instanceï¼‰ Docker Swarm é”åˆ°é€™å…©é …ç‰¹æ€§çš„æ–¹æ³•å¦‚ä¸‹ï¼š Scalabilityï¼šè‡ªå‹•åœ¨ç©ºé–“è¶³å¤ çš„ worker ä¸Šé–‹å•Ÿæ–°çš„ container Availabilityï¼šä»¥æ›´æ–° appã€é™ä½ downtime ç‚ºä¾‹ ç•¶éœ€è¦æ›´æ–° app ç‰ˆæœ¬æ™‚ï¼Œå¯ä»¥è®“ load balancer è‡ªå‹• route åˆ°æ–°ç‰ˆ app ä¸Š æ¼¸é€²å¼å–ä»£æ‰€æœ‰èˆŠç‰ˆçš„ app container Deploy Tools: Stack vs Compose ç•¶æˆ‘å€‘éœ€è¦ä½¿ç”¨ docker swarm é€™å€‹æ¶æ§‹æ™‚ï¼Œå¿…é ˆé€é Docker stack é€™é …å·¥å…·é€²è¡Œéƒ¨ç½²çš„å‹•ä½œã€‚Stack å¯ä»¥èªªæ˜¯é€²åŒ–ç‰ˆçš„ Composeï¼Œå› ç‚ºåŸºæœ¬ä¸Š stack çš„è¨­å®šæª”æ ¼å¼å°±æ˜¯ docker-compose.ymlï¼Œä»¥ä¸‹æ˜¯é€™å…©å€‹å·¥å…·ä¹‹é–“çš„ç•°åŒï¼š éƒ½ä½¿ç”¨ compose format é€²è¡Œ deployï¼Œä½†æ˜¯ stack åªæ”¯æ´ç‰ˆæœ¬ä¸‰ä»¥ä¸Š Stack ç„¡æ³• build imageï¼Œå› æ­¤åªèƒ½ä½¿ç”¨ç¾æœ‰çš„æ˜ åƒæª”ï¼Œæˆ–è€…ä½¿ç”¨ compose ä¾†å¹«æˆ‘å€‘åš build image çš„å‹•ä½œ Compose åªèƒ½åšåˆ°å–®ä¸€æ©Ÿå™¨ä¸Šçš„åŸ·è¡Œï¼Œä½† stack æ­é…äº† docker swarm çš„æ¶æ§‹ï¼Œå¯ä»¥é€é scheduler èˆ‡ worker çš„ docker daemon é€²è¡Œè¯ç¹«ï¼Œå› æ­¤å¯ä»¥åšåˆ°å¤šå°æ©Ÿå™¨ä¹‹é–“çš„æ“ä½œï¼Œé”åˆ° cluster çš„æ•ˆæœ Compose ç›¸è¼ƒä¹‹ä¸‹æ›´é©åˆç”¨æ–¼é–‹ç™¼ç’°å¢ƒ åè©è§£é‡‹: Service vs Task Taskï¼šå„å€‹å¯¦é«”æ©Ÿä¸Šé ˆè¦åŸ·è¡Œçš„äººç‰©ï¼›ç•¶ service æŒ‡å®šçš„ replica ç‚º 3 æ™‚ï¼Œä»£è¡¨æœƒæœ‰ 3 å€‹ tasks åˆ†åˆ¥åŸ·è¡Œåœ¨ 3 å€‹ container è£¡ Serviceï¼šä¸€å€‹ image æ‰€æä¾›çš„æœå‹™ï¼Œlike: app/redis/postgres æ‰€æœ‰ service çš„ç¸½å’Œç¨±ç‚º stack Traefik Traefik æœ€ç›´è§€çš„è§£é‡‹å°±æ˜¯ä¸€å€‹ reverse proxy çš„å·¥å…·ï¼Œä¹Ÿå¯ä»¥æ‹¿ä¾†åš load balancer ä½¿ç”¨ã€‚é‚£ä»–çš„å¥½è™•æœ‰ä»¥ä¸‹é€™å¹¾é»ï¼š èˆ‡ Docker é«˜åº¦æ•´åˆï¼šå¯ä»¥ç›´æ¥åœ¨ docker compose å®šç¾© service æ™‚ï¼Œç›´æ¥æŠŠ routing rules å®šç¾©åœ¨ deploy label ä¸‹é¢ è‡ªå‹•å‘ Letâ€™s Encrypt ç”³è«‹ HTTPS æ†‘è­‰ï¼Œé™ä½ç”³è«‹æ†‘è­‰çš„ç¹è¤‡ç¨‹åº ç„¡éœ€é‡å•Ÿï¼šç•¶æˆ‘å€‘æœ‰æ–°çš„ app å¸Œæœ›å¯ä»¥ç”¨ Traefik åš reverse proxy æ™‚ï¼Œä¸éœ€è¦é‡æ–°å•Ÿå‹• Traefikï¼Œä»–å°±èƒ½è‡ªå‹•å¹«æˆ‘å€‘æŠŠæ–°çš„ host request å°å‘æ–°çš„ application ä¸Š æœ‰åˆ¥æ–¼ä»¥å¾€è¨­å®š reverse proxy æ™‚ï¼Œéƒ½éœ€è¦å…ˆè¨­å®šå¥½ app å†å»è¨­å®š reverse proxy çš„è·¯ç”±ï¼ŒTraefik æ˜¯å…ˆæŠŠä»–è‡ªå·±çš„æœå‹™é–‹å¥½å¾Œï¼Œå†æŠŠæˆ‘å€‘è¦é–‹æ”¾çš„ app æ›ä¸Šå» AWS EC2 å°±æ˜¯ä¸€å°è™›æ“¬æ©Ÿï¼Œå¿…é ˆå­˜åœ¨æ–¼æŸå€‹ VPC çš„å­ç¶²è·¯ä¸‹ï¼ˆå¯ç›´æ¥é¸æ“‡ AWS æä¾›çµ¦å…è²»å¸³æˆ¶çš„é è¨­ VPCï¼‰ã€‚åŒæ™‚ä¹Ÿç‚ºäº†è¦ç°¡åŒ–å¾ŒçºŒçš„å¯¦ä½œæµç¨‹ï¼Œé€™é‚Šä¹Ÿæœƒä½¿ç”¨åˆ° AMI èˆ‡ EC2 template ä¾†åŠ é€Ÿæˆ‘å€‘é–‹å•Ÿæ©Ÿå™¨çš„æ­¥é©Ÿï¼Œä»¥ä¸‹ç°¡å–®ä»‹ç´¹ä¸€ä¸‹é€™å…©é …å·¥å…·ï¼š AMI (software only)ï¼šæ˜ åƒæª”æœå‹™ï¼Œå¯ä»¥å¾æˆ‘å€‘å·²ç¶“é–‹å¥½ä¸¦å®‰è£ä¸€äº›å¥—ä»¶ä¹‹å¾Œçš„ EC2 è£½æˆã€‚å› ç‚ºæ˜¯æ˜ åƒæª”çš„é—œä¿‚ï¼Œå»ºå¥½ AMI å¾Œæœƒå¹«æˆ‘å€‘ä¿ç•™è©² EC2 ä¸Šå·²ç¶“å®‰è£å¥½çš„å¥—ä»¶ã€‚ Template (hardware only)ï¼šEC2 æ¨¡æ¿ï¼Œå”åŠ©é–‹å•ŸåŒæ¨£çš„ EC2 å•Ÿå‹•ç²¾éˆï¼Œå…§å®¹åŒ…å«äº†ç¡¬é«”çš„é¸æ“‡ã€VPC/Subnet è¨­å®šã€IAM è§’è‰²çš„çµ¦å®šï¼Œä»¥åŠ user data çš„å…§å®¹ï¼ˆå•Ÿå‹•å¾Œè¦åŸ·è¡Œçš„è…³æœ¬ï¼‰ Route53ï¼šè·¯ç”±æœå‹™ æœƒç‚ºæ“æœ‰çš„ Domain ç”¢ç”Ÿ Hosted Zone çš„ Name Serverï¼Œç®¡ç† DNS routingï¼ˆdomain è¦å°æ‡‰åˆ°å“ªå€‹ IP addressï¼‰ å¯ä»¥å‰µå»ºè¨±å¤šå‹æ…‹çš„ recordï¼Œå®šç¾© sub-domain]]></summary></entry><entry><title type="html">VScode ssh to Windows server é ç«¯å¯«æ‰£ï¼</title><link href="https://jqlynchien713.github.io/2022/06/22/vscode-ssh.html" rel="alternate" type="text/html" title="VScode ssh to Windows server é ç«¯å¯«æ‰£ï¼" /><published>2022-06-22T13:42:00+00:00</published><updated>2022-06-22T13:42:00+00:00</updated><id>https://jqlynchien713.github.io/2022/06/22/vscode-ssh</id><content type="html" xml:base="https://jqlynchien713.github.io/2022/06/22/vscode-ssh.html"><![CDATA[<p>é›–ç„¶æˆ‘å·²ç¶“æ˜¯ Vim çš„ä¿¡å¾’ã„Œï¼Œä½†ç¸½ä¸å¯èƒ½ç”¨ Vim å¯« Jupyter Notebook å§ï¼é–‹å¥½ Jupyter Notebook Server ä¹‹å¾Œå¯«äº†å¤§æ¦‚ä¸€å€‹æœˆï¼ŒçœŸçš„è¦ºå¾—é è¨­çš„æ¡†æ¡†æœ‰å¤ çª„æœ‰å¤ é›£å¯«ï¼Œæ”¹æˆç”¨ Jupyter Lab å¯«äº†ä¸€å€‹ç¦®æ‹œä¹‹å¾Œåˆè¦ºå¾—é‚£å€‹ç·¨è¼¯å™¨çš„è¨­å®šçœŸçš„è«åå…¶å¦™ï¼ˆèˆ‰ä¾‹ï¼šåœ¨è¼¸å…¥æœå°‹æ¬„å¾ŒæŒ‰ enterï¼Œcursor æœƒç›´æ¥ focus åœ¨ç¬¬äºŒå€‹çµæœï¼Œä¹Ÿå°±æ˜¯èªªç•¶ä½ æƒ³å†æŒ‰ä¸€æ¬¡ enter è·³åˆ°ä¸‹ä¸€å€‹çµæœæ™‚ï¼Œç¬¬ä¸€å€‹çµæœçš„å­—å…ƒç›´æ¥è®Šæˆæ›è¡Œï¼‰ã€‚æ–¼æ˜¯ï¼å¤§æ¦‚æŸ¥äº†ä¸€ä¸‹ï¼Œç™¼ç¾ VScode æœ‰å€‹é…·å¤–æ›å«åš Remote - SSHåç¨±: <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-ssh">Remote - SSH</a>ï¼Œè®“æˆ‘å€‘å¯ä»¥ç›´æ¥é€£åˆ°é ç«¯çš„é›»è…¦åšé–‹ç™¼ï¼ä¸éæœ€å¤§çš„å•é¡Œæ˜¯è¦é–‹å•Ÿé ç«¯ä¸»æ©Ÿçš„ SSH serverï¼Œä¹Ÿå› ç‚ºæœ‰è§€çœ¾æ•²ç¢—æ‰€ä»¥æƒ³èªªä¾†è¨˜éŒ„ä¸€ä¸‹å¥½ã„Œï¼</p>

<h2 id="windows-ssh-server-configuration">Windows SSH Server Configuration</h2>

<p>é¦–å…ˆè¦æ„Ÿè¬å¤§å­¸æ™‚çš„ç ”ç©¶æ‰€å­¸é•·å—¡å—¡ï¼Œé€™æ®µåŸºæœ¬ä¸Šæ˜¯ç…§è‘—ä»–çš„ç¶²èªŒåšè¨­å®šã„‰ğŸ¥º</p>

<h3 id="step-1-å®‰è£-ssh-server">Step 1 å®‰è£ SSH server</h3>

<p>é¦–å…ˆè¦é€²åˆ°è¨­å®š &gt; æ‡‰ç”¨ç¨‹å¼èˆ‡åŠŸèƒ½ &gt; é¸ç”¨åŠŸèƒ½ï¼Œæª¢æŸ¥æœ‰æ²’æœ‰å®‰è£ SSH serverï¼Œå¦‚æœæ²’æœ‰çš„è©±å¯ä»¥é»é¸ç¬¬äºŒå¼µåœ–ä¸Šæ–¹çš„ã€Œæ–°å¢åŠŸèƒ½ã€ï¼Œæœå°‹ä¸¦å®‰è£ã€ŒOpenSSH ä¼ºæœå™¨ã€</p>

<p><img src="/assets/img/ssh1.png" alt="" />
<img src="/assets/img/ssh2.png" alt="" /></p>

<h3 id="step-2-åŸ·è¡Œ-ssh-server">Step 2 åŸ·è¡Œ SSH server</h3>

<p>æ¥ä¸‹ä¾†è¦ä»¥<strong>ç³»çµ±ç®¡ç†å“¡</strong>é–‹å•Ÿ Windows PowerShellï¼Œä¸¦è¼¸å…¥ä»¥ä¸‹æŒ‡ä»¤ä¾†é–‹å•Ÿ serverï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Start-Service sshd  # é–‹å•Ÿ SSH server
Set-Service -Name sshd -StartupType 'Automatic'  # é–‹æ©Ÿæ™‚è‡ªå‹•å•Ÿç”¨ï¼Œæ“”å¿ƒè³‡å®‰å•é¡Œä¹Ÿå¯ä»¥æŠŠ 'Automatic' æ”¹æˆ 'Manual'
</code></pre></div></div>
<p>è¨­å®šå¥½é ç«¯ä¸»æ©Ÿå¾Œï¼Œå¯ä»¥å›åˆ°ç¾åœ¨ç”¨çš„é›»è…¦ä¸Šï¼Œå…ˆé–‹å•Ÿ VScode ä¸¦å®‰è£å®˜æ–¹çš„ Remote å¤–æ›</p>

<h2 id="vscode-plugin-remote---ssh">VScode plugin: Remote - SSH</h2>

<p>å®‰è£å®Œé ç«¯ä¸»æ©Ÿçš„ SSH server ä¹‹å¾Œï¼Œå›åˆ°ç¾åœ¨ä½¿ç”¨çš„é›»è…¦ä¸Šï¼Œå®‰è£ VScode çš„ Remote - SSH å¤–æ›</p>

<p><img src="/assets/img/ssh-vscode.png" alt="" /></p>

<p>å®‰è£å®Œå¾Œæœƒç™¼ç¾å·¦ä¸‹è§’æœ‰ä¸€å€‹è—è‰²çš„æ¡†æ¡†å¯ä»¥é»
<img src="/assets/img/ssh-btn.png" alt="" /></p>

<p>é»é¸ä¹‹å¾Œæœƒè·³å‡ºä¸€å€‹å°è©±ç­ï¼Œè¼¸å…¥ä½ çš„é ç«¯ä¸»æ©Ÿ hostname/ip
<img src="/assets/img/ssh-host.png" alt="" /></p>

<p>ç¬¬ä¸€æ¬¡ä½¿ç”¨æ™‚éœ€è¦å…ˆæ–°å¢ä¸»æ©Ÿï¼ŒæŒ‰ç…§å°è©±ç­çš„æç¤ºï¼ˆ<code class="language-plaintext highlighter-rouge">ssh user@hostname</code>ï¼‰è¼¸å…¥ã€ä¸¦è¼¸å…¥è©²ä½¿ç”¨è€…çš„å¯†ç¢¼å¾Œï¼Œå°±å¯ä»¥é€£ç·šåˆ°é ç«¯ä¸»æ©Ÿäº†ï¼</p>
<blockquote>
  <p>è¨»ï¼šé€™é‚Šçš„ user æ˜¯æŒ‡é ç«¯ä¸»æ©Ÿçš„ä½¿ç”¨è€…ï¼Œå¯†ç¢¼å‰‡æ˜¯ç™»å…¥è©²ä½ä½¿ç”¨è€…çš„å¯†ç¢¼</p>
</blockquote>

<p><img src="/assets/img/ssh-new.png" alt="" /></p>

<font color="grey" style="font-size: 24px">Reference</font>
<ul>
  <li>å¤§ç¥å­¸é•·çš„ç¶²èªŒï¼š<a href="https://www.wongwonggoods.com/draft_notes/windows/windows-ssh/">ã€Windowsã€‘windows é–‹å•Ÿ ssh çš„æ–¹å¼ï½œå—¡å—¡çš„éš¨æ‰‹ç­†è¨˜</a></li>
  <li>Remote - SSH plugin æœ¬äººçš„é€£çµï¼š<a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-ssh">Remote - SSH</a></li>
</ul>]]></content><author><name></name></author><category term="update" /><category term="ssh" /><category term="config" /><category term="vscode" /><summary type="html"><![CDATA[é›–ç„¶æˆ‘å·²ç¶“æ˜¯ Vim çš„ä¿¡å¾’ã„Œï¼Œä½†ç¸½ä¸å¯èƒ½ç”¨ Vim å¯« Jupyter Notebook å§ï¼é–‹å¥½ Jupyter Notebook Server ä¹‹å¾Œå¯«äº†å¤§æ¦‚ä¸€å€‹æœˆï¼ŒçœŸçš„è¦ºå¾—é è¨­çš„æ¡†æ¡†æœ‰å¤ çª„æœ‰å¤ é›£å¯«ï¼Œæ”¹æˆç”¨ Jupyter Lab å¯«äº†ä¸€å€‹ç¦®æ‹œä¹‹å¾Œåˆè¦ºå¾—é‚£å€‹ç·¨è¼¯å™¨çš„è¨­å®šçœŸçš„è«åå…¶å¦™ï¼ˆèˆ‰ä¾‹ï¼šåœ¨è¼¸å…¥æœå°‹æ¬„å¾ŒæŒ‰ enterï¼Œcursor æœƒç›´æ¥ focus åœ¨ç¬¬äºŒå€‹çµæœï¼Œä¹Ÿå°±æ˜¯èªªç•¶ä½ æƒ³å†æŒ‰ä¸€æ¬¡ enter è·³åˆ°ä¸‹ä¸€å€‹çµæœæ™‚ï¼Œç¬¬ä¸€å€‹çµæœçš„å­—å…ƒç›´æ¥è®Šæˆæ›è¡Œï¼‰ã€‚æ–¼æ˜¯ï¼å¤§æ¦‚æŸ¥äº†ä¸€ä¸‹ï¼Œç™¼ç¾ VScode æœ‰å€‹é…·å¤–æ›å«åš Remote - SSHåç¨±: Remote - SSHï¼Œè®“æˆ‘å€‘å¯ä»¥ç›´æ¥é€£åˆ°é ç«¯çš„é›»è…¦åšé–‹ç™¼ï¼ä¸éæœ€å¤§çš„å•é¡Œæ˜¯è¦é–‹å•Ÿé ç«¯ä¸»æ©Ÿçš„ SSH serverï¼Œä¹Ÿå› ç‚ºæœ‰è§€çœ¾æ•²ç¢—æ‰€ä»¥æƒ³èªªä¾†è¨˜éŒ„ä¸€ä¸‹å¥½ã„Œï¼ Windows SSH Server Configuration é¦–å…ˆè¦æ„Ÿè¬å¤§å­¸æ™‚çš„ç ”ç©¶æ‰€å­¸é•·å—¡å—¡ï¼Œé€™æ®µåŸºæœ¬ä¸Šæ˜¯ç…§è‘—ä»–çš„ç¶²èªŒåšè¨­å®šã„‰ğŸ¥º Step 1 å®‰è£ SSH server é¦–å…ˆè¦é€²åˆ°è¨­å®š &gt; æ‡‰ç”¨ç¨‹å¼èˆ‡åŠŸèƒ½ &gt; é¸ç”¨åŠŸèƒ½ï¼Œæª¢æŸ¥æœ‰æ²’æœ‰å®‰è£ SSH serverï¼Œå¦‚æœæ²’æœ‰çš„è©±å¯ä»¥é»é¸ç¬¬äºŒå¼µåœ–ä¸Šæ–¹çš„ã€Œæ–°å¢åŠŸèƒ½ã€ï¼Œæœå°‹ä¸¦å®‰è£ã€ŒOpenSSH ä¼ºæœå™¨ã€ Step 2 åŸ·è¡Œ SSH server æ¥ä¸‹ä¾†è¦ä»¥ç³»çµ±ç®¡ç†å“¡é–‹å•Ÿ Windows PowerShellï¼Œä¸¦è¼¸å…¥ä»¥ä¸‹æŒ‡ä»¤ä¾†é–‹å•Ÿ serverï¼š Start-Service sshd # é–‹å•Ÿ SSH server Set-Service -Name sshd -StartupType 'Automatic' # é–‹æ©Ÿæ™‚è‡ªå‹•å•Ÿç”¨ï¼Œæ“”å¿ƒè³‡å®‰å•é¡Œä¹Ÿå¯ä»¥æŠŠ 'Automatic' æ”¹æˆ 'Manual' è¨­å®šå¥½é ç«¯ä¸»æ©Ÿå¾Œï¼Œå¯ä»¥å›åˆ°ç¾åœ¨ç”¨çš„é›»è…¦ä¸Šï¼Œå…ˆé–‹å•Ÿ VScode ä¸¦å®‰è£å®˜æ–¹çš„ Remote å¤–æ› VScode plugin: Remote - SSH å®‰è£å®Œé ç«¯ä¸»æ©Ÿçš„ SSH server ä¹‹å¾Œï¼Œå›åˆ°ç¾åœ¨ä½¿ç”¨çš„é›»è…¦ä¸Šï¼Œå®‰è£ VScode çš„ Remote - SSH å¤–æ› å®‰è£å®Œå¾Œæœƒç™¼ç¾å·¦ä¸‹è§’æœ‰ä¸€å€‹è—è‰²çš„æ¡†æ¡†å¯ä»¥é» é»é¸ä¹‹å¾Œæœƒè·³å‡ºä¸€å€‹å°è©±ç­ï¼Œè¼¸å…¥ä½ çš„é ç«¯ä¸»æ©Ÿ hostname/ip ç¬¬ä¸€æ¬¡ä½¿ç”¨æ™‚éœ€è¦å…ˆæ–°å¢ä¸»æ©Ÿï¼ŒæŒ‰ç…§å°è©±ç­çš„æç¤ºï¼ˆssh user@hostnameï¼‰è¼¸å…¥ã€ä¸¦è¼¸å…¥è©²ä½¿ç”¨è€…çš„å¯†ç¢¼å¾Œï¼Œå°±å¯ä»¥é€£ç·šåˆ°é ç«¯ä¸»æ©Ÿäº†ï¼ è¨»ï¼šé€™é‚Šçš„ user æ˜¯æŒ‡é ç«¯ä¸»æ©Ÿçš„ä½¿ç”¨è€…ï¼Œå¯†ç¢¼å‰‡æ˜¯ç™»å…¥è©²ä½ä½¿ç”¨è€…çš„å¯†ç¢¼ Reference å¤§ç¥å­¸é•·çš„ç¶²èªŒï¼šã€Windowsã€‘windows é–‹å•Ÿ ssh çš„æ–¹å¼ï½œå—¡å—¡çš„éš¨æ‰‹ç­†è¨˜ Remote - SSH plugin æœ¬äººçš„é€£çµï¼šRemote - SSH]]></summary></entry><entry><title type="html">åœ¨ EC2 ä¸­é–‹å•Ÿ Docker Swarm ç¾¤é›†</title><link href="https://jqlynchien713.github.io/2022/06/22/docker-swarm-intro.html" rel="alternate" type="text/html" title="åœ¨ EC2 ä¸­é–‹å•Ÿ Docker Swarm ç¾¤é›†" /><published>2022-06-22T12:38:00+00:00</published><updated>2022-06-22T12:38:00+00:00</updated><id>https://jqlynchien713.github.io/2022/06/22/docker-swarm-intro</id><content type="html" xml:base="https://jqlynchien713.github.io/2022/06/22/docker-swarm-intro.html"><![CDATA[<h2 id="docker-swarm-introduction">Docker Swarm Introduction</h2>

<ul>
  <li>Ref: <a href="https://www.youtube.com/watch?v=_riEfxHoUh0&amp;list=PLzZ2RIhyht-PTxy-l5H4iwtCPmNHJu8wD&amp;index=29">(32) Docker Swarm Introduction - Video 28 - YouTube</a></li>
</ul>

<h3 id="structure">Structure</h3>

<p><img src="/assets/img/swarm.png" alt="Work.jpg" /></p>

<h3 id="scalability--availability">Scalability &amp; Availability</h3>

<p><strong>Differences/Definitions of Scalability &amp; Availability</strong></p>

<ul>
  <li>Scalability: ç•¶æµé‡è®Šå¤§/è®Šå°æ™‚ï¼Œç³»çµ±ä¸­çš„ server æ•¸å¯ä»¥æ©«å‘æ“´å±•æˆ–ç¸®æ¸›</li>
  <li>Availability: ç•¶éƒ¨åˆ†çš„æ©Ÿå™¨ç„¡æ³•é‹ä½œæ™‚ï¼Œèƒ½å¤ ç¢ºä¿æœå‹™ä¸è¢«ä¸­æ–·ï¼ˆè‡ªå‹•é–‹å•Ÿæ–°çš„ instanceï¼‰</li>
  <li>Docker Swarm Features
    <ol>
      <li>Scalabilityï¼šè‡ªå‹•åœ¨ç©ºé–“è¶³å¤ çš„ worker ä¸Šé–‹å•Ÿæ–°çš„ container</li>
      <li>Availabilityï¼šä»¥æ›´æ–° appã€é™ä½ downtime ç‚ºä¾‹
        <ol>
          <li>ç•¶éœ€è¦æ›´æ–° app ç‰ˆæœ¬æ™‚ï¼Œå¯ä»¥è®“ load balancer è‡ªå‹• route åˆ°æ–°ç‰ˆ app ä¸Š</li>
          <li>æ¼¸é€²å¼å–ä»£æ‰€æœ‰èˆŠç‰ˆçš„ app container</li>
        </ol>
      </li>
    </ol>
  </li>
</ul>

<h3 id="service-vs-task">Service vs Task</h3>
<p>æ ¹æ“š document çš„å¯«æ³•ï¼Œservice èˆ‡ task çš„å·®åˆ¥å¦‚ä¸‹åœ–ï¼š
<img src="https://docs.docker.com/engine/swarm/images/services-diagram.png" alt="https://docs.docker.com/engine/swarm/images/services-diagram.png" />
å…©è€…çš„å€åˆ¥åœ¨æ–¼ï¼Œservice æ˜¯ç”± manager æ§ç®¡çš„ applicationï¼Œè€Œ task å‰‡æ˜¯æ ¹æ“š manager çš„æ§åˆ¶ã€å„å€‹ worker è¢«æŒ‡æ´¾çš„ä»»å‹™ã€‚</p>

<h3 id="stack-vs-compose">Stack vs Compose</h3>

<p>åŸºæœ¬ä¸Š stack å¯ä»¥è¦–ç‚ºå‡ç´šç‰ˆçš„ composeï¼Œä¸¦ä¸” stack çš„è¨­å®šæª”ä¹Ÿå¯ä»¥æ‹¿ docker-compose file ä¾†åŸ·è¡Œï¼ˆåªè¦æ˜¯ yml éƒ½è¡Œï¼‰</p>

<h2 id="swarm-mode-implementation">Swarm Mode Implementation</h2>

<ul>
  <li>Ref: <a href="https://zhuanlan.zhihu.com/p/79694462">Swarmä¸Dockerçš„æ•´åˆâ€”â€”Swarm mode - çŸ¥ä¹ (zhihu.com)</a></li>
  <li><a href="https://docs.docker.com/engine/swarm/swarm-tutorial/#open-protocols-and-ports-between-the-hosts">Getting started with swarm mode, Docker Documentation</a> â†’ port prerequistive to set up security group</li>
  <li>Run docker daemon on EC2(amazon linux): <a href="https://phoenixnap.com/kb/cannot-connect-to-the-docker-daemon-error#:~:text=Method%202%3A%20Assign%20Ownership%20to%20the%20Docker%20Unix%20Socket">Method 2: Assign Ownership to the Docker Unix Socket</a></li>
</ul>

<h3 id="ec2-ç‰¹æ®Šè¨­å®š">EC2 ç‰¹æ®Šè¨­å®š</h3>

<ul>
  <li>SSM53: session manager <a href="/2022/06/05/aws-ssh.html">åƒè€ƒå‰ä¸€ç¯‡æ–‡ç« </a></li>
  <li>Security Group Inbounds
    <ul>
      <li>Allow TCP port 6000-9000 from my IP</li>
      <li>Allow all TCP inbound from same security groupï¼Œå¥½è™•æ˜¯å¯ä»¥ä¸ç”¨ç‰¹åˆ¥è¨­å®š <a href="https://docs.docker.com/engine/swarm/swarm-tutorial/#open-protocols-and-ports-between-the-hosts">docker swarm æŒ‡å®šçš„å‚³è¼¸ port</a></li>
    </ul>
  </li>
</ul>

<h3 id="æ“ä½œæ­¥é©Ÿ">æ“ä½œæ­¥é©Ÿ</h3>

<ol>
  <li>é–‹ä¸‰å° EC2ï¼Œå…¶ä¸­ä¸€å°ä½œç‚º managerã€å¦å¤–å…©å°ä½œç‚º worker</li>
  <li>å®‰è£ docker ä¸¦åŸ·è¡Œ docker daemon
    <ol>
      <li>é–‹å•Ÿ docker engineï¼š<code class="language-plaintext highlighter-rouge">sudo service docker start</code></li>
      <li><code class="language-plaintext highlighter-rouge">sudo chown ec2-user:docker /var/run/docker.sock</code> ï¼ˆ<code class="language-plaintext highlighter-rouge">ec2-user</code>ç‚º user-nameï¼Œçµ¦äºˆ ec2-user docker engine çš„ ownershipï¼‰</li>
    </ol>
  </li>
</ol>

<p><strong>Manager</strong></p>

<ol>
  <li>é–‹å•Ÿä¸€å€‹ swarmã€ä¸¦å°‡æ‰€åœ¨çš„æ©Ÿå™¨æŒ‡å®šç‚º managerï¼š<code class="language-plaintext highlighter-rouge">docker swarm init --advertise-addr [manager-ip]</code>
    <ol>
      <li>çµ‚ç«¯æ©Ÿæœƒå›å‚³å¦‚ä½•å°‡ worker åŠ å…¥ swarm çš„æŒ‡ä»¤ï¼š<code class="language-plaintext highlighter-rouge">docker swarm join --token [token] [manager-ip]:2377</code></li>
      <li>å¦‚æœéºå¿˜åŠ å…¥çš„æŒ‡ä»¤çš„è©±ï¼Œå¯ä»¥åœ¨ manager ä¸‹é€™å€‹æŒ‡ä»¤ä¾†æ‰¾å›ï¼š<code class="language-plaintext highlighter-rouge">docker swarm join-token worker</code></li>
    </ol>
  </li>
</ol>

<p><strong>Worker</strong></p>

<ol>
  <li>ç”¨ç”Ÿæˆçš„æŒ‡ä»¤ä¾†åŠ å…¥å‰›å‰›è¨­å®šçš„ swarmï¼š<code class="language-plaintext highlighter-rouge">docker swarm join --token [token] [manager-ip]:2377</code></li>
</ol>

<p><strong>æª¢æŸ¥ swarm å…ƒä»¶</strong></p>

<ol>
  <li>å¯ä»¥åœ¨ manager ä¸‹ <code class="language-plaintext highlighter-rouge">docker node ls</code> æª¢æŸ¥ swarm å…§çš„ç¯€é»æ˜¯å¦ç¬¦åˆé æœŸ</li>
</ol>]]></content><author><name></name></author><category term="update" /><category term="docker" /><category term="docker-swarm" /><category term="COSCUP" /><summary type="html"><![CDATA[Docker Swarm Introduction Ref: (32) Docker Swarm Introduction - Video 28 - YouTube Structure Scalability &amp; Availability Differences/Definitions of Scalability &amp; Availability Scalability: ç•¶æµé‡è®Šå¤§/è®Šå°æ™‚ï¼Œç³»çµ±ä¸­çš„ server æ•¸å¯ä»¥æ©«å‘æ“´å±•æˆ–ç¸®æ¸› Availability: ç•¶éƒ¨åˆ†çš„æ©Ÿå™¨ç„¡æ³•é‹ä½œæ™‚ï¼Œèƒ½å¤ ç¢ºä¿æœå‹™ä¸è¢«ä¸­æ–·ï¼ˆè‡ªå‹•é–‹å•Ÿæ–°çš„ instanceï¼‰ Docker Swarm Features Scalabilityï¼šè‡ªå‹•åœ¨ç©ºé–“è¶³å¤ çš„ worker ä¸Šé–‹å•Ÿæ–°çš„ container Availabilityï¼šä»¥æ›´æ–° appã€é™ä½ downtime ç‚ºä¾‹ ç•¶éœ€è¦æ›´æ–° app ç‰ˆæœ¬æ™‚ï¼Œå¯ä»¥è®“ load balancer è‡ªå‹• route åˆ°æ–°ç‰ˆ app ä¸Š æ¼¸é€²å¼å–ä»£æ‰€æœ‰èˆŠç‰ˆçš„ app container Service vs Task æ ¹æ“š document çš„å¯«æ³•ï¼Œservice èˆ‡ task çš„å·®åˆ¥å¦‚ä¸‹åœ–ï¼š å…©è€…çš„å€åˆ¥åœ¨æ–¼ï¼Œservice æ˜¯ç”± manager æ§ç®¡çš„ applicationï¼Œè€Œ task å‰‡æ˜¯æ ¹æ“š manager çš„æ§åˆ¶ã€å„å€‹ worker è¢«æŒ‡æ´¾çš„ä»»å‹™ã€‚ Stack vs Compose åŸºæœ¬ä¸Š stack å¯ä»¥è¦–ç‚ºå‡ç´šç‰ˆçš„ composeï¼Œä¸¦ä¸” stack çš„è¨­å®šæª”ä¹Ÿå¯ä»¥æ‹¿ docker-compose file ä¾†åŸ·è¡Œï¼ˆåªè¦æ˜¯ yml éƒ½è¡Œï¼‰ Swarm Mode Implementation Ref: Swarmä¸Dockerçš„æ•´åˆâ€”â€”Swarm mode - çŸ¥ä¹ (zhihu.com) Getting started with swarm mode, Docker Documentation â†’ port prerequistive to set up security group Run docker daemon on EC2(amazon linux): Method 2: Assign Ownership to the Docker Unix Socket EC2 ç‰¹æ®Šè¨­å®š SSM53: session manager åƒè€ƒå‰ä¸€ç¯‡æ–‡ç«  Security Group Inbounds Allow TCP port 6000-9000 from my IP Allow all TCP inbound from same security groupï¼Œå¥½è™•æ˜¯å¯ä»¥ä¸ç”¨ç‰¹åˆ¥è¨­å®š docker swarm æŒ‡å®šçš„å‚³è¼¸ port æ“ä½œæ­¥é©Ÿ é–‹ä¸‰å° EC2ï¼Œå…¶ä¸­ä¸€å°ä½œç‚º managerã€å¦å¤–å…©å°ä½œç‚º worker å®‰è£ docker ä¸¦åŸ·è¡Œ docker daemon é–‹å•Ÿ docker engineï¼šsudo service docker start sudo chown ec2-user:docker /var/run/docker.sock ï¼ˆec2-userç‚º user-nameï¼Œçµ¦äºˆ ec2-user docker engine çš„ ownershipï¼‰ Manager é–‹å•Ÿä¸€å€‹ swarmã€ä¸¦å°‡æ‰€åœ¨çš„æ©Ÿå™¨æŒ‡å®šç‚º managerï¼šdocker swarm init --advertise-addr [manager-ip] çµ‚ç«¯æ©Ÿæœƒå›å‚³å¦‚ä½•å°‡ worker åŠ å…¥ swarm çš„æŒ‡ä»¤ï¼šdocker swarm join --token [token] [manager-ip]:2377 å¦‚æœéºå¿˜åŠ å…¥çš„æŒ‡ä»¤çš„è©±ï¼Œå¯ä»¥åœ¨ manager ä¸‹é€™å€‹æŒ‡ä»¤ä¾†æ‰¾å›ï¼šdocker swarm join-token worker Worker ç”¨ç”Ÿæˆçš„æŒ‡ä»¤ä¾†åŠ å…¥å‰›å‰›è¨­å®šçš„ swarmï¼šdocker swarm join --token [token] [manager-ip]:2377 æª¢æŸ¥ swarm å…ƒä»¶ å¯ä»¥åœ¨ manager ä¸‹ docker node ls æª¢æŸ¥ swarm å…§çš„ç¯€é»æ˜¯å¦ç¬¦åˆé æœŸ]]></summary></entry><entry><title type="html">SSH to EC2 with Auto Assigned Certificates</title><link href="https://jqlynchien713.github.io/2022/06/05/aws-ssh.html" rel="alternate" type="text/html" title="SSH to EC2 with Auto Assigned Certificates" /><published>2022-06-05T08:24:00+00:00</published><updated>2022-06-05T08:24:00+00:00</updated><id>https://jqlynchien713.github.io/2022/06/05/aws-ssh</id><content type="html" xml:base="https://jqlynchien713.github.io/2022/06/05/aws-ssh.html"><![CDATA[<p>åœ¨é–‹å§‹ä½¿ç”¨ EC2 å¾Œï¼Œæ¯æ¬¡éƒ½è¦æ‰¾åˆ° EC2 çš„ certificate å¸¶å…¥ ssh çš„æŒ‡ä»¤è£¡çœŸã„‰å¾ˆéº»ç…©ï¼Œå‰›å¥½åœ¨ä¸Šæ¬¡ä¸Šèª²çš„æ™‚å€™è€å¸«æ•™äº† ssh çš„è¨­å®šï¼Œè®“æˆ‘å€‘åœ¨ä¹‹å¾Œé€£å…¥ EC2 éƒ½å¯ä»¥ä½¿ç”¨åŸæœ¬é›»è…¦è£¡çš„ ssh keyã€ä¸¦é€é <code class="language-plaintext highlighter-rouge">ssh i-[EC2 id]</code> å°±èƒ½é€£åˆ° EC2 è£¡ã„Œï¼Œæ¯”åŸæœ¬çš„æ–¹æ³•æ–¹ä¾¿è¨±å¤šï¼</p>
<h2 id="create-qualified-ec2">Create qualified EC2</h2>
<p>åœ¨ EC2 çš„éƒ¨åˆ†ï¼Œä¸»è¦æ˜¯éœ€è¦å°‡ Session Manager çš„ <em>role</em> æŒ‡å®šçµ¦æˆ‘å€‘æƒ³è¦é€£ç·šçš„ EC2</p>
<ul>
  <li>Create new EC2 instances(optional)</li>
  <li>Assigning IAM role with Session Manager access
    <ul>
      <li>Policy name: <code class="language-plaintext highlighter-rouge">AmazonEC2RoleforSSM</code></li>
    </ul>
  </li>
</ul>

<h2 id="æ–°å¢ä½¿ç”¨è€…">æ–°å¢ä½¿ç”¨è€…</h2>
<p>åŒæ™‚æˆ‘å€‘å¿…é ˆè¦æŒ‡å®šï¼Œä»Šå¤©é€£é€² EC2 çš„æ˜¯å“ªä¸€å€‹ <em>user</em></p>
<ul>
  <li>åœ¨ AWS IAM æ–°å¢ä¸€å€‹ userï¼Œè©² user è¦æœ‰ <code class="language-plaintext highlighter-rouge">AdministratorAccess</code></li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">aws configure --profile default</code> æ–°å¢ä¸€å€‹ default çš„ aws user</p>

    <p><img src="/assets/img/key-sec.png" alt="æˆªåœ– 2022-06-05 15.57.54.png" /></p>

    <ul>
      <li>USER_KEY = <code class="language-plaintext highlighter-rouge">[Access key ID]</code></li>
      <li>USER_SECRET = <code class="language-plaintext highlighter-rouge">[Secret access key]</code></li>
    </ul>
  </li>
</ul>

<h2 id="è¨­å®šæœ¬åœ°ç«¯-ssh">è¨­å®šæœ¬åœ°ç«¯ SSH</h2>
<p>æœ€å¾Œå°±æ˜¯æ¯”è¼ƒéº»ç…©çš„ ssh è¨­å®šï¼Œåƒè€ƒä¸‹é¢çš„é€™å€‹ script</p>
<ul>
  <li>Ref:  https://github.com/qoomon/aws-ssm-ec2-proxy-command</li>
  <li>è¤‡è£½ <a href="https://github.com/qoomon/aws-ssm-ec2-proxy-command/blob/master/aws-ssm-ec2-proxy-command.sh">aws-ssm-ec2-proxy-command.sh</a> åˆ° <code class="language-plaintext highlighter-rouge">.ssh</code> ä¸‹</li>
  <li><code class="language-plaintext highlighter-rouge">chmod +x ~/.ssh/aws-ssm-ec2-proxy-command.sh</code></li>
  <li>
    <p>å¯¦éš›ä½¿ç”¨ï¼šä»¥ default IAM user é€£é€² EC2</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">AWS_PROFILE</span><span class="o">=</span>default ssh ec2-user@i-0c45c33713e830c9d <span class="se">\</span>
  <span class="nt">-i</span> <span class="s2">"~/.ssh/id_ed25519"</span> <span class="se">\</span>
  <span class="nt">-o</span> <span class="nv">ProxyCommand</span><span class="o">=</span><span class="s2">"~/.ssh/aws-ssm-ec2-proxy-command.sh %h %r %p ~/.ssh/id_ed25519.pub"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>åŠ å…¥ <code class="language-plaintext highlighter-rouge">.ssh/config</code></p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>host i-<span class="k">*</span> mi-<span class="k">*</span>
  User ec2-user
  IdentityFile ~/.ssh/id_ed25519
  ProxyCommand ~/.ssh/aws-ssm-ec2-proxy-command.sh %h %r %p ~/.ssh/id_ed25519.pub
  StrictHostKeyChecking no
</code></pre></div>    </div>
  </li>
  <li>è¨­å®šå®Œå¾Œèˆ‡ EC2 é€£ç·šï¼š<code class="language-plaintext highlighter-rouge">ssh i-072f2dd63ae1189e9</code></li>
</ul>

<p>å®Œæˆå•¦ï¼ï¼ï¼ğŸ¥³ğŸ¥³ğŸ¥³ğŸ¥³</p>]]></content><author><name></name></author><category term="update" /><category term="aws" /><category term="ec2" /><category term="ssh" /><summary type="html"><![CDATA[åœ¨é–‹å§‹ä½¿ç”¨ EC2 å¾Œï¼Œæ¯æ¬¡éƒ½è¦æ‰¾åˆ° EC2 çš„ certificate å¸¶å…¥ ssh çš„æŒ‡ä»¤è£¡çœŸã„‰å¾ˆéº»ç…©ï¼Œå‰›å¥½åœ¨ä¸Šæ¬¡ä¸Šèª²çš„æ™‚å€™è€å¸«æ•™äº† ssh çš„è¨­å®šï¼Œè®“æˆ‘å€‘åœ¨ä¹‹å¾Œé€£å…¥ EC2 éƒ½å¯ä»¥ä½¿ç”¨åŸæœ¬é›»è…¦è£¡çš„ ssh keyã€ä¸¦é€é ssh i-[EC2 id] å°±èƒ½é€£åˆ° EC2 è£¡ã„Œï¼Œæ¯”åŸæœ¬çš„æ–¹æ³•æ–¹ä¾¿è¨±å¤šï¼ Create qualified EC2 åœ¨ EC2 çš„éƒ¨åˆ†ï¼Œä¸»è¦æ˜¯éœ€è¦å°‡ Session Manager çš„ role æŒ‡å®šçµ¦æˆ‘å€‘æƒ³è¦é€£ç·šçš„ EC2 Create new EC2 instances(optional) Assigning IAM role with Session Manager access Policy name: AmazonEC2RoleforSSM æ–°å¢ä½¿ç”¨è€… åŒæ™‚æˆ‘å€‘å¿…é ˆè¦æŒ‡å®šï¼Œä»Šå¤©é€£é€² EC2 çš„æ˜¯å“ªä¸€å€‹ user åœ¨ AWS IAM æ–°å¢ä¸€å€‹ userï¼Œè©² user è¦æœ‰ AdministratorAccess aws configure --profile default æ–°å¢ä¸€å€‹ default çš„ aws user USER_KEY = [Access key ID] USER_SECRET = [Secret access key] è¨­å®šæœ¬åœ°ç«¯ SSH æœ€å¾Œå°±æ˜¯æ¯”è¼ƒéº»ç…©çš„ ssh è¨­å®šï¼Œåƒè€ƒä¸‹é¢çš„é€™å€‹ script Ref: https://github.com/qoomon/aws-ssm-ec2-proxy-command è¤‡è£½ aws-ssm-ec2-proxy-command.sh åˆ° .ssh ä¸‹ chmod +x ~/.ssh/aws-ssm-ec2-proxy-command.sh å¯¦éš›ä½¿ç”¨ï¼šä»¥ default IAM user é€£é€² EC2 AWS_PROFILE=default ssh ec2-user@i-0c45c33713e830c9d \ -i "~/.ssh/id_ed25519" \ -o ProxyCommand="~/.ssh/aws-ssm-ec2-proxy-command.sh %h %r %p ~/.ssh/id_ed25519.pub" åŠ å…¥ .ssh/config host i-* mi-* User ec2-user IdentityFile ~/.ssh/id_ed25519 ProxyCommand ~/.ssh/aws-ssm-ec2-proxy-command.sh %h %r %p ~/.ssh/id_ed25519.pub StrictHostKeyChecking no è¨­å®šå®Œå¾Œèˆ‡ EC2 é€£ç·šï¼šssh i-072f2dd63ae1189e9 å®Œæˆå•¦ï¼ï¼ï¼ğŸ¥³ğŸ¥³ğŸ¥³ğŸ¥³]]></summary></entry><entry><title type="html">VPC/Route 53 config &amp;amp; Nginx + EC2 æœ€ç°¡å–®çš„ EC2 å¯¦ä½œğŸ« </title><link href="https://jqlynchien713.github.io/2022/05/16/aws-ec2.html" rel="alternate" type="text/html" title="VPC/Route 53 config &amp;amp; Nginx + EC2 æœ€ç°¡å–®çš„ EC2 å¯¦ä½œğŸ« " /><published>2022-05-16T13:52:00+00:00</published><updated>2022-05-16T13:52:00+00:00</updated><id>https://jqlynchien713.github.io/2022/05/16/aws-ec2</id><content type="html" xml:base="https://jqlynchien713.github.io/2022/05/16/aws-ec2.html"><![CDATA[<p>æœ€è¿‘å› ç‚ºå…¬å¸é–‹äº†å¹¾å ‚ AWS çš„æ•™è‚²è¨“ç·´ï¼Œèª²ç¨‹çµæŸå¾Œè€é—†å€‘æœ‰æŒ‡æ´¾å›å®¶ä½œæ¥­éœ€è¦å®Œæˆï¼Œå› æ­¤æŠŠå¯¦ä½œçš„æ­·ç¨‹ç´€éŒ„åœ¨é€™é‚Šï¼ˆä¸çŸ¥é“æˆ‘ k8s é‚£å…©ç¯‡å•¥æ™‚æ‰èƒ½ç™¼ä½ˆğŸ« ï¼‰</p>

<h2 id="homework">Homework</h2>
<p>åŸºæœ¬è¦æ±‚</p>
<ul>
  <li>VPC å»ºå‡ºä¾†è¦æœ‰ Subnet / Route Table</li>
  <li>Route 53 è¦è¨­å®šå‡º sub-domain è¦æœ‰å¹¾ç­† CNAME / A</li>
</ul>

<p>å…¶å¯¦é€™æ¬¡çš„ä½œæ¥­è »ç°¡å–®çš„ï¼Œå› ç‚º VPC é è¨­å°±æœƒå¹«æˆ‘å€‘é–‹å¥½ Subnet èˆ‡ route tableï¼Œéº»ç…©çš„é»æ˜¯åœ¨è¦ç†è§£ Route 53 çš„æœå‹™åˆ°åº•å¯ä»¥å¹«æˆ‘å€‘å®Œæˆä»€éº¼äº‹ã€‚</p>

<h3 id="hw---record">HW - record</h3>

<ol>
  <li>Create VPC
    <ul>
      <li>Route table æ–°å¢è·¯ç”±é€£åˆ°å¤–ç¶²ï¼š
        <ul>
          <li>Main route table â†’ Routes â†’ Edit Routes</li>
          <li>Destination: 0.0.0.0/0 , Target: igw-XXXX</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Create EC2
    <ol>
      <li><a href="https://ithelp.ithome.com.tw/articles/10233669">Day4ï¼šAmazon Elastic Cloud Compute(EC2)</a></li>
      <li><a href="https://www.kx.com.tw/aws-usecase-VPC/">ã€AWS 101ã€‘é‚å…¥AWSçš„ç¬¬ä¸€æ­¥-è¨­å®šVPC &amp; public subnet</a></li>
    </ol>
  </li>
  <li>Setup Route53
    <ol>
      <li><a href="https://ithelp.ithome.com.tw/articles/10234138">Day11ï¼šAmazon Route 53</a></li>
    </ol>
  </li>
  <li>Amplify: ä»¥è¦–è¦ºæ–¹å¼å»ºç½® Web å‰ç«¯ UI
    <ol>
      <li><a href="https://medium.com/@jameshamann/deploy-your-jekyll-site-using-aws-amplify-with-only-a-few-clicks-8f3dd8f26112">Deploy your Jekyll Site using AWS Amplify â€” with only a few clicks</a></li>
      <li>Amplify console - Domain management: å¯ä»¥ç›´æ¥åœ¨åŸæœ‰çš„ domain åŠ ä¸Šä¸€å€‹ subdomain</li>
    </ol>
  </li>
</ol>

<h3 id="å•é¡Œ">å•é¡Œ</h3>

<ol>
  <li>CNAME æ‡‰ç”¨å ´æ™¯ï¼šå…§éƒ¨é–‹ç™¼æ–¹ä¾¿ï¼ˆè¨­åœ¨ private zoneï¼‰ã€å®‰å…¨æ€§ï¼ˆè¨­å®šæª”éƒ½è¨­ CNAME çš„ dnsï¼‰</li>
  <li>Name server ç”¨è™•ï¼šè®“å…¶ä»–äººå¾—ä»¥ query åˆ°æˆ‘å€‘è‡ªå·±è¨­å®šçš„ dns record</li>
</ol>

<h2 id="nginx-in-ec2">Nginx in EC2</h2>

<blockquote>
  <p>Prerequisite: EC2 w/ SG allowing http &amp; https</p>

</blockquote>

<h3 id="nginx-config">Nginx Config</h3>
<p>åœ¨è¨­å®šå®Œä¸Šè¿° Route 53 çš„ A / CNAME record ä¹‹å¾Œï¼Œè¦ºå¾—å¦‚æœæ²’æœ‰çœŸçš„é–‹ä¸€å€‹ server é¡¯ç¤ºä¸€é»æ±è¥¿çœŸçš„å¤ªå°ä¸èµ·è‡ªå·±ã„Œå§ï¼ˆè›¤ï¼‰ï¼Œæ–¼æ˜¯å°±æ”¾äº†ä¸€å€‹ç°¡å–®çš„é é¢é€²å»å‰›å‰›é–‹å¥½çš„ EC2 è£¡</p>

<ol>
  <li>
    <p>ä¸‹è¼‰ nginx &amp; epel</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">sudo </span>yum <span class="nb">install</span> <span class="nt">-y</span> epel-release
 <span class="nb">sudo </span>yum <span class="nb">install </span>nginx <span class="nt">-y</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Nginx ç›¸é—œæŒ‡ä»¤</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">sudo </span>systemctl start nginx
 <span class="nb">sudo </span>systemctl <span class="nb">enable </span>nginx
 <span class="nb">sudo </span>systemctl status nginx
</code></pre></div>    </div>
  </li>
  <li>
    <p>å»ºç«‹è³‡æ–™å¤¾æ”¾ç½®è¦ serve çš„éœæ…‹æª”æ¡ˆï¼ŒæŠŠ index.html åŠ åˆ°è£¡é¢</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">sudo mkdir</span> /var/www/jc713.staff.5xruby.dev/public_html
</code></pre></div>    </div>
  </li>
  <li>
    <p>æ”¹è®Šè©²è³‡æ–™å¤¾çš„æ‰€æœ‰æ¬Šï¼Œè®“ Nginx å¯ä»¥å­˜å–åŸ·è¡Œ</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">sudo chown</span> <span class="nt">-R</span> nginx: /var/www/jc713.staff.5xruby.dev/
</code></pre></div>    </div>
  </li>
  <li>
    <p>Enable SELinux: <code class="language-plaintext highlighter-rouge">sudo vim /etc/selinux/config</code> å°‡ disable æ”¹æˆ enable</p>

    <p>&amp; check <code class="language-plaintext highlighter-rouge">sudo sestatus</code></p>
  </li>
  <li>
    <p>é–‹æ”¾ SELinux å­˜å– Nginx website files</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">sudo </span>setsebool <span class="nt">-P</span> httpd_can_network_connect on
 <span class="nb">sudo chcon</span> <span class="nt">-Rt</span> httpd_sys_content_t /var/www/
</code></pre></div>    </div>
  </li>
  <li>
    <p>Nginx è¨­å®šæª” <code class="language-plaintext highlighter-rouge">sudo vi /etc/nginx/sites-available/jc713.staff.5xruby.dev.conf</code></p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> server <span class="o">{</span>
     listen 80<span class="p">;</span>
     listen <span class="o">[</span>::]:80<span class="p">;</span>

     root /var/www/example-one.com/public_html<span class="p">;</span>

     index index.html<span class="p">;</span>

     server_name example-one.com www.example-one.com<span class="p">;</span>

     access_log /var/log/nginx/example-one.com.access.log<span class="p">;</span>
     error_log /var/log/nginx/example-one.com.error.log<span class="p">;</span>

     location / <span class="o">{</span>
         try_files <span class="nv">$uri</span> <span class="nv">$uri</span>/ <span class="o">=</span>404<span class="p">;</span>
     <span class="o">}</span>
 <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>é©—è­‰ Nginx è¨­å®š</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span><span class="nb">sudo </span>nginx <span class="nt">-t</span>
 nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
 nginx: configuration file /etc/nginx/nginx.conf <span class="nb">test </span>is successful
</code></pre></div>    </div>
  </li>
  <li>
    <p>Restart Nginx with <code class="language-plaintext highlighter-rouge">sudo systemctl restart nginx</code></p>
  </li>
</ol>

<h3 id="nginx-ssl-settings">Nginx SSL settings</h3>

<ol>
  <li>
    <p>å®‰è£ Certbot</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">sudo </span>apt <span class="nb">install </span>certbot <span class="nt">-y</span>
 <span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> python-certbot-nginx
</code></pre></div>    </div>
  </li>
  <li>
    <p>ç”Ÿæˆ SSL æ†‘è­‰ &amp; Nginx è¨­å®š</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span><span class="nb">sudo </span>certbot <span class="nt">--nginx</span>
 <span class="nt">-------</span>
 1. You site admin email address
 2. Terms of Service agreement.
 3. List of domains you need HTTPS <span class="k">for</span><span class="nb">.</span> Certbot will automatically detect this information from the Nginx conf files.
 4. HTTP to HTTPS redirection confirmation <span class="o">(</span>it is better to redirect<span class="o">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Certbot æœƒè‡ªå‹•åœ¨å‰›å‰›è¨­å®šçš„ Nginx è¨­å®šæª”è£¡ç”¢ç”Ÿä»¥ä¸‹è³‡è¨Š</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> listen <span class="o">[</span>::]:443 ssl <span class="nv">ipv6only</span><span class="o">=</span>on<span class="p">;</span> <span class="c"># managed by Certbot</span>
     listen 443 ssl<span class="p">;</span> <span class="c"># managed by Certbot</span>
     ssl_certificate /etc/letsencrypt/live/kartsavings.com/fullchain.pem<span class="p">;</span> <span class="c"># managed by Certbot</span>
     ssl_certificate_key /etc/letsencrypt/live/kartsavings.com/privkey.pem<span class="p">;</span> <span class="c"># managed by Certbot</span>
     include /etc/letsencrypt/options-ssl-nginx.conf<span class="p">;</span> <span class="c"># managed by Certbot</span>
     ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem<span class="p">;</span> <span class="c"># managed by Certbot</span>
 <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Done!</p>
  </li>
</ol>

<font color="grey" style="font-size: 24px">Reference</font>
<ul>
  <li><a href="https://comtechies.com/how-to-install-and-configure-nginx-on-amazon-ec2-rhel-and-ubuntu-instances.html">Ref 1</a></li>
  <li><a href="https://comtechies.com/nginx-letsencrypt-setup-guide-certbot.html">Ref 2</a></li>
</ul>]]></content><author><name></name></author><category term="update" /><summary type="html"><![CDATA[æœ€è¿‘å› ç‚ºå…¬å¸é–‹äº†å¹¾å ‚ AWS çš„æ•™è‚²è¨“ç·´ï¼Œèª²ç¨‹çµæŸå¾Œè€é—†å€‘æœ‰æŒ‡æ´¾å›å®¶ä½œæ¥­éœ€è¦å®Œæˆï¼Œå› æ­¤æŠŠå¯¦ä½œçš„æ­·ç¨‹ç´€éŒ„åœ¨é€™é‚Šï¼ˆä¸çŸ¥é“æˆ‘ k8s é‚£å…©ç¯‡å•¥æ™‚æ‰èƒ½ç™¼ä½ˆğŸ« ï¼‰ Homework åŸºæœ¬è¦æ±‚ VPC å»ºå‡ºä¾†è¦æœ‰ Subnet / Route Table Route 53 è¦è¨­å®šå‡º sub-domain è¦æœ‰å¹¾ç­† CNAME / A å…¶å¯¦é€™æ¬¡çš„ä½œæ¥­è »ç°¡å–®çš„ï¼Œå› ç‚º VPC é è¨­å°±æœƒå¹«æˆ‘å€‘é–‹å¥½ Subnet èˆ‡ route tableï¼Œéº»ç…©çš„é»æ˜¯åœ¨è¦ç†è§£ Route 53 çš„æœå‹™åˆ°åº•å¯ä»¥å¹«æˆ‘å€‘å®Œæˆä»€éº¼äº‹ã€‚ HW - record Create VPC Route table æ–°å¢è·¯ç”±é€£åˆ°å¤–ç¶²ï¼š Main route table â†’ Routes â†’ Edit Routes Destination: 0.0.0.0/0 , Target: igw-XXXX Create EC2 Day4ï¼šAmazon Elastic Cloud Compute(EC2) ã€AWS 101ã€‘é‚å…¥AWSçš„ç¬¬ä¸€æ­¥-è¨­å®šVPC &amp; public subnet Setup Route53 Day11ï¼šAmazon Route 53 Amplify: ä»¥è¦–è¦ºæ–¹å¼å»ºç½® Web å‰ç«¯ UI Deploy your Jekyll Site using AWS Amplify â€” with only a few clicks Amplify console - Domain management: å¯ä»¥ç›´æ¥åœ¨åŸæœ‰çš„ domain åŠ ä¸Šä¸€å€‹ subdomain å•é¡Œ CNAME æ‡‰ç”¨å ´æ™¯ï¼šå…§éƒ¨é–‹ç™¼æ–¹ä¾¿ï¼ˆè¨­åœ¨ private zoneï¼‰ã€å®‰å…¨æ€§ï¼ˆè¨­å®šæª”éƒ½è¨­ CNAME çš„ dnsï¼‰ Name server ç”¨è™•ï¼šè®“å…¶ä»–äººå¾—ä»¥ query åˆ°æˆ‘å€‘è‡ªå·±è¨­å®šçš„ dns record Nginx in EC2 Prerequisite: EC2 w/ SG allowing http &amp; https Nginx Config åœ¨è¨­å®šå®Œä¸Šè¿° Route 53 çš„ A / CNAME record ä¹‹å¾Œï¼Œè¦ºå¾—å¦‚æœæ²’æœ‰çœŸçš„é–‹ä¸€å€‹ server é¡¯ç¤ºä¸€é»æ±è¥¿çœŸçš„å¤ªå°ä¸èµ·è‡ªå·±ã„Œå§ï¼ˆè›¤ï¼‰ï¼Œæ–¼æ˜¯å°±æ”¾äº†ä¸€å€‹ç°¡å–®çš„é é¢é€²å»å‰›å‰›é–‹å¥½çš„ EC2 è£¡ ä¸‹è¼‰ nginx &amp; epel sudo yum install -y epel-release sudo yum install nginx -y Nginx ç›¸é—œæŒ‡ä»¤ sudo systemctl start nginx sudo systemctl enable nginx sudo systemctl status nginx å»ºç«‹è³‡æ–™å¤¾æ”¾ç½®è¦ serve çš„éœæ…‹æª”æ¡ˆï¼ŒæŠŠ index.html åŠ åˆ°è£¡é¢ sudo mkdir /var/www/jc713.staff.5xruby.dev/public_html æ”¹è®Šè©²è³‡æ–™å¤¾çš„æ‰€æœ‰æ¬Šï¼Œè®“ Nginx å¯ä»¥å­˜å–åŸ·è¡Œ sudo chown -R nginx: /var/www/jc713.staff.5xruby.dev/ Enable SELinux: sudo vim /etc/selinux/config å°‡ disable æ”¹æˆ enable &amp; check sudo sestatus é–‹æ”¾ SELinux å­˜å– Nginx website files sudo setsebool -P httpd_can_network_connect on sudo chcon -Rt httpd_sys_content_t /var/www/ Nginx è¨­å®šæª” sudo vi /etc/nginx/sites-available/jc713.staff.5xruby.dev.conf server { listen 80; listen [::]:80; root /var/www/example-one.com/public_html; index index.html; server_name example-one.com www.example-one.com; access_log /var/log/nginx/example-one.com.access.log; error_log /var/log/nginx/example-one.com.error.log; location / { try_files $uri $uri/ =404; } } é©—è­‰ Nginx è¨­å®š $ sudo nginx -t nginx: the configuration file /etc/nginx/nginx.conf syntax is ok nginx: configuration file /etc/nginx/nginx.conf test is successful Restart Nginx with sudo systemctl restart nginx Nginx SSL settings å®‰è£ Certbot sudo apt install certbot -y sudo apt-get install -y python-certbot-nginx ç”Ÿæˆ SSL æ†‘è­‰ &amp; Nginx è¨­å®š $ sudo certbot --nginx ------- 1. You site admin email address 2. Terms of Service agreement. 3. List of domains you need HTTPS for. Certbot will automatically detect this information from the Nginx conf files. 4. HTTP to HTTPS redirection confirmation (it is better to redirect) Certbot æœƒè‡ªå‹•åœ¨å‰›å‰›è¨­å®šçš„ Nginx è¨­å®šæª”è£¡ç”¢ç”Ÿä»¥ä¸‹è³‡è¨Š listen [::]:443 ssl ipv6only=on; # managed by Certbot listen 443 ssl; # managed by Certbot ssl_certificate /etc/letsencrypt/live/kartsavings.com/fullchain.pem; # managed by Certbot ssl_certificate_key /etc/letsencrypt/live/kartsavings.com/privkey.pem; # managed by Certbot include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot } Done! Reference Ref 1 Ref 2]]></summary></entry><entry><title type="html">DQN å­¸ç¿’ç­†è¨˜</title><link href="https://jqlynchien713.github.io/2022/02/24/dqn.html" rel="alternate" type="text/html" title="DQN å­¸ç¿’ç­†è¨˜" /><published>2022-02-24T07:51:00+00:00</published><updated>2022-02-24T07:51:00+00:00</updated><id>https://jqlynchien713.github.io/2022/02/24/dqn</id><content type="html" xml:base="https://jqlynchien713.github.io/2022/02/24/dqn.html"><![CDATA[<blockquote>
  <p>é€™æ˜¯è«–æ–‡è¦ç ”ç©¶ã„‰ä¸»é¡Œï¼Œæƒ³èªªéƒ½å¯«å¥½äº†é‚£å°±å…ˆæ”¾ä¸Šä¾†å¥½äº†</p>
</blockquote>

<h2 id="basic-components">Basic Components</h2>
<p><img src="https://i.imgur.com/Ht2mciG.png" width="300" /></p>

<ul>
  <li>Env, Actor, Reward Funciton, Episode &amp; Trajectory</li>
  <li>Trajectory: \(\tau = \{s_i, a_i,\dots\}\) in 1 episode</li>
  <li>å¯ä»¥è¨ˆç®—ç‰¹å®š (action, state) pair å‡ºç¾çš„æ©Ÿç‡\(P_\theta(\tau) = p(s_1)p_\theta(a_1\|s_1)p(s_2\|s_1, a_1)p_\theta(a_2\|s_2)p(s_3\|s_2, a_2)\dots\\=P(s_1)\prod_{t=1}^{T}p_\theta(a_t\|s_t)p(s_{t+1}\|s_t, a_t)\)</li>
  <li>æ›´æ–° \(\theta\) æ‰¾åˆ°æœ€å¤§çš„ reward: \(\max R(\tau)=\sum_t^Tr_t\)
    <ul>
      <li>Env &amp; Reward ç‚ºéš¨æ©Ÿè®Šæ•¸ï¼Œå› æ­¤åªèƒ½ç®—æœŸæœ›å€¼ï¼š \(\bar{R}_\theta = \sum R(\tau)p_\theta(\tau) = E_{\tau\sim p_\theta(\tau)}[R(\tau)]\)</li>
    </ul>
  </li>
</ul>

<h2 id="gradient-ascent-maximize-expected-reward">Gradient Ascent: Maximize expected reward</h2>
<ul>
  <li>ç›®æ¨™ï¼šå¦‚æœæŸå€‹ (state, action) pair èƒ½è®“ trajectory reward ç‚ºæ­£ï¼Œå‰‡å¢åŠ é€™é …å‡ºç¾çš„æ©Ÿç‡
   \(\nabla \bar{R_\theta}=\frac{1}{N}\sum_n^N\sum_t^{T_n} R(\tau^n)\nabla\log p_\theta(a_t^n\|s_t^n)\)</li>
  <li>éœ€è¦ä¸æ–·å¾ trajectory set sample data
<img src="https://i.imgur.com/Q6sCVDq.png" alt="" /></li>
  <li>Tips for implementation
    <ul>
      <li>å°‡ state(input) &amp; action(output) è¦–ç‚ºåˆ†é¡å•é¡Œ
        <ul>
          <li>ä¸€èˆ¬åˆ†é¡å•é¡Œ objective functionï¼šmin cross entropy = max log likelihood</li>
          <li>è½‰æ›æˆ RL æ™‚è¦å¤šä¹˜ä¸Š reward
  \(\frac{1}{N}\sum_n^N\sum_t^{T_n} \nabla\log p_\theta(a_t^n\|s_t^n)\Rightarrow\frac{1}{N}\sum_n^N\sum_t^{T_n} R(\tau^n)\nabla\log p_\theta(a_t^n\|s_t^n)\)</li>
        </ul>
      </li>
      <li>Add a baseline
        <ul>
          <li>æƒ…å¢ƒï¼šç•¶éŠæˆ²è¦å‰‡è£¡ä¸æœƒå¾—åˆ°è² åˆ†æ™‚ï¼›ä¸”æœ‰äº› action ä¸æœƒè¢« sample åˆ°ï¼Œå°è‡´ agent ä½ä¼°é€™å€‹action èƒ½å¸¶ä¾†çš„ reward</li>
          <li>è§£æ³•ï¼šè®“ reward ä¸è¦ç¸½æ˜¯æ­£çš„ \(\rightarrow\) Reward - baseline(ex. \(\bar{\tau^n}\))</li>
        </ul>
      </li>
      <li>Assign Suitable Credit
        <ul>
          <li>å•é¡Œï¼šå°±ç®—æŸå€‹ pair çš„è¡¨ç¾æ˜¯ä¸å¥½çš„ï¼Œä½†åœ¨ç¸½ reward ç‚ºæ­£çš„æƒ…æ³ä¸‹ï¼Œé‚„æ˜¯æœƒè¢«æå‡å‡ºç¾çš„æ©Ÿç‡</li>
          <li>è§£æ³•ï¼šåªè¨ˆç®—åŸ·è¡Œæ­¤ action å¾Œçš„ reward
<img src="https://i.imgur.com/8J18po0.png" alt="" /></li>
          <li>æ–°çš„æ›´æ–°æ–¹å¼ï¼š
  \(\frac{1}{N}\sum_n^N\sum_t^{T_n} (R(\tau^n)-b)\nabla\log p_\theta(a_t^n\|s_t^n)\)
            <ul>
              <li>b å–æ±ºæ–¼ state</li>
              <li>\((R(\tau^n)-b)\) ç‚º advantage function \(A^\theta(s_t, a_t)\)</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="proximal-policy-optimization-ppo">Proximal Policy Optimization, PPO</h2>
<ul>
  <li>Off-Policy
    <ul>
      <li>On-policy vs. Off-policy
        <ul>
          <li>On: agent å’Œç’°å¢ƒäº’å‹•ï¼‹å­¸ç¿’</li>
          <li>Off: å­¸ç¿’çš„ agent \(\neq\) äº’å‹•çš„ agentï¼Œaka agent åœ¨æ—é‚Šçœ‹åˆ¥äººç©ï¼ˆä¸¦å­¸ï¼‰</li>
        </ul>
      </li>
      <li>On-policy çš„å•é¡Œï¼šæ›´æ–° model å¾Œéœ€è¦é‡æ–° sample data</li>
      <li>
        <p>Off-policy å¦‚ä½•è§£æ±ºï¼šsample \(\pi_{\theta'}\) ä¾†è¨“ç·´ \(\pi_\theta \rightarrow\) reuse sampled data</p>

        <blockquote>
          <p><strong>Importance Sampling</strong> <br />
ç„¡æ³•ç›´æ¥å¾ p(x) æŠ½æ¨£çš„æƒ…æ³ä¸‹ï¼Œå¯è—‰ç”±å¦ä¸€å€‹åˆ†éƒ¨ q(x) æŠ½æ¨£
ä¸” sample q æ¬¡æ•¸å¤ å¤šå‰‡å¯è¶Šè¶¨è¿‘æ–¼ p(x)
\(E_{x\sim p}[f(x)]=E_{x\sim q}[f(x)\frac{p(x)}{q(x)}]\)
\(\frac{p(x)}{q(x)}\)ç‚ºä¿®æ­£å¾ q æŠ½æ¨£çš„èª¿æ•´é …</p>
        </blockquote>
      </li>
      <li>Off-policy åš gradient ascent æ™‚çš„èª¿æ•´
  \(\nabla \bar{R_\theta}=E_{\tau\sim p_\theta(\tau)}[R(\tau)\nabla\log p_\theta(\tau)]\rightarrow E_{\tau\sim p_{\theta'}(\tau)}[\frac{p_\theta(\tau)}{p_{\theta'}(\tau)}R(\tau)\nabla\log p_\theta(\tau)]\)</li>
      <li>New Objective Function
  \(J^{\theta'}(\theta)=E_{(s_t,a_t)\sim \pi_{\theta'}(\tau)}[\frac{p_\theta(a_t\|s_t)}{p_{\theta'}(a_t\|s_t)}A^{\theta'}(s_t, a_t)]\)
        <ul>
          <li>\(\theta'\): demo</li>
          <li>\(\theta\): update</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>PPO: é™åˆ¶ \(\pi\) èˆ‡ \(\pi'\) é–“çš„ç›¸ä¼¼åº¦
    <ul>
      <li>
\[J_{PPO}^{\theta'}=J^{\theta'}(\theta)-\beta\cdot KL(\theta, \theta')\]
      </li>
    </ul>
  </li>
  <li>PPO2:</li>
</ul>

<h2 id="q-learningvalue-based">Q Learning(Value-based)</h2>
<p>Learn Critic: è©•åƒ¹ <strong>actor \(\pi\)</strong> åšå¾—å¤šå¥½ï¼ˆè€Œä¸æ˜¯ stateï¼‰</p>
<ul>
  <li>State value function \(V^\pi(s)\)
    <ul>
      <li>å®šç¾©ï¼šgiven sï¼Œåˆ°çµæŸçš„ç´¯ç©<strong>æœŸæœ›</strong> reward</li>
      <li>Estimate \(V^\pi(s)\)
        <ul>
          <li>Monte-Carlo based
            <ul>
              <li>çœ‹åˆ° state a å›å‚³ cumulated gain a</li>
              <li>ä¸å¯èƒ½æƒéæ‰€æœ‰ state \(\rightarrow V^\pi(s)\) è¦–ç‚º regression</li>
            </ul>
          </li>
          <li>Temporal-difference appoarch
\(\because s_t, a_t, r_t \rightarrow s_{t+1}, a_{t+1}, r_{t+1}\)
<img src="https://i.imgur.com/DiOr0kj.png" alt="" /></li>
          <li>MC vs. TD: ä¸åŒæ‰‹æ®µä¼°å‡ºä¾†çš„çµæœå¯èƒ½ä¸åŒ
            <ul>
              <li>MC: larger varianceï¼Œå› ç‚ºæ¯æ¬¡å¾—åˆ°çš„ state &amp; gain æœ‰æŠ½æ¨£çš„éš¨æ©Ÿæ€§ï¼Œä¸”æ˜¯è¨ˆç®—ç´¯ç© reward</li>
              <li>TD: smaller varianceï¼Œå› ç‚ºæ¯æ¬¡åªè¨ˆç®—ä¸€å€‹ rï¼Œä½† \(V^\pi\) å¯èƒ½ä¼°çš„ä¸æº–</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>State-action value function \(Q^\pi(s, a)\)
    <ul>
      <li>å®šç¾©ï¼š<span style="background: #FFFF33">åœ¨ state s <strong>å¼·åˆ¶æ¡å– action a</strong>ï¼Œå¾ŒçºŒæ¡ç”¨ \(\pi\) çš„ç´¯ç©æœŸæœ› reward</span>
  ï¼ˆagent ä¸ä¸€å®šæœƒæ¡ç”¨ aï¼‰
  <img src="https://i.imgur.com/ONuC5sa.png" alt="" /></li>
      <li>ä½¿ç”¨ Q function æ›´æ–° \(\pi\) çš„æµç¨‹
  <img src="https://i.imgur.com/VkljFxs.png" alt="" /></li>
    </ul>
  </li>
  <li>Tips:
    <ul>
      <li>Target Network
   <img src="https://i.imgur.com/bbimeav.png" alt="" /></li>
      <li>Exploration
        <ul>
          <li>åŸå› ï¼šQ function æœ‰é»é¡ä¼¼ regressionï¼ˆç„¡éš¨æ©Ÿæ€§ï¼‰ï¼Œä¸é©åˆç”¨æ–¼ sample data</li>
          <li>è§£æ³•ï¼š
            <ul>
              <li>Epsilon Greedy: <img src="https://i.imgur.com/dzvQtq3.png" alt="" /></li>
              <li>Boltzmann Exploration</li>
            </ul>
          </li>
        </ul>
      </li>
      <li>Replay Buffer
  <img src="https://i.imgur.com/QLBWaPY.jpg" alt="" />
        <ul>
          <li>æ¸›å°‘å’Œç’°å¢ƒäº’å‹•çš„æ¬¡æ•¸</li>
          <li>å¯æå‡ batch data diversity</li>
          <li>Off-policy: å› ç‚ºéå»çš„ exp ä¸ä¸€å®šä¾†è‡ª \(\pi\)</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Advanced Tips
    <ul>
      <li>Double DQN
        <ul>
          <li>å•é¡Œï¼šDQN æœƒé«˜ä¼° Q value
            <ul>
              <li>ä¼°è¨ˆèª¤å·® \(\rightarrow\) é¸åˆ°é«˜ä¼°çš„ action \(\rightarrow\) targetå€¼æœƒè¢«è¨­å¤ªé«˜</li>
            </ul>
          </li>
          <li>è§£æ³•ï¼šé¸ action çš„ Q function \(\neq\) ç®— Q value çš„ Q function
            <ul>
              <li><img src="https://i.imgur.com/7KlxIx9.png" alt="" /></li>
            </ul>
          </li>
        </ul>
      </li>
      <li>Dueling DQN
        <ul>
          <li>æ”¹è®Š network æ¶æ§‹ï¼Œ\(Q(s, a)\rightarrow Q(s, a)=V(s)+A(s, a)\)</li>
          <li>æå‡ä¼°è¨ˆ Q value çš„æ•ˆç‡ï¼Œä¸ç”¨æ¯å€‹ pair éƒ½è¢« sample</li>
          <li><img src="https://i.imgur.com/z1WzTyg.jpg" alt="" /></li>
          <li>\(\because\) æ›´æ–° \(V(s)\) æ¯” sample æœ‰æ•ˆç‡</li>
          <li>A çš„ column åˆç‚º 0ï¼Œç¢ºä¿æ›´æ–° V</li>
        </ul>
      </li>
      <li>Priority Reply
        <ul>
          <li>å¾ buffer è£¡é¸æ“‡ TD error è¼ƒå¤§çš„ experience set</li>
          <li>æ”¹è®Š sample data çš„ distribution &amp; training process</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>]]></content><author><name></name></author><category term="update" /><category term="research" /><summary type="html"><![CDATA[é€™æ˜¯è«–æ–‡è¦ç ”ç©¶ã„‰ä¸»é¡Œï¼Œæƒ³èªªéƒ½å¯«å¥½äº†é‚£å°±å…ˆæ”¾ä¸Šä¾†å¥½äº† Basic Components Env, Actor, Reward Funciton, Episode &amp; Trajectory Trajectory: \(\tau = \{s_i, a_i,\dots\}\) in 1 episode å¯ä»¥è¨ˆç®—ç‰¹å®š (action, state) pair å‡ºç¾çš„æ©Ÿç‡\(P_\theta(\tau) = p(s_1)p_\theta(a_1\|s_1)p(s_2\|s_1, a_1)p_\theta(a_2\|s_2)p(s_3\|s_2, a_2)\dots\\=P(s_1)\prod_{t=1}^{T}p_\theta(a_t\|s_t)p(s_{t+1}\|s_t, a_t)\) æ›´æ–° \(\theta\) æ‰¾åˆ°æœ€å¤§çš„ reward: \(\max R(\tau)=\sum_t^Tr_t\) Env &amp; Reward ç‚ºéš¨æ©Ÿè®Šæ•¸ï¼Œå› æ­¤åªèƒ½ç®—æœŸæœ›å€¼ï¼š \(\bar{R}_\theta = \sum R(\tau)p_\theta(\tau) = E_{\tau\sim p_\theta(\tau)}[R(\tau)]\) Gradient Ascent: Maximize expected reward ç›®æ¨™ï¼šå¦‚æœæŸå€‹ (state, action) pair èƒ½è®“ trajectory reward ç‚ºæ­£ï¼Œå‰‡å¢åŠ é€™é …å‡ºç¾çš„æ©Ÿç‡ \(\nabla \bar{R_\theta}=\frac{1}{N}\sum_n^N\sum_t^{T_n} R(\tau^n)\nabla\log p_\theta(a_t^n\|s_t^n)\) éœ€è¦ä¸æ–·å¾ trajectory set sample data Tips for implementation å°‡ state(input) &amp; action(output) è¦–ç‚ºåˆ†é¡å•é¡Œ ä¸€èˆ¬åˆ†é¡å•é¡Œ objective functionï¼šmin cross entropy = max log likelihood è½‰æ›æˆ RL æ™‚è¦å¤šä¹˜ä¸Š reward \(\frac{1}{N}\sum_n^N\sum_t^{T_n} \nabla\log p_\theta(a_t^n\|s_t^n)\Rightarrow\frac{1}{N}\sum_n^N\sum_t^{T_n} R(\tau^n)\nabla\log p_\theta(a_t^n\|s_t^n)\) Add a baseline æƒ…å¢ƒï¼šç•¶éŠæˆ²è¦å‰‡è£¡ä¸æœƒå¾—åˆ°è² åˆ†æ™‚ï¼›ä¸”æœ‰äº› action ä¸æœƒè¢« sample åˆ°ï¼Œå°è‡´ agent ä½ä¼°é€™å€‹action èƒ½å¸¶ä¾†çš„ reward è§£æ³•ï¼šè®“ reward ä¸è¦ç¸½æ˜¯æ­£çš„ \(\rightarrow\) Reward - baseline(ex. \(\bar{\tau^n}\)) Assign Suitable Credit å•é¡Œï¼šå°±ç®—æŸå€‹ pair çš„è¡¨ç¾æ˜¯ä¸å¥½çš„ï¼Œä½†åœ¨ç¸½ reward ç‚ºæ­£çš„æƒ…æ³ä¸‹ï¼Œé‚„æ˜¯æœƒè¢«æå‡å‡ºç¾çš„æ©Ÿç‡ è§£æ³•ï¼šåªè¨ˆç®—åŸ·è¡Œæ­¤ action å¾Œçš„ reward æ–°çš„æ›´æ–°æ–¹å¼ï¼š \(\frac{1}{N}\sum_n^N\sum_t^{T_n} (R(\tau^n)-b)\nabla\log p_\theta(a_t^n\|s_t^n)\) b å–æ±ºæ–¼ state \((R(\tau^n)-b)\) ç‚º advantage function \(A^\theta(s_t, a_t)\) Proximal Policy Optimization, PPO Off-Policy On-policy vs. Off-policy On: agent å’Œç’°å¢ƒäº’å‹•ï¼‹å­¸ç¿’ Off: å­¸ç¿’çš„ agent \(\neq\) äº’å‹•çš„ agentï¼Œaka agent åœ¨æ—é‚Šçœ‹åˆ¥äººç©ï¼ˆä¸¦å­¸ï¼‰ On-policy çš„å•é¡Œï¼šæ›´æ–° model å¾Œéœ€è¦é‡æ–° sample data Off-policy å¦‚ä½•è§£æ±ºï¼šsample \(\pi_{\theta'}\) ä¾†è¨“ç·´ \(\pi_\theta \rightarrow\) reuse sampled data Importance Sampling ç„¡æ³•ç›´æ¥å¾ p(x) æŠ½æ¨£çš„æƒ…æ³ä¸‹ï¼Œå¯è—‰ç”±å¦ä¸€å€‹åˆ†éƒ¨ q(x) æŠ½æ¨£ ä¸” sample q æ¬¡æ•¸å¤ å¤šå‰‡å¯è¶Šè¶¨è¿‘æ–¼ p(x) \(E_{x\sim p}[f(x)]=E_{x\sim q}[f(x)\frac{p(x)}{q(x)}]\) \(\frac{p(x)}{q(x)}\)ç‚ºä¿®æ­£å¾ q æŠ½æ¨£çš„èª¿æ•´é … Off-policy åš gradient ascent æ™‚çš„èª¿æ•´ \(\nabla \bar{R_\theta}=E_{\tau\sim p_\theta(\tau)}[R(\tau)\nabla\log p_\theta(\tau)]\rightarrow E_{\tau\sim p_{\theta'}(\tau)}[\frac{p_\theta(\tau)}{p_{\theta'}(\tau)}R(\tau)\nabla\log p_\theta(\tau)]\) New Objective Function \(J^{\theta'}(\theta)=E_{(s_t,a_t)\sim \pi_{\theta'}(\tau)}[\frac{p_\theta(a_t\|s_t)}{p_{\theta'}(a_t\|s_t)}A^{\theta'}(s_t, a_t)]\) \(\theta'\): demo \(\theta\): update PPO: é™åˆ¶ \(\pi\) èˆ‡ \(\pi'\) é–“çš„ç›¸ä¼¼åº¦ \[J_{PPO}^{\theta'}=J^{\theta'}(\theta)-\beta\cdot KL(\theta, \theta')\] PPO2: Q Learning(Value-based) Learn Critic: è©•åƒ¹ actor \(\pi\) åšå¾—å¤šå¥½ï¼ˆè€Œä¸æ˜¯ stateï¼‰ State value function \(V^\pi(s)\) å®šç¾©ï¼šgiven sï¼Œåˆ°çµæŸçš„ç´¯ç©æœŸæœ› reward Estimate \(V^\pi(s)\) Monte-Carlo based çœ‹åˆ° state a å›å‚³ cumulated gain a ä¸å¯èƒ½æƒéæ‰€æœ‰ state \(\rightarrow V^\pi(s)\) è¦–ç‚º regression Temporal-difference appoarch \(\because s_t, a_t, r_t \rightarrow s_{t+1}, a_{t+1}, r_{t+1}\) MC vs. TD: ä¸åŒæ‰‹æ®µä¼°å‡ºä¾†çš„çµæœå¯èƒ½ä¸åŒ MC: larger varianceï¼Œå› ç‚ºæ¯æ¬¡å¾—åˆ°çš„ state &amp; gain æœ‰æŠ½æ¨£çš„éš¨æ©Ÿæ€§ï¼Œä¸”æ˜¯è¨ˆç®—ç´¯ç© reward TD: smaller varianceï¼Œå› ç‚ºæ¯æ¬¡åªè¨ˆç®—ä¸€å€‹ rï¼Œä½† \(V^\pi\) å¯èƒ½ä¼°çš„ä¸æº– State-action value function \(Q^\pi(s, a)\) å®šç¾©ï¼šåœ¨ state s å¼·åˆ¶æ¡å– action aï¼Œå¾ŒçºŒæ¡ç”¨ \(\pi\) çš„ç´¯ç©æœŸæœ› reward ï¼ˆagent ä¸ä¸€å®šæœƒæ¡ç”¨ aï¼‰ ä½¿ç”¨ Q function æ›´æ–° \(\pi\) çš„æµç¨‹ Tips: Target Network Exploration åŸå› ï¼šQ function æœ‰é»é¡ä¼¼ regressionï¼ˆç„¡éš¨æ©Ÿæ€§ï¼‰ï¼Œä¸é©åˆç”¨æ–¼ sample data è§£æ³•ï¼š Epsilon Greedy: Boltzmann Exploration Replay Buffer æ¸›å°‘å’Œç’°å¢ƒäº’å‹•çš„æ¬¡æ•¸ å¯æå‡ batch data diversity Off-policy: å› ç‚ºéå»çš„ exp ä¸ä¸€å®šä¾†è‡ª \(\pi\) Advanced Tips Double DQN å•é¡Œï¼šDQN æœƒé«˜ä¼° Q value ä¼°è¨ˆèª¤å·® \(\rightarrow\) é¸åˆ°é«˜ä¼°çš„ action \(\rightarrow\) targetå€¼æœƒè¢«è¨­å¤ªé«˜ è§£æ³•ï¼šé¸ action çš„ Q function \(\neq\) ç®— Q value çš„ Q function Dueling DQN æ”¹è®Š network æ¶æ§‹ï¼Œ\(Q(s, a)\rightarrow Q(s, a)=V(s)+A(s, a)\) æå‡ä¼°è¨ˆ Q value çš„æ•ˆç‡ï¼Œä¸ç”¨æ¯å€‹ pair éƒ½è¢« sample \(\because\) æ›´æ–° \(V(s)\) æ¯” sample æœ‰æ•ˆç‡ A çš„ column åˆç‚º 0ï¼Œç¢ºä¿æ›´æ–° V Priority Reply å¾ buffer è£¡é¸æ“‡ TD error è¼ƒå¤§çš„ experience set æ”¹è®Š sample data çš„ distribution &amp; training process]]></summary></entry><entry><title type="html">Jekyll + Utterances å¯¦ä½œ gh-pages ç•™è¨€åŠŸèƒ½</title><link href="https://jqlynchien713.github.io/2022/02/23/utterances.html" rel="alternate" type="text/html" title="Jekyll + Utterances å¯¦ä½œ gh-pages ç•™è¨€åŠŸèƒ½" /><published>2022-02-23T06:48:00+00:00</published><updated>2022-02-23T06:48:00+00:00</updated><id>https://jqlynchien713.github.io/2022/02/23/utterances</id><content type="html" xml:base="https://jqlynchien713.github.io/2022/02/23/utterances.html"><![CDATA[<p>å¯«éƒ¨è½æ ¼æ²’æœ‰ç•™è¨€çš„åŠŸèƒ½å¥½åƒæ€ªæ€ªã„‰ï¼Œä¸Šèª²çš„æ™‚å€™è·Ÿæœ‹å‹è¨è«–ç ”ç©¶äº†ä¸€ä¸‹ï¼Œç™¼ç¾äº† Utterances é€™å€‹é…·å·¥å…·å¯ä»¥è·Ÿ Jekyll &amp; gh-pages æ•´åˆï¼Œä¸ç”¨ç”¨åˆ°è³‡æ–™åº«å°±å¯ä»¥å¯¦ä½œå‡ºç•™è¨€ã„‰åŠŸèƒ½äº†ï¼</p>

<h2 id="é‹ä½œåŸç†">é‹ä½œåŸç†</h2>
<p>åŸºæœ¬ä¸Šé€™å€‹å¤–æ›æ˜¯å°‡ github repo çš„ issues æ•´åˆåˆ°éœæ…‹ç¶²é æœ¬èº«ä¸Šï¼Œæ‰€ä»¥ç•¶å…¶ä»–ä½¿ç”¨è€…åœ¨ç•™è¨€æ™‚ï¼Œéœ€è¦ç™»å…¥ github çš„å¸³æˆ¶ï¼Œä¸¦ä¸”åœ¨å…¶ä»–ä½¿ç”¨è€…ç•™è¨€å¾Œï¼Œé€™äº›ç•™è¨€å°±æœƒæ›´æ–°åˆ° github repo ä¸Šçš„ issues åˆ†é </p>

<p>é€™æ˜¯éƒ¨è½æ ¼ç•™è¨€å¾Œçš„æ¨£å­
<img src="/assets/img/comment-demo.png" alt="" /></p>

<p>ç•™è¨€æœƒåŒæ­¥æ›´æ–°åˆ° github issue
<img src="/assets/img/comment-gh.png" alt="" /></p>

<h2 id="configuration">Configuration</h2>

<h3 id="github-ç«¯è¨­å®š">Github ç«¯è¨­å®š</h3>
<ul>
  <li>
    <p>éœ€è¦å…ˆåœ¨ Github ä¸Š install utterances appï¼Œä¸¦ä¸”åœ¨å€‹äººè¨­å®šé é¢è¨­å®šé¸æ“‡è¦å¥—ç”¨ utterance app çš„ repo
<img src="/assets/img/comment-setup.png" alt="" /></p>
  </li>
  <li>
    <p>æ¥ä¸‹ä¾†å¯ä»¥è¤‡è£½ Utterances çµ¦çš„ scriptï¼Œåœ¨ <code class="language-plaintext highlighter-rouge">[ENTER REPO HERE]</code> å¡«å…¥æƒ³è¦æ¡ç”¨ Utterances çš„ <code class="language-plaintext highlighter-rouge">UserName/RepoName</code>ã€‚å¦å¤– theme çš„éƒ¨åˆ†å¯ä»¥åˆ° Utterances çš„å®˜ç¶²ä¸Šçœ‹ï¼Œç¸½å…±æœ‰ä¹å€‹ä¸»é¡Œå¯ä»¥é¸ï¼Œæˆ‘æœ€å¾Œé¸çš„æ˜¯è·Ÿç¾åœ¨ç¶²ç«™æ¯”è¼ƒæ­çš„ github-light</p>

    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://utteranc.es/client.js"</span>
        <span class="na">repo=</span><span class="s">"[ENTER REPO HERE]"</span>
        <span class="na">issue-term=</span><span class="s">"pathname"</span>
        <span class="na">theme=</span><span class="s">"github-light"</span>
        <span class="na">crossorigin=</span><span class="s">"anonymous"</span>
        <span class="na">async</span><span class="nt">&gt;</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="jekyll-ç«¯è¨­å®š">Jekyll ç«¯è¨­å®š</h3>
<ul>
  <li>
    <p>å…ˆè¨­å®šå¥½ <code class="language-plaintext highlighter-rouge">config.yml</code>ï¼ŒæŒ‡å®šç•™è¨€ä½¿ç”¨çš„å¤–æ›ç‚º Utterances</p>

    <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Set which comment system to use</span>
<span class="na">comments</span><span class="pi">:</span>
  <span class="c1"># 'disqus' or 'utterances' are available</span>
  <span class="na">provider</span><span class="pi">:</span>            <span class="s">utterances</span>

<span class="c1"># You must install utterances github app before use.(https://github.com/apps/utterances)</span>
<span class="c1"># Make sure all variables are set properly. Check below link for detail.</span>
<span class="c1"># https://utteranc.es/</span>
<span class="na">utterances</span><span class="pi">:</span>
  <span class="na">repo</span><span class="pi">:</span>                <span class="s2">"</span><span class="s">jqlynchien713/jqlynchien713.github.io"</span>
  <span class="na">issue-term</span><span class="pi">:</span>          <span class="s2">"</span><span class="s">pathname"</span>
  <span class="na">label</span><span class="pi">:</span>               <span class="s2">"</span><span class="s">Comments"</span>
  <span class="na">theme</span><span class="pi">:</span>               <span class="s2">"</span><span class="s">github-light"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>æ¥ä¸‹ä¾†å¯ä»¥åœ¨ <code class="language-plaintext highlighter-rouge">_includes/my-comment.html</code> è¨­å®šç•™è¨€å¦‚ä½•é¡¯ç¤ºï¼Œä¸»è¦å°±æ˜¯è²¼ä¸Šå‰›å‰›åœ¨ Utterances å®˜ç¶²ä¸Šè¨­å®šå¥½çš„ scriptï¼Œé€™é‚Šä¸åŒçš„åœ°æ–¹åªæœ‰å¸¶å…¥æˆ‘åœ¨ config.yml è£¡è¨­å®šçš„åƒæ•¸è€Œå·²</p>

    <div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  {% assign provider = site.comments.provider | default:"disqus" %}
  {% if provider == "utterances" %}
    {% assign utterances = site.utterances %}
    {% if utterances.repo %}
      <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://utteranc.es/client.js"</span>
              <span class="na">repo=</span><span class="s">{{</span> <span class="na">utterances.repo</span> <span class="err">}}</span>
              <span class="na">issue-term=</span><span class="s">{{</span> <span class="na">utterances.issue-term</span> <span class="err">}}</span>
              <span class="na">label=</span><span class="s">{{</span> <span class="na">utterances.label</span> <span class="err">}}</span>
              <span class="na">theme=</span><span class="s">{{</span> <span class="na">utterances.theme</span> <span class="err">}}</span>
              <span class="na">crossorigin= </span><span class="s">"anonymous"</span>
              <span class="na">async</span><span class="nt">&gt;</span>
      <span class="nt">&lt;/script&gt;</span>
    {% endif %}
  {% endif %}
</code></pre></div>    </div>
  </li>
  <li>
    <p>æœ€å¾Œå°±æ˜¯æŠŠ comment section åŠ åˆ° post layout è£¡ã€<code class="language-plaintext highlighter-rouge">{{ content }}</code>ä¹‹å¾ŒåŠ ä¸Šä¸‹é¢é€™ä¸‰è¡Œï¼Œè®“æ¯ç¯‡æ–‡ç« ä¸‹é¢éƒ½æœ‰ç•™è¨€å€ï¼Œé€™æ¨£å°±å®Œæˆäº†ï¼</p>

    <div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{%- if site.comments.provider -%}
  {%- include my-comment.html -%}
{%- endif -%}
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p>ä¸Šèª²ä¸èªçœŸéƒ½åœ¨æé€™äº›æœ‰çš„æ²’çš„ğŸ¤¡</p>
</blockquote>

<font color="grey" style="font-size: 24px">Reference</font>
<ul>
  <li><a href="https://utteranc.es/">Utterances official site</a></li>
  <li><a href="https://lazyren.github.io/devlog/use-utterances-for-jekyll-comments.html">Use Utterances/Giscus for Jekyll Comments System</a></li>
</ul>]]></content><author><name></name></author><category term="update" /><category term="jekyll" /><summary type="html"><![CDATA[å¯«éƒ¨è½æ ¼æ²’æœ‰ç•™è¨€çš„åŠŸèƒ½å¥½åƒæ€ªæ€ªã„‰ï¼Œä¸Šèª²çš„æ™‚å€™è·Ÿæœ‹å‹è¨è«–ç ”ç©¶äº†ä¸€ä¸‹ï¼Œç™¼ç¾äº† Utterances é€™å€‹é…·å·¥å…·å¯ä»¥è·Ÿ Jekyll &amp; gh-pages æ•´åˆï¼Œä¸ç”¨ç”¨åˆ°è³‡æ–™åº«å°±å¯ä»¥å¯¦ä½œå‡ºç•™è¨€ã„‰åŠŸèƒ½äº†ï¼ é‹ä½œåŸç† åŸºæœ¬ä¸Šé€™å€‹å¤–æ›æ˜¯å°‡ github repo çš„ issues æ•´åˆåˆ°éœæ…‹ç¶²é æœ¬èº«ä¸Šï¼Œæ‰€ä»¥ç•¶å…¶ä»–ä½¿ç”¨è€…åœ¨ç•™è¨€æ™‚ï¼Œéœ€è¦ç™»å…¥ github çš„å¸³æˆ¶ï¼Œä¸¦ä¸”åœ¨å…¶ä»–ä½¿ç”¨è€…ç•™è¨€å¾Œï¼Œé€™äº›ç•™è¨€å°±æœƒæ›´æ–°åˆ° github repo ä¸Šçš„ issues åˆ†é  é€™æ˜¯éƒ¨è½æ ¼ç•™è¨€å¾Œçš„æ¨£å­ ç•™è¨€æœƒåŒæ­¥æ›´æ–°åˆ° github issue Configuration Github ç«¯è¨­å®š éœ€è¦å…ˆåœ¨ Github ä¸Š install utterances appï¼Œä¸¦ä¸”åœ¨å€‹äººè¨­å®šé é¢è¨­å®šé¸æ“‡è¦å¥—ç”¨ utterance app çš„ repo æ¥ä¸‹ä¾†å¯ä»¥è¤‡è£½ Utterances çµ¦çš„ scriptï¼Œåœ¨ [ENTER REPO HERE] å¡«å…¥æƒ³è¦æ¡ç”¨ Utterances çš„ UserName/RepoNameã€‚å¦å¤– theme çš„éƒ¨åˆ†å¯ä»¥åˆ° Utterances çš„å®˜ç¶²ä¸Šçœ‹ï¼Œç¸½å…±æœ‰ä¹å€‹ä¸»é¡Œå¯ä»¥é¸ï¼Œæˆ‘æœ€å¾Œé¸çš„æ˜¯è·Ÿç¾åœ¨ç¶²ç«™æ¯”è¼ƒæ­çš„ github-light &lt;script src="https://utteranc.es/client.js" repo="[ENTER REPO HERE]" issue-term="pathname" theme="github-light" crossorigin="anonymous" async&gt; &lt;/script&gt; Jekyll ç«¯è¨­å®š å…ˆè¨­å®šå¥½ config.ymlï¼ŒæŒ‡å®šç•™è¨€ä½¿ç”¨çš„å¤–æ›ç‚º Utterances # Set which comment system to use comments: # 'disqus' or 'utterances' are available provider: utterances # You must install utterances github app before use.(https://github.com/apps/utterances) # Make sure all variables are set properly. Check below link for detail. # https://utteranc.es/ utterances: repo: "jqlynchien713/jqlynchien713.github.io" issue-term: "pathname" label: "Comments" theme: "github-light" æ¥ä¸‹ä¾†å¯ä»¥åœ¨ _includes/my-comment.html è¨­å®šç•™è¨€å¦‚ä½•é¡¯ç¤ºï¼Œä¸»è¦å°±æ˜¯è²¼ä¸Šå‰›å‰›åœ¨ Utterances å®˜ç¶²ä¸Šè¨­å®šå¥½çš„ scriptï¼Œé€™é‚Šä¸åŒçš„åœ°æ–¹åªæœ‰å¸¶å…¥æˆ‘åœ¨ config.yml è£¡è¨­å®šçš„åƒæ•¸è€Œå·² {% assign provider = site.comments.provider | default:"disqus" %} {% if provider == "utterances" %} {% assign utterances = site.utterances %} {% if utterances.repo %} &lt;script src="https://utteranc.es/client.js" repo={{ utterances.repo }} issue-term={{ utterances.issue-term }} label={{ utterances.label }} theme={{ utterances.theme }} crossorigin= "anonymous" async&gt; &lt;/script&gt; {% endif %} {% endif %} æœ€å¾Œå°±æ˜¯æŠŠ comment section åŠ åˆ° post layout è£¡ã€{{ content }}ä¹‹å¾ŒåŠ ä¸Šä¸‹é¢é€™ä¸‰è¡Œï¼Œè®“æ¯ç¯‡æ–‡ç« ä¸‹é¢éƒ½æœ‰ç•™è¨€å€ï¼Œé€™æ¨£å°±å®Œæˆäº†ï¼ {%- if site.comments.provider -%} {%- include my-comment.html -%} {%- endif -%} ä¸Šèª²ä¸èªçœŸéƒ½åœ¨æé€™äº›æœ‰çš„æ²’çš„ğŸ¤¡ Reference Utterances official site Use Utterances/Giscus for Jekyll Comments System]]></summary></entry></feed>